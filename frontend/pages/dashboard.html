<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Clearance Face Search</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Authentication Loading Screen */
        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .auth-loading.hidden {
            display: none;
        }

        .auth-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .auth-loading-text {
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex; /* make column layout */
            flex-direction: column;
            overflow: hidden; /* prevent footer overlap; inner area scrolls */
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
        }

        .sidebar-menu {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto; /* scroll only menu area */
            min-height: 0; /* allow flexbox scrolling */
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
            margin-bottom: 8px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: rgba(255,255,255,0.5);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: white;
            border-left-width: 4px;
        }

        .menu-item i {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .nav-submenu {
            margin-left: 20px;
            margin-top: 0;
            margin-bottom: 8px;
        }

        .nav-submenu .menu-item {
            padding: 12px 25px;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .footer-section .nav-submenu {
            margin-left: 0;
            margin-top: 8px;
        }

        .footer-section .nav-submenu .menu-item {
            padding: 10px 20px;
            margin-bottom: 4px;
        }

        .menu-item span {
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .menu-item span {
            opacity: 0;
        }

        .menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 20px 20px;
        }

        .sidebar-footer {
            position: static; /* no overlay */
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
            margin-top: auto; /* push to bottom */
        }

        .footer-section {
            margin-bottom: 20px;
        }

        .footer-section:last-of-type {
            margin-bottom: 15px;
        }

        .footer-section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            color: rgba(255,255,255,0.9);
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 8px;
        }

        .footer-section-title i {
            font-size: 1rem;
            width: 16px;
            text-align: center;
        }

        .sidebar.collapsed .footer-section-title span {
            opacity: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user-details {
            opacity: 1;
            transition: opacity 0.3s ease;
            flex: 1;
            min-width: 0;
        }

        .sidebar.collapsed .user-details {
            opacity: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar.collapsed .logout-btn span {
            opacity: 0;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 70px;
        }

        .topbar {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: #f8f9ff;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a202c;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            width: 300px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #6b7280;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: #f8f9ff;
            color: #667eea;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dashboard Content */
        .dashboard-content {
            padding: 30px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .kpi-card.primary { border-left-color: #667eea; }
        .kpi-card.success { border-left-color: #10b981; }
        .kpi-card.warning { border-left-color: #f59e0b; }
        .kpi-card.danger { border-left-color: #ef4444; }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .kpi-title {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .kpi-icon.primary { background: #667eea; }
        .kpi-icon.success { background: #10b981; }
        .kpi-icon.warning { background: #f59e0b; }
        .kpi-icon.danger { background: #ef4444; }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 5px;
        }

        .kpi-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .kpi-change.positive { color: #10b981; }
        .kpi-change.negative { color: #ef4444; }

        /* Chart Styles */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a202c;
            display: flex;
            align-items: center;
        }

        .chart-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-grid.full-width {
            grid-template-columns: 1fr;
        }

        /* Recent Activity */
        .activity-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-top: 25px;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .activity-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a202c;
        }

        .view-all-btn {
            background: #f8f9ff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .view-all-btn:hover {
            background: #667eea;
            color: white;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .activity-icon.search { background: #667eea; }
        .activity-icon.user { background: #10b981; }
        .activity-icon.system { background: #f59e0b; }

        .activity-content {
            flex: 1;
        }

        .activity-item-title {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 3px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #6b7280;
        }

        /* Activity Monitoring Card */
        .activity-monitoring-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-top: 25px;
        }

        /* Activity Stats Grid */
        .activity-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .activity-stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .activity-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Activity Filters */
        .activity-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group label i {
            color: #667eea;
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .filter-btn.reset {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .filter-btn.reset:hover {
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        /* Activity Table */
        .activity-table-container {
            margin-top: 20px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .table-info {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .table-action-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-action-btn:hover {
            background: #f8f9ff;
            border-color: #667eea;
            color: #667eea;
        }

        .activity-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .activity-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .activity-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .activity-table th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.9rem;
            vertical-align: middle;
        }

        .activity-table tbody tr {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .activity-table tbody tr:hover {
            background: linear-gradient(90deg, #f8f9ff 0%, #ffffff 100%);
            border-left-color: #667eea;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .activity-table tbody tr:last-child td {
            border-bottom: none;
        }

        .time-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
        }

        .time-cell i {
            color: #667eea;
        }

        .description-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Mobile Cards View */
        .activity-cards {
            display: none;
            padding: 15px;
            gap: 15px;
        }

        .activity-card-mobile {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .activity-card-mobile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .activity-card-mobile.empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .activity-card-mobile.empty i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f1f3f4;
        }

        .card-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .card-icon.search { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-icon.login { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .card-icon.logout { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }
        .card-icon.export { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .card-icon.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .card-icon.system { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

        .card-header-info {
            flex: 1;
            min-width: 0;
        }

        .card-user {
            margin-bottom: 6px;
        }

        .card-time {
            font-size: 0.75rem;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .card-body {
            margin-bottom: 12px;
        }

        .card-type {
            margin-bottom: 8px;
        }

        .card-description {
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.5;
            word-break: break-word;
        }

        .card-footer {
            padding-top: 12px;
            border-top: 1px solid #f1f3f4;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.75rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #6b7280;
            padding: 4px 8px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .meta-item i {
            color: #667eea;
        }

        .loading-row {
            text-align: center;
            padding: 30px !important;
            color: #6b7280;
        }

        .loading-row i {
            margin-right: 10px;
        }

        .activity-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .activity-type-badge.login { background: #d1fae5; color: #065f46; }
        .activity-type-badge.logout { background: #e5e7eb; color: #374151; }
        .activity-type-badge.search { background: #dbeafe; color: #1e40af; }
        .activity-type-badge.profiling_search { background: #e0e7ff; color: #3730a3; }
        .activity-type-badge.cek_plat { background: #fef3c7; color: #92400e; }
        .activity-type-badge.export { background: #ede9fe; color: #5b21b6; }
        .activity-type-badge.error { background: #fee2e2; color: #991b1b; }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #f3f4f6;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .user-badge.admin { background: #fee2e2; color: #991b1b; }
        .user-badge.user { background: #dbeafe; color: #1e40af; }

        .ip-address {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ip-address i {
            color: #667eea;
        }

        .device-info {
            font-size: 0.8rem;
            color: #9ca3af;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .device-info i {
            color: #667eea;
        }

        /* Desktop: Hide mobile cards, show table */
        @media (min-width: 769px) {
            .desktop-table {
                display: table;
            }

            .mobile-cards {
                display: none;
            }
        }

        /* Pagination */
        .activity-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: #6b7280;
            margin: 0 10px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 280px;
                z-index: 1001;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0 !important;
                width: 100%;
            }
            
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 1000;
            }
            
            .sidebar-overlay.active {
                display: block;
            }

            .topbar {
                padding: 12px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .topbar-left {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .topbar-right {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            }

            .page-title {
                font-size: 1.3rem;
                flex: 1;
            }

            .search-box {
                flex: 1;
                min-width: 0;
            }

            .search-box input {
                width: 100%;
                max-width: 100%;
                font-size: 0.9rem;
                padding: 8px 12px 8px 35px;
            }

            .notification-btn {
                padding: 8px;
                font-size: 1.1rem;
            }

            .dashboard-content {
                padding: 15px 10px;
            }

            .chart-grid {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }

            .chart-wrapper {
                height: 220px;
            }

            .chart-container {
                padding: 15px;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .chart-title {
                font-size: 1rem;
            }

            .kpi-grid {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            .kpi-card {
                padding: 18px;
            }

            .kpi-header {
                flex-direction: row;
                justify-content: space-between;
            }

            .kpi-value {
                font-size: 1.6rem;
            }

            .kpi-change {
                font-size: 0.75rem;
            }

            /* Activity Monitoring Mobile */
            .activity-monitoring-card {
                padding: 15px 10px;
                margin-top: 15px;
            }

            .activity-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                margin-bottom: 15px;
            }

            .activity-title {
                font-size: 1.1rem;
            }

            .activity-subtitle {
                font-size: 0.8rem;
            }

            .refresh-btn {
                align-self: flex-end;
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .activity-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }

            .activity-stat-card {
                padding: 12px;
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }

            .stat-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
                margin: 0 auto;
            }

            .stat-value {
                font-size: 1.4rem;
                margin-bottom: 3px;
            }

            .stat-label {
                font-size: 0.7rem;
                line-height: 1.2;
            }

            .activity-filters {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 12px;
                margin-bottom: 15px;
            }

            .filter-group {
                width: 100%;
            }

            .filter-group label {
                font-size: 0.8rem;
                margin-bottom: 5px;
            }

            .filter-select, .filter-input {
                padding: 8px 10px;
                font-size: 0.85rem;
                width: 100%;
            }

            .filter-btn {
                width: 100%;
                margin-top: 5px;
                padding: 10px;
                font-size: 0.85rem;
            }

            /* Hide desktop table, show mobile cards */
            .desktop-table {
                display: none !important;
            }

            .mobile-cards {
                display: flex !important;
                flex-direction: column;
                padding: 10px;
                gap: 12px;
            }

            .activity-table-wrapper {
                border: none;
                box-shadow: none;
                background: transparent;
                padding: 0;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                margin-bottom: 10px;
                padding: 0 5px;
            }

            .table-info {
                font-size: 0.75rem;
                width: 100%;
            }

            .table-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .table-action-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .activity-card-mobile {
                padding: 14px;
                margin-bottom: 12px;
                border-radius: 10px;
                width: 100%;
                box-sizing: border-box;
            }

            .activity-card-mobile:last-child {
                margin-bottom: 0;
            }

            .card-header {
                gap: 10px;
                margin-bottom: 10px;
                padding-bottom: 10px;
                display: flex;
                align-items: flex-start;
            }

            .card-icon {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
                flex-shrink: 0;
            }

            .card-header-info {
                flex: 1;
                min-width: 0;
            }

            .card-user {
                margin-bottom: 4px;
            }

            .user-badge {
                font-size: 0.8rem;
                padding: 3px 8px;
                display: inline-flex;
                max-width: 100%;
            }

            .card-time {
                font-size: 0.7rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .card-body {
                margin-bottom: 10px;
            }

            .card-type {
                margin-bottom: 6px;
            }

            .activity-type-badge {
                font-size: 0.7rem;
                padding: 3px 10px;
            }

            .card-description {
                font-size: 0.85rem;
                line-height: 1.4;
                word-break: break-word;
                overflow-wrap: break-word;
                color: #374151;
            }

            .card-footer {
                padding-top: 10px;
                border-top: 1px solid #f1f3f4;
            }

            .card-meta {
                gap: 8px;
                font-size: 0.7rem;
                flex-wrap: wrap;
                display: flex;
            }

            .meta-item {
                padding: 3px 6px;
                font-size: 0.7rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
            }

            .activity-pagination {
                flex-wrap: wrap;
                gap: 6px;
                padding: 10px 5px;
            }

            .pagination-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-width: 36px;
            }

            .pagination-info {
                width: 100%;
                text-align: center;
                margin: 8px 0 0 0;
                font-size: 0.75rem;
                order: 10;
            }
        }

        /* Tablet Responsive */
        @media (max-width: 1024px) and (min-width: 769px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 280px;
            }
        }


        /* Small Mobile Responsive */
        @media (max-width: 480px) {
            .topbar {
                padding: 10px 12px;
            }

            .page-title {
                font-size: 1.1rem;
            }

            .dashboard-content {
                padding: 12px 8px;
            }

            .kpi-card {
                padding: 15px;
            }

            .kpi-header {
                margin-bottom: 12px;
            }

            .kpi-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }

            .kpi-value {
                font-size: 1.4rem;
            }

            .kpi-title {
                font-size: 0.85rem;
            }

            .kpi-change {
                font-size: 0.7rem;
            }

            .chart-container {
                padding: 12px;
            }

            .chart-wrapper {
                height: 180px;
            }

            .chart-title {
                font-size: 0.95rem;
            }

            .chart-subtitle {
                font-size: 0.8rem;
            }

            .activity-card {
                padding: 12px;
            }

            .activity-item {
                padding: 10px 0;
            }

            .activity-icon {
                width: 32px;
                height: 32px;
                font-size: 0.85rem;
            }

            .activity-item-title {
                font-size: 0.85rem;
            }

            .activity-time {
                font-size: 0.7rem;
            }

            .search-box input {
                font-size: 0.85rem;
                padding: 7px 10px 7px 32px;
            }

            .search-box i {
                left: 10px;
                font-size: 0.85rem;
            }

            .notification-btn {
                padding: 6px;
                font-size: 1rem;
            }

            .activity-stats-grid {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }

            .activity-stat-card {
                padding: 10px;
            }

            .stat-icon {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .stat-label {
                font-size: 0.65rem;
            }
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Authentication Loading Screen -->
    <div class="auth-loading" id="authLoading">
        <div class="auth-spinner"></div>
        <div class="auth-loading-text">Memverifikasi autentikasi...</div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="sidebar-title">Clearance Search</div>
        </div>
        
        <nav class="sidebar-menu">
            <a href="/dashboard" class="menu-item active">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="/profiling" class="menu-item">
                <i class="fas fa-search"></i>
                <span>Profiling</span>
            </a>
            <a href="/data-profiling" class="menu-item">
                <i class="fas fa-database"></i>
                <span>Data Profiling</span>
            </a>
            <a href="/cekplat" class="menu-item">
                <i class="fas fa-car"></i>
                <span>Cek Plat No Jambi</span>
            </a>
            <div class="nav-submenu">
                <a href="/data-cari-plat" class="menu-item">
                    <i class="fas fa-list"></i>
                    <span>Data Cari Plat No</span>
                </a>
            </div>
            <a href="/user-management" class="menu-item">
                <i class="fas fa-users"></i>
                <span>User Management</span>
            </a>
            <a href="/ai-features" class="menu-item">
                <i class="fas fa-robot"></i>
                <span>AI Features</span>
            </a>
            <a href="/mapping" class="menu-item">
                <i class="fas fa-project-diagram"></i>
                <span>Mapping Profiling</span>
            </a>
            <a href="/reports" class="menu-item">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </a>
            <div class="nav-submenu">
                <a href="/reports/profiling" class="menu-item">
                    <i class="fas fa-user-circle"></i>
                    <span>Profiling</span>
                </a>
            </div>
            <a href="/settings" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        
        <div class="menu-divider"></div>
        
        <div class="sidebar-footer">
            <!-- User Info Section -->
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin User</div>
                    <div class="user-role" id="userRole">Administrator</div>
                </div>
            </div>
            
            <!-- Logout Button -->
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Dashboard</h1>
            </div>
            <div class="topbar-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search..." id="globalSearch">
                </div>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card primary">
                    <div class="kpi-header">
                        <div class="kpi-title">Total Searches</div>
                        <div class="kpi-icon primary">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                    <div class="kpi-value">1,247</div>
                    <div class="kpi-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+12% from last month</span>
                    </div>
                </div>

                <div class="kpi-card success">
                    <div class="kpi-header">
                        <div class="kpi-title">Active Users</div>
                        <div class="kpi-icon success">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="kpi-value">89</div>
                    <div class="kpi-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+5% from last week</span>
                    </div>
                </div>

                <div class="kpi-card warning">
                    <div class="kpi-header">
                        <div class="kpi-title">Face Matches</div>
                        <div class="kpi-icon warning">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="kpi-value">456</div>
                    <div class="kpi-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>+8% from last month</span>
                    </div>
                </div>

                <div class="kpi-card danger">
                    <div class="kpi-header">
                        <div class="kpi-title">System Alerts</div>
                        <div class="kpi-icon danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="kpi-value">3</div>
                    <div class="kpi-change negative">
                        <i class="fas fa-arrow-down"></i>
                        <span>-2 from yesterday</span>
                    </div>
                </div>
            </div>

            <!-- Analytics Charts -->
            <div class="chart-grid">
                <!-- Profiling Search Types Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                <i class="fas fa-search" style="color: #667eea; margin-right: 10px;"></i>
                                Profiling Search Types
                            </h3>
                            <p class="chart-subtitle">Distribusi jenis pencarian profiling</p>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="profilingChart"></canvas>
                    </div>
                </div>

                <!-- Daily Activity Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">
                                <i class="fas fa-chart-line" style="color: #10b981; margin-right: 10px;"></i>
                                Daily Activity
                            </h3>
                            <p class="chart-subtitle">Aktivitas harian dalam 7 hari terakhir</p>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="dailyActivityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Cek Plat Analytics -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">
                            <i class="fas fa-car" style="color: #f59e0b; margin-right: 10px;"></i>
                            Cek Plat Analytics
                        </h3>
                        <p class="chart-subtitle">Analisis pencarian nomor polisi Jambi</p>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="cekplatChart"></canvas>
                </div>
            </div>

            <!-- User Activity Monitoring Section -->
            <div class="activity-monitoring-card">
                <div class="activity-header">
                    <div>
                        <h3 class="activity-title">
                            <i class="fas fa-chart-line" style="color: #667eea; margin-right: 10px;"></i>
                            Monitoring Aktivitas User
                        </h3>
                        <p class="activity-subtitle">Pantau aktivitas semua user secara real-time</p>
                    </div>
                    <button class="refresh-btn" onclick="refreshActivityMonitoring()" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <!-- Activity Stats Cards -->
                <div class="activity-stats-grid">
                    <div class="activity-stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalUsersStat">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="activeUsersStat">0</div>
                            <div class="stat-label">Active Today</div>
                        </div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalActivitiesStat">0</div>
                            <div class="stat-label">Total Activities</div>
                        </div>
                    </div>
                    <div class="activity-stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="todayActivitiesStat">0</div>
                            <div class="stat-label">Today's Activities</div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="activity-filters">
                    <div class="filter-group">
                        <label><i class="fas fa-user"></i> User</label>
                        <select id="filterUserId" class="filter-select">
                            <option value="">Semua User</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-filter"></i> Tipe Aktivitas</label>
                        <select id="filterActivityType" class="filter-select">
                            <option value="">Semua Tipe</option>
                            <option value="login">Login</option>
                            <option value="logout">Logout</option>
                            <option value="search">Search</option>
                            <option value="profiling_search">Profiling Search</option>
                            <option value="cek_plat">Cek Plat</option>
                            <option value="export">Export</option>
                            <option value="error">Error</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Dari Tanggal</label>
                        <input type="date" id="filterStartDate" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-calendar"></i> Sampai Tanggal</label>
                        <input type="date" id="filterEndDate" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label><i class="fas fa-search"></i> Cari</label>
                        <input type="text" id="filterSearch" class="filter-input" placeholder="Cari aktivitas...">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn" onclick="applyActivityFilters()">
                            <i class="fas fa-filter"></i> Terapkan Filter
                        </button>
                        <button class="filter-btn reset" onclick="resetActivityFilters()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>

                <!-- Activity Table -->
                <div class="activity-table-container">
                    <div class="table-header">
                        <div class="table-info">
                            <span id="activityTableInfo">Memuat data...</span>
                        </div>
                        <div class="table-actions">
                            <button class="table-action-btn" onclick="exportActivities()" title="Export">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="activity-table-wrapper">
                        <!-- Desktop Table View -->
                        <table class="activity-table desktop-table">
                            <thead>
                                <tr>
                                    <th>Waktu</th>
                                    <th>User</th>
                                    <th>Tipe</th>
                                    <th>Deskripsi</th>
                                    <th>IP Address</th>
                                    <th>Device</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <tr>
                                    <td colspan="6" class="loading-row">
                                        <i class="fas fa-spinner fa-spin"></i> Memuat aktivitas...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- Mobile Card View -->
                        <div class="activity-cards mobile-cards" id="activityCardsBody">
                            <div class="activity-card-mobile empty">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Memuat aktivitas...</p>
                            </div>
                        </div>
                    </div>
                    <!-- Pagination -->
                    <div class="activity-pagination" id="activityPagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Recent Activity (Simplified) -->
            <div class="activity-card">
                <div class="activity-header">
                    <h3 class="activity-title">Recent Activity</h3>
                    <button class="view-all-btn" onclick="showAllActivities()">View All</button>
                </div>
                <div class="activity-list" id="recentActivityList">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>

        class DashboardApp {
            constructor() {
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOverlay = document.getElementById('sidebarOverlay');
                this.isSidebarCollapsed = false;
                this.isMobile = window.innerWidth <= 768;
                
                this.init();
            }
            
            init() {
                console.log('Dashboard app initializing...');
                this.setupEventListeners();
                this.loadUserData();
                this.loadDashboardData();
                // Load activity monitoring
                loadActivityMonitoring();
            }

            setupEventListeners() {
                // Global search
                document.getElementById('globalSearch').addEventListener('input', (e) => {
                    this.handleGlobalSearch(e.target.value);
                });

                // Window resize
                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth <= 768;
                    if (!this.isMobile) {
                        this.sidebarOverlay.classList.remove('active');
                    }
                });
            }


            loadUserData() {
                const userData = localStorage.getItem('user_data');
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        const userName = document.getElementById('userName');
                        const userRole = document.getElementById('userRole');
                        if (userName && userRole) {
                            userName.textContent = user.username || user.name || 'Admin User';
                            userRole.textContent = user.role || 'Administrator';
                        }
                        
                        // Set menu visibility based on user role
                        this.setMenuVisibility(user.role);
                    } catch (e) {
                        console.log('Could not parse user data from localStorage');
                    }
                }
            }

            setMenuVisibility(userRole) {
                // Hide admin-only menus for non-admin users
                const adminOnlyMenus = ['user-management', 'settings'];
                
                adminOnlyMenus.forEach(menuId => {
                    const menuElement = document.querySelector(`a[href="/${menuId}"]`);
                    if (menuElement) {
                        if (userRole === 'admin') {
                            menuElement.style.display = 'flex';
                        } else {
                            menuElement.style.display = 'none';
                        }
                    }
                });
            }

            async loadDashboardData() {
                try {
                    const token = localStorage.getItem('session_token');
                    if (!token) {
                        console.log('No session token found');
                        return;
                    }

                    const response = await fetch('/api/dashboard/stats', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        this.dashboardData = result.data;
                        this.updateKPICards();
                        this.initCharts();
                        this.updateRecentActivities(this.dashboardData.recent_activities);
                    } else {
                        console.error('Failed to load dashboard data:', result.error);
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    // Fallback to static data
                    this.initCharts();
                }
            }

            updateKPICards() {
                if (!this.dashboardData) return;

                // Update KPI cards with real data
                const kpiCards = document.querySelectorAll('.kpi-card');
                
                // Total Searches
                if (kpiCards[0]) {
                    const totalSearches = this.dashboardData.total_searches || 0;
                    kpiCards[0].querySelector('.kpi-value').textContent = totalSearches.toLocaleString();
                }

                // Active Users
                if (kpiCards[1]) {
                    const activeUsers = this.dashboardData.active_users || 0;
                    kpiCards[1].querySelector('.kpi-value').textContent = activeUsers;
                }

                // Face Matches
                if (kpiCards[2]) {
                    const faceMatches = this.dashboardData.face_matches || 0;
                    kpiCards[2].querySelector('.kpi-value').textContent = faceMatches;
                }

                // System Alerts
                if (kpiCards[3]) {
                    const systemAlerts = this.dashboardData.system_alerts || 0;
                    kpiCards[3].querySelector('.kpi-value').textContent = systemAlerts;
                }
            }
            
            initCharts() {
                // Get real data or use fallback
                const searchTypes = this.dashboardData?.search_types || {identity: 0, phone: 0, face: 0};
                const dailyActivity = this.dashboardData?.daily_activity || [];
                const cekPlatDaily = this.dashboardData?.cek_plat_daily_activity || [];
                const cekPlatRegions = this.dashboardData?.cek_plat_regions || [];
                const recentActivities = this.dashboardData?.recent_activities || [];
                
                // Debug: Log the actual data being used
                console.log('Dashboard data for charts:', {
                    searchTypes,
                    dailyActivity,
                    cekPlatDaily,
                    cekPlatRegions,
                    recentActivities
                });
                
                // Debug: Log processed chart data
                const last7Days = this.getLast7Days();
                const profilingData = this.processDailyData(dailyActivity, last7Days, 'profiling_searches');
                const cekPlatData = this.processDailyData(cekPlatDaily, last7Days, 'cek_plat_searches');
                console.log('Processed chart data:', {
                    last7Days,
                    profilingData,
                    cekPlatData
                });

                // Profiling Search Types Chart (Doughnut) - dengan data real
                const profilingCtx = document.getElementById('profilingChart').getContext('2d');
                new Chart(profilingCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Identity Search', 'Phone Search', 'Face Detection'],
                        datasets: [{
                            data: [
                                searchTypes.identity || 0,
                                searchTypes.phone || 0,
                                searchTypes.face || 0
                            ],
                            backgroundColor: [
                                '#667eea', // Biru besar (40-45%)
                                '#10b981', // Hijau (30-35%)
                                '#f59e0b'  // Orange (20-25%)
                            ],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // Sembunyikan legend sesuai gambar
                            }
                        }
                    }
                });

                // Daily Activity Chart (Line) - dengan data real
                const dailyCtx = document.getElementById('dailyActivityChart').getContext('2d');
                
                // Use already processed data from above
                
                new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(day => day.day),
                        datasets: [{
                            label: 'Profiling Searches',
                            data: profilingData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'Cek Plat Searches',
                            data: cekPlatData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...profilingData, ...cekPlatData, 25), // Dynamic max based on data
                                grid: {
                                    color: '#f1f3f4'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });

                // Cek Plat Analytics Chart (Bar) - dengan data real
                const cekplatCtx = document.getElementById('cekplatChart').getContext('2d');
                
                // Process cek plat regions data
                const regionLabels = cekPlatRegions.map(region => region.region || 'Unknown');
                const regionData = cekPlatRegions.map(region => region.count || 0);
                
                new Chart(cekplatCtx, {
                    type: 'bar',
                    data: {
                        labels: regionLabels.length > 0 ? regionLabels : ['BH', 'BB', 'BG', 'BL', 'BM', 'BN', 'BP'],
                        datasets: [{
                            label: 'Pencarian per Kode Wilayah',
                            data: regionData.length > 0 ? regionData : [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: [
                                '#667eea', // Biru tinggi
                                '#10b981', // Hijau
                                '#f59e0b', // Orange
                                '#8b5cf6', // Ungu
                                '#06b6d4', // Cyan
                                '#84cc16', // Hijau muda
                                '#ef4444'  // Merah
                            ],
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(...regionData, 25), // Dynamic max based on data
                                grid: {
                                    color: '#f1f3f4'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            handleGlobalSearch(query) {
                if (query.length > 2) {
                    console.log('Searching for:', query);
                    // Implement global search functionality
                }
            }

            getLast7Days() {
                const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
                const result = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    result.push({
                        date: date.toISOString().split('T')[0],
                        day: days[date.getDay()]
                    });
                }
                return result;
            }

            processDailyData(dailyActivity, last7Days, valueKey = 'profiling_searches') {
                const data = new Array(7).fill(0);
                dailyActivity.forEach(activity => {
                    let activityDate;
                    
                    // Handle different date formats from API
                    if (typeof activity.date === 'string') {
                        // Handle formats like "Thu, 23 Oct 2025 00:00:00 GMT"
                        if (activity.date.includes('GMT')) {
                            activityDate = new Date(activity.date).toISOString().split('T')[0];
                        } else {
                            // Handle YYYY-MM-DD format
                            activityDate = activity.date;
                        }
                    } else {
                        // Handle Date object
                        activityDate = activity.date.toISOString().split('T')[0];
                    }
                    
                    const dayIndex = last7Days.findIndex(day => day.date === activityDate);
                    if (dayIndex !== -1) {
                        data[dayIndex] = activity[valueKey] || 0;
                    }
                });
                return data;
            }

            updateRecentActivities(activities) {
                const activityList = document.getElementById('recentActivityList') || document.querySelector('.activity-list');
                if (!activityList || !activities) return;

                activityList.innerHTML = '';
                
                // Show only first 5 activities
                const recentActivities = activities.slice(0, 5);
                
                if (recentActivities.length === 0) {
                    activityList.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-content">
                                <div class="activity-item-title" style="color: #6b7280; font-style: italic;">No recent activities</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                recentActivities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    const iconClass = this.getActivityIcon(activity.activity_type);
                    const timeAgo = this.getTimeAgo(activity.created_at);
                    const username = activity.username || 'Unknown';
                    
                    activityItem.innerHTML = `
                        <div class="activity-icon ${iconClass.class}">
                            <i class="${iconClass.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-item-title">${activity.description || 'Activity'} - ${username}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    `;
                    
                    activityList.appendChild(activityItem);
                });
            }

            getActivityIcon(activityType) {
                const icons = {
                    'search': { class: 'search', icon: 'fas fa-search' },
                    'profiling_search': { class: 'search', icon: 'fas fa-user-search' },
                    'cek_plat': { class: 'search', icon: 'fas fa-car' },
                    'login': { class: 'login', icon: 'fas fa-sign-in-alt' },
                    'logout': { class: 'logout', icon: 'fas fa-sign-out-alt' },
                    'export': { class: 'export', icon: 'fas fa-download' },
                    'error': { class: 'error', icon: 'fas fa-exclamation-triangle' },
                    'default': { class: 'system', icon: 'fas fa-cog' }
                };
                return icons[activityType] || icons.default;
            }

            getTimeAgo(timestamp) {
                const now = new Date();
                const time = new Date(timestamp);
                const diffMs = now - time;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} minutes ago`;
                if (diffHours < 24) return `${diffHours} hours ago`;
                return `${diffDays} days ago`;
            }
        }

        // Activity Monitoring Functions
        let currentActivityPage = 1;
        let activityFilters = {
            user_id: null,
            activity_type: null,
            start_date: null,
            end_date: null,
            search: null
        };

        async function loadActivityMonitoring() {
            try {
                const token = localStorage.getItem('session_token');
                if (!token) {
                    console.error(' No session token found');
                    return;
                }

                console.log(' Loading activity monitoring...');

                // Load activity stats
                try {
                    const statsResponse = await fetch('/api/dashboard/activity-stats', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (statsResponse.ok) {
                        const statsData = await statsResponse.json();
                        console.log(' Activity stats received:', statsData); // Debug log
                        if (statsData.success && statsData.data) {
                            updateActivityStats(statsData.data);
                        } else {
                            console.warn(' Stats response missing data:', statsData);
                        }
                    } else {
                        const errorData = await statsResponse.json().catch(() => ({}));
                        console.error(' Stats API error:', statsResponse.status, errorData);
                    }
                } catch (statsError) {
                    console.error(' Error loading activity stats:', statsError);
                }

                // Load activities
                console.log(' Loading activities...');
                await loadActivities();
            } catch (error) {
                console.error(' Error loading activity monitoring:', error);
                // Show error in UI
                const tbody = document.getElementById('activityTableBody');
                const cardsBody = document.getElementById('activityCardsBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="loading-row">
                                <i class="fas fa-exclamation-triangle"></i> Error: ${error.message}
                            </td>
                        </tr>
                    `;
                }
                if (cardsBody) {
                    cardsBody.innerHTML = `
                        <div class="activity-card-mobile empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function updateActivityStats(stats) {
            console.log('Updating activity stats:', stats); // Debug log
            
            // Update stat cards
            const totalActivitiesEl = document.getElementById('totalActivitiesStat');
            const todayActivitiesEl = document.getElementById('todayActivitiesStat');
            const totalUsersEl = document.getElementById('totalUsersStat');
            const activeUsersEl = document.getElementById('activeUsersStat');
            
            if (totalActivitiesEl) {
                totalActivitiesEl.textContent = stats.total_activities || 0;
            }
            
            // Calculate today's activities
            const today = new Date().toISOString().split('T')[0];
            let todayCount = 0;
            
            if (stats.daily_activities && Array.isArray(stats.daily_activities)) {
                // Handle different date formats
                const todayActivity = stats.daily_activities.find(d => {
                    if (!d || !d.date) return false;
                    // Handle date object or string
                    const dateStr = typeof d.date === 'string' ? d.date : 
                                   (d.date.toISOString ? d.date.toISOString().split('T')[0] : String(d.date));
                    return dateStr === today || dateStr.startsWith(today);
                });
                todayCount = todayActivity ? (todayActivity.count || 0) : 0;
            }
            
            if (todayActivitiesEl) {
                todayActivitiesEl.textContent = todayCount;
            }

            // Update top users count (if available)
            if (stats.top_users && Array.isArray(stats.top_users)) {
                if (totalUsersEl) {
                    totalUsersEl.textContent = stats.top_users.length;
                }
                
                // Calculate active users (users with activity today)
                let activeCount = 0;
                if (stats.daily_activities && Array.isArray(stats.daily_activities)) {
                    // Count unique users who have activity today
                    const todayActivities = stats.daily_activities.filter(d => {
                        if (!d || !d.date) return false;
                        const dateStr = typeof d.date === 'string' ? d.date : 
                                       (d.date.toISOString ? d.date.toISOString().split('T')[0] : String(d.date));
                        return dateStr === today || dateStr.startsWith(today);
                    });
                    activeCount = todayActivities.length > 0 ? stats.top_users.length : 0;
                }
                
                if (activeUsersEl) {
                    activeUsersEl.textContent = activeCount;
                }
            } else {
                // If no top_users, try to get from stats
                if (totalUsersEl) {
                    totalUsersEl.textContent = stats.total_users || 0;
                }
                if (activeUsersEl) {
                    activeUsersEl.textContent = stats.active_users || 0;
                }
            }
        }

        async function loadActivities(page = 1) {
            try {
                const token = localStorage.getItem('session_token');
                if (!token) {
                    console.error(' No session token');
                    return;
                }

                // Show loading state
                const tbody = document.getElementById('activityTableBody');
                const cardsBody = document.getElementById('activityCardsBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="loading-row">
                                <i class="fas fa-spinner fa-spin"></i> Memuat aktivitas...
                            </td>
                        </tr>
                    `;
                }
                if (cardsBody) {
                    cardsBody.innerHTML = `
                        <div class="activity-card-mobile empty">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Memuat aktivitas...</p>
                        </div>
                    `;
                }

                const params = new URLSearchParams({
                    page: page,
                    per_page: 10
                });

                if (activityFilters.user_id) params.append('user_id', activityFilters.user_id);
                if (activityFilters.activity_type) params.append('activity_type', activityFilters.activity_type);
                if (activityFilters.start_date) params.append('start_date', activityFilters.start_date);
                if (activityFilters.end_date) params.append('end_date', activityFilters.end_date);
                if (activityFilters.search) params.append('search', activityFilters.search);

                console.log(' Fetching activities with params:', params.toString());

                const response = await fetch(`/api/dashboard/user-activities?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log(' Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log(' Activity data received:', data); // Debug log
                    console.log(' Data count:', data.data ? data.data.length : 0);
                    
                    if (data.success) {
                        if (data.data && Array.isArray(data.data) && data.data.length > 0) {
                            console.log(' Displaying', data.data.length, 'activities');
                            displayActivities(data.data);
                            if (data.pagination) {
                                updatePagination(data.pagination);
                            }
                            currentActivityPage = page;
                        } else {
                            console.warn(' No activities in data array');
                            // Show empty state
                            if (tbody) {
                                tbody.innerHTML = `
                                    <tr>
                                        <td colspan="6" class="loading-row">
                                            <i class="fas fa-inbox"></i> Tidak ada aktivitas ditemukan
                                        </td>
                                    </tr>
                                `;
                            }
                            if (cardsBody) {
                                cardsBody.innerHTML = `
                                    <div class="activity-card-mobile empty">
                                        <i class="fas fa-inbox"></i>
                                        <p>Tidak ada aktivitas ditemukan</p>
                                    </div>
                                `;
                            }
                            // Still update pagination if available
                            if (data.pagination) {
                                updatePagination(data.pagination);
                            }
                        }
                    } else {
                        console.error(' API returned success=false:', data);
                        const errorMsg = data.error || 'Unknown error';
                        if (tbody) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="6" class="loading-row">
                                        <i class="fas fa-exclamation-triangle"></i> ${errorMsg}
                                    </td>
                                </tr>
                            `;
                        }
                        if (cardsBody) {
                            cardsBody.innerHTML = `
                                <div class="activity-card-mobile empty">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>${errorMsg}</p>
                                </div>
                            `;
                        }
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error(' Error response:', response.status, errorData);
                    const errorMsg = errorData.error || `HTTP ${response.status}: Unknown error`;
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error(' Error loading activities:', error);
                const tbody = document.getElementById('activityTableBody');
                const cardsBody = document.getElementById('activityCardsBody');
                
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="loading-row">
                                <i class="fas fa-exclamation-triangle"></i> Error: ${error.message}
                            </td>
                        </tr>
                    `;
                }
                if (cardsBody) {
                    cardsBody.innerHTML = `
                        <div class="activity-card-mobile empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        function displayActivities(activities) {
            console.log(' Displaying activities:', activities); // Debug log
            const tbody = document.getElementById('activityTableBody');
            const cardsBody = document.getElementById('activityCardsBody');
            const isMobile = window.innerWidth <= 768;
            
            if (!activities || activities.length === 0) {
                console.warn(' No activities to display');
                const emptyMsg = `
                    <tr>
                        <td colspan="6" class="loading-row">
                            <i class="fas fa-inbox"></i> No activities found
                        </td>
                    </tr>
                `;
                if (tbody) tbody.innerHTML = emptyMsg;
                if (cardsBody) cardsBody.innerHTML = `
                    <div class="activity-card-mobile empty">
                        <i class="fas fa-inbox"></i>
                        <p>No activities found</p>
                    </div>
                `;
                return;
            }

            // Desktop table view
            if (tbody) {
                tbody.innerHTML = activities.map(activity => {
                    // Handle date parsing - support multiple formats
                    let time;
                    try {
                        if (activity.created_at) {
                            time = new Date(activity.created_at);
                            // Check if date is valid
                            if (isNaN(time.getTime())) {
                                // Try parsing as ISO string
                                time = new Date(activity.created_at.replace(' ', 'T'));
                            }
                        } else {
                            time = new Date();
                        }
                    } catch (e) {
                        console.warn('Error parsing date:', activity.created_at, e);
                        time = new Date();
                    }
                    
                    const timeStr = time.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const activityTypeClass = activity.activity_type || 'default';
                    const userRoleClass = activity.role === 'admin' ? 'admin' : 'user';
                    const deviceInfo = activity.user_agent ? 
                        activity.user_agent.substring(0, 50) + (activity.user_agent.length > 50 ? '...' : '') : 
                        'Unknown';

                    return `
                        <tr>
                            <td>
                                <div class="time-cell">
                                    <i class="fas fa-clock"></i>
                                    <span>${timeStr}</span>
                                </div>
                            </td>
                            <td>
                                <span class="user-badge ${userRoleClass}">
                                    <i class="fas fa-user"></i>
                                    ${activity.full_name || activity.username || 'Unknown'}
                                </span>
                            </td>
                            <td>
                                <span class="activity-type-badge ${activityTypeClass}">
                                    ${activityTypeClass.replace('_', ' ')}
                                </span>
                            </td>
                            <td>
                                <div class="description-cell">
                                    ${activity.description || '-'}
                                </div>
                            </td>
                            <td>
                                <span class="ip-address">
                                    <i class="fas fa-network-wired"></i>
                                    ${activity.ip_address || '-'}
                                </span>
                            </td>
                            <td>
                                <span class="device-info" title="${activity.user_agent || ''}">
                                    <i class="fas fa-mobile-alt"></i>
                                    ${deviceInfo}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Mobile card view
            if (cardsBody) {
                cardsBody.innerHTML = activities.map(activity => {
                    // Handle date parsing - support multiple formats
                    let time;
                    try {
                        if (activity.created_at) {
                            time = new Date(activity.created_at);
                            // Check if date is valid
                            if (isNaN(time.getTime())) {
                                // Try parsing as ISO string
                                time = new Date(activity.created_at.replace(' ', 'T'));
                            }
                        } else {
                            time = new Date();
                        }
                    } catch (e) {
                        console.warn('Error parsing date:', activity.created_at, e);
                        time = new Date();
                    }
                    
                    const timeStr = time.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const activityTypeClass = activity.activity_type || 'default';
                    const userRoleClass = activity.role === 'admin' ? 'admin' : 'user';
                    const iconClass = getActivityIconForType(activityTypeClass);
                    
                    return `
                        <div class="activity-card-mobile">
                            <div class="card-header">
                                <div class="card-icon ${iconClass.class}">
                                    <i class="${iconClass.icon}"></i>
                                </div>
                                <div class="card-header-info">
                                    <div class="card-user">
                                        <span class="user-badge ${userRoleClass}">
                                            <i class="fas fa-user"></i>
                                            ${activity.full_name || activity.username || 'Unknown'}
                                        </span>
                                    </div>
                                    <div class="card-time">
                                        <i class="fas fa-clock"></i>
                                        ${timeStr}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="card-type">
                                    <span class="activity-type-badge ${activityTypeClass}">
                                        ${activityTypeClass.replace('_', ' ')}
                                    </span>
                                </div>
                                <div class="card-description">
                                    ${activity.description || '-'}
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="card-meta">
                                    <span class="meta-item">
                                        <i class="fas fa-network-wired"></i>
                                        ${activity.ip_address || '-'}
                                    </span>
                                    <span class="meta-item">
                                        <i class="fas fa-mobile-alt"></i>
                                        Device
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function getActivityIconForType(activityType) {
            const icons = {
                'search': { class: 'search', icon: 'fas fa-search' },
                'profiling_search': { class: 'search', icon: 'fas fa-user-search' },
                'cek_plat': { class: 'search', icon: 'fas fa-car' },
                'login': { class: 'login', icon: 'fas fa-sign-in-alt' },
                'logout': { class: 'logout', icon: 'fas fa-sign-out-alt' },
                'export': { class: 'export', icon: 'fas fa-download' },
                'error': { class: 'error', icon: 'fas fa-exclamation-triangle' },
                'default': { class: 'system', icon: 'fas fa-cog' }
            };
            return icons[activityType] || icons.default;
        }

        function updatePagination(pagination) {
            const paginationEl = document.getElementById('activityPagination');
            if (!pagination || pagination.pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            const page = pagination.page;
            const pages = pagination.pages;
            const total = pagination.total;

            let html = '';

            // Previous button
            html += `<button class="pagination-btn" onclick="loadActivities(${page - 1})" ${page === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>`;

            // Page numbers
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(pages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="loadActivities(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-info">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === page ? 'active' : ''}" onclick="loadActivities(${i})">${i}</button>`;
            }

            if (endPage < pages) {
                if (endPage < pages - 1) {
                    html += `<span class="pagination-info">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="loadActivities(${pages})">${pages}</button>`;
            }

            // Next button
            html += `<button class="pagination-btn" onclick="loadActivities(${page + 1})" ${page === pages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>`;

            // Info
            html += `<span class="pagination-info">
                Showing ${((page - 1) * pagination.per_page) + 1} - ${Math.min(page * pagination.per_page, total)} of ${total}
            </span>`;

            paginationEl.innerHTML = html;

            // Update table info
            document.getElementById('activityTableInfo').textContent = 
                `Total: ${total} activities | Page ${page} of ${pages}`;
        }

        function applyActivityFilters() {
            activityFilters = {
                user_id: document.getElementById('filterUserId').value || null,
                activity_type: document.getElementById('filterActivityType').value || null,
                start_date: document.getElementById('filterStartDate').value || null,
                end_date: document.getElementById('filterEndDate').value || null,
                search: document.getElementById('filterSearch').value.trim() || null
            };
            currentActivityPage = 1;
            loadActivities(1);
        }

        function resetActivityFilters() {
            document.getElementById('filterUserId').value = '';
            document.getElementById('filterActivityType').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterSearch').value = '';
            activityFilters = {
                user_id: null,
                activity_type: null,
                start_date: null,
                end_date: null,
                search: null
            };
            currentActivityPage = 1;
            loadActivities(1);
        }

        function refreshActivityMonitoring() {
            const btn = document.querySelector('.refresh-btn');
            btn.classList.add('loading');
            loadActivityMonitoring().finally(() => {
                setTimeout(() => btn.classList.remove('loading'), 500);
            });
        }

        function showAllActivities() {
            // Scroll to activity monitoring section
            document.querySelector('.activity-monitoring-card').scrollIntoView({ behavior: 'smooth' });
        }

        function exportActivities() {
            alert('Export functionality will be implemented soon');
        }

        // Global functions
        function toggleSidebar() {
            const app = window.dashboardApp;
            if (app.isMobile) {
                app.sidebar.classList.toggle('mobile-open');
                app.sidebarOverlay.classList.toggle('active');
            } else {
                app.isSidebarCollapsed = !app.isSidebarCollapsed;
                app.sidebar.classList.toggle('collapsed');
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const token = localStorage.getItem('session_token');
                    if (token) {
                        await fetch('/api/logout', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ session_token: token })
                        });
                    }
                } catch (error) {
                    console.error('Logout API error:', error);
                } finally {
                    // Always clear local storage and redirect
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_data');
                    sessionStorage.clear();
                    // Use server-side logout to ensure proper session cleanup
                    window.location.href = '/logout';
                }
            }
        }

        // Clear corrupted session data
        function clearSessionData() {
            localStorage.removeItem('session_token');
            localStorage.removeItem('user_data');
            sessionStorage.clear();
        }


        // Global configuration
        let appConfig = {
            baseUrl: window.location.origin,
            apiBase: window.location.origin + '/api'
        };


        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard page loaded, initializing...');
            
            // Hide loading screen immediately
            const authLoading = document.getElementById('authLoading');
            if (authLoading) {
                authLoading.classList.add('hidden');
            }
            
            // Load user data from localStorage
            const userData = localStorage.getItem('user_data');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    const userName = document.getElementById('userName');
                    const userRole = document.getElementById('userRole');
                    if (userName && userRole) {
                        userName.textContent = user.username || 'Admin User';
                        userRole.textContent = user.role || 'Administrator';
                    }
                } catch (e) {
                    console.log('Could not parse user data from localStorage');
                }
            }
            
            // Initialize dashboard app
            window.dashboardApp = new DashboardApp();
        });
    </script>
</body>
</html>
</html>