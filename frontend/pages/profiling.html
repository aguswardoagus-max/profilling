<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profiling - Pencarian Wajah Clearance</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Authentication Loading Screen */
        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .auth-loading.hidden {
            display: none;
        }

        .auth-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .auth-loading-text {
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 50%, #f0f4f8 100%);
            background-attachment: fixed;
            color: #333;
            position: relative;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
        }

        .sidebar-menu {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
            margin-bottom: 8px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: rgba(255,255,255,0.5);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: white;
            border-left-width: 4px;
        }

        .menu-item i {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .nav-submenu {
            margin-left: 20px;
            margin-top: 0;
            margin-bottom: 8px;
        }

        .nav-submenu .menu-item {
            padding: 12px 25px;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .menu-item span {
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .menu-item span {
            opacity: 0;
        }

        .menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 20px 20px;
        }

        .sidebar-footer {
            position: static;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user-details {
            opacity: 1;
            transition: opacity 0.3s ease;
            flex: 1;
            min-width: 0;
        }

        .sidebar.collapsed .user-details {
            opacity: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar.collapsed .logout-btn span {
            opacity: 0;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 70px;
        }

        .topbar {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(20px);
            padding: 20px 30px;
            box-shadow: 
                0 4px 20px rgba(102, 126, 234, 0.08),
                0 0 0 1px rgba(102, 126, 234, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 10;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: #f8f9ff;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            width: 300px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #6b7280;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: #f8f9ff;
            color: #667eea;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Profiling Content */
        .profiling-content {
            padding: 40px;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-suggestions-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ai-suggestions-header h4 {
            color: #667eea;
            font-weight: 600;
            margin: 0;
        }

        .ai-suggestions-header i {
            color: #667eea;
            font-size: 18px;
        }

        .ai-suggestion-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ai-suggestion-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .ai-suggestion-item i {
            color: #667eea;
            font-size: 16px;
        }

        .ai-suggestion-text {
            flex: 1;
            color: #374151;
            font-size: 14px;
        }

        .ai-suggestion-confidence {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* AI Analysis Dashboard */
        .ai-dashboard {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .ai-dashboard.active {
            display: block;
        }

        .ai-dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .ai-dashboard-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-weight: 600;
            font-size: 18px;
        }

        .ai-dashboard-title i {
            font-size: 20px;
        }

        .ai-dashboard-refresh {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-dashboard-refresh:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .ai-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .ai-analysis-card {
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .ai-analysis-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .ai-analysis-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .ai-analysis-card-header i {
            color: #667eea;
            font-size: 16px;
        }

        .ai-analysis-card-title {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .ai-analysis-card-content {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
        }

        .ai-confidence-score {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            margin-top: 8px;
        }

        /* AI Insights Modal */
        .ai-insights-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }

        .ai-insights-modal-content {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            margin: 3% auto;
            padding: 0;
            border: none;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-80px) scale(0.8) rotateX(20deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
            }
        }

        .ai-insights-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
            overflow: hidden;
        }

        .ai-insights-modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(180deg); }
        }

        .ai-insights-modal-header h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .ai-insights-modal-header .icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .ai-insights-modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(90vh - 200px);
        }

        .ai-insights-modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .ai-insights-modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .ai-insights-modal-body::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .ai-insights-modal-body::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .ai-insight-section {
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ai-insight-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ai-insight-section-header i {
            color: #667eea;
            font-size: 18px;
        }

        .ai-insight-section-title {
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }

        .ai-insight-content {
            color: #6b7280;
            line-height: 1.6;
            font-size: 14px;
        }

        .ai-insight-confidence {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 10px;
        }

        .ai-insights-modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .ai-insights-modal-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-insights-modal-close:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .ai-insights-modal-export {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-insights-modal-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AI Face Upload Section */
        .ai-face-upload-section {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: block;
            animation: slideDown 0.3s ease;
        }

        .ai-face-upload-section.active {
            display: block;
        }

        .ai-upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
        }

        .ai-upload-area:hover {
            border-color: #5a6fd8;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0ecff 100%);
            transform: translateY(-2px);
        }

        .ai-upload-area i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
        }

        .ai-upload-area p {
            color: #374151;
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .ai-upload-area input[type="file"] {
            display: none;
        }

        /* AI Results Panel */
        .ai-results-panel {
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .ai-results-panel.active {
            display: block;
        }

        .ai-results-panel h4 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-results-panel h4 i {
            font-size: 18px;
        }

        .ai-results-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-result-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-result-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .ai-result-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .ai-result-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e1e5e9;
        }

        .ai-result-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            border: 2px solid #e1e5e9;
        }

        .ai-result-info {
            flex: 1;
        }

        .source-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .ai-result-info h5 {
            color: #374151;
            font-weight: 600;
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        .ai-result-info p {
            color: #6b7280;
            margin: 0;
            font-size: 12px;
        }

        .confidence-score {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            min-width: 50px;
            text-align: center;
        }

        .confidence-score.high {
            background: #10b981;
        }

        .confidence-score.medium {
            background: #f59e0b;
        }

        .confidence-score.low {
            background: #ef4444;
        }

        /* Hybrid Input Form */
        .hybrid-input-form {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group input.ai-filled {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .ai-fill-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .ai-fill-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-fill-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* AI Control Panel */
        .ai-control-panel {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .ai-control-panel.active {
            display: block;
        }

        .ai-control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .ai-control-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
        }

        .ai-control-title i {
            font-size: 16px;
        }

        .ai-control-settings {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-threshold-setting {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .ai-threshold-setting input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
        }

        .ai-status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .ai-status-indicator.active {
            color: #10b981;
        }

        .ai-status-indicator.inactive {
            color: #6b7280;
        }

        .ai-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .page-header {
            margin-bottom: 40px;
            position: relative;
            padding: 35px 40px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 20px 60px rgba(102, 126, 234, 0.1),
                0 0 0 1px rgba(102, 126, 234, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            animation: slideInDown 0.6s ease-out;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            animation: shimmerHeader 3s linear infinite;
        }

        @keyframes shimmerHeader {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            50% {
                transform: translate(-20px, -20px) scale(1.1);
            }
        }

        .page-header-content {
            position: relative;
            z-index: 2;
        }

        .page-header h2 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
            line-height: 1.2;
            position: relative;
        }

        .page-header h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
            animation: expandLine 0.8s ease-out 0.3s both;
        }

        @keyframes expandLine {
            from {
                width: 0;
                opacity: 0;
            }
            to {
                width: 60px;
                opacity: 1;
            }
        }

        .page-header p {
            color: #6b7280;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-top: 15px;
            font-weight: 400;
        }

        .page-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6b7280;
            border: 1px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .mobile-menu-btn {
            display: none;
        }

        /* Chatbot Container */
        .chatbot-container {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 25px 70px rgba(102, 126, 234, 0.18),
                0 0 0 1px rgba(102, 126, 234, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            margin-bottom: 30px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(102, 126, 234, 0.15);
            position: relative;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .chatbot-container:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 30px 80px rgba(102, 126, 234, 0.25),
                0 0 0 1px rgba(102, 126, 234, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .chatbot-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .chatbot-container.collapsed .chatbot-body {
            display: none;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .chatbot-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chatbot-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a3f8f 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .chatbot-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chatbot-avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.2) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            position: relative;
            z-index: 1;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.2),
                0 0 0 3px rgba(255,255,255,0.3),
                inset 0 2px 10px rgba(255,255,255,0.3);
            animation: pulseAvatar 2.5s ease-in-out infinite;
            border: 2px solid rgba(255,255,255,0.4);
        }

        .chatbot-avatar::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #667eea);
            background-size: 300% 300%;
            animation: rotateGradient 3s linear infinite;
            z-index: -1;
            opacity: 0.6;
        }

        @keyframes pulseAvatar {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                box-shadow: 
                    0 10px 30px rgba(0,0,0,0.2),
                    0 0 0 3px rgba(255,255,255,0.3),
                    inset 0 2px 10px rgba(255,255,255,0.3);
            }
            50% {
                transform: scale(1.08) rotate(5deg);
                box-shadow: 
                    0 15px 40px rgba(0,0,0,0.3),
                    0 0 0 4px rgba(255,255,255,0.5),
                    inset 0 2px 10px rgba(255,255,255,0.4);
            }
        }

        @keyframes rotateGradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .chatbot-info h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(255,255,255,0.3);
            letter-spacing: -0.5px;
        }

        .chatbot-info p {
            margin: 6px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.95;
            color: rgba(255,255,255,0.95);
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .chatbot-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chatbot-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .chatbot-container.collapsed .chatbot-toggle i {
            transform: rotate(180deg);
        }

        .chatbot-body {
            padding: 28px 28px 50px 28px;
            min-height: 500px;
            max-height: 800px;
            display: flex;
            flex-direction: column;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 2;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 10px;
            min-height: 350px;
            max-height: 600px;
        }

        .chatbot-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chatbot-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .chatbot-messages::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .chatbot-message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: messageSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chatbot-message.user-message {
            animation: messageSlideInRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes messageSlideInRight {
            from {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .chatbot-message.user-message {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bot-message .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-message .message-avatar {
            background: #e1e5e9;
            color: #667eea;
        }

        .message-content {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            padding: 18px 22px;
            border-radius: 20px;
            max-width: 75%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08), 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }

        .message-content:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12), 0 2px 5px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3), 0 2px 5px rgba(102, 126, 234, 0.2);
        }

        .user-message .message-content:hover {
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4), 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .message-content p {
            margin: 0;
            line-height: 1.5;
            font-size: 14px;
        }

        .message-content p + p {
            margin-top: 8px;
        }

        .message-hint {
            font-size: 12px !important;
            opacity: 0.8;
            font-style: italic;
        }

        .message-parsed {
            background: #e8f5e9;
            border-left: 3px solid #10b981;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            font-size: 12px;
        }

        .message-parsed strong {
            color: #10b981;
        }

        .chatbot-input-container {
            border-top: 2px solid #e1e5e9;
            padding-top: 15px;
            position: relative;
        }

        .chatbot-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 15px;
            position: relative;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 16px;
            padding: 12px;
            transition: all 0.3s ease;
        }

        .chatbot-input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .chatbot-input-top {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .chatbot-input-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        /* Typing Indicator Styles (Gemini-like) */
        .typing-indicator-content {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px !important;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%) !important;
            position: relative;
            overflow: hidden;
        }

        .typing-indicator-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .typing-dots {
            display: flex;
            gap: 6px;
            align-items: center;
            position: relative;
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: typingDotGemini 1.6s infinite ease-in-out;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            position: relative;
        }

        .typing-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.8;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDotGemini {
            0%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.5;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            }
            50% {
                transform: translateY(-12px) scale(1.2);
                opacity: 1;
                box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);
            }
        }

        .typing-text {
            margin: 0;
            color: #6b7280;
            font-size: 13px;
            font-style: italic;
            position: relative;
            animation: pulseText 2s ease-in-out infinite;
        }

        @keyframes pulseText {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }

        /* Gemini-style thinking animation */
        .gemini-thinking {
            position: relative;
            padding: 16px 20px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.08), 0 0 0 1px rgba(102, 126, 234, 0.05);
        }

        .gemini-thinking::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(102, 126, 234, 0.1) 50%, 
                transparent 100%);
            animation: thinkingShimmer 2.5s infinite;
            z-index: 1;
        }

        .gemini-thinking::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.05) 0%, transparent 70%);
            animation: thinkingGlow 3s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes thinkingShimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        @keyframes thinkingGlow {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translate(20px, 20px) scale(1.1);
                opacity: 0.6;
            }
        }

        /* Make sure typing content is above shimmer effects */
        .typing-indicator-content > * {
            position: relative;
            z-index: 2;
        }

        /* Streaming Text Effect (Gemini-like) */
        .streaming-text {
            margin: 0;
            min-height: 20px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .streaming-text::after {
            content: 'â–Š';
            animation: blinkCursor 1s infinite;
            color: #667eea;
            margin-left: 2px;
            font-weight: bold;
        }

        .streaming-text.streaming-complete::after {
            display: none;
        }

        @keyframes blinkCursor {
            0%, 50% {
                opacity: 1;
            }
            51%, 100% {
                opacity: 0;
            }
        }

        .message-content.streaming {
            position: relative;
        }

        .message-content.streaming::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(102, 126, 234, 0.02) 50%, 
                transparent 100%);
            pointer-events: none;
            animation: streamingGlow 2s ease-in-out infinite;
        }

        @keyframes streamingGlow {
            0%, 100% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
        }

        /* Upload Button */
        .chatbot-upload-btn {
            width: 50px;
            height: 50px;
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #e1e5e9;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            position: relative;
        }

        .chatbot-upload-btn:hover {
            background: #10b981;
            color: white;
            border-color: #10b981;
            transform: scale(1.05);
        }

        .chatbot-upload-btn.uploading {
            background: #f59e0b;
            color: white;
            border-color: #f59e0b;
            animation: pulseUploading 1.5s ease-in-out infinite;
        }

        @keyframes pulseUploading {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }
        }

        .chatbot-upload-btn i {
            font-size: 20px;
        }

        /* Extracted Data List */
        .extracted-data-list {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(145deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 15px;
            border: 2px solid #0ea5e9;
            max-height: 300px;
            overflow-y: auto;
        }

        .extracted-data-list h4 {
            margin: 0 0 12px 0;
            color: #0369a1;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .extracted-data-item {
            background: white;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 2px solid #e0f2fe;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .extracted-data-item:hover {
            border-color: #0ea5e9;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }

        .extracted-data-item:last-child {
            margin-bottom: 0;
        }

        .extracted-data-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .extracted-data-item-title {
            font-weight: 600;
            color: #0369a1;
            font-size: 13px;
        }

        .extracted-data-item-select {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .extracted-data-item-select:hover {
            background: #0284c7;
            transform: scale(1.05);
        }

        .extracted-data-item-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            font-size: 12px;
        }

        .extracted-data-field {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .extracted-data-field i {
            color: #0ea5e9;
            font-size: 11px;
        }

        .extracted-data-field-value {
            color: #1e293b;
            font-weight: 500;
        }

        .extracted-data-field-value:empty::before {
            content: '-';
            color: #94a3b8;
            font-weight: normal;
        }

        /* Voice Input Button */
        .chatbot-voice-btn {
            width: 40px;
            height: 40px;
            background: #f8f9fa;
            color: #667eea;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            position: relative;
        }

        .chatbot-voice-btn:hover {
            background: #e8f0ff;
            color: #667eea;
            transform: scale(1.05);
        }

        .chatbot-voice-btn.recording {
            background: #ef4444;
            color: white;
            animation: pulseRecording 1.5s ease-in-out infinite;
        }

        @keyframes pulseRecording {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        .chatbot-voice-btn i {
            font-size: 18px;
        }

        .chatbot-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            min-width: 0;
            background: transparent;
        }

        .chatbot-input::placeholder {
            color: #9ca3af;
            opacity: 0.7;
        }

        .chatbot-input:focus {
            outline: none;
        }

        /* Smart Query Suggestions Dropdown */
        .query-suggestions-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 10px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease;
            border: 1px solid #e1e5e9;
        }

        .query-suggestions-dropdown.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .suggestions-header {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
            border-radius: 16px 16px 0 0;
        }

        .suggestions-header i {
            color: #667eea;
            font-size: 14px;
        }

        .suggestions-header span {
            font-size: 13px;
            font-weight: 600;
            color: #4b5563;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f9fafb;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
            border-left: 3px solid #667eea;
        }

        .suggestion-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .suggestion-item-icon.complete {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .suggestion-item-icon.typo_fix {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .suggestion-item-icon.combination {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .suggestion-item-icon.alternative {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .suggestion-item-content {
            flex: 1;
            min-width: 0;
        }

        .suggestion-item-query {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .suggestion-item-description {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        .suggestion-item-confidence {
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
            padding: 2px 8px;
            background: #f3f4f6;
            border-radius: 12px;
            flex-shrink: 0;
        }

        .typo-corrections {
            padding: 12px 16px;
            background: #fef3c7;
            border-bottom: 1px solid #fde68a;
            border-top: 1px solid #fde68a;
        }

        .typo-corrections-header {
            font-size: 12px;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .typo-correction-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: white;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 8px;
            margin-bottom: 6px;
            border: 1px solid #fde68a;
        }

        .typo-original {
            color: #dc2626;
            text-decoration: line-through;
        }

        .typo-arrow {
            color: #9ca3af;
        }

        .typo-corrected {
            color: #059669;
            font-weight: 600;
        }

        .quick-actions {
            padding: 12px 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        .quick-actions-header {
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .quick-action-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .quick-action-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .quick-action-btn i {
            font-size: 14px;
        }

        .suggestions-loading {
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 13px;
        }

        .suggestions-loading i {
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .no-suggestions {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
        }

        .chatbot-send-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .chatbot-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .chatbot-send-btn:active {
            transform: scale(0.95);
        }

        .chatbot-send-btn i {
            font-size: 16px;
            position: relative;
            z-index: 1;
        }

        .chatbot-suggestions {
            display: none; /* Hidden - suggestion chips hidden but not removed */
            gap: 10px;
            flex-wrap: wrap;
        }

        .suggestion-chip {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #374151;
        }

        .suggestion-chip:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        /* Auto Dropdown */
        .auto-dropdown-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .auto-dropdown-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 500;
            color: #4b5563;
        }

        .auto-dropdown-btn:hover {
            background: #e8f0ff;
            border-color: #667eea;
            color: #667eea;
        }

        .auto-dropdown-btn i {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .auto-dropdown-wrapper.active .auto-dropdown-btn i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .auto-dropdown-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            overflow: hidden;
        }

        .auto-dropdown-wrapper.active .auto-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .auto-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #4b5563;
        }

        .auto-dropdown-item:hover {
            background: #f8f9ff;
            color: #667eea;
        }

        .auto-dropdown-item i {
            font-size: 14px;
            width: 18px;
            text-align: center;
        }

        .chatbot-input-right-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Responsive Chatbot - Tablet */
        @media (max-width: 1024px) and (min-width: 769px) {
            .chatbot-container {
                margin-left: 0;
                margin-right: 0;
            }

            .chatbot-header {
                padding: 20px 25px;
            }

            .chatbot-avatar {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .chatbot-info h3 {
                font-size: 1.1rem;
            }

            .chatbot-info p {
                font-size: 0.8rem;
            }

            .message-content {
                max-width: 70%;
                padding: 16px 20px;
            }

            .chatbot-messages {
                max-height: 350px;
            }
        }

        /* Responsive Chatbot - Mobile */
        @media (max-width: 768px) {
            .profiling-content {
                padding: 20px 15px;
            }

            .page-header {
                padding: 25px 20px;
                margin-bottom: 25px;
                border-radius: 20px;
            }

            .page-header h2 {
                font-size: 1.8rem;
            }

            .page-header p {
                font-size: 0.95rem;
                margin-top: 10px;
            }

            .page-header::after {
                width: 200px;
                height: 200px;
            }

            .chatbot-container {
                border-radius: 20px;
                margin-left: 0;
                margin-right: 0;
                margin-bottom: 20px;
            }

            .chatbot-header {
                padding: 15px 18px;
            }

            .chatbot-header-left {
                gap: 12px;
            }

            .chatbot-avatar {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .chatbot-info h3 {
                font-size: 1rem;
            }

            .chatbot-info p {
                font-size: 0.75rem;
            }

            .chatbot-toggle {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .chatbot-body {
                padding: 15px 18px 40px 18px;
                min-height: 550px;
                max-height: 700px;
                display: flex;
                flex-direction: column;
            }

            .chatbot-messages {
                min-height: 300px;
                max-height: 500px;
                margin-bottom: 25px;
                flex: 1;
            }

            .chatbot-message {
                gap: 10px;
                margin-bottom: 15px;
            }

            .message-avatar {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .message-content {
                max-width: 85%;
                padding: 14px 16px;
                font-size: 13px;
            }

            .message-content p {
                font-size: 13px;
                line-height: 1.4;
            }

            .typing-indicator-content {
                padding: 12px 16px !important;
            }

            .typing-dot {
                width: 8px;
                height: 8px;
            }

            .typing-text {
                font-size: 12px;
            }

            .chatbot-input-container {
                margin-top: 30px;
                padding-top: 25px;
            }

            .chatbot-input-wrapper {
                gap: 8px;
                margin-bottom: 18px;
            }

            .chatbot-input {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 12px 16px;
            }

            .chatbot-input::placeholder {
                font-size: 14px;
            }

            .chatbot-upload-btn,
            .chatbot-voice-btn {
                width: 45px;
                height: 45px;
            }

            .chatbot-upload-btn i,
            .chatbot-voice-btn i {
                font-size: 18px;
            }

            .chatbot-send-btn {
                width: 45px;
                height: 45px;
            }

            .chatbot-send-btn i {
                font-size: 16px;
            }

            .chatbot-suggestions {
                gap: 10px;
                margin-top: 15px;
            }

            .suggestion-chip {
                padding: 10px 16px;
                font-size: 12px;
            }

            .message-parsed {
                font-size: 11px;
                padding: 8px;
            }
        }

        /* Responsive Chatbot - Small Mobile */
        @media (max-width: 480px) {
            .profiling-content {
                padding: 15px 10px;
            }

            .page-header {
                padding: 20px 15px;
                margin-bottom: 20px;
                border-radius: 16px;
            }

            .page-header h2 {
                font-size: 1.5rem;
            }

            .page-header p {
                font-size: 0.85rem;
                margin-top: 8px;
            }

            .page-header::after {
                width: 150px;
                height: 150px;
            }

            .chatbot-container {
                margin-left: 0;
                margin-right: 0;
                border-radius: 16px;
            }

            .chatbot-header {
                padding: 12px 15px;
            }

            .chatbot-avatar {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .chatbot-info h3 {
                font-size: 0.9rem;
            }

            .chatbot-info p {
                font-size: 0.7rem;
            }

            .chatbot-body {
                padding: 12px 15px 40px 15px;
                min-height: 500px;
                max-height: 650px;
                display: flex;
                flex-direction: column;
            }

            .chatbot-messages {
                min-height: 280px;
                max-height: 450px;
                margin-bottom: 30px;
                flex: 1;
            }

            .chatbot-input-container {
                margin-top: 35px;
                padding-top: 30px;
            }

            .chatbot-input-wrapper {
                margin-bottom: 20px;
                gap: 6px;
            }

            .chatbot-input {
                padding: 10px 14px;
                font-size: 16px;
            }

            .chatbot-input::placeholder {
                font-size: 13px;
            }

            .chatbot-upload-btn,
            .chatbot-voice-btn,
            .chatbot-send-btn {
                width: 40px;
                height: 40px;
            }

            .chatbot-upload-btn i,
            .chatbot-voice-btn i,
            .chatbot-send-btn i {
                font-size: 14px;
            }

            .chatbot-suggestions {
                gap: 8px;
                margin-top: 20px;
            }

            .suggestion-chip {
                padding: 9px 14px;
                font-size: 11px;
            }

            .streaming-text {
                font-size: 12px;
            }
        }

        /* Responsive Chatbot - Extra Small Mobile */
        @media (max-width: 360px) {
            .chatbot-header {
                padding: 10px 12px;
            }

            .chatbot-avatar {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .chatbot-info h3 {
                font-size: 0.85rem;
            }

            .chatbot-info p {
                display: none; /* Hide subtitle on very small screens */
            }

            .chatbot-body {
                padding: 10px 12px;
            }

            .chatbot-messages {
                max-height: 200px;
            }

            .message-content {
                max-width: 95%;
                padding: 10px 12px;
                font-size: 11px;
            }

            .chatbot-input {
                padding: 8px 12px;
                font-size: 16px; /* Prevent zoom on iOS */
            }

            .chatbot-input::placeholder {
                font-size: 12px;
            }

            .chatbot-voice-btn,
            .chatbot-send-btn {
                width: 36px;
                height: 36px;
            }

            /* Smart Query Suggestions Mobile */
            .query-suggestions-dropdown {
                max-height: 300px;
                border-radius: 12px;
            }

            .suggestion-item {
                padding: 10px 12px;
                gap: 10px;
            }

            .suggestion-item-icon {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .suggestion-item-query {
                font-size: 13px;
            }

            .suggestion-item-description {
                font-size: 11px;
            }

            .quick-actions-grid {
                grid-template-columns: 1fr;
            }

            .quick-action-btn {
                padding: 10px;
                font-size: 11px;
            }
        }

        /* Responsive Chatbot - Landscape Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .chatbot-body {
                max-height: 300px;
            }

            .chatbot-messages {
                max-height: 200px;
                min-height: 100px;
            }

            .chatbot-header {
                padding: 12px 18px;
            }

            .chatbot-avatar {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }

        /* Touch-friendly improvements for mobile */
        @media (max-width: 768px) {
            .chatbot-voice-btn,
            .chatbot-send-btn {
                min-width: 44px; /* Minimum touch target size */
                min-height: 44px;
            }

            .suggestion-chip {
                min-height: 36px; /* Touch-friendly */
                padding: 8px 14px;
            }

            .chatbot-toggle {
                min-width: 44px;
                min-height: 44px;
            }

            /* Improve scrolling on mobile */
            .chatbot-messages {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }

            /* Better text selection on mobile */
            .message-content {
                -webkit-user-select: text;
                user-select: text;
            }

            /* Ensure input doesn't overflow */
            .chatbot-input-wrapper {
                flex-wrap: nowrap;
            }

            .chatbot-input {
                min-width: 0;
                flex: 1 1 auto;
            }

            /* Make sure buttons don't shrink */
            .chatbot-upload-btn,
            .chatbot-voice-btn,
            .chatbot-send-btn {
                flex-shrink: 0;
            }

            /* Extracted data list responsive */
            .extracted-data-list {
                max-height: 250px;
            }

            .extracted-data-item-fields {
                grid-template-columns: 1fr;
            }
        }

        /* Responsive Chatbot - Large Desktop */
        @media (min-width: 1400px) {
            .chatbot-container {
                max-width: 1200px;
                margin: 0 auto 25px auto;
            }

            .chatbot-messages {
                max-height: 500px;
            }
        }

        /* Responsive Chatbot - Medium Desktop */
        @media (min-width: 1025px) and (max-width: 1399px) {
            .chatbot-messages {
                max-height: 450px;
            }
        }

        /* Search Type Selector */
        .search-type-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .search-type-selector h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .search-type-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .search-tab {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .search-tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .search-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-tab i {
            font-size: 1.5rem;
        }

        .search-tab span {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Search Forms */
        .search-form {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .search-form.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styling */
        .form-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Face Upload Section */
        .face-upload-section {
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f0ff;
            transform: scale(1.02);
        }

        .upload-content i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-content h4 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .upload-content p {
            color: #6b7280;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .face-preview {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            border: 1px solid #e1e5e9;
        }

        .face-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        /* Threshold Slider */
        .threshold-slider {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .threshold-slider input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e1e5e9;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .threshold-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .threshold-slider input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        #thresholdValue {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        /* Search Buttons */
        .search-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        /* Results Section */
        .results-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            display: none;
        }

        .results-header {
            padding: 25px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a202c;
        }

        .results-count {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .results-content {
            padding: 25px;
            max-height: calc(100vh - 250px);
            overflow-y: scroll !important; /* Force scrollbar to always show */
            overflow-x: hidden;
            min-height: 200px; /* Ensure minimum height for scrollbar visibility */
        }

        /* Enhanced Scrollbar for Results Content - Desktop */
        .results-content::-webkit-scrollbar {
            width: 12px;
            -webkit-appearance: none;
            appearance: none;
        }

        .results-content::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            margin: 10px 0;
            -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }

        .results-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid #f8f9fa;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            min-height: 50px; /* Ensure thumb is visible */
        }

        .results-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.5);
            transform: scale(1.05);
        }

        /* Firefox Scrollbar */
        .results-content {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        /* Force scrollbar visibility when content overflows */
        .results-content:not(:empty) {
            overflow-y: scroll !important;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: #f8f9ff;
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #667eea;
            transition: all 0.3s ease;
            position: relative;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .result-card:first-child {
            position: relative;
        }

        .data-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .result-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .result-info h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 3px;
        }

        .result-info p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.75rem;
        }

        .info-value {
            color: #1a202c;
            font-size: 0.85rem;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Scrollbar Styles */
        * {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        *::-webkit-scrollbar-track {
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }

        *::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid #f8f9fa;
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.5);
            transform: scale(1.1);
        }

        *::-webkit-scrollbar-corner {
            background: #f8f9fa;
        }

        /* Video Embed Container - Responsive */
        .video-embed-container {
            position: relative;
            width: 120px; /* Square size like 4x6 photo but square (120x120px) */
            height: 120px;
            overflow: hidden;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            background: #000;
            margin-bottom: 12px;
            margin-right: 12px;
            float: left;
            flex-shrink: 0;
            cursor: pointer;
        }

        .video-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            pointer-events: none; /* Disable interaction on thumbnail */
        }

        /* Video thumbnail overlay - click to play */
        .video-embed-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
        }

        .video-embed-container::before {
            content: 'â–¶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-45%, -50%);
            color: white;
            font-size: 24px;
            z-index: 11;
            pointer-events: none;
        }

        /* Result Item - Enhanced Responsive */
        .result-item {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .result-item .result-header {
            flex-wrap: wrap;
            gap: 8px;
        }

        .result-item .result-title a {
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .result-item .result-snippet {
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .result-item .result-thumbnail {
            width: 120px; /* Square size like 4x6 photo but square (120x120px) */
            height: 120px;
            flex-shrink: 0;
            margin-right: 12px;
            float: left;
            position: relative;
            overflow: hidden;
        }

        .result-item .result-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .result-item .result-meta {
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Optimized Image Loading - All result images */
        .result-item img,
        .result-thumbnail img,
        .social-item img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: optimize-quality;
        }

        /* Add transition for smooth image loading */
        .result-item img,
        .result-thumbnail img {
            transition: opacity 0.3s ease;
        }

        /* Placeholder while image loads */
        .result-thumbnail {
            position: relative;
            background: #f3f4f6;
        }

        /* Clear float after thumbnail */
        .result-item::after {
            content: "";
            display: table;
            clear: both;
        }

        .result-thumbnail img {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .result-thumbnail img[src] {
            opacity: 1;
        }

        /* Tablet Responsive */
        @media (max-width: 1024px) and (min-width: 769px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .result-item {
                padding: 14px !important;
            }

            .result-item .result-title a {
                font-size: 1.05rem !important;
            }

            .video-embed-container {
                width: 100px !important;
                height: 100px !important;
                margin-right: 10px !important;
                float: left !important;
            }

            .result-item .result-thumbnail {
                width: 100px !important;
                height: 100px !important;
                margin-right: 10px !important;
            }
        }

        /* Small Mobile Responsive */
        @media (max-width: 480px) {
            .result-item {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }

            .result-item .result-title a {
                font-size: 0.95rem !important;
            }

            .result-item .result-snippet {
                font-size: 0.85rem !important;
                padding: 8px !important;
            }

            .video-embed-container {
                width: 60px !important;
                height: 60px !important;
                margin-right: 6px !important;
                margin-bottom: 0 !important;
                float: left !important;
            }

            .video-embed-container::after {
                width: 25px !important;
                height: 25px !important;
            }

            .video-embed-container::before {
                font-size: 14px !important;
            }

            .result-item .result-thumbnail {
                width: 60px !important;
                height: 60px !important;
                margin-right: 6px !important;
            }

            .results-content {
                padding: 12px 15px !important;
                max-height: calc(100vh - 180px) !important;
                overflow-y: scroll !important; /* Force scrollbar */
                min-height: 120px !important;
            }

            /* Small Mobile Scrollbar */
            .results-content::-webkit-scrollbar {
                width: 6px !important;
            }

            .results-content::-webkit-scrollbar-thumb {
                min-height: 30px !important;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .topbar {
                padding: 15px 20px;
            }

            .page-title {
                font-size: 1.4rem;
            }

            .profiling-content {
                padding: 15px;
                min-height: 100vh;
            }
            
            .page-description {
                font-size: 0.95rem;
                line-height: 1.6;
                margin-bottom: 25px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .page-actions {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }
            
            .page-actions .btn {
                width: 100%;
                font-size: 0.9rem;
                padding: 12px 20px;
                justify-content: center;
            }

            .search-type-selector {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .search-type-selector h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .search-type-tabs {
                flex-direction: row;
                justify-content: space-between;
                gap: 6px;
            }

            .search-tab {
                flex: 1;
                min-width: 0;
                padding: 12px 8px;
                font-size: 0.8rem;
            }

            .search-tab i {
                font-size: 1.2rem;
            }

            .search-tab span {
                font-size: 0.75rem;
            }

            .form-container {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 0.95rem;
                margin-bottom: 10px;
                font-weight: 600;
            }
            
            .form-group input,
            .form-group select {
                padding: 14px 16px;
                font-size: 0.95rem;
                border-radius: 8px;
                border: 2px solid #e1e5e9;
            }
            
            .form-group input:focus,
            .form-group select:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .search-buttons {
                flex-direction: column;
                gap: 15px;
                margin-top: 20px;
            }
            
            .search-buttons .btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 0.95rem;
                font-weight: 600;
                border-radius: 10px;
            }
            
            .search-buttons .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
            }
            
            .search-buttons .btn-secondary {
                background: #f8f9fa;
                border: 2px solid #e1e5e9;
                color: #6b7280;
            }
            
            .threshold-slider {
                flex-direction: column;
                gap: 15px;
                margin-top: 20px;
            }
            
            .threshold-slider label {
                font-size: 0.9rem;
                font-weight: 600;
            }
            
            .threshold-slider input[type="range"] {
                width: 100%;
                height: 8px;
                border-radius: 4px;
                background: #e1e5e9;
                outline: none;
            }
            
            .threshold-slider input[type="range"]::-webkit-slider-thumb {
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #667eea;
                cursor: pointer;
            }
            
            .threshold-value {
                font-size: 0.9rem;
                font-weight: 600;
                color: #667eea;
                text-align: center;
                padding: 8px 12px;
                background: #f0f4ff;
                border-radius: 6px;
            }
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .pdf-btn {
            background: #dc2626;
        }

        .pdf-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .word-btn {
            background: #2563eb;
        }

        .word-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .ai-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .copy-btn {
            background: #059669;
        }

        .copy-btn:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-section h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 10px;
        }

        .detail-section h3 i {
            color: #667eea;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .detail-item .label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .detail-item .value {
            color: #1a202c;
            font-size: 1rem;
        }

        .phone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .phone-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .phone-number {
            font-weight: 600;
            color: #1a202c;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .phone-operator {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .phone-date {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .family-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .family-name {
            font-weight: 600;
            color: #1a202c;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .family-relationship {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .family-nik {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .topbar {
                padding: 15px 20px;
            }
            
            .topbar-left h1 {
                font-size: 1.2rem;
            }
            
            .search-box {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: #374151;
                cursor: pointer;
                margin-right: 15px;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .results-section {
                padding: 20px;
                margin-left: -30px;
                margin-right: -30px;
                border-radius: 0;
            }
            
            .results-header {
                margin-bottom: 20px;
                padding: 15px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .results-title {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }
            
            .results-count {
                font-size: 0.85rem;
                padding: 4px 10px;
            }
            
            .results-content {
                padding: 15px 20px;
                max-height: calc(100vh - 200px);
                overflow-y: scroll !important; /* Force scrollbar to always show */
                overflow-x: hidden;
                min-height: 150px; /* Ensure minimum height */
            }

            /* Enhanced Scrollbar for Results Content - Mobile */
            .results-content::-webkit-scrollbar {
                width: 8px;
                -webkit-appearance: none;
                appearance: none;
            }

            .results-content::-webkit-scrollbar-track {
                background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
                border-radius: 10px;
                box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
                -webkit-box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
            }

            .results-content::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
                border: 1px solid #f8f9fa;
                box-shadow: 0 1px 3px rgba(102, 126, 234, 0.3);
                min-height: 40px; /* Ensure thumb is visible */
            }

            .results-content::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #5a6fd8 0%, #6a4190 100%);
                box-shadow: 0 2px 5px rgba(102, 126, 234, 0.5);
            }

            /* Firefox Scrollbar Mobile */
            .results-content {
                scrollbar-width: thin;
                scrollbar-color: #667eea #f1f1f1;
            }

            /* Force scrollbar visibility on mobile */
            .results-content:not(:empty) {
                overflow-y: scroll !important;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .result-card {
                padding: 15px;
                border-radius: 12px;
            }

            /* Result Item Mobile Responsive */
            .result-item {
                padding: 12px !important;
                margin-bottom: 12px !important;
                border-radius: 10px !important;
                overflow: hidden; /* Clear float */
            }

            .result-item .result-header {
                flex-direction: row;
                align-items: flex-start !important;
                gap: 8px !important;
                flex-wrap: wrap;
                margin-bottom: 10px !important;
            }

            .result-item .result-header > div {
                flex: 1;
                min-width: 0;
            }

            .result-item .result-title {
                margin-bottom: 8px !important;
                clear: both; /* Clear float from thumbnail */
            }

            .result-item .result-title a {
                font-size: 0.95rem !important;
                flex-direction: row;
                align-items: flex-start !important;
                gap: 6px !important;
            }

            .result-item .result-title a i {
                margin-top: 3px !important;
                flex-shrink: 0;
            }

            .result-item .result-snippet {
                font-size: 0.85rem !important;
                padding: 8px !important;
                line-height: 1.5 !important;
                clear: both; /* Clear float from thumbnail */
                margin-top: 8px !important;
            }

            .result-item .result-thumbnail {
                width: 80px !important;
                height: 80px !important;
                margin-right: 8px !important;
                margin-bottom: 0 !important;
                float: left !important;
            }

            .result-item .result-thumbnail img {
                border-radius: 6px !important;
            }

            /* Video Embed Mobile Responsive */
            .video-embed-container {
                width: 80px !important;
                height: 80px !important;
                margin-right: 8px !important;
                margin-bottom: 0 !important;
                float: left !important;
            }

            .video-embed-container::after {
                width: 35px !important;
                height: 35px !important;
            }

            .video-embed-container::before {
                font-size: 18px !important;
            }

            .result-item .result-meta {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 6px !important;
                padding-top: 10px !important;
                clear: both; /* Clear float from thumbnail/video */
                margin-top: 8px !important;
            }

            .result-item .result-meta > * {
                font-size: 0.75rem !important;
            }

            /* Content Type Tags Mobile */
            .result-item .content-type-tag {
                font-size: 0.7rem !important;
                padding: 3px 8px !important;
            }

            /* Badges Mobile */
            .result-item .result-header span {
                font-size: 0.65rem !important;
                padding: 2px 6px !important;
            }

            /* Result Position Mobile */
            .result-item .result-position {
                font-size: 0.7rem !important;
                padding: 3px 6px !important;
            }
            
            .result-header {
                gap: 12px;
                margin-bottom: 12px;
            }
            
            .result-avatar {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .result-info h3 {
                font-size: 0.95rem;
            }
            
            .result-info p {
                font-size: 0.85rem;
            }
            
            .info-grid {
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .info-label {
                font-size: 0.8rem;
            }
            
            .info-value {
                font-size: 0.9rem;
            }
            
            .result-actions {
                margin-top: 15px;
            }
            
            .result-actions .btn {
                width: 100%;
                padding: 12px;
                font-size: 0.9rem;
            }
            
            /* Mobile Modal Improvements */
            .modal {
                padding: 0;
            }
            
            .modal-content {
                width: 100%;
                margin: 0;
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
                display: flex;
                flex-direction: column;
            }
            
            .modal-header {
                padding: 15px 20px;
                flex-shrink: 0;
                border-radius: 0;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .modal-header h2 {
                font-size: 1.1rem;
                margin: 0;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                margin-right: 10px;
            }
            
            .modal-actions {
                gap: 8px;
                flex-shrink: 0;
                display: flex;
                align-items: center;
            }
            
            .export-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-width: auto;
            }

            /* AI Components Mobile */
            .ai-toggle-container {
                padding: 10px 15px;
                margin-bottom: 15px;
            }

            .ai-toggle-label {
                font-size: 14px;
            }

            .ai-suggestions-panel {
                padding: 15px;
                margin-bottom: 15px;
            }

            .ai-suggestions-header h4 {
                font-size: 16px;
            }

            .ai-suggestion-item {
                padding: 12px;
                margin-bottom: 8px;
            }

            .ai-suggestion-text {
                font-size: 13px;
            }

            .ai-dashboard {
                padding: 15px;
                margin-bottom: 15px;
            }

            .ai-dashboard-title {
                font-size: 16px;
            }

            .ai-analysis-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .ai-analysis-card {
                padding: 12px;
            }

            .ai-analysis-card-title {
                font-size: 13px;
            }

            .ai-analysis-card-content {
                font-size: 12px;
            }

            /* AI Face-to-NIK Mobile */
            .ai-control-panel {
                padding: 12px;
                margin-bottom: 15px;
            }

            .ai-control-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .ai-control-settings {
                width: 100%;
                justify-content: space-between;
            }

            .ai-face-upload-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .ai-upload-area {
                padding: 20px;
            }

            .ai-upload-area i {
                font-size: 36px;
            }

            .ai-upload-area p {
                font-size: 14px;
            }

            .ai-results-panel {
                padding: 15px;
            }

            .ai-results-panel h4 {
                font-size: 16px;
            }

            .ai-result-item {
                padding: 12px;
                gap: 12px;
            }

            .ai-result-item img {
                width: 40px;
                height: 40px;
            }

            .ai-result-info h5 {
                font-size: 13px;
            }

            .ai-result-info p {
                font-size: 11px;
            }

            .confidence-score {
                padding: 4px 8px;
                font-size: 11px;
                min-width: 40px;
            }

            .hybrid-input-form {
                padding: 15px;
                margin-bottom: 15px;
            }

            .input-group {
                margin-bottom: 12px;
            }

            .input-group input {
                padding: 10px 12px;
                font-size: 13px;
            }

            .ai-fill-btn {
                padding: 6px 12px;
                font-size: 11px;
                margin-left: 8px;
            }
            
            .export-btn i {
                font-size: 0.8rem;
            }
            
            .modal-close {
                font-size: 1.5rem;
                width: 30px;
                height: 30px;
            }
            
            .modal-body {
                padding: 15px 20px;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .detail-section {
                margin-bottom: 25px;
            }
            
            .detail-section h3 {
                font-size: 1rem;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 8px;
                color: #374151;
            }
            
            .detail-section h3 i {
                font-size: 0.9rem;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .detail-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #667eea;
                margin-bottom: 12px;
            }
            
            .detail-item .label {
                font-size: 0.8rem;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 6px;
            }
            
            .detail-item .value {
                font-size: 0.95rem;
                color: #1f2937;
                font-weight: 500;
                line-height: 1.4;
                word-break: break-word;
            }
            
            /* Phone Grid Mobile */
            .phone-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .phone-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #10b981;
            }
            
            .phone-number {
                font-size: 1rem;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 5px;
            }
            
            .phone-operator, .phone-date {
                font-size: 0.8rem;
                color: #6b7280;
            }
            
            /* Family Grid Mobile */
            .family-grid {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .family-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #8b5cf6;
                text-align: center;
            }
            
            .family-photo {
                margin-bottom: 10px;
            }
            
            .family-photo img {
                width: 50px;
                height: 50px;
            }
            
            .family-avatar {
                width: 50px !important;
                height: 50px !important;
                font-size: 14px !important;
                margin: 0 auto 10px !important;
            }
            
            .family-name {
                font-size: 0.9rem;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 5px;
            }
            
            .family-relationship, .family-nik {
                font-size: 0.75rem;
                color: #6b7280;
                margin-bottom: 3px;
            }
            
            .modal-footer {
                padding: 20px;
                border-top: 1px solid #e1e5e9;
            }
            
            .modal-footer .btn {
                width: 100%;
                margin: 5px 0;
                padding: 12px;
            }
            
            .loading-spinner {
                font-size: 1.5rem;
            }
            
            .error-message {
                padding: 20px;
                text-align: center;
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 10px;
                color: #dc2626;
                margin: 20px 0;
            }
            
            .no-results {
                padding: 40px 20px;
                text-align: center;
                color: #6b7280;
            }
            
            .no-results i {
                font-size: 3rem;
                margin-bottom: 20px;
                color: #d1d5db;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Extra Small Mobile Devices */
        @media (max-width: 480px) {
            .modal-header {
                padding: 12px 15px;
            }
            
            .modal-header h2 {
                font-size: 1rem;
            }
            
            .export-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .export-btn span {
                display: none;
            }
            
            .modal-body {
                padding: 12px 15px;
            }
            
            .detail-section {
                margin-bottom: 20px;
            }
            
            .detail-section h3 {
                font-size: 0.9rem;
                margin-bottom: 12px;
            }
            
            .detail-item {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .detail-item .label {
                font-size: 0.75rem;
            }
            
            .detail-item .value {
                font-size: 0.9rem;
            }
            
            .phone-item {
                padding: 12px;
            }
            
            .phone-number {
                font-size: 0.9rem;
            }
            
            .phone-operator, .phone-date {
                font-size: 0.75rem;
            }
            
            .family-item {
                padding: 12px;
            }
            
            .family-photo img {
                width: 40px;
                height: 40px;
            }
            
            .family-avatar {
                width: 40px !important;
                height: 40px !important;
                font-size: 12px !important;
            }
            
            .family-name {
                font-size: 0.85rem;
            }
            
        .family-relationship, .family-nik {
            font-size: 0.7rem;
        }
    }

    /* Universal Search Styles */
    .universal-search-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e1e5e9;
    }

    .universal-search-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e5e9;
    }

    .search-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .search-label {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
    }

    .search-name {
        font-size: 1.1rem;
        color: #1f2937;
        font-weight: 600;
    }

    .search-status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #667eea;
        font-weight: 500;
    }

    .search-status.success {
        color: #10b981;
    }

    .search-status.error {
        color: #ef4444;
    }

    .universal-results {
        margin-bottom: 20px;
    }

    .result-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .result-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .result-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .result-title a {
        color: #667eea;
        text-decoration: none;
    }

    .result-title a:hover {
        text-decoration: underline;
    }

    .result-snippet {
        font-size: 0.9rem;
        color: #6b7280;
        line-height: 1.4;
        margin-bottom: 8px;
    }

    .result-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .result-source {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .result-position {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
    }

    .social-links {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e1e5e9;
    }

    .social-links h4 {
        font-size: 1rem;
        color: #374151;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .social-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .social-item {
        background: white;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e1e5e9;
        transition: all 0.3s ease;
        text-align: center;
    }

    .social-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.15);
    }

    .social-item a {
        text-decoration: none;
        color: #374151;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .social-icon {
        font-size: 1.5rem;
        color: #667eea;
    }

    .social-name {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .social-followers {
        font-size: 0.8rem;
        color: #6b7280;
    }

    /* Mobile Universal Search */
    @media (max-width: 768px) {
        .universal-search-container {
            padding: 15px;
        }

        .universal-search-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .search-status {
            align-self: flex-end;
        }

        /* Search Info Header - Responsive */
        .search-info-header {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .search-info-header > div:first-child {
            flex: 1;
            min-width: 0;
        }

        .search-info-header .search-status {
            flex-shrink: 0;
        }

        .result-item {
            padding: 12px;
        }

        .result-title {
            font-size: 0.9rem;
        }

        .result-snippet {
            font-size: 0.85rem;
        }

        .result-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .social-grid {
            grid-template-columns: 1fr;
        }

        .social-item {
            padding: 10px;
        }

        /* Search Info Header Mobile */
        .search-info-header {
            flex-direction: column !important;
            align-items: flex-start !important;
            padding: 12px 15px !important;
            gap: 10px !important;
        }

        .search-info-header > div:first-child {
            width: 100% !important;
        }

        .search-info-header .search-status {
            width: 100% !important;
            justify-content: flex-start !important;
            font-size: 0.85rem !important;
        }

        .search-info-header #socialMediaSearchName {
            display: block;
            margin-top: 4px;
            font-size: 1rem;
            font-weight: 600;
        }
    }

        @media (max-width: 1024px) and (min-width: 769px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-type-tabs {
                gap: 12px;
            }
            
            .search-tab {
                padding: 14px 20px;
                min-width: 100px;
            }
        }

        /* Message animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Loading Screen -->
    <div class="auth-loading" id="authLoading">
        <div class="auth-spinner"></div>
        <div class="auth-loading-text">Memverifikasi autentikasi...</div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="sidebar-title">Pencarian Clearance</div>
        </div>
        
        <nav class="sidebar-menu">
            <a href="/dashboard" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="/profiling" class="menu-item active">
                <i class="fas fa-search"></i>
                <span>Profiling</span>
            </a>
            <a href="/data-profiling" class="menu-item">
                <i class="fas fa-database"></i>
                <span>Data Profiling</span>
            </a>
            <a href="/cekplat" class="menu-item">
                <i class="fas fa-car"></i>
                <span>Cek Plat No Jambi</span>
            </a>
            <div class="nav-submenu">
                <a href="/data-cari-plat" class="menu-item">
                    <i class="fas fa-list"></i>
                    <span>Data Cari Plat No</span>
                </a>
            </div>
            <a href="/user-management" class="menu-item">
                <i class="fas fa-users"></i>
                <span>User Management</span>
            </a>
            <a href="/ai-features" class="menu-item">
                <i class="fas fa-robot"></i>
                <span>AI Features</span>
            </a>
            <a href="/mapping" class="menu-item">
                <i class="fas fa-project-diagram"></i>
                <span>Mapping Profiling</span>
            </a>
            <a href="/reports" class="menu-item">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </a>
            <div class="nav-submenu">
                <a href="/reports/profiling" class="menu-item">
                    <i class="fas fa-user-circle"></i>
                    <span>Profiling</span>
                </a>
            </div>
            <a href="/settings" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        
        <div class="menu-divider"></div>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin User</div>
                    <div class="user-role" id="userRole">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Profiling</h1>
            </div>
            <div class="topbar-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Pencarian cepat..." id="globalSearch">
                </div>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
            </div>
        </div>

        <!-- Profiling Content -->
        <div class="profiling-content">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <h2>Profiling Identitas</h2>
                    <p>Cari dan analisis informasi identitas menggunakan berbagai metode</p>
                </div>
            </div>

            <!-- Chatbot Interface -->
            <div class="chatbot-container" id="chatbotContainer">
                <div class="chatbot-header" onclick="toggleChatbot()">
                    <div class="chatbot-header-left">
                        <div class="chatbot-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="chatbot-info">
                            <h3>AI Profiling Assistant</h3>
                            <p>Cari dengan natural language - NIK, Nama, Lokasi, No HP</p>
                        </div>
                    </div>
                    <button class="chatbot-toggle" id="chatbotToggle" onclick="event.stopPropagation(); toggleChatbot()">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="chatbot-body" id="chatbotBody">
                    <div class="chatbot-messages" id="chatbotMessages">
                        <div class="chatbot-message bot-message">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <p>Halo! Saya AI Assistant untuk Profiling. Saya bisa membantu Anda mencari data dengan cara yang lebih mudah.</p>
                                <p class="message-hint">Contoh: "Cari NIK 1505041107830002" atau "Cari nama Jambi" atau "Cari no HP 6285755349653"</p>
                            </div>
                        </div>
                    </div>
                    <div class="chatbot-input-container">
                        <div class="chatbot-input-wrapper" style="position: relative;">
                            <input type="file" id="chatbotFileInput" accept="image/*,.pdf" style="display: none;" onchange="handleChatbotFileUpload(event)">
                            <!-- Smart Query Suggestions Dropdown -->
                            <div class="query-suggestions-dropdown" id="querySuggestionsDropdown">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            <!-- Top Section: Input Field -->
                            <div class="chatbot-input-top">
                                <input type="text" id="chatbotInput" class="chatbot-input" placeholder="Ketik pencarian Anda..." onkeypress="handleChatbotKeyPress(event)" onkeydown="handleChatbotKeyDown(event)" oninput="handleChatbotInput(event)" onfocus="handleChatbotInputFocus(event)" onblur="handleChatbotInputBlur(event)">
                            </div>
                            <!-- Bottom Section: Auto Dropdown (Left) and Action Buttons (Right) -->
                            <div class="chatbot-input-bottom">
                                <div class="auto-dropdown-wrapper" id="autoDropdownWrapper">
                                    <button class="auto-dropdown-btn" onclick="event.stopPropagation(); toggleAutoDropdown()">
                                        <i class="fas fa-cog"></i>
                                        <span>Auto</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div class="auto-dropdown-menu" id="autoDropdownMenu">
                                        <div class="auto-dropdown-item" onclick="setAutoMode('nik')">
                                            <i class="fas fa-id-card"></i>
                                            <span>Auto NIK</span>
                                        </div>
                                        <div class="auto-dropdown-item" onclick="setAutoMode('nama')">
                                            <i class="fas fa-user"></i>
                                            <span>Auto Nama</span>
                                        </div>
                                        <div class="auto-dropdown-item" onclick="setAutoMode('phone')">
                                            <i class="fas fa-phone"></i>
                                            <span>Auto No HP</span>
                                        </div>
                                        <div class="auto-dropdown-item" onclick="setAutoMode('kombinasi')">
                                            <i class="fas fa-layer-group"></i>
                                            <span>Auto Kombinasi</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="chatbot-input-right-buttons">
                                    <button class="chatbot-voice-btn" id="chatbotVoiceBtn" onclick="toggleVoiceInput()" title="Voice Input">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button class="chatbot-send-btn" onclick="handleChatbotSubmit()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="chatbot-suggestions" id="chatbotSuggestions">
                            <button class="suggestion-chip" onclick="fillChatbotInput('Cari NIK 1505041107830002')">Cari NIK</button>
                            <button class="suggestion-chip" onclick="fillChatbotInput('Cari nama Jambi')">Cari Nama</button>
                            <button class="suggestion-chip" onclick="fillChatbotInput('Cari no HP 6285755349653')">Cari No HP</button>
                            <button class="suggestion-chip" onclick="fillChatbotInput('Cari NIK 1505041107830002 nama Jambi')">Kombinasi</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Type Selector - HIDDEN -->
            <div class="search-type-selector" style="display: none;">
                <h3><i class="fas fa-search"></i> Pilih Jenis Pencarian</h3>
                <div class="search-type-tabs">
                    <button class="search-tab active" data-type="identity" onclick="switchSearchType('identity')">
                        <i class="fas fa-id-card"></i>
                        <span>Identitas</span>
                    </button>
                    <button class="search-tab" data-type="phone" onclick="switchSearchType('phone')">
                        <i class="fas fa-phone"></i>
                        <span>Nomor HP</span>
                    </button>
                    <button class="search-tab" data-type="face" onclick="switchSearchType('face')">
                        <i class="fas fa-camera"></i>
                        <span>Deteksi Wajah</span>
                    </button>
                </div>
            </div>

            <!-- Identity Search Form - HIDDEN -->
            <div class="search-form active" id="identityForm" style="display: none;">
                <div class="form-container">
                    <!-- AI Face Upload Section for Identity Form -->
                    <div class="ai-face-upload-section" id="identityFaceUploadSection">
                        <div class="ai-upload-area" id="identityUploadArea" onclick="document.getElementById('identityFaceFile').click()">
                            <i class="fas fa-camera"></i>
                            <p>Upload foto untuk AI auto-fill NIK & Nama</p>
                            <input type="file" id="identityFaceFile" accept="image/*" onchange="handleIdentityFaceUpload(this)">
                        </div>
                        
                        <!-- AI Results Panel for Identity -->
                        <div class="ai-results-panel" id="identityResultsPanel">
                            <h4>
                                <i class="fas fa-search"></i>
                                Hasil Pencarian AI
                            </h4>
                            <div class="ai-results-list" id="identityResultsList">
                                <!-- AI results will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                            <div class="form-group">
                            <label for="name"><i class="fas fa-user-circle"></i> Nama Lengkap</label>
                            <input type="text" id="name" placeholder="Masukkan nama lengkap (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="nik"><i class="fas fa-id-card"></i> NIK</label>
                            <input type="text" id="nik" placeholder="Masukkan nomor NIK" value="1505041107830002">
                            </div>
                            <div class="form-group">
                            <label for="family_cert_number"><i class="fas fa-home"></i> Nomor Kartu Keluarga</label>
                            <input type="text" id="family_cert_number" placeholder="Masukkan nomor KK (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="tempat_lahir"><i class="fas fa-map-marker-alt"></i> Tempat Lahir</label>
                            <input type="text" id="tempat_lahir" placeholder="Masukkan tempat lahir (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="tanggal_lahir"><i class="fas fa-calendar"></i> Tanggal Lahir</label>
                            <input type="date" id="tanggal_lahir" placeholder="Masukkan tanggal lahir (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="provinsi"><i class="fas fa-map"></i> Provinsi</label>
                            <select id="provinsi" onchange="loadKabupaten()">
                                <option value="">Pilih Provinsi</option>
                            </select>
                            <input type="hidden" id="no_prop" value="">
                            </div>
                            <div class="form-group">
                            <label for="kabupaten"><i class="fas fa-city"></i> Kabupaten/Kota</label>
                            <select id="kabupaten" onchange="loadKecamatan()" disabled>
                                <option value="">Pilih Kabupaten/Kota</option>
                            </select>
                            <input type="hidden" id="no_kab" value="">
                            </div>
                            <div class="form-group">
                            <label for="kecamatan"><i class="fas fa-building"></i> Kecamatan</label>
                            <select id="kecamatan" onchange="loadKelurahan()" disabled>
                                <option value="">Pilih Kecamatan</option>
                            </select>
                            <input type="hidden" id="no_kec" value="">
                            </div>
                            <div class="form-group">
                            <label for="kelurahan"><i class="fas fa-home"></i> Kelurahan/Desa</label>
                            <select id="kelurahan" onchange="updateKelurahanCode()" disabled>
                                <option value="">Pilih Kelurahan/Desa</option>
                            </select>
                            <input type="hidden" id="no_desa" value="">
                            </div>
                        </div>
                </div>
            </div>

            <!-- Phone Search Form - HIDDEN -->
            <div class="search-form" id="phoneForm" style="display: none;">
                <div class="form-container">
                    <div class="form-grid">
                            <div class="form-group">
                            <label for="phoneNumber"><i class="fas fa-phone"></i> Nomor HP</label>
                            <input type="text" id="phoneNumber" placeholder="Contoh: 6285755349653">
                        </div>
                        <div class="form-group">
                            <label for="phoneOperator"><i class="fas fa-network-wired"></i> Operator (Opsional)</label>
                            <select id="phoneOperator">
                                <option value="">Semua Operator</option>
                                <option value="TELKOMSEL">Telkomsel</option>
                                <option value="INDOSAT">Indosat</option>
                                <option value="XL">XL</option>
                                <option value="TRI">3 (Tri)</option>
                                <option value="SMARTFREN">Smartfren</option>
                            </select>
                        </div>
                            </div>
                        </div>
                    </div>

            <!-- Face Search Form - HIDDEN -->
            <div class="search-form" id="faceForm" style="display: none;">
                <div class="form-container">
                    <div class="face-upload-section">
                        <div class="upload-area" id="faceUploadArea">
                            <div class="upload-content">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Upload Foto Wajah</h4>
                                <p>Drag & drop atau klik untuk memilih foto</p>
                                <p class="upload-hint">Format: JPG, PNG, JPEG (Max: 5MB)</p>
                            </div>
                                <input type="file" id="faceFile" accept="image/*" style="display: none;" onchange="handleFaceUploadForNIK(this)">
                            </div>
                        <div class="face-preview" id="facePreview" style="display: none;">
                            <img id="previewImage" alt="Preview">
                            <button class="btn btn-secondary" onclick="removeFaceImage()">
                                <i class="fas fa-times"></i> Hapus
                                </button>
                            </div>
                        </div>

                        <!-- AI Results Panel for Face Form -->
                        <div class="ai-results-panel" id="faceResultsPanel">
                            <h4>
                                <i class="fas fa-search"></i>
                                Hasil Pencarian AI
                            </h4>
                            <div class="ai-results-list" id="faceResultsList">
                                <!-- AI results will be populated here -->
                            </div>
                        </div>

                        <!-- Auto-fill Form Fields -->
                        <div class="form-grid" style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="faceNIK"><i class="fas fa-id-card"></i> NIK (AI Auto-fill)</label>
                                <input type="text" id="faceNIK" placeholder="NIK akan diisi otomatis oleh AI">
                            </div>
                            <div class="form-group">
                                <label for="faceName"><i class="fas fa-user-circle"></i> Nama Lengkap (AI Auto-fill)</label>
                                <input type="text" id="faceName" placeholder="Nama akan diisi otomatis oleh AI">
                            </div>
                        </div>
                            <div class="form-group">
                        <label for="faceThreshold"><i class="fas fa-sliders-h"></i> Tingkat Kemiripan</label>
                        <div class="threshold-slider">
                            <input type="range" id="faceThreshold" min="0.1" max="1.0" step="0.1" value="0.5">
                            <span id="thresholdValue">0.5</span>
                            </div>
                            </div>
                        </div>
                    </div>

            <!-- Hidden credentials (auto-filled from .env) -->
            <input type="hidden" id="username" value="">
            <input type="hidden" id="password" value="">
            
            <div class="search-buttons" style="display: none;">
                <button class="btn btn-primary" onclick="handleSubmit()">
                    <i class="fas fa-search"></i> <span id="searchButtonText">Search Identity</span>
                        </button>
                <button class="btn btn-secondary" onclick="clearForm()">
                    <i class="fas fa-eraser"></i> Hapus Form
                        </button>
                    </div>
            </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Searching identity database...</p>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
                <div class="results-header">
                <h3 class="results-title">Hasil Pencarian</h3>
                <span class="results-count" id="resultsCount">0 hasil</span>
                </div>
            <div class="results-content" id="resultsContent">
                <!-- Results will be displayed here -->
            </div>
                </div>

        <!-- Person Details Modal -->
        <div class="modal" id="personDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Person Details</h2>
                    <div class="modal-actions">
                        <button class="export-btn ai-btn" onclick="app.showAIInsights(currentPersonData)" title="AI Insights">
                            <i class="fas fa-brain"></i> AI Insights
                        </button>
                        <button class="export-btn copy-btn" onclick="copyPersonData()" title="Copy Data">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="export-btn pdf-btn" onclick="exportToPDF()" title="Ekspor ke PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="export-btn word-btn" onclick="exportToWord()" title="Ekspor ke Word">
                            <i class="fas fa-file-word"></i> Word
                        </button>
                        <button class="modal-close" onclick="closePersonDetails()">&times;</button>
                    </div>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Detailed information will be displayed here -->
                </div>
            </div>
        </div>

        <!-- AI Insights Modal -->
        <div class="ai-insights-modal" id="aiInsightsModal">
            <div class="ai-insights-modal-content">
                <div class="ai-insights-modal-header">
                    <h3>
                        <i class="fas fa-brain icon"></i>
                        AI Insights & Analysis
                    </h3>
                    <span class="close" onclick="closeAIInsights()">&times;</span>
                </div>
                <div class="ai-insights-modal-body" id="aiInsightsModalBody">
                    <!-- AI insights content will be populated here -->
                </div>
                <div class="ai-insights-modal-footer">
                    <button class="ai-insights-modal-close" onclick="closeAIInsights()">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="ai-insights-modal-export" onclick="exportAIInsights()">
                        <i class="fas fa-download"></i> Export Insights
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication middleware
        async function checkAuthentication() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (!sessionToken) {
                console.log('No session token found, redirecting to login');
                window.location.href = '/login';
                return false;
            }
            
            try {
                const response = await fetch('/api/validate-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                });
                
                const data = await response.json();
                
                if (!data.valid) {
                    console.log('Invalid session token, redirecting to login');
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/login';
                    return false;
                }
                
                console.log('Authentication successful');
                // Hide loading screen after successful authentication
                document.getElementById('authLoading').classList.add('hidden');
                return true;
            } catch (error) {
                console.error('Authentication check failed:', error);
                localStorage.removeItem('session_token');
                localStorage.removeItem('user_data');
                window.location.href = '/login';
                return false;
            }
        }

        class ProfilingApp {
            constructor() {
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOverlay = document.getElementById('sidebarOverlay');
                this.isSidebarCollapsed = false;
                this.isMobile = window.innerWidth <= 768;
                this.currentSearchType = 'identity';
                this.faceFile = null;
                
                // AI properties
                this.aiModeEnabled = false;
                this.aiSuggestions = [];
                this.aiAnalysis = null;
                this.currentPersonData = null;
                
                // AI Face-to-NIK properties
                this.aiFaceResults = [];
                this.aiThreshold = 50;
                this.selectedNIK = null;
                
                // Identity Form AI properties
                this.identityFaceResults = [];
                this.selectedIdentityNIK = null;
                
                this.init();
            }

            async init() {
                // Check authentication first
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    return; // Stop initialization if not authenticated
                }
                
                this.setupEventListeners();
                this.loadConfig();
                this.loadUserData();
            }

            setupEventListeners() {
                // Face file upload
                const faceFileInput = document.getElementById('faceFile');
                const faceUploadArea = document.getElementById('faceUploadArea');
                
                faceFileInput.addEventListener('change', (e) => this.handleFaceFileSelect(e));
                
                // Drag and drop for face upload
                faceUploadArea.addEventListener('click', () => faceFileInput.click());
                faceUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    faceUploadArea.classList.add('dragover');
                });
                faceUploadArea.addEventListener('dragleave', () => {
                    faceUploadArea.classList.remove('dragover');
                });
                faceUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    faceUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFaceFile(files[0]);
                    }
                });

                // Threshold slider
                const thresholdSlider = document.getElementById('faceThreshold');
                const thresholdValue = document.getElementById('thresholdValue');
                thresholdSlider.addEventListener('input', (e) => {
                    thresholdValue.textContent = e.target.value;
                });

                // Global search
                document.getElementById('globalSearch').addEventListener('input', (e) => {
                    this.handleGlobalSearch(e.target.value);
                });

                // Window resize
                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth <= 768;
                    if (!this.isMobile) {
                        this.sidebarOverlay.classList.remove('active');
                    }
                });
            }

            checkAuth() {
                const token = localStorage.getItem('session_token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
            }

            loadConfig() {
                // Auto-fill credentials from config
                document.getElementById('username').value = 'rezarios';
                document.getElementById('password').value = '12345678';
            }

            loadUserData() {
                const userData = localStorage.getItem('user_data');
                if (userData) {
                    const user = JSON.parse(userData);
                    document.getElementById('userName').textContent = user.name || 'Admin User';
                    document.getElementById('userRole').textContent = user.role || 'Administrator';
                    
                    // Set menu visibility based on user role
                    this.setMenuVisibility(user.role);
                }
            }

            setMenuVisibility(userRole) {
                // Hide admin-only menus for non-admin users
                const adminOnlyMenus = ['user-management', 'settings'];
                
                adminOnlyMenus.forEach(menuId => {
                    const menuElement = document.querySelector(`a[href="/${menuId}"]`);
                    if (menuElement) {
                        if (userRole === 'admin') {
                            menuElement.style.display = 'flex';
                        } else {
                            menuElement.style.display = 'none';
                        }
                    }
                });
            }

            handleFaceFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.handleFaceFile(file);
                }
            }

            handleFaceFile(file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showMessage('Silakan pilih file gambar yang valid', 'error');
                    return;
                }

                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('Ukuran file harus kurang dari 5MB', 'error');
                    return;
                }

                this.faceFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('facePreview');
                    const previewImage = document.getElementById('previewImage');
                    const uploadArea = document.getElementById('faceUploadArea');
                    
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                    uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            removeFaceImage() {
                this.faceFile = null;
                document.getElementById('facePreview').style.display = 'none';
                document.getElementById('faceUploadArea').style.display = 'block';
                document.getElementById('faceFile').value = '';
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            async handleSubmit() {
                console.log('handleSubmit called');
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                console.log('Username:', username);
                console.log('Password:', password ? '***' : 'empty');
                console.log('Current search type:', this.currentSearchType);

                if (!username || !password) {
                    this.showMessage('Kredensial tidak ditemukan. Pastikan file .env sudah dikonfigurasi dengan benar.', 'error');
                    return;
                }

                // Validate based on search type
                if (!this.validateCurrentSearch()) {
                    console.log('Validation failed');
                    return;
                }

                console.log('Validation passed, starting search...');
                this.showLoading(true);
                this.hideResults();

                try {
                    const requestData = await this.buildRequestData(username, password);
                    console.log('Request data:', requestData);
                    
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('Response result:', result);
                    
                    if (!response.ok) {
                        throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.displayResults(result);

                } catch (error) {
                    console.error('Error in handleSubmit:', error);
                    this.showMessage(`Error: ${error.message}`, 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            validateCurrentSearch() {
                console.log('validateCurrentSearch called for type:', this.currentSearchType);
                
                switch (this.currentSearchType) {
                    case 'identity':
                        const name = document.getElementById('name').value.trim();
                        const nik = document.getElementById('nik').value.trim();
                        const family_cert_number = document.getElementById('family_cert_number').value.trim();
                        const tempat_lahir = document.getElementById('tempat_lahir').value.trim();
                        const tanggal_lahir = document.getElementById('tanggal_lahir').value.trim();
                        const no_prop = document.getElementById('no_prop').value.trim();
                        const no_kab = document.getElementById('no_kab').value.trim();
                        const no_kec = document.getElementById('no_kec').value.trim();
                        const no_desa = document.getElementById('no_desa').value.trim();
                        
                        console.log('Identity validation - Name:', name, 'NIK:', nik, 'Family Cert:', family_cert_number, 'Tempat Lahir:', tempat_lahir, 'Tanggal Lahir:', tanggal_lahir, 'No Prop:', no_prop, 'No Kab:', no_kab, 'No Kec:', no_kec, 'No Desa:', no_desa);
                        
                        if (!name && !nik && !family_cert_number && !tempat_lahir && !tanggal_lahir && !no_prop && !no_kab && !no_kec && !no_desa) {
                            this.showMessage('Minimal satu parameter harus diisi (Nama, NIK, KK, Tempat Lahir, Tanggal Lahir, atau Kode Lokasi)', 'error');
                            return false;
                        }
                        break;
                    
                    case 'phone':
                        const phoneNumber = document.getElementById('phoneNumber').value.trim();
                        console.log('Phone validation - Number:', phoneNumber);
                        if (!phoneNumber) {
                            this.showMessage('Nomor HP harus diisi', 'error');
                            return false;
                        }
                        break;
                    
                    case 'face':
                        console.log('Face validation - File:', this.faceFile);
                        if (!this.faceFile) {
                            this.showMessage('Foto wajah harus diupload', 'error');
                            return false;
                        }
                        break;
                }
                console.log('Validation passed');
                return true;
            }

            async buildRequestData(username, password) {
                const baseData = {
                    username,
                    password,
                    search_type: this.currentSearchType,
                    page: 1,
                    limit: 100  // Tambahkan parameter limit dengan default 100
                };

                switch (this.currentSearchType) {
                    case 'identity':
                        return {
                            ...baseData,
                            name: document.getElementById('name').value.trim(),
                            nik: document.getElementById('nik').value.trim(),
                            family_cert_number: document.getElementById('family_cert_number').value.trim(),
                            tempat_lahir: document.getElementById('tempat_lahir').value.trim(),
                            tanggal_lahir: document.getElementById('tanggal_lahir').value.trim(),
                            no_prop: document.getElementById('no_prop').value.trim(),
                            no_kab: document.getElementById('no_kab').value.trim(),
                            no_kec: document.getElementById('no_kec').value.trim(),
                            no_desa: document.getElementById('no_desa').value.trim()
                        };
                    
                    case 'phone':
                        return {
                            ...baseData,
                            phone_number: document.getElementById('phoneNumber').value.trim(),
                            phone_operator: document.getElementById('phoneOperator').value.trim()
                        };
                    
                    case 'face':
                        const faceQuery = await this.fileToBase64(this.faceFile);
                        return {
                            ...baseData,
                            face_query: faceQuery,
                            face_threshold: parseFloat(document.getElementById('faceThreshold').value)
                        };
                    
                    default:
                        return baseData;
                }
            }

            displayResults(result) {
                console.log('displayResults called with:', result);
                console.log('result.results:', result.results);
                console.log('result.results length:', result.results ? result.results.length : 'undefined');
                
                const resultsCount = document.getElementById('resultsCount');
                const resultsContent = document.getElementById('resultsContent');
                
                resultsCount.textContent = `${result.total_results || 0} results`;
                resultsContent.innerHTML = '';

                // Check if this is a fallback mode response
                if (result.message && result.message.includes('Server eksternal tidak tersedia')) {
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.className = 'result-card';
                    fallbackDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 15px;"></i>
                            <h3 style="color: #d97706; margin-bottom: 10px;">Server Eksternal Tidak Tersedia</h3>
                            <p style="color: #92400e; margin-bottom: 15px;">Sistem sedang menggunakan mode offline</p>
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 10px 0;">
                                <p style="color: #92400e; margin: 0; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> 
                                    Data pencarian tidak dapat diakses saat ini. Silakan coba lagi nanti atau hubungi administrator.
                                </p>
                            </div>
                        </div>
                    `;
                    resultsContent.appendChild(fallbackDiv);
                } else if (result.results && result.results.length > 0) {
                    console.log('Creating results grid with', result.results.length, 'items');
                    // Create grid container
                    const gridContainer = document.createElement('div');
                    gridContainer.className = 'results-grid';
                    
                    result.results.forEach((item, index) => {
                        console.log('Processing item', index, ':', item);
                        const person = item.person;
                        console.log('Person data:', person);
                        const resultCard = this.createResultCard(person, index, result.results.length);
                        gridContainer.appendChild(resultCard);
                    });
                    
                    resultsContent.appendChild(gridContainer);
                    console.log('Results grid created and appended');
                } else {
                    console.log('No results found, showing empty message');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'result-card';
                    messageDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-search" style="font-size: 3rem; color: #9ca3af; margin-bottom: 15px;"></i>
                            <h3 style="color: #6b7280; margin-bottom: 10px;">Tidak Ada Hasil Ditemukan</h3>
                            <p style="color: #9ca3af;">Coba sesuaikan kriteria pencarian Anda</p>
                        </div>
                    `;
                    resultsContent.appendChild(messageDiv);
                }

                this.showResults();
            }

            createResultCard(person, index, totalResults) {
                const card = document.createElement('div');
                card.className = 'result-card';
                
                const fullName = person.full_name || person.name || 'Unknown';
                const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                card.innerHTML = `
                    ${index === 0 ? `<div class="data-count">${totalResults} data</div>` : ''}
                    <div class="result-header">
                        <div class="result-avatar">
                            ${person.face ? `<img src="${person.face}" alt="Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : initials}
                        </div>
                        <div class="result-info">
                            <h3>${fullName}</h3>
                            <p>NIK: ${person.ktp_number || person.nik || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Nama Lengkap</span>
                            <span class="info-value">${fullName}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">NIK</span>
                            <span class="info-value">${person.ktp_number || person.nik || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tanggal Lahir</span>
                            <span class="info-value">${person.tanggal_lahir || person.date_of_birth || person.birth_date || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tempat Lahir</span>
                            <span class="info-value">${person.tempat_lahir || person.place_of_birth || person.birth_place || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Jenis Kelamin</span>
                            <span class="info-value">${person.jenis_kelamin || person.gender || person.sex || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Alamat</span>
                            <span class="info-value">${person.alamat || person.address || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Provinsi</span>
                            <span class="info-value">${person.province_name || person.provinsi || person.province || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="result-actions" style="margin-top: 12px; text-align: center;">
                        <button class="btn btn-primary btn-sm" onclick="viewPersonDetails('${person.ktp_number || person.nik || ''}')">
                            <i class="fas fa-eye"></i> Lihat Detail
                        </button>
                    </div>
                `;
                
                return card;
            }

            showLoading(show) {
                const loading = document.getElementById('loading');
                loading.style.display = show ? 'block' : 'none';
            }

            showResults() {
                document.getElementById('resultsSection').style.display = 'block';
            }

            hideResults() {
                document.getElementById('resultsSection').style.display = 'none';
            }

            showMessage(message, type) {
                // Create a better message display
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    max-width: 400px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease-out;
                `;
                
                if (type === 'error') {
                    messageDiv.style.backgroundColor = '#dc3545';
                } else if (type === 'success') {
                    messageDiv.style.backgroundColor = '#28a745';
                } else {
                    messageDiv.style.backgroundColor = '#007bff';
                }
                
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">&times;</button>
                    </div>
                `;
                
                document.body.appendChild(messageDiv);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 5000);
            }

            clearForm() {
                // Clear all form fields based on current search type
                switch (this.currentSearchType) {
                    case 'identity':
                document.getElementById('name').value = '';
                document.getElementById('nik').value = '';
                document.getElementById('family_cert_number').value = '';
                document.getElementById('tempat_lahir').value = '';
                document.getElementById('tanggal_lahir').value = '';
                
                // Reset wilayah dropdowns
                document.getElementById('provinsi').value = '';
                document.getElementById('kabupaten').value = '';
                document.getElementById('kecamatan').value = '';
                document.getElementById('kelurahan').value = '';
                
                // Reset hidden fields
                document.getElementById('no_prop').value = '';
                document.getElementById('no_kab').value = '';
                document.getElementById('no_kec').value = '';
                document.getElementById('no_desa').value = '';
                
                // Reset dropdown states
                document.getElementById('kabupaten').disabled = true;
                document.getElementById('kecamatan').disabled = true;
                document.getElementById('kelurahan').disabled = true;
                
                // Reset dropdown options
                document.getElementById('kabupaten').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
                document.getElementById('kecamatan').innerHTML = '<option value="">Pilih Kecamatan</option>';
                document.getElementById('kelurahan').innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
                        break;
                    case 'phone':
                        document.getElementById('phoneNumber').value = '';
                        document.getElementById('phoneOperator').value = '';
                        break;
                    case 'face':
                        this.removeFaceImage();
                        document.getElementById('faceThreshold').value = '0.5';
                        document.getElementById('thresholdValue').textContent = '0.5';
                        break;
                }
                this.hideResults();
            }

            handleGlobalSearch(query) {
                if (query.length > 2) {
                    console.log('Global search for:', query);
                    // Implement global search functionality
                }
            }

            // AI Methods
            async toggleAIMode() {
                this.aiModeEnabled = !this.aiModeEnabled;
                const toggleContainer = document.getElementById('aiToggleContainer');
                const toggleSwitch = document.getElementById('aiToggleSwitch');
                const suggestionsPanel = document.getElementById('aiSuggestionsPanel');
                const dashboard = document.getElementById('aiDashboard');

                if (this.aiModeEnabled) {
                    toggleContainer.classList.add('active');
                    toggleSwitch.classList.add('active');
                    suggestionsPanel.classList.add('active');
                    dashboard.classList.add('active');
                    
                    // Load AI suggestions and analysis
                    await this.loadAISuggestions();
                    await this.loadAIAnalysis();
                } else {
                    toggleContainer.classList.remove('active');
                    toggleSwitch.classList.remove('active');
                    suggestionsPanel.classList.remove('active');
                    dashboard.classList.remove('active');
                }
            }

            async loadAISuggestions() {
                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/suggestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            search_type: this.currentSearchType,
                            context: 'profiling_search'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.aiSuggestions = result.suggestions || [];
                        this.renderAISuggestions();
                    }
                } catch (error) {
                    console.error('Error loading AI suggestions:', error);
                    this.renderAISuggestions(); // Show fallback suggestions
                }
            }

            renderAISuggestions() {
                const suggestionsContent = document.getElementById('aiSuggestionsContent');
                
                if (this.aiSuggestions.length === 0) {
                    // Fallback suggestions
                    this.aiSuggestions = [
                        { text: 'Coba tambahkan informasi lokasi untuk hasil yang lebih akurat', confidence: 85, icon: 'fas fa-map-marker-alt' },
                        { text: 'Gunakan pencarian kombinasi NIK + nama untuk hasil terbaik', confidence: 92, icon: 'fas fa-id-card' },
                        { text: 'Upload foto dengan kualitas tinggi untuk face recognition', confidence: 78, icon: 'fas fa-camera' }
                    ];
                }

                suggestionsContent.innerHTML = this.aiSuggestions.map(suggestion => `
                    <div class="ai-suggestion-item" onclick="app.applyAISuggestion('${suggestion.text}')">
                        <i class="${suggestion.icon}"></i>
                        <div class="ai-suggestion-text">${suggestion.text}</div>
                        <div class="ai-suggestion-confidence">${suggestion.confidence}%</div>
                    </div>
                `).join('');
            }

            applyAISuggestion(suggestionText) {
                // Apply suggestion based on content
                if (suggestionText.includes('lokasi')) {
                    // Focus on location input
                    const locationInput = document.querySelector('input[placeholder*="alamat"], input[placeholder*="lokasi"]');
                    if (locationInput) {
                        locationInput.focus();
                        locationInput.style.borderColor = '#667eea';
                        setTimeout(() => locationInput.style.borderColor = '', 2000);
                    }
                } else if (suggestionText.includes('NIK')) {
                    // Focus on NIK input
                    const nikInput = document.querySelector('input[placeholder*="NIK"], input[name*="nik"]');
                    if (nikInput) {
                        nikInput.focus();
                        nikInput.style.borderColor = '#667eea';
                        setTimeout(() => nikInput.style.borderColor = '', 2000);
                    }
                } else if (suggestionText.includes('foto')) {
                    // Focus on face upload
                    const faceUpload = document.getElementById('faceUploadArea');
                    if (faceUpload) {
                        faceUpload.style.borderColor = '#667eea';
                        setTimeout(() => faceUpload.style.borderColor = '', 2000);
                    }
                }
            }

            async loadAIAnalysis() {
                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            search_type: this.currentSearchType,
                            context: 'profiling_analysis'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.aiAnalysis = result.analysis || {};
                        this.renderAIAnalysis();
                    }
                } catch (error) {
                    console.error('Error loading AI analysis:', error);
                    this.renderAIAnalysis(); // Show fallback analysis
                }
            }

            renderAIAnalysis() {
                const analysisGrid = document.getElementById('aiAnalysisGrid');
                
                if (!this.aiAnalysis || Object.keys(this.aiAnalysis).length === 0) {
                    // Fallback analysis
                    this.aiAnalysis = {
                        search_optimization: {
                            title: 'Search Optimization',
                            content: 'AI suggests using multiple search criteria for better results',
                            confidence: 88
                        },
                        data_quality: {
                            title: 'Data Quality',
                            content: 'Current search parameters show good data coverage potential',
                            confidence: 92
                        },
                        risk_assessment: {
                            title: 'Risk Assessment',
                            content: 'Standard profiling search with low risk indicators',
                            confidence: 85
                        }
                    };
                }

                analysisGrid.innerHTML = Object.entries(this.aiAnalysis).map(([key, analysis]) => `
                    <div class="ai-analysis-card">
                        <div class="ai-analysis-card-header">
                            <i class="fas fa-chart-bar"></i>
                            <div class="ai-analysis-card-title">${analysis.title}</div>
                        </div>
                        <div class="ai-analysis-card-content">${analysis.content}</div>
                        <div class="ai-confidence-score">${analysis.confidence}% confidence</div>
                    </div>
                `).join('');
            }

            async refreshAIDashboard() {
                const refreshBtn = document.querySelector('.ai-dashboard-refresh');
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                refreshBtn.disabled = true;

                try {
                    await this.loadAISuggestions();
                    await this.loadAIAnalysis();
                } finally {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }

            async showAIInsights(personData) {
                this.currentPersonData = personData;
                const modal = document.getElementById('aiInsightsModal');
                const modalBody = document.getElementById('aiInsightsModalBody');

                // Show loading
                modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Generating AI insights...</p></div>';
                modal.style.display = 'block';

                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/insights', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            person_data: personData,
                            search_type: this.currentSearchType
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.renderAIInsights(result.insights);
                    } else {
                        this.renderAIInsights(); // Show fallback insights
                    }
                } catch (error) {
                    console.error('Error loading AI insights:', error);
                    this.renderAIInsights(); // Show fallback insights
                }
            }

            renderAIInsights(insights = null) {
                const modalBody = document.getElementById('aiInsightsModalBody');
                
                if (!insights) {
                    // Fallback insights
                    insights = {
                        behavioral_analysis: {
                            title: 'Behavioral Analysis',
                            content: 'Based on available data, this individual shows standard demographic patterns typical for the region. No significant behavioral anomalies detected.',
                            confidence: 87
                        },
                        risk_assessment: {
                            title: 'Risk Assessment',
                            content: 'Low to moderate risk profile based on standard profiling criteria. No immediate red flags identified.',
                            confidence: 82
                        },
                        network_analysis: {
                            title: 'Network Analysis',
                            content: 'Standard family and social network patterns observed. No unusual connections detected.',
                            confidence: 79
                        },
                        recommendations: {
                            title: 'Recommendations',
                            content: 'Continue standard monitoring protocols. Consider additional verification if higher confidence is required.',
                            confidence: 91
                        }
                    };
                }

                modalBody.innerHTML = Object.entries(insights).map(([key, insight]) => `
                    <div class="ai-insight-section">
                        <div class="ai-insight-section-header">
                            <i class="fas fa-brain"></i>
                            <div class="ai-insight-section-title">${insight.title}</div>
                        </div>
                        <div class="ai-insight-content">${insight.content}</div>
                        <div class="ai-insight-confidence">${insight.confidence}% confidence</div>
                    </div>
                `).join('');
            }

            async exportAIInsights() {
                if (!this.currentPersonData) {
                    alert('No data available for export');
                    return;
                }

                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/export-insights', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            person_data: this.currentPersonData,
                            insights: this.aiAnalysis
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            window.open(`/api/ai/download-insights/${result.filename}`, '_blank');
                        }
                    }
                } catch (error) {
                    console.error('Error exporting AI insights:', error);
                    alert('Error exporting insights');
                }
            }

            // AI Face-to-NIK Methods
            async handleFaceUpload(input) {
                const file = input.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showMessage('Harap pilih file gambar yang valid', 'error');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('Ukuran file maksimal 5MB', 'error');
                    return;
                }

                try {
                    // Show loading state
                    this.updateAIStatus('processing', 'AI Analyzing...');
                    
                    // Convert file to base64
                    const base64 = await this.fileToBase64(file);
                    
                    // Call AI face analysis API
                    const response = await fetch('/api/ai/face-to-nik', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('session_token')}`
                        },
                        body: JSON.stringify({
                            image: base64,
                            threshold: this.aiThreshold
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.aiFaceResults = data.results || [];
                        this.renderAIResults();
                        this.updateAIStatus('active', 'AI Ready');
                        this.showMessage(`AI menemukan ${this.aiFaceResults.length} kemungkinan NIK`, 'success');
                    } else {
                        throw new Error('AI analysis failed');
                    }
                } catch (error) {
                    console.error('Error in face upload:', error);
                    this.updateAIStatus('inactive', 'AI Error');
                    this.showMessage('Error saat menganalisis foto', 'error');
                }
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }

            renderAIResults() {
                const resultsList = document.getElementById('aiResultsList');
                const resultsPanel = document.getElementById('aiResultsPanel');
                
                if (this.aiFaceResults.length === 0) {
                    resultsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Tidak ada hasil yang ditemukan</p>';
                    resultsPanel.classList.add('active');
                    return;
                }

                resultsList.innerHTML = this.aiFaceResults.map((result, index) => {
                    const confidenceClass = this.getConfidenceClass(result.confidence);
                    const isSelected = index === 0; // Auto-select highest confidence
                    
                    return `
                        <div class="ai-result-item ${isSelected ? 'selected' : ''}" 
                             onclick="selectAIResult(${index})" 
                             data-nik="${result.nik}">
                            <img src="${result.photo_url || '/static/default-avatar.png'}" 
                                 alt="${result.name}" 
                                 onerror="this.src='/static/default-avatar.png'">
                            <div class="ai-result-info">
                                <h5>${result.name || 'N/A'}</h5>
                                <p>NIK: ${result.nik}</p>
                            </div>
                            <div class="confidence-score ${confidenceClass}">
                                ${result.confidence}%
                            </div>
                        </div>
                    `;
                }).join('');

                resultsPanel.classList.add('active');
                
                // Auto-select first result (highest confidence)
                if (this.aiFaceResults.length > 0) {
                    this.selectedNIK = this.aiFaceResults[0].nik;
                    this.updateAIFillButton();
                }
            }

            getConfidenceClass(confidence) {
                if (confidence >= 80) return 'high';
                if (confidence >= 60) return 'medium';
                return 'low';
            }

            selectAIResult(index) {
                // Remove previous selection
                document.querySelectorAll('.ai-result-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selection to clicked item
                const selectedItem = document.querySelectorAll('.ai-result-item')[index];
                selectedItem.classList.add('selected');
                
                // Update selected NIK
                this.selectedNIK = this.aiFaceResults[index].nik;
                this.updateAIFillButton();
            }

            updateAIFillButton() {
                const fillBtn = document.getElementById('aiFillBtn');
                if (this.selectedNIK) {
                    fillBtn.disabled = false;
                    fillBtn.innerHTML = '<i class="fas fa-magic"></i> AI Fill';
                } else {
                    fillBtn.disabled = true;
                    fillBtn.innerHTML = '<i class="fas fa-magic"></i> AI Fill';
                }
            }

            fillNIKFromAI() {
                if (!this.selectedNIK) {
                    this.showMessage('Pilih NIK dari hasil AI terlebih dahulu', 'error');
                    return;
                }

                const nikInput = document.getElementById('nikInput');
                nikInput.value = this.selectedNIK;
                nikInput.classList.add('ai-filled');
                
                // Find corresponding name if available
                const selectedResult = this.aiFaceResults.find(result => result.nik === this.selectedNIK);
                if (selectedResult && selectedResult.name) {
                    const nameInput = document.getElementById('nameInput');
                    nameInput.value = selectedResult.name;
                }
                
                this.showMessage('NIK berhasil diisi oleh AI!', 'success');
            }

            updateAIThreshold() {
                const thresholdInput = document.getElementById('aiThreshold');
                this.aiThreshold = parseInt(thresholdInput.value) || 50;
            }

            updateAIStatus(status, text) {
                const statusIndicator = document.getElementById('aiStatusIndicator');
                const statusDot = statusIndicator.querySelector('.ai-status-dot');
                const statusText = statusIndicator.querySelector('span');
                
                statusIndicator.className = `ai-status-indicator ${status}`;
                statusText.textContent = text;
            }

            // Identity Form AI Face Upload Methods
            async handleIdentityFaceUpload(input) {
                const file = input.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showMessage('Harap pilih file gambar yang valid', 'error');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('Ukuran file maksimal 5MB', 'error');
                    return;
                }

                try {
                    // Show loading state
                    this.showMessage('OCR sedang membaca NIK dari foto...', 'info');
                    
                    // Convert file to base64
                    const base64 = await this.fileToBase64(file);
                    
                    // Call OCR NIK extraction API
                    const response = await fetch('/api/ai/ocr-nik', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('session_token')}`
                        },
                        body: JSON.stringify({
                            image_data: base64
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // Convert OCR results to the expected format
                            this.identityFaceResults = data.data.nik_candidates.map(candidate => ({
                                nik: candidate.nik,
                                name: candidate.name || 'Nama tidak terdeteksi',
                                confidence: candidate.confidence,
                                source: 'ocr'
                            }));
                            
                            this.renderIdentityResults();
                            this.showMessage(`OCR menemukan ${this.identityFaceResults.length} NIK dari foto`, 'success');
                        } else {
                            throw new Error(data.error || 'OCR extraction failed');
                        }
                    } else {
                        throw new Error('OCR analysis failed');
                    }
                } catch (error) {
                    console.error('Error in OCR NIK extraction:', error);
                    this.showMessage('Error saat membaca NIK dari foto', 'error');
                }
            }

            renderIdentityResults() {
                const resultsList = document.getElementById('identityResultsList');
                const resultsPanel = document.getElementById('identityResultsPanel');
                
                if (this.identityFaceResults.length === 0) {
                    resultsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Tidak ada NIK yang ditemukan dalam foto</p>';
                    resultsPanel.classList.add('active');
                    return;
                }

                resultsList.innerHTML = this.identityFaceResults.map((result, index) => {
                    const confidenceClass = this.getConfidenceClass(result.confidence);
                    const isSelected = index === 0; // Auto-select highest confidence
                    const sourceIcon = result.source === 'ocr' ? 'fas fa-eye' : 'fas fa-user';
                    const sourceText = result.source === 'ocr' ? 'OCR' : 'AI';
                    
                    return `
                        <div class="ai-result-item ${isSelected ? 'selected' : ''}" 
                             onclick="selectIdentityResult(${index})" 
                             data-nik="${result.nik}">
                            <div class="ai-result-icon">
                                <i class="${sourceIcon}"></i>
                            </div>
                            <div class="ai-result-info">
                                <h5>${result.name || 'Nama tidak terdeteksi'}</h5>
                                <p>NIK: ${result.nik}</p>
                                <small class="source-badge">${sourceText}</small>
                            </div>
                            <div class="confidence-score ${confidenceClass}">
                                ${result.confidence}%
                            </div>
                        </div>
                    `;
                }).join('');

                resultsPanel.classList.add('active');
                
                // Auto-select first result (highest confidence) and auto-fill
                if (this.identityFaceResults.length > 0) {
                    this.selectedIdentityNIK = this.identityFaceResults[0].nik;
                    this.autoFillIdentityForm(this.identityFaceResults[0]);
                }
            }

            selectIdentityResult(index) {
                // Remove previous selection
                document.querySelectorAll('#identityResultsList .ai-result-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selection to clicked item
                const selectedItem = document.querySelectorAll('#identityResultsList .ai-result-item')[index];
                selectedItem.classList.add('selected');
                
                // Update selected NIK and auto-fill form
                this.selectedIdentityNIK = this.identityFaceResults[index].nik;
                this.autoFillIdentityForm(this.identityFaceResults[index]);
            }

            autoFillIdentityForm(result) {
                // Auto-fill NIK field
                const nikInput = document.getElementById('nik');
                nikInput.value = result.nik;
                nikInput.classList.add('ai-filled');
                
                // Auto-fill Name field
                const nameInput = document.getElementById('name');
                nameInput.value = result.name || '';
                nameInput.classList.add('ai-filled');
                
                this.showMessage(`Form berhasil diisi: ${result.name} - ${result.nik}`, 'success');
            }
        }

        // Global functions
        const app = new ProfilingApp();

        function handleSubmit() {
            app.handleSubmit();
        }

        function clearForm() {
            app.clearForm();
        }

        // ============================================================================
        // CHATBOT FUNCTIONS
        // ============================================================================

        function toggleChatbot() {
            const container = document.getElementById('chatbotContainer');
            container.classList.toggle('collapsed');
        }

        // Auto Dropdown Functions
        let currentAutoMode = null;

        function toggleAutoDropdown() {
            const wrapper = document.getElementById('autoDropdownWrapper');
            if (wrapper) {
                wrapper.classList.toggle('active');
            }
        }

        function setAutoMode(mode) {
            currentAutoMode = mode;
            const wrapper = document.getElementById('autoDropdownWrapper');
            if (!wrapper) return;
            
            const btn = wrapper.querySelector('.auto-dropdown-btn span');
            if (!btn) return;
            
            const modeNames = {
                'nik': 'Auto NIK',
                'nama': 'Auto Nama',
                'phone': 'Auto No HP',
                'kombinasi': 'Auto Kombinasi'
            };
            
            btn.textContent = modeNames[mode] || 'Auto';
            wrapper.classList.remove('active');
            
            // Auto-fill input with command based on mode
            const input = document.getElementById('chatbotInput');
            if (input) {
                if (mode === 'nik') {
                    input.value = 'Cari NIK ';
                    input.placeholder = 'Masukkan NIK...';
                } else if (mode === 'nama') {
                    input.value = 'Cari nama ';
                    input.placeholder = 'Masukkan Nama...';
                } else if (mode === 'phone') {
                    input.value = 'Cari no HP ';
                    input.placeholder = 'Masukkan No HP...';
                } else if (mode === 'kombinasi') {
                    input.value = 'Cari NIK nama ';
                    input.placeholder = 'Masukkan NIK, Nama, atau No HP...';
                }
                // Focus and move cursor to end
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const wrapper = document.getElementById('autoDropdownWrapper');
            if (wrapper && !wrapper.contains(event.target)) {
                wrapper.classList.remove('active');
            }
        });

        function fillChatbotInput(text) {
            const input = document.getElementById('chatbotInput');
            input.value = text;
            input.focus();
        }

        function handleChatbotKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleChatbotSubmit();
            }
        }

        // Smart Query Suggestions Variables
        let suggestionsDebounceTimer = null;
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');

        // Handle input with debounce for suggestions
        function handleChatbotInput(event) {
            const query = event.target.value.trim();
            
            // Clear previous debounce timer
            if (suggestionsDebounceTimer) {
                clearTimeout(suggestionsDebounceTimer);
            }
            
            // Hide suggestions if query is empty or too short
            if (!query || query.length < 2) {
                hideSuggestions();
                return;
            }
            
            // Debounce API call (wait 500ms after user stops typing - increased from 300ms)
            suggestionsDebounceTimer = setTimeout(() => {
                // Double check query is still valid before fetching
                const currentQuery = document.getElementById('chatbotInput')?.value.trim();
                if (currentQuery && currentQuery.length >= 2) {
                    fetchQuerySuggestions(currentQuery);
                } else {
                    hideSuggestions();
                }
            }, 500);
        }

        // Handle focus event - only show suggestions if there's meaningful input
        function handleChatbotInputFocus(event) {
            const query = event.target.value.trim();
            // Only show suggestions if query has at least 2 characters
            if (query && query.length >= 2) {
                // Add small delay to prevent aggressive showing
                setTimeout(() => {
                    const currentQuery = document.getElementById('chatbotInput')?.value.trim();
                    if (currentQuery && currentQuery.length >= 2) {
                        fetchQuerySuggestions(currentQuery);
                    }
                }, 200);
            }
        }

        // Handle blur event (with delay to allow clicks on suggestions)
        function handleChatbotInputBlur(event) {
            setTimeout(() => {
                hideSuggestions();
            }, 200);
        }

        // Handle keyboard navigation
        function handleChatbotKeyDown(event) {
            const dropdown = document.getElementById('querySuggestionsDropdown');
            if (!dropdown || !dropdown.classList.contains('active')) {
                return;
            }

            const suggestions = dropdown.querySelectorAll('.suggestion-item');
            if (suggestions.length === 0) {
                return;
            }

            switch(event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                    updateSelectedSuggestion(suggestions);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSelectedSuggestion(suggestions);
                    break;
                case 'Enter':
                    if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestions.length) {
                        event.preventDefault();
                        const selectedSuggestion = currentSuggestions[selectedSuggestionIndex];
                        if (selectedSuggestion) {
                            fillChatbotInput(selectedSuggestion.query);
                            hideSuggestions();
                        }
                    }
                    break;
                case 'Escape':
                    event.preventDefault();
                    hideSuggestions();
                    break;
            }
        }

        function updateSelectedSuggestion(suggestions) {
            suggestions.forEach((item, index) => {
                if (index === selectedSuggestionIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Fetch query suggestions from API
        async function fetchQuerySuggestions(query) {
            const dropdown = document.getElementById('querySuggestionsDropdown');
            if (!dropdown) return;

            // Validate query before making API call
            const trimmedQuery = query.trim();
            if (!trimmedQuery || trimmedQuery.length < 2) {
                hideSuggestions();
                return;
            }

            // Check if input is still focused (user is still typing/interacting)
            const input = document.getElementById('chatbotInput');
            if (!input || document.activeElement !== input) {
                // Input is not focused, don't show suggestions
                return;
            }

            // Show loading state
            dropdown.innerHTML = `
                <div class="suggestions-loading">
                    <i class="fas fa-spinner"></i>
                    Mencari suggestions...
                </div>
            `;
            dropdown.classList.add('active');

            try {
                const response = await fetch('/api/chatbot/query-suggestions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('session_token')}`
                    },
                    body: JSON.stringify({
                        query: trimmedQuery,
                        search_history: searchHistory.slice(-5) // Last 5 searches
                    })
                });

                const data = await response.json();
                
                // Double check input is still focused before displaying
                if (document.activeElement !== input) {
                    hideSuggestions();
                    return;
                }
                
                if (data.success) {
                    currentSuggestions = data.suggestions || [];
                    displaySuggestions(data);
                } else {
                    hideSuggestions();
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                hideSuggestions();
            }
        }

        // Display suggestions in dropdown
        function displaySuggestions(data) {
            const dropdown = document.getElementById('querySuggestionsDropdown');
            if (!dropdown) return;

            // Check if input is still focused before showing suggestions
            const input = document.getElementById('chatbotInput');
            if (!input || document.activeElement !== input) {
                // Input is not focused, don't show suggestions
                hideSuggestions();
                return;
            }

            const suggestions = data.suggestions || [];
            const typoCorrections = data.typo_corrections || [];
            const quickActions = data.quick_actions || [];

            if (suggestions.length === 0 && typoCorrections.length === 0 && quickActions.length === 0) {
                // Don't show "no suggestions" message, just hide
                hideSuggestions();
                return;
            }

            let html = `
                <div class="suggestions-header">
                    <i class="fas fa-magic"></i>
                    <span>Smart Suggestions</span>
                </div>
            `;

            // Typo corrections section
            if (typoCorrections.length > 0) {
                html += `
                    <div class="typo-corrections">
                        <div class="typo-corrections-header">
                            <i class="fas fa-spell-check"></i>
                            Koreksi Typo
                        </div>
                        ${typoCorrections.map(correction => `
                            <span class="typo-correction-item" onclick="applyTypoCorrection('${correction.original}', '${correction.corrected}')">
                                <span class="typo-original">${correction.original}</span>
                                <span class="typo-arrow">â†’</span>
                                <span class="typo-corrected">${correction.corrected}</span>
                            </span>
                        `).join('')}
                    </div>
                `;
            }

            // Suggestions list
            if (suggestions.length > 0) {
                html += suggestions.map((suggestion, index) => {
                    const iconClass = getSuggestionIconClass(suggestion.type);
                    const icon = getSuggestionIcon(suggestion.type);
                    const confidence = Math.round(suggestion.confidence * 100);
                    
                    return `
                        <div class="suggestion-item" onclick="selectSuggestion(${index})" data-index="${index}">
                            <div class="suggestion-item-icon ${suggestion.type}">
                                <i class="${icon}"></i>
                            </div>
                            <div class="suggestion-item-content">
                                <div class="suggestion-item-query">${escapeHtml(suggestion.query)}</div>
                                <div class="suggestion-item-description">${escapeHtml(suggestion.description || '')}</div>
                            </div>
                            <div class="suggestion-item-confidence">${confidence}%</div>
                        </div>
                    `;
                }).join('');
            }

            // Quick actions section
            if (quickActions.length > 0) {
                html += `
                    <div class="quick-actions">
                        <div class="quick-actions-header">
                            <i class="fas fa-bolt"></i>
                            Quick Actions
                        </div>
                        <div class="quick-actions-grid">
                            ${quickActions.map(action => `
                                <button class="quick-action-btn" onclick="fillChatbotInput('${action.action}')">
                                    <i class="fas fa-${action.icon || 'search'}"></i>
                                    <span>${escapeHtml(action.action)}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            dropdown.innerHTML = html;
            dropdown.classList.add('active');
            selectedSuggestionIndex = -1;
        }

        function getSuggestionIconClass(type) {
            const iconMap = {
                'complete': 'complete',
                'typo_fix': 'typo_fix',
                'combination': 'combination',
                'alternative': 'alternative'
            };
            return iconMap[type] || 'alternative';
        }

        function getSuggestionIcon(type) {
            const iconMap = {
                'complete': 'fa-check-circle',
                'typo_fix': 'fa-spell-check',
                'combination': 'fa-layer-group',
                'alternative': 'fa-lightbulb'
            };
            return iconMap[type] || 'fa-lightbulb';
        }

        function selectSuggestion(index) {
            if (currentSuggestions[index]) {
                const suggestion = currentSuggestions[index];
                fillChatbotInput(suggestion.query);
                hideSuggestions();
                
                // Add to search history
                addToSearchHistory(suggestion.query);
            }
        }

        function applyTypoCorrection(original, corrected) {
            const input = document.getElementById('chatbotInput');
            if (input) {
                const currentValue = input.value;
                const correctedValue = currentValue.replace(original, corrected);
                input.value = correctedValue;
                input.focus();
                
                // Trigger suggestions update
                handleChatbotInput({ target: input });
            }
        }

        function hideSuggestions() {
            const dropdown = document.getElementById('querySuggestionsDropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
                selectedSuggestionIndex = -1;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addToSearchHistory(query) {
            // Remove if already exists
            searchHistory = searchHistory.filter(q => q !== query);
            // Add to beginning
            searchHistory.unshift(query);
            // Keep only last 20
            searchHistory = searchHistory.slice(0, 20);
            // Save to localStorage
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        // Voice Input Functions
        let recognition = null;
        let isRecording = false;

        function initSpeechRecognition() {
            // Check if browser supports speech recognition
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech recognition not supported in this browser');
                return false;
            }

            // Initialize speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'id-ID'; // Indonesian language

            recognition.onstart = () => {
                isRecording = true;
                const voiceBtn = document.getElementById('chatbotVoiceBtn');
                if (voiceBtn) {
                    voiceBtn.classList.add('recording');
                    voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    voiceBtn.title = 'Menghentikan rekaman...';
                }
                
                // Show recording indicator in chatbot
                addChatbotMessage('ðŸŽ¤ Mendengarkan...', 'bot');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('chatbotInput');
                if (input) {
                    input.value = transcript;
                    // Auto-submit after getting result
                    setTimeout(() => {
                        handleChatbotSubmit();
                    }, 500);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                stopVoiceRecording();
                
                let errorMessage = 'Terjadi kesalahan saat merekam suara.';
                if (event.error === 'no-speech') {
                    errorMessage = 'Tidak ada suara terdeteksi. Silakan coba lagi.';
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'Tidak dapat mengakses mikrofon. Pastikan mikrofon sudah diizinkan.';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'Akses mikrofon ditolak. Silakan izinkan akses mikrofon di pengaturan browser.';
                }
                
                addChatbotMessage(errorMessage, 'bot');
            };

            recognition.onend = () => {
                stopVoiceRecording();
            };

            return true;
        }

        function toggleVoiceInput() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    addChatbotMessage('Voice input tidak didukung di browser ini. Silakan gunakan browser modern seperti Chrome atau Edge.', 'bot');
                    return;
                }
            }

            if (isRecording) {
                stopVoiceRecording();
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    addChatbotMessage('Tidak dapat memulai rekaman. Silakan coba lagi.', 'bot');
                }
            }
        }

        function stopVoiceRecording() {
            isRecording = false;
            const voiceBtn = document.getElementById('chatbotVoiceBtn');
            if (voiceBtn) {
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceBtn.title = 'Voice Input';
            }
        }

        // Initialize speech recognition will be called in main DOMContentLoaded

        async function handleChatbotFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                addChatbotMessage('Format file tidak didukung. Silakan gunakan file gambar (JPG, PNG, GIF) atau PDF.', 'bot');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                addChatbotMessage('File terlalu besar. Maksimal ukuran file adalah 10MB.', 'bot');
                return;
            }

            // Show uploading state
            const uploadBtn = document.getElementById('chatbotUploadBtn');
            uploadBtn.classList.add('uploading');
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Add user message
            addChatbotMessage(`ðŸ“Ž Mengupload file: ${file.name}`, 'user');

            // Show typing indicator
            const typingId = addTypingIndicator();

            try {
                // Create FormData
                const formData = new FormData();
                formData.append('file', file);

                // Get session token
                const sessionToken = localStorage.getItem('session_token');
                if (!sessionToken) {
                    throw new Error('Session token tidak ditemukan. Silakan login ulang.');
                }

                // Upload file to extract document
                const response = await fetch('/api/chatbot/extract-document', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const result = await response.json();
                removeTypingIndicator(typingId);
                uploadBtn.classList.remove('uploading');
                uploadBtn.innerHTML = '<i class="fas fa-paperclip"></i>';

                if (result.success && result.extracted_data && result.extracted_data.length > 0) {
                    // Display extracted data list
                    displayExtractedDataList(result.extracted_data, file.name);
                } else {
                    // No data extracted
                    addChatbotMessage(
                        result.error || 'Tidak dapat mengekstrak data dari dokumen. Pastikan dokumen jelas dan mengandung informasi NIK, nama, atau nomor HP.',
                        'bot'
                    );
                }

            } catch (error) {
                removeTypingIndicator(typingId);
                uploadBtn.classList.remove('uploading');
                uploadBtn.innerHTML = '<i class="fas fa-paperclip"></i>';
                addChatbotMessage(`Maaf, terjadi kesalahan saat memproses file: ${error.message}`, 'bot');
                console.error('File upload error:', error);
            }

            // Reset file input
            event.target.value = '';
        }

        function displayExtractedDataList(extractedData, fileName) {
            const messagesContainer = document.getElementById('chatbotMessages');
            
            // Create message container
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chatbot-message bot-message';
            messageDiv.innerHTML = `
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <p><strong>âœ… Data berhasil diekstrak dari ${fileName}</strong></p>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Pilih data yang ingin dicari:</p>
                    <div class="extracted-data-list">
                        <h4><i class="fas fa-list"></i> Hasil Deteksi (${extractedData.length} data)</h4>
                        ${extractedData.map((item, index) => `
                            <div class="extracted-data-item" data-index="${index}">
                                <div class="extracted-data-item-header">
                                    <span class="extracted-data-item-title">Data ${index + 1}</span>
                                    <button class="extracted-data-item-select" onclick="selectExtractedData(${index})">
                                        <i class="fas fa-search"></i> Cari
                                    </button>
                                </div>
                                <div class="extracted-data-item-fields">
                                    <div class="extracted-data-field">
                                        <i class="fas fa-id-card"></i>
                                        <span class="extracted-data-field-value">${item.nik || '-'}</span>
                                    </div>
                                    <div class="extracted-data-field">
                                        <i class="fas fa-user"></i>
                                        <span class="extracted-data-field-value">${item.name || '-'}</span>
                                    </div>
                                    <div class="extracted-data-field">
                                        <i class="fas fa-phone"></i>
                                        <span class="extracted-data-field-value">${item.phone || '-'}</span>
                                    </div>
                                    <div class="extracted-data-field">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span class="extracted-data-field-value">${item.location || '-'}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Store extracted data globally for selection
            window.extractedDataList = extractedData;
        }

        async function selectExtractedData(index) {
            // Get item from stored extracted data list
            if (!window.extractedDataList || !window.extractedDataList[index]) {
                addChatbotMessage('Data tidak ditemukan. Silakan upload file lagi.', 'bot');
                return;
            }

            const item = window.extractedDataList[index];
            
            // Build query from extracted data
            let queryParts = [];
            if (item.nik && item.nik.trim()) queryParts.push(`NIK ${item.nik.trim()}`);
            if (item.name && item.name.trim()) queryParts.push(`nama ${item.name.trim()}`);
            if (item.phone && item.phone.trim()) queryParts.push(`no HP ${item.phone.trim()}`);
            if (item.location && item.location.trim()) queryParts.push(`lokasi ${item.location.trim()}`);

            const query = queryParts.length > 0 ? `Cari ${queryParts.join(' ')}` : '';

            if (query) {
                // Add message showing selected data
                addChatbotMessage(`âœ… Memilih Data ${index + 1} untuk pencarian`, 'user');
                
                // Fill input and submit
                const input = document.getElementById('chatbotInput');
                input.value = query;
                await handleChatbotSubmit();
            } else {
                addChatbotMessage('Data yang dipilih tidak memiliki informasi yang cukup untuk pencarian.', 'bot');
            }
        }

        async function handleChatbotSubmit() {
            const input = document.getElementById('chatbotInput');
            const query = input.value.trim();
            
            if (!query) {
                return;
            }

            // Hide suggestions
            hideSuggestions();

            // Add to search history
            addToSearchHistory(query);

            // Add user message
            addChatbotMessage(query, 'user');
            input.value = '';

            // Show typing indicator
            const typingId = addTypingIndicator();

            try {
                // IMPORTANT: Check if it's a greeting/conversation FIRST before parsing
                // This prevents greetings from being treated as search queries
                const isGreeting = isGreetingOrGeneralQuery(query);
                
                if (isGreeting) {
                    // Get AI response for greeting/conversation - NO SEARCH
                    removeTypingIndicator(typingId);
                    const aiResponse = await getGreetingResponse(query);
                    // Use streaming effect for AI response
                    addChatbotMessage(aiResponse, 'bot', null, true);
                    return; // IMPORTANT: Exit early, don't proceed to search
                }
                
                // Check if query contains explicit search keywords
                // If no search keyword, treat as conversation even if it has numbers/names
                const lowerQuery = query.toLowerCase();
                const searchKeywords = ['cari', 'search', 'find', 'carikan', 'cariin', 'tolong cari'];
                const hasExplicitSearchKeyword = searchKeywords.some(keyword => lowerQuery.includes(keyword));
                
                if (!hasExplicitSearchKeyword) {
                    // No explicit search keyword - treat as general conversation
                    // Don't search even if it has numbers or names
                    removeTypingIndicator(typingId);
                    const clarificationResponse = await getClarificationResponse(query);
                    // Use streaming effect for clarification response
                    addChatbotMessage(clarificationResponse, 'bot', null, true);
                    return; // Exit early, don't proceed to search
                }
                
                // Only parse if it has explicit search keyword
                const parsed = parseNaturalLanguageQuery(query);
                
                // Check if we have valid search parameters
                const hasSearchParams = parsed.nik || parsed.name || parsed.phone || parsed.location;
                
                if (hasSearchParams) {
                    // Valid search parameters found - proceed with search
                    // Add bot response with parsed data (no streaming for parsed data)
                    removeTypingIndicator(typingId);
                    addChatbotMessage(formatParsedResponse(parsed), 'bot', parsed);

                    // Auto-fill form and trigger search
                    await autoFillAndSearch(parsed, query);
                } else {
                    // Has search keyword but no valid parameters - ask for clarification
                    removeTypingIndicator(typingId);
                    const clarificationResponse = await getClarificationResponse(query);
                    // Use streaming effect for clarification response
                    addChatbotMessage(clarificationResponse, 'bot', null, true);
                }

            } catch (error) {
                removeTypingIndicator(typingId);
                addChatbotMessage(`Maaf, terjadi kesalahan: ${error.message}`, 'bot');
                console.error('Chatbot error:', error);
            }
        }

        function isGreetingOrGeneralQuery(query) {
            const lowerQuery = query.toLowerCase().trim();
            
            // IMPORTANT: If query contains search keywords, it's NOT a greeting
            const searchKeywords = ['cari', 'search', 'find'];
            const hasSearchKeyword = searchKeywords.some(keyword => lowerQuery.includes(keyword));
            if (hasSearchKeyword) {
                return false; // This is a search query, not a greeting
            }
            
            // IMPORTANT: If query contains search parameters, it's NOT a greeting
            // Check for NIK pattern (16 digits)
            if (/\b\d{16}\b/.test(query)) {
                return false; // Contains NIK, this is a search query
            }
            
            // Check for phone number pattern
            if (/\b(\+?62|0)?[\s-]?(\d{3,4})[\s-]?(\d{3,4})[\s-]?(\d{3,4})\b/.test(query) || 
                /\b\d{10,13}\b/.test(query)) {
                return false; // Contains phone number, this is a search query
            }
            
            // Check for explicit search parameter keywords
            const searchParamKeywords = ['nik', 'nama', 'hp', 'phone', 'no hp', 'nomor hp', 'lokasi', 'location', 'provinsi'];
            const hasSearchParam = searchParamKeywords.some(keyword => lowerQuery.includes(keyword));
            if (hasSearchParam) {
                return false; // Contains search parameter keyword, this is a search query
            }
            
            // List of greetings and general queries (expanded)
            const greetings = [
                'halo', 'hello', 'hi', 'hai', 'hey', 'hei', 'hallo',
                'selamat pagi', 'selamat siang', 'selamat sore', 'selamat malam',
                'pagi', 'siang', 'sore', 'malam',
                'apa kabar', 'kabar', 'how are you', 'gimana kabar', 'gimana',
                'terima kasih', 'thanks', 'thank you', 'makasih', 'terimakasih',
                'sama-sama', 'you\'re welcome', 'sama sama',
                'tolong', 'help', 'bantuan', 'help me', 'bantu',
                'bagaimana cara', 'cara menggunakan', 'how to use', 'cara pakai',
                'apa itu', 'what is', 'jelaskan', 'explain',
                'siapa', 'who', 'dimana', 'where', 'kapan', 'when',
                'kenapa', 'why', 'mengapa', 'bagaimana', 'how',
                'baik', 'oke', 'ok', 'okay', 'ya', 'yes', 'tidak', 'no',
                'saya', 'aku', 'anda', 'kamu', 'you', 'i',
                'permisi', 'excuse me', 'maaf', 'sorry',
                'selamat', 'congratulations', 'selamat datang', 'welcome'
            ];
            
            // Check if query is exactly a greeting (exact match or starts/ends with greeting)
            for (const greeting of greetings) {
                if (lowerQuery === greeting || 
                    lowerQuery.startsWith(greeting + ' ') || 
                    lowerQuery.endsWith(' ' + greeting) ||
                    lowerQuery.includes(' ' + greeting + ' ')) {
                    return true;
                }
            }
            
            // Check if query is very short and doesn't contain numbers (likely greeting/conversation)
            // BUT only if it doesn't contain search keywords
            if (lowerQuery.length <= 15 && !/\d/.test(lowerQuery) && !hasSearchKeyword) {
                // Check if it contains common greeting/conversation words
                const conversationWords = [
                    'halo', 'hi', 'hai', 'hey', 'pagi', 'siang', 'sore', 'malam',
                    'kabar', 'gimana', 'bagaimana',
                    'kenapa', 'mengapa', 'tolong', 'bantu', 'help', 'bantuan',
                    'terima kasih', 'makasih', 'maaf', 'permisi', 'selamat'
                ];
                for (const word of conversationWords) {
                    if (lowerQuery.includes(word)) {
                        return true;
                    }
                }
            }
            
            // Check if query is a question (starts with question words)
            // BUT only if it doesn't contain search keywords
            const questionWords = ['apa', 'siapa', 'dimana', 'kapan', 'kenapa', 'mengapa', 'bagaimana', 'how', 'what', 'who', 'where', 'when', 'why'];
            const firstWord = lowerQuery.split(' ')[0];
            if (questionWords.includes(firstWord) && lowerQuery.length < 50 && !hasSearchKeyword) {
                // But exclude if it's a search-related question
                if (!lowerQuery.includes('cari') && !lowerQuery.includes('search') && !lowerQuery.includes('find')) {
                    return true;
                }
            }
            
            // Check if query doesn't contain search keywords and is conversational
            // Be more strict: only return true if it's clearly conversational
            if (!hasSearchKeyword && !hasSearchParam && lowerQuery.length < 50) {
                // Check if it's a simple conversational statement (no numbers, no search params)
                const hasNumbers = /\d{4,}/.test(lowerQuery); // 4+ consecutive digits
                
                if (!hasNumbers && !hasSearchParam) {
                    // Likely a conversational query - no numbers, no search params, no search keywords
                    return true;
                }
            }
            
            return false;
        }

        async function getGreetingResponse(query) {
            try {
                const response = await fetch('/api/chatbot/gemini-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        search_params: {},
                        search_results: {},
                        has_results: false,
                        is_greeting: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.response;
                } else {
                    // Fallback response
                    return `Halo! Saya AI Assistant untuk Profiling. Saya bisa membantu Anda mencari data identitas dengan cara yang mudah.\n\nAnda bisa mencari dengan mengetik:\nâ€¢ "Cari NIK 1505041107830002"\nâ€¢ "Cari nama Jambi"\nâ€¢ "Cari no HP 6285755349653"\nâ€¢ Atau kombinasi parameter lainnya\n\nAda yang bisa saya bantu?`;
                }
            } catch (error) {
                console.error('Error getting greeting response:', error);
                // Fallback response
                return `Halo! Saya AI Assistant untuk Profiling. Saya bisa membantu Anda mencari data identitas dengan cara yang mudah.\n\nAnda bisa mencari dengan mengetik:\nâ€¢ "Cari NIK 1505041107830002"\nâ€¢ "Cari nama Jambi"\nâ€¢ "Cari no HP 6285755349653"\nâ€¢ Atau kombinasi parameter lainnya\n\nAda yang bisa saya bantu?`;
            }
        }

        async function getClarificationResponse(query) {
            try {
                const response = await fetch('/api/chatbot/gemini-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        search_params: {},
                        search_results: {},
                        has_results: false,
                        needs_clarification: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.response;
                } else {
                    // Fallback response
                    return `Maaf, saya tidak dapat memahami permintaan Anda. Untuk melakukan pencarian, silakan berikan salah satu atau kombinasi dari:\n\nâ€¢ NIK (16 digit)\nâ€¢ Nama lengkap\nâ€¢ Nomor HP\nâ€¢ Lokasi (Provinsi)\n\nContoh: "Cari NIK 1505041107830002" atau "Cari nama Jambi"`;
                }
            } catch (error) {
                console.error('Error getting clarification response:', error);
                // Fallback response
                return `Maaf, saya tidak dapat memahami permintaan Anda. Untuk melakukan pencarian, silakan berikan salah satu atau kombinasi dari:\n\nâ€¢ NIK (16 digit)\nâ€¢ Nama lengkap\nâ€¢ Nomor HP\nâ€¢ Lokasi (Provinsi)\n\nContoh: "Cari NIK 1505041107830002" atau "Cari nama Jambi"`;
            }
        }

        function parseNaturalLanguageQuery(query) {
            const lowerQuery = query.toLowerCase();
            const parsed = {
                nik: null,
                name: null,
                phone: null,
                location: null,
                searchType: 'identity' // default
            };

            // IMPORTANT: Exclude greeting words from being parsed as names
            const greetingWords = [
                'halo', 'hello', 'hi', 'hai', 'hey', 'hei', 'hallo',
                'selamat pagi', 'selamat siang', 'selamat sore', 'selamat malam',
                'pagi', 'siang', 'sore', 'malam',
                'apa kabar', 'kabar', 'gimana kabar', 'gimana',
                'terima kasih', 'thanks', 'thank you', 'makasih', 'terimakasih',
                'sama-sama', 'sama sama',
                'tolong', 'help', 'bantuan', 'bantu',
                'baik', 'oke', 'ok', 'okay', 'ya', 'yes', 'tidak', 'no',
                'permisi', 'maaf', 'sorry'
            ];
            
            // If query is just a greeting word, don't parse it
            const trimmedQuery = query.trim();
            if (greetingWords.some(greeting => trimmedQuery.toLowerCase() === greeting || 
                trimmedQuery.toLowerCase().startsWith(greeting + ' ') ||
                trimmedQuery.toLowerCase().endsWith(' ' + greeting))) {
                return parsed; // Return empty parsed object
            }

            // IMPORTANT: Check if query contains "NIK" or "nik" keyword first
            // If it does, prioritize NIK extraction
            const hasNikKeyword = /\bnik\b/i.test(query);
            
            // Extract NIK (16 digits) - handle both continuous and spaced formats
            let nikMatch = null;
            let extractedNik = null;
            
            // Pattern 1: 16 digits continuous
            const nikPatternContinuous = /\b(\d{16})\b/g;
            const continuousMatch = query.match(nikPatternContinuous);
            if (continuousMatch) {
                extractedNik = continuousMatch[0];
            }
            
            // Pattern 2: NIK with spaces (e.g., "157106 2703 97001" or "1571 0627 0397 0001")
            // This handles voice input where NIK might be spoken with pauses
            if (!extractedNik) {
                // Try multiple patterns for spaced NIK
                const spacedPatterns = [
                    /(\d{6}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{2})/,  // "157106 2703 9700 01"
                    /(\d{4,6}[\s-]?\d{3,4}[\s-]?\d{3,4}[\s-]?\d{3,4})/,  // "1571 0627 0397 0001"
                    /(\d{6}[\s-]?\d{4}[\s-]?\d{6})/,  // "157106 2703 970001"
                    /(\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4})/,  // "1571 0627 0397 0001"
                ];
                
                for (const pattern of spacedPatterns) {
                    const spacedMatch = query.match(pattern);
                    if (spacedMatch) {
                        const cleaned = spacedMatch[1].replace(/[\s-]/g, '');
                        if (cleaned.length === 16 && /^\d{16}$/.test(cleaned)) {
                            extractedNik = cleaned;
                            break;
                        }
                    }
                }
            }
            
            // Pattern 3: If "NIK" keyword is present, look for digits after it (with or without spaces)
            if (!extractedNik && hasNikKeyword) {
                // Match "NIK" followed by digits (with possible spaces)
                const nikAfterKeywordPatterns = [
                    /nik\s+(\d{4,6}[\s-]?\d{3,4}[\s-]?\d{3,4}[\s-]?\d{3,4})/i,
                    /nik\s+(\d{16})/i,
                    /nik\s+(\d{6}[\s-]?\d{4}[\s-]?\d{6})/i,
                    /nik\s+(\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4})/i
                ];
                
                for (const pattern of nikAfterKeywordPatterns) {
                    const keywordMatch = query.match(pattern);
                    if (keywordMatch) {
                        const cleaned = keywordMatch[1].replace(/[\s-]/g, '');
                        if (cleaned.length === 16 && /^\d{16}$/.test(cleaned)) {
                            extractedNik = cleaned;
                            break;
                        }
                    }
                }
            }
            
            // Pattern 4: Extract all digits from query and check if they form a 16-digit NIK
            // This is a fallback for voice input where NIK might be very spaced out
            if (!extractedNik && hasNikKeyword) {
                // Extract all digits from the part after "NIK"
                const nikKeywordMatch = query.match(/nik\s+(.+)/i);
                if (nikKeywordMatch) {
                    const afterNik = nikKeywordMatch[1];
                    // Remove all non-digits
                    const allDigits = afterNik.replace(/\D/g, '');
                    // Accept 14-16 digits (voice input might miss digits)
                    if (allDigits.length >= 14 && allDigits.length <= 16 && /^\d+$/.test(allDigits)) {
                        // Pad to 16 digits if needed
                        if (allDigits.length === 14) {
                            extractedNik = allDigits + '00'; // Pad with 00
                        } else if (allDigits.length === 15) {
                            extractedNik = allDigits + '0'; // Pad with 0
                        } else {
                            extractedNik = allDigits; // Already 16 digits
                        }
                        // Validate it's exactly 16 digits after padding
                        if (extractedNik.length === 16 && /^\d{16}$/.test(extractedNik)) {
                            // Valid NIK - keep it
                        } else {
                            extractedNik = null; // Invalid
                        }
                    }
                }
            }
            
            // Pattern 5: If still no NIK but has keyword, try to find any digit sequence after "NIK"
            // This handles cases where NIK is very spaced out or has other text
            if (!extractedNik && hasNikKeyword) {
                const nikKeywordMatch = query.match(/nik\s+(.+)/i);
                if (nikKeywordMatch) {
                    const afterNik = nikKeywordMatch[1];
                    // Try to find spaced digits that might form NIK
                    const digitGroups = afterNik.match(/\d+/g);
                    if (digitGroups && digitGroups.length > 0) {
                        const combined = digitGroups.join('');
                        if (combined.length >= 14 && combined.length <= 16 && /^\d+$/.test(combined)) {
                            // Pad to 16 digits if needed
                            if (combined.length === 14) {
                                extractedNik = combined + '00';
                            } else if (combined.length === 15) {
                                extractedNik = combined + '0';
                            } else {
                                extractedNik = combined;
                            }
                            // Validate
                            if (extractedNik.length === 16 && /^\d{16}$/.test(extractedNik)) {
                                // Valid NIK
                            } else {
                                extractedNik = null;
                            }
                        }
                    }
                }
            }
            
            if (extractedNik) {
                parsed.nik = extractedNik;
            }

            // Extract phone number (various formats)
            // IMPORTANT: Only extract phone if NIK is not found AND no "NIK" keyword
            // Also check that the phone number is not part of a NIK sequence
            if (!parsed.nik && !hasNikKeyword) {
                const phonePatterns = [
                    /\b(\+?62|0)?[\s-]?(\d{3,4})[\s-]?(\d{3,4})[\s-]?(\d{3,4})\b/g,
                    /\b(\d{10,13})\b/g
                ];
                for (const pattern of phonePatterns) {
                    const phoneMatch = query.match(pattern);
                    if (phoneMatch) {
                        const phone = phoneMatch[0].replace(/[\s-]/g, '');
                        // IMPORTANT: Don't treat 16-digit numbers as phone (they're likely NIK)
                        if (phone.length === 16) {
                            continue; // Skip, this is likely a NIK
                        }
                        // IMPORTANT: Don't treat 14-15 digit numbers as phone if they might be part of NIK
                        if (phone.length >= 14 && phone.length <= 15) {
                            // Check if there are more digits nearby that could form a 16-digit NIK
                            const phoneIndex = query.indexOf(phoneMatch[0]);
                            const beforePhone = query.substring(Math.max(0, phoneIndex - 10), phoneIndex);
                            const afterPhone = query.substring(phoneIndex + phoneMatch[0].length, phoneIndex + phoneMatch[0].length + 10);
                            const nearbyDigits = (beforePhone + afterPhone).replace(/\D/g, '');
                            // If nearby digits could form a 16-digit number, skip this phone match
                            if (phone.length + nearbyDigits.length >= 16) {
                                continue; // This might be part of a NIK
                            }
                        }
                        if (phone.length >= 10 && phone.length <= 13) {
                            // Normalize phone number
                            let normalized = phone;
                            if (normalized.startsWith('0')) {
                                normalized = '62' + normalized.substring(1);
                            } else if (!normalized.startsWith('62')) {
                                normalized = '62' + normalized;
                            }
                            parsed.phone = normalized;
                            parsed.searchType = 'phone';
                            break;
                        }
                    }
                }
            }

            // Extract location (province names in Indonesia)
            const provinces = [
                'aceh', 'sumatera utara', 'sumut', 'sumatera barat', 'sumbar',
                'riau', 'kepulauan riau', 'kepri', 'jambi', 'sumatera selatan', 'sumsel',
                'bangka belitung', 'babel', 'bengkulu', 'lampung',
                'jakarta', 'dki jakarta', 'jawa barat', 'jabar', 'jawa tengah', 'jateng',
                'yogyakarta', 'jogja', 'jawa timur', 'jatim', 'banten',
                'bali', 'nusa tenggara barat', 'ntb', 'nusa tenggara timur', 'ntt',
                'kalimantan barat', 'kalbar', 'kalimantan tengah', 'kalteng',
                'kalimantan selatan', 'kalsel', 'kalimantan timur', 'kaltim',
                'kalimantan utara', 'kaltara', 'sulawesi utara', 'sulut',
                'sulawesi tengah', 'sulteng', 'sulawesi selatan', 'sulsel',
                'sulawesi tenggara', 'sultra', 'gorontalo', 'sulawesi barat', 'sulbar',
                'maluku', 'maluku utara', 'malut', 'papua barat', 'pabar', 'papua'
            ];

            for (const province of provinces) {
                if (lowerQuery.includes(province)) {
                    parsed.location = province;
                    break;
                }
            }

            // Extract name (words that are not NIK, phone, or location)
            // Look for patterns like "nama X", "cari X", "X" where X is not a number
            // Also handle patterns like "NIK 123 nama X" or "nama X NIK 123"
            const namePatterns = [
                /(?:nama|cari|search|find)\s+([a-zA-Z\s]{2,})(?:\s+(?:nik|no|hp|phone|provinsi|kota|kabupaten))?/i,
                /(?:nik|no|hp|phone)\s+\d+\s+(?:nama|cari|search|find)?\s*([a-zA-Z\s]{2,})/i,
                /(?:nama|cari|search|find)?\s*([a-zA-Z\s]{2,})\s+(?:nik|no|hp|phone)\s+\d+/i,
                /^([a-zA-Z\s]{2,})(?:\s+(?:nik|no|hp|phone|provinsi|kota|kabupaten))?/i
            ];

            for (const pattern of namePatterns) {
                const nameMatch = query.match(pattern);
                if (nameMatch && nameMatch[1]) {
                    let name = nameMatch[1].trim();
                    // Remove common words but keep location names that might be part of name
                    name = name.replace(/\b(nik|no|hp|phone|cari|search|find|nama|provinsi|kota|kabupaten)\b/gi, '').trim();
                    // Remove NIK if it was captured
                    name = name.replace(/\b\d{16}\b/g, '').trim();
                    // Only remove location if it's a standalone word, not part of a name
                    if (name.length >= 2 && !/^\d+$/.test(name)) {
                        // Check if the name is actually a location
                        const isLocation = provinces.some(p => name.toLowerCase().includes(p) || p.includes(name.toLowerCase()));
                        // Check if the name is actually a greeting word
                        const isGreetingWord = greetingWords.some(g => name.toLowerCase() === g || 
                            name.toLowerCase().includes(g) || g.includes(name.toLowerCase()));
                        if (!isLocation && !isGreetingWord) {
                            parsed.name = name;
                            break;
                        }
                    }
                }
            }

            // If no explicit name found but query doesn't contain numbers, treat as name
            // But exclude if it's a known location or greeting word
            if (!parsed.name && !parsed.nik && !parsed.phone && query.length >= 2 && !/^\d+$/.test(query)) {
                const words = query.split(/\s+/).filter(w => {
                    const lowerW = w.toLowerCase();
                    return !['cari', 'search', 'find', 'nama', 'nik', 'no', 'hp', 'phone'].includes(lowerW) &&
                           !provinces.some(p => lowerW.includes(p) || p.includes(lowerW)) &&
                           !greetingWords.some(g => lowerW === g || lowerW.includes(g) || g.includes(lowerW)) &&
                           !/^\d{16}$/.test(w); // Exclude NIK
                });
                if (words.length > 0) {
                    const potentialName = words.join(' ');
                    // Double check it's not a location or greeting
                    const isLocation = provinces.some(p => potentialName.toLowerCase().includes(p) || p.includes(potentialName.toLowerCase()));
                    const isGreeting = greetingWords.some(g => potentialName.toLowerCase() === g || 
                        potentialName.toLowerCase().includes(g) || g.includes(potentialName.toLowerCase()));
                    if (!isLocation && !isGreeting) {
                        parsed.name = potentialName;
                    }
                }
            }

            return parsed;
        }

        function formatParsedResponse(parsed) {
            const parts = [];
            
            if (parsed.nik) {
                parts.push(`<strong>NIK:</strong> ${parsed.nik}`);
            }
            if (parsed.name) {
                parts.push(`<strong>Nama:</strong> ${parsed.name}`);
            }
            if (parsed.phone) {
                parts.push(`<strong>No HP:</strong> ${parsed.phone}`);
            }
            if (parsed.location) {
                parts.push(`<strong>Lokasi:</strong> ${parsed.location}`);
            }

            if (parts.length === 0) {
                return 'Maaf, saya tidak dapat memahami permintaan Anda. Silakan coba lagi dengan format: "Cari NIK 1505041107830002" atau "Cari nama Jambi" atau "Cari no HP 6285755349653"';
            }

            return `Saya menemukan:<br>${parts.join('<br>')}<br><br>Mencari data...`;
        }

        function addChatbotMessage(text, type, parsed = null, useStreaming = false) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chatbot-message ${type}-message`;

            const avatar = type === 'bot' 
                ? '<i class="fas fa-robot"></i>'
                : '<i class="fas fa-user"></i>';

            let content = `<div class="message-avatar">${avatar}</div>`;
            
            if (useStreaming && type === 'bot') {
                // Create streaming message
                content += '<div class="message-content streaming">';
                content += '<p class="streaming-text"></p>';
            } else {
                content += '<div class="message-content">';
                content += `<p>${text}</p>`;
            }
            
            if (parsed && (parsed.nik || parsed.name || parsed.phone || parsed.location)) {
                content += '<div class="message-parsed">';
                content += '<strong>Data yang akan dicari:</strong><br>';
                if (parsed.nik) content += `NIK: ${parsed.nik}<br>`;
                if (parsed.name) content += `Nama: ${parsed.name}<br>`;
                if (parsed.phone) content += `No HP: ${parsed.phone}<br>`;
                if (parsed.location) content += `Lokasi: ${parsed.location}`;
                content += '</div>';
            }
            
            content += '</div>';

            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // If streaming, animate the text
            if (useStreaming && type === 'bot') {
                const textElement = messageDiv.querySelector('.streaming-text');
                if (textElement) {
                    streamText(textElement, text);
                }
            }
            
            return messageDiv;
        }

        function streamText(element, fullText) {
            // Check if text has HTML formatting
            const hasHTML = fullText.includes('<br>') || fullText.includes('<strong>') || fullText.includes('<em>') || fullText.includes('<code>');
            const hasMarkdown = fullText.includes('**') || fullText.includes('*') || fullText.includes('`') || fullText.includes('\n');
            
            // Extract plain text for streaming
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullText;
            let plainText = tempDiv.textContent || tempDiv.innerText || fullText;
            
            // If no HTML, use original text
            if (!hasHTML && !hasMarkdown) {
                plainText = fullText;
            }
            
            let index = 0;
            const speed = 12; // milliseconds per character (adjust for speed - lower = faster)
            const messagesContainer = document.getElementById('chatbotMessages');
            
            function typeChar() {
                if (index < plainText.length) {
                    // Get the character and add it
                    element.textContent = plainText.substring(0, index + 1);
                    index++;
                    
                    // Scroll to bottom as text streams
                    if (messagesContainer) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                    
                    // Continue typing
                    setTimeout(typeChar, speed);
                } else {
                    // Finished streaming, now add HTML formatting if needed
                    if (hasHTML || hasMarkdown) {
                        // Replace with formatted version
                        element.innerHTML = formatStreamedText(fullText);
                    }
                    // Remove cursor
                    element.classList.add('streaming-complete');
                }
            }
            
            // Start typing after a small delay for natural feel
            setTimeout(() => {
                typeChar();
            }, 300);
        }

        function formatStreamedText(text) {
            // Format text with line breaks and markdown-like formatting
            let formatted = text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-family: monospace;">$1</code>');
            
            return formatted;
        }

        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chatbotMessages');
            const typingId = 'typing-' + Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.id = typingId;
            typingDiv.className = 'chatbot-message bot-message';
            typingDiv.innerHTML = `
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content typing-indicator-content gemini-thinking">
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                    <p class="typing-text">AI sedang berpikir...</p>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return typingId;
        }

        function removeTypingIndicator(typingId) {
            const typingElement = document.getElementById(typingId);
            if (typingElement) {
                typingElement.remove();
            }
        }

        async function autoFillAndSearch(parsed, originalQuery) {
            try {
                // Switch to appropriate search type
                if (parsed.searchType === 'phone' && parsed.phone) {
                    switchSearchType('phone');
                    // Wait for form to be visible (even if hidden, form elements still work)
                    await new Promise(resolve => setTimeout(resolve, 100));
                    const phoneInput = document.getElementById('phoneNumber');
                    if (phoneInput) {
                        phoneInput.value = parsed.phone;
                        phoneInput.classList.add('ai-filled');
                    }
                } else if (parsed.nik || parsed.name || parsed.location) {
                    switchSearchType('identity');
                    // Wait for form to be visible (even if hidden, form elements still work)
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    if (parsed.nik) {
                        const nikInput = document.getElementById('nik');
                        if (nikInput) {
                            nikInput.value = parsed.nik;
                            nikInput.classList.add('ai-filled');
                        }
                    }
                    
                    if (parsed.name) {
                        const nameInput = document.getElementById('name');
                        if (nameInput) {
                            nameInput.value = parsed.name;
                            nameInput.classList.add('ai-filled');
                        }
                    }

                    // Handle location - try to match with province dropdown
                    if (parsed.location) {
                        // Load provinces if not loaded
                        const provinsiSelect = document.getElementById('provinsi');
                        if (provinsiSelect && provinsiSelect.options.length <= 1) {
                            await loadProvinces();
                        }
                        
                        // Try to find and select province
                        if (provinsiSelect) {
                            const locationLower = parsed.location.toLowerCase();
                            for (let i = 0; i < provinsiSelect.options.length; i++) {
                                const option = provinsiSelect.options[i];
                                const optionText = option.text.toLowerCase();
                                if (optionText.includes(locationLower) || 
                                    locationLower.includes(optionText) ||
                                    optionText.replace(/\s+/g, '').includes(locationLower.replace(/\s+/g, ''))) {
                                    provinsiSelect.value = option.value;
                                    // Update hidden field
                                    const noPropInput = document.getElementById('no_prop');
                                    if (noPropInput) {
                                        noPropInput.value = option.value;
                                    }
                                    // Trigger change event to load kabupaten
                                    provinsiSelect.dispatchEvent(new Event('change'));
                                    break;
                                }
                            }
                        }
                    }
                }

                // Auto-trigger search after a short delay
                setTimeout(async () => {
                    await handleSubmitWithChatbot(originalQuery || '', parsed);
                }, 500);

            } catch (error) {
                console.error('Error in autoFillAndSearch:', error);
                addChatbotMessage(`Terjadi kesalahan saat mengisi form: ${error.message}`, 'bot');
            }
        }

        async function loadProvinces() {
            try {
                const response = await fetch('/api/wilayah/provinsi');
                const result = await response.json();
                
                if (result.success) {
                    const select = document.getElementById('provinsi');
                    if (select.options.length <= 1) {
                        select.innerHTML = '<option value="">Pilih Provinsi</option>';
                        result.data.forEach(provinsi => {
                            const option = document.createElement('option');
                            option.value = provinsi.kode;
                            option.textContent = provinsi.nama;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
            }
        }

        async function handleSubmitWithChatbot(originalQuery, parsed) {
            // Show loading in chatbot
            const loadingId = addTypingIndicator();
            
            try {
                // Ensure results section is visible
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                }
                
                // Trigger search - use the existing handleSubmit function
                // Call handleSubmit which will call app.handleSubmit()
                handleSubmit();
                
                // Wait for search to complete and results to be displayed
                // Check results multiple times with delay
                let attempts = 0;
                let hasResults = false;
                let totalResults = 0;
                const maxAttempts = 40; // 20 seconds max wait
                
                while (attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const resultsCount = document.getElementById('resultsCount');
                    const loading = document.getElementById('loading');
                    const resultsContent = document.getElementById('resultsContent');
                    
                    // Check if loading is finished
                    const isLoading = loading && loading.style.display !== 'none';
                    
                    // Make sure results section stays visible
                    if (resultsSection) {
                        resultsSection.style.display = 'block';
                    }
                    
                    // Multiple ways to check for results
                    // Method 1: Check resultsCount text
                    if (!isLoading && resultsCount) {
                        const countText = resultsCount.textContent;
                        // Try to extract number from text (handles both "1 results" and "1 hasil")
                        const numberMatch = countText.match(/(\d+)/);
                        if (numberMatch) {
                            totalResults = parseInt(numberMatch[1]);
                            hasResults = totalResults > 0;
                            console.log('Found results count from text:', totalResults);
                        }
                    }
                    
                    // Method 2: Check resultsContent for actual result cards
                    if (!isLoading && resultsContent) {
                        const resultCards = resultsContent.querySelectorAll('.result-card');
                        const resultsGrid = resultsContent.querySelector('.results-grid');
                        
                        // Check if we have result cards (excluding empty message cards)
                        if (resultCards.length > 0) {
                            // Check if it's not the "no results" message
                            const isEmptyMessage = resultsContent.textContent.includes('Tidak Ada Hasil Ditemukan') ||
                                                   resultsContent.textContent.includes('No results found');
                            
                            if (!isEmptyMessage) {
                                hasResults = true;
                                if (totalResults === 0) {
                                    totalResults = resultCards.length;
                                }
                                console.log('Found result cards:', resultCards.length);
                            }
                        }
                        
                        // Also check if results grid exists and has children
                        if (resultsGrid && resultsGrid.children.length > 0) {
                            hasResults = true;
                            if (totalResults === 0) {
                                totalResults = resultsGrid.children.length;
                            }
                            console.log('Found results in grid:', resultsGrid.children.length);
                        }
                    }
                    
                    // Method 3: Check if results section is visible and has content
                    if (!isLoading && resultsSection && resultsSection.style.display !== 'none') {
                        const hasContent = resultsContent && (
                            resultsContent.querySelector('.results-grid') ||
                            (resultsContent.innerHTML.trim() !== '' && 
                             !resultsContent.textContent.includes('Tidak Ada Hasil') &&
                             !resultsContent.textContent.includes('No results'))
                        );
                        
                        if (hasContent && totalResults === 0) {
                            // Try to count from DOM (exclude empty message cards)
                            const allCards = resultsContent.querySelectorAll('.result-card');
                            const validCards = Array.from(allCards).filter(card => {
                                const cardText = card.textContent || '';
                                return !cardText.includes('Tidak Ada Hasil') && 
                                       !cardText.includes('No results') &&
                                       !cardText.includes('Server Eksternal');
                            });
                            if (validCards.length > 0) {
                                totalResults = validCards.length;
                                hasResults = true;
                            }
                        }
                    }
                    
                    // If loading is done and we have results, break
                    if (!isLoading && hasResults && totalResults > 0) {
                        console.log('Results confirmed:', totalResults);
                        break;
                    }
                    
                    // If loading is done but no results after reasonable wait, break
                    if (!isLoading && attempts > 10) {
                        console.log('Loading done, final check:', { hasResults, totalResults, attempts });
                        break;
                    }
                    
                    attempts++;
                }
                
                // Final comprehensive check
                const finalResultsCount = document.getElementById('resultsCount');
                const finalResultsContent = document.getElementById('resultsContent');
                
                if (finalResultsCount && !hasResults) {
                    const finalCountText = finalResultsCount.textContent.match(/(\d+)/);
                    if (finalCountText) {
                        totalResults = parseInt(finalCountText[1]);
                        hasResults = totalResults > 0;
                        console.log('Final check from count:', totalResults);
                    }
                }
                
                if (finalResultsContent && !hasResults) {
                    const finalCards = finalResultsContent.querySelectorAll('.result-card');
                    const finalGrid = finalResultsContent.querySelector('.results-grid');
                    
                    if (finalGrid && finalGrid.children.length > 0) {
                        hasResults = true;
                        totalResults = finalGrid.children.length;
                        console.log('Final check from grid:', totalResults);
                    } else if (finalCards.length > 0) {
                        const isEmptyMsg = finalResultsContent.textContent.includes('Tidak Ada Hasil') ||
                                          finalResultsContent.textContent.includes('No results');
                        if (!isEmptyMsg) {
                            hasResults = true;
                            totalResults = finalCards.length;
                            console.log('Final check from cards:', totalResults);
                        }
                    }
                }
                
                // Make sure results section is visible
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                }
                
                // Remove loading indicator
                removeTypingIndicator(loadingId);
                
                console.log('Final result check:', { hasResults, totalResults, originalQuery });
                
                // Get Gemini response
                const geminiResponse = await getGeminiResponse(originalQuery, parsed, {
                    total_results: totalResults
                }, hasResults);
                
                // Add Gemini response to chatbot with streaming effect
                addChatbotMessage(geminiResponse, 'bot', null, true);
                
            } catch (error) {
                removeTypingIndicator(loadingId);
                console.error('Error in handleSubmitWithChatbot:', error);
                addChatbotMessage('Maaf, terjadi kesalahan saat melakukan pencarian. Silakan coba lagi.', 'bot');
                
                // Make sure results section is visible even on error
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                }
            }
        }

        async function getGeminiResponse(query, searchParams, searchResults, hasResults) {
            try {
                const response = await fetch('/api/chatbot/gemini-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        search_params: {
                            nik: searchParams.nik,
                            name: searchParams.name,
                            phone: searchParams.phone,
                            location: searchParams.location
                        },
                        search_results: searchResults,
                        has_results: hasResults
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.response;
                } else {
                    // Fallback response
                    if (hasResults) {
                        return `Berhasil menemukan ${searchResults.total_results || 0} hasil untuk pencarian Anda.`;
                    } else {
                        return 'Maaf, tidak ada data yang ditemukan untuk pencarian Anda. Silakan periksa kembali parameter pencarian atau coba dengan kombinasi yang berbeda.';
                    }
                }
            } catch (error) {
                console.error('Error getting Gemini response:', error);
                // Fallback response
                if (hasResults) {
                    return `Berhasil menemukan ${searchResults.total_results || 0} hasil untuk pencarian Anda.`;
                } else {
                    return 'Maaf, tidak ada data yang ditemukan untuk pencarian Anda. Silakan periksa kembali parameter pencarian atau coba dengan kombinasi yang berbeda.';
                }
            }
        }

        function switchSearchType(type) {
            app.currentSearchType = type;
            
            // Update active tab
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update active form
            document.querySelectorAll('.search-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`${type}Form`).classList.add('active');
            
            // Update search button text
            const buttonTexts = {
                'identity': 'Search Identity',
                'phone': 'Search by Phone',
                'face': 'Search by Face'
            };
            document.getElementById('searchButtonText').textContent = buttonTexts[type];
            
            // Clear current form
            app.clearForm();
        }

        function removeFaceImage() {
            app.removeFaceImage();
        }

        function toggleSidebar() {
            const app = window.profilingApp;
            if (app.isMobile) {
                app.sidebar.classList.toggle('mobile-open');
                app.sidebarOverlay.classList.toggle('active');
            } else {
                app.isSidebarCollapsed = !app.isSidebarCollapsed;
                app.sidebar.classList.toggle('collapsed');
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const token = localStorage.getItem('session_token');
                    if (token) {
                        await fetch('/api/logout', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ session_token: token })
                        });
                    }
                } catch (error) {
                    console.error('Logout API error:', error);
                } finally {
                    // Always clear local storage and redirect
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/login';
                }
            }
        }

        // Person Details Modal Functions
        async function viewPersonDetails(nik) {
            if (!nik) {
                alert('NIK tidak ditemukan');
                return;
            }

            const modal = document.getElementById('personDetailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Show loading
            modalTitle.textContent = 'Memuat...';
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Memuat detail orang...</p></div>';
            modal.style.display = 'block';

            try {
                const token = localStorage.getItem('session_token');
                const response = await fetch('/api/person-details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nik: nik,
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });

                const result = await response.json();

                if (result.success && result.person) {
                    displayPersonDetails(result.person);
                } else {
                    modalTitle.textContent = 'Error';
                    modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i><h3>Error Memuat Detail</h3><p>' + (result.error || 'Gagal memuat detail orang') + '</p></div>';
                }
            } catch (error) {
                modalTitle.textContent = 'Error';
                modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i><h3>Error Jaringan</h3><p>Gagal terhubung ke server</p></div>';
            }
        }

        function displayPersonDetails(person) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Store person data for export
            currentPersonData = person;

            modalTitle.textContent = person.full_name || 'Person Details';

            let html = `
                <div class="detail-section">
                    <h3><i class="fas fa-user"></i> Informasi Pribadi</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Nama Lengkap</div>
                            <div class="value">${person.full_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">NIK</div>
                            <div class="value">${person.ktp_number || person.nik || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Tanggal Lahir</div>
                            <div class="value">${person.date_of_birth || person.tanggal_lahir || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Tempat Lahir</div>
                            <div class="value">${person.birth_place || person.tempat_lahir || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Jenis Kelamin</div>
                            <div class="value">${person.sex || person.jenis_kelamin || person.gender || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Status Perkawinan</div>
                            <div class="value">${person.marital_status || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Agama</div>
                            <div class="value">${person.religion || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Pekerjaan</div>
                            <div class="value">${person.occupation || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Alamat</div>
                            <div class="value">${person.address || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Provinsi</div>
                            <div class="value">${person.province_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Kecamatan</div>
                            <div class="value">${person.district_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Desa/Kelurahan</div>
                            <div class="value">${person.village_name || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;

            // Phone Numbers Section
            if (person.phone_data && person.phone_data.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3><i class="fas fa-phone"></i> Nomor Telepon (${person.phone_data.length})</h3>
                        <div class="phone-grid">
                `;
                person.phone_data.forEach(phone => {
                    html += `
                        <div class="phone-item">
                            <div class="phone-number">${phone.number || phone.msisdn || 'N/A'}</div>
                            <div class="phone-operator">${phone.operator || 'Unknown'}</div>
                            <div class="phone-date">Terdaftar: ${phone.register_date || 'N/A'}</div>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }

            // Family Members Section
            if (person.family_data && person.family_data.anggota_keluarga && person.family_data.anggota_keluarga.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3><i class="fas fa-users"></i> Family Members (${person.family_data.anggota_keluarga.length})</h3>
                        <div class="detail-item" style="margin-bottom: 20px;">
                            <div class="label">Family Head</div>
                            <div class="value">${person.family_data.kepala_keluarga || 'N/A'}</div>
                        </div>
                        <div class="detail-item" style="margin-bottom: 20px;">
                            <div class="label">Family Card Number (NKK)</div>
                            <div class="value">${person.family_data.nkk || 'N/A'}</div>
                        </div>
                        <div class="detail-item" style="margin-bottom: 20px;">
                            <div class="label">Alamat Keluarga</div>
                            <div class="value">${person.family_data.alamat_keluarga || 'N/A'}</div>
                        </div>
                        <div class="family-grid">
                `;
                person.family_data.anggota_keluarga.forEach(member => {
                    // Handle photo display
                    let photoHtml = '';
                    if (member.foto && member.foto.trim() !== '') {
                        let photoSrc = member.foto;
                        if (!photoSrc.startsWith('data:image/')) {
                            // Add proper prefix if missing
                            if (photoSrc.startsWith('/9j/')) {
                                photoSrc = 'data:image/jpeg;base64,' + photoSrc;
                            } else if (photoSrc.startsWith('iVBORw0KGgo')) {
                                photoSrc = 'data:image/png;base64,' + photoSrc;
                            } else {
                                photoSrc = 'data:image/jpeg;base64,' + photoSrc;
                            }
                        }
                        photoHtml = `<div class="family-photo"><img src="${photoSrc}" alt="${member.nama || 'Family Member'}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;"></div>`;
                    } else {
                        // Generate avatar with initials
                        const name = member.nama || 'N/A';
                        const initials = name !== 'N/A' ? name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
                        photoHtml = `<div class="family-photo"><div class="family-avatar" style="width: 60px; height: 60px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; margin-bottom: 10px;">${initials}</div></div>`;
                    }
                    
                    html += `
                        <div class="family-item">
                            ${photoHtml}
                            <div class="family-name">${member.nama || member.name || 'N/A'}</div>
                            <div class="family-relationship">${member.hubungan || member.relationship || 'N/A'}</div>
                            <div class="family-nik">NIK: ${member.nik || 'N/A'}</div>
                            <div class="family-nik">Birth: ${member.tanggal_lahir || member.date_of_birth || member.birth_date || 'N/A'}</div>
                            <div class="family-nik">Jenis Kelamin: ${member.jenis_kelamin || member.gender || member.sex || 'N/A'}</div>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }

            // Add Social Media Search Section (INTEGRATED: Universal + Social Media + Multi-Query)
            html += `
                <div class="detail-section" id="socialMediaSearchSection">
                    <h3><i class="fas fa-share-alt"></i> Social Media Search</h3>
                    <div class="search-info-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                        <div style="color: white; flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <i class="fas fa-search" style="flex-shrink: 0;"></i>
                                <strong style="flex-shrink: 0;">Mencari:</strong>
                                <span id="socialMediaSearchName" style="word-break: break-word; overflow-wrap: break-word;">${person.full_name || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="search-status" id="socialMediaSearchStatus" style="color: white; display: flex; align-items: center; gap: 8px; flex-shrink: 0; font-size: 0.9rem;">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span style="white-space: nowrap;">Siap mencari...</span>
                        </div>
                    </div>
                        
                    <div class="universal-search-container">
                        <!-- AI Analysis Section -->
                        <div class="ai-analysis-section" id="aiAnalysisSection" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-robot"></i> AI Analysis
                                <span style="font-size: 0.8rem; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 8px;">Powered by AI</span>
                            </h4>
                            <div id="aiAnalysisContent" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <p><i class="fas fa-spinner fa-spin"></i> Analyzing social media presence...</p>
                            </div>
                        </div>
                        
                        <!-- Social Media Search Tabs -->
                        <div class="search-tabs" style="display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #e5e7eb;">
                            <button class="tab-button active" onclick="switchSocialMediaTab('api-results')" style="flex: 1; min-width: 120px; padding: 12px 16px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-server"></i> API Results
                            </button>
                            <button class="tab-button" onclick="switchSocialMediaTab('categorized')" style="flex: 1; min-width: 120px; padding: 12px 16px; border: none; background: #f3f4f6; color: #6b7280; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-layer-group"></i> Categorized
                            </button>
                            <button class="tab-button" onclick="switchSocialMediaTab('social-links')" style="flex: 1; min-width: 120px; padding: 12px 16px; border: none; background: #f3f4f6; color: #6b7280; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-users"></i> Social Links
                            </button>
                        </div>
                        
                        <!-- Tab Contents -->
                        <div class="tab-content">
                            <!-- API Results Tab -->
                            <div id="tab-api-results" class="tab-pane active">
                                <div id="socialMediaWebResults">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <p>Klik tombol pencarian untuk melihat hasil dari API</p>
                                </div>
                                </div>
                                    </div>
                            
                            <!-- Categorized Tab -->
                            <div id="tab-categorized" class="tab-pane" style="display: none;">
                                <div id="categorizedResults">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        <i class="fas fa-layer-group" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <p>Hasil akan dikategorikan otomatis</p>
                                </div>
                            </div>
                        </div>
                        
                            <!-- Social Links Tab -->
                            <div id="tab-social-links" class="tab-pane" style="display: none;">
                                <div id="socialMediaLinks">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <p>Link social media akan muncul di sini (150+ platforms)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dummy elements for backward compatibility -->
                <div id="universalSearchStatus" style="display:none;"></div>
                <div id="universalResults" style="display:none;"></div>
            `;

            modalBody.innerHTML = html;
            
            // Trigger INTEGRATED SEARCH after modal is displayed
            setTimeout(() => {
                performSocialMediaSearch(person.full_name);
            }, 500);
        }

        function closePersonDetails() {
            const modal = document.getElementById('personDetailsModal');
            modal.style.display = 'none';
        }

        // ============================================================================
        // INTEGRATED SEARCH SYSTEM: Universal + Social Media + Multi-Query (80-100 results)
        // ============================================================================

        // Social Media Search - Main Function (INTEGRATED)
        async function performSocialMediaSearch(name) {
            if (!name || name === 'N/A') {
                updateSocialMediaSearchStatus('error', 'Nama tidak tersedia untuk pencarian social media');
                return;
            }

            const statusElement = document.getElementById('socialMediaSearchStatus');
            const webResultsElement = document.getElementById('socialMediaWebResults');
            const socialLinksElement = document.getElementById('socialMediaLinks');

            // Update status - mencari data
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #3b82f6;"></i> Mencari data...';
            }

            // Show loading message
            if (webResultsElement) {
                webResultsElement.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 15px; color: #3b82f6;"></i>
                        <h3 style="color: #1f2937; margin-bottom: 10px;">Mencari Data...</h3>
                        <p style="font-size: 0.9rem;">
                            Sedang mencari data dari Universal Search + Social Media Search<br>
                            (150+ platforms detection)
                        </p>
                    </div>
                `;
            }

            // INTEGRATED SEARCH: Universal Search + Social Media Search + ADVANCED QUERIES
            try {
                console.log('=== ADVANCED INTEGRATED SEARCH: Universal + Social Media + Multi-Query ===');
                
                // 1. Call Universal Search first (internal server)
                const universalResults = await performUniversalSearch(name);
                console.log('âœ“ Universal Search Results:', universalResults?.length || 0, 'items');

                // 2. ENHANCED QUERIES: Focus on profiles with images (more accurate!)
                const socialMediaQueries = [
                    // Core searches with image focus
                    { query: `"${name}" profile photo`, type: 'profile_photo' },
                    { query: `"${name}" profile picture`, type: 'profile_picture' },
                    { query: `"${name}"`, type: 'exact_phrase' },
                    { query: name, type: 'general' },
                    { query: `${name} profile`, type: 'profile' },
                    
                    // Major Social Media Platforms with image focus
                    { query: `"${name}" (site:facebook.com OR site:instagram.com OR site:twitter.com OR site:x.com) profile`, type: 'social_tier1_profile' },
                    { query: `"${name}" (site:facebook.com OR site:instagram.com OR site:twitter.com OR site:x.com)`, type: 'social_tier1' },
                    { query: `"${name}" (site:linkedin.com OR site:tiktok.com OR site:youtube.com) profile`, type: 'social_tier2_profile' },
                    { query: `"${name}" (site:linkedin.com OR site:tiktok.com OR site:youtube.com)`, type: 'social_tier2' },
                    { query: `"${name}" (site:pinterest.com OR site:reddit.com OR site:tumblr.com)`, type: 'social_tier3' },
                    
                    // Professional & Creative with images
                    { query: `"${name}" (site:github.com OR site:behance.net OR site:dribbble.com)`, type: 'professional' },
                    
                    // Regional/Indonesian
                    { query: `"${name}" (site:weibo.com OR site:vk.com OR site:kaskus.co.id)`, type: 'regional' },
                    
                    // Content/Media
                    { query: `"${name}" (site:medium.com OR site:quora.com OR site:stackoverflow.com)`, type: 'content' },
                    
                    // Streaming/Video
                    { query: `"${name}" (site:twitch.tv OR site:discord.com OR site:vimeo.com)`, type: 'streaming' },
                    
                    // Catch-all keywords with image focus
                    { query: `${name} social media profile photo`, type: 'social_keyword_photo' },
                    { query: `${name} social media profile`, type: 'social_keyword' },
                    { query: `${name} online presence`, type: 'online_presence' }
                ];

                const allSocialResults = [];
                let totalResultsFetched = 0;

                // SMART SEARCH MODE: Try API first, fallback to Universal Search if quota exhausted
                console.log('ðŸš€ SMART SEARCH MODE: Trying API first, using Universal Search as fallback');
                console.log('ðŸ“Š Will combine all sources: Universal + Google CSE + Social Searcher Style');
                
                let apiQuotaExhausted = false; // Try API first
                
                const queryPromises = socialMediaQueries.map(async (queryObj, index) => {
                    // Skip if quota already exhausted
                    if (apiQuotaExhausted) {
                        console.log(`â­ï¸ Query ${index + 1} skipped (quota exhausted)`);
                        return [];
                    }
                    
                    try {
                        const startTime = Date.now();
                        console.log(`ðŸ” [Google CSE API] Query ${index + 1}/${socialMediaQueries.length}: "${queryObj.query}"`);
                        
                        const response = await fetch('/api/social-media-search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ name: queryObj.query, type: 'web' })
                        });

                        const result = await response.json();
                        const elapsed = Date.now() - startTime;
                        
                        // DEBUG: Log full response for debugging
                        console.log(`ðŸ” [Google CSE API] Query ${index + 1} Response:`, {
                            status: response.status,
                            ok: response.ok,
                            success: result.success,
                            hasData: !!result.data,
                            webLength: result.data?.web?.length || 0,
                            error: result.error,
                            message: result.message
                        });
                        
                        // DEBUG: Log response status
                        if (!response.ok) {
                            console.error(`âŒ [Google CSE API] Query ${index + 1} HTTP Error: ${response.status}`, result);
                            console.error(`   Error details:`, result.error || result.message || 'Unknown error');
                            console.error(`   Full response:`, JSON.stringify(result, null, 2));
                            
                            // Detect quota exceeded (429)
                            if (response.status === 429 || result.error?.includes('quota') || result.error?.includes('Quota') || result.error_code === 429) {
                                apiQuotaExhausted = true;
                                console.warn('ðŸš« [Google CSE API] QUOTA EXCEEDED! Will continue with other sources...');
                                updateSocialMediaSearchStatus('warning', 'âš ï¸ Google CSE API quota exceeded - Using other sources');
                                return [];
                            }
                            
                            // Detect invalid API key (400, 403)
                            if (response.status === 400 || response.status === 403) {
                                console.error(`âŒ [Google CSE API] API Key Error (${response.status}): ${result.error || result.message}`);
                                updateSocialMediaSearchStatus('error', `âŒ Google CSE API Error: ${result.error || result.message || 'Invalid API key or access denied'}`);
                                // Don't stop completely, but log the error
                            }
                            
                            // Don't return empty on other errors - continue trying
                            console.warn(`âš ï¸ [Google CSE API] Query ${index + 1} failed but continuing...`);
                            return [];
                        }
                        
                        if (!result.success) {
                            console.warn(`âš ï¸ [Google CSE API] Query ${index + 1} API Error:`, result.error || result.message);
                            
                            // Also check error message for quota
                            if (result.error?.includes('quota') || result.error?.includes('Quota') || result.error?.includes('429')) {
                                apiQuotaExhausted = true;
                                console.warn('ðŸš« [Google CSE API] QUOTA EXCEEDED (from error message)! Will continue with other sources...');
                                return [];
                            }
                            // Continue even if this query fails
                            return [];
                        }
                        
                        // Check if we have results - be more lenient with success check
                        const hasResults = result.data && result.data.web && Array.isArray(result.data.web) && result.data.web.length > 0;
                        
                        if (hasResults) {
                            const resultCount = result.data.web.length;
                            totalResultsFetched += resultCount;
                            console.log(`âœ… [Google CSE API] Query ${index + 1}/${socialMediaQueries.length} (${queryObj.type}): ${resultCount} results in ${elapsed}ms | Total so far: ${totalResultsFetched}`);
                            
                            // Update status with progress
                            updateSocialMediaSearchStatus('searching', 
                                `ðŸ” Query ${index + 1}/${socialMediaQueries.length} - Found ${totalResultsFetched} results...`);
                            
                            // Map results with source and ensure all properties are preserved
                            const mappedResults = result.data.web.map((item, itemIdx) => {
                                const mapped = {
                                    ...item,
                                    source: 'Google CSE',  // CRITICAL: Set source for filtering
                                    queryType: queryObj.type
                                };
                                // Ensure link exists
                                if (!mapped.link && mapped.formattedUrl) {
                                    mapped.link = mapped.formattedUrl;
                                }
                                // Ensure title exists
                                if (!mapped.title && mapped.htmlTitle) {
                                    mapped.title = mapped.htmlTitle.replace(/<[^>]*>/g, ''); // Strip HTML tags
                                }
                                
                                // DEBUG: Log first result structure
                                if (itemIdx === 0) {
                                    console.log(`ðŸ“‹ [Google CSE API] First result structure from query ${index + 1}:`, {
                                        hasTitle: !!mapped.title,
                                        hasLink: !!mapped.link,
                                        hasSnippet: !!mapped.snippet,
                                        source: mapped.source,
                                        keys: Object.keys(mapped)
                                    });
                                }
                                
                                return mapped;
                            });
                            
                            console.log(`ðŸ“‹ [Google CSE API] Sample results from query ${index + 1}:`, mappedResults.slice(0, 2).map(r => ({
                                title: r.title?.substring(0, 50),
                                link: r.link?.substring(0, 50),
                                source: r.source
                            })));
                            
                            return mappedResults;
                        } else {
                            // More detailed logging for empty results
                            console.log(`âš ï¸ [Google CSE API] Query ${index + 1} returned no results (${elapsed}ms)`);
                            console.log(`   Response details:`, {
                                success: result.success,
                                hasData: !!result.data,
                                hasWeb: !!result.data?.web,
                                webIsArray: Array.isArray(result.data?.web),
                                webLength: result.data?.web?.length || 0,
                                error: result.error,
                                message: result.message,
                                error_code: result.error_code
                            });
                            
                            // If success is false but no error, log it
                            if (result.success === false && !result.error) {
                                console.warn(`   âš ï¸ API returned success=false but no error message`);
                            }
                            
                            return [];
                        }
                    } catch (error) {
                        console.error(`âŒ [Google CSE API] Query ${index + 1} (${queryObj.type}) FAILED:`, error);
                        console.error(`   Error message: ${error.message}`);
                        console.error(`   Error stack: ${error.stack}`);
                        // Don't update status for every error - too noisy
                        // updateSocialMediaSearchStatus('error', `âš ï¸ Query ${index + 1} failed: ${error.message}`);
                        return [];
                    }
                });

                // Wait for all queries
                const queryResults = await Promise.all(queryPromises);

                // SMART MERGE: Normalize URLs and deduplicate intelligently
                const normalizeUrl = (url) => {
                    if (!url) return '';
                    try {
                        // Remove protocol, www, trailing slash, and normalize
                        let normalized = url.toLowerCase()
                            .replace(/^https?:\/\//, '')
                            .replace(/^www\./, '')
                            .replace(/\/$/, '')
                            .split('#')[0]  // Remove fragment
                            .split('?')[0]; // Remove query params for comparison
                        return normalized;
                    } catch (e) {
                        return url.toLowerCase();
                    }
                };
                
                const isDuplicate = (result1, result2) => {
                    // Normalize URLs for comparison
                    const url1 = normalizeUrl(result1.link);
                    const url2 = normalizeUrl(result2.link);
                    
                    // Exact URL match
                    if (url1 === url2 && url1 !== '') return true;
                    
                    // Same title and similar URL (same domain + path)
                    if (result1.title && result2.title && 
                        result1.title.toLowerCase().trim() === result2.title.toLowerCase().trim()) {
                        const domain1 = url1.split('/')[0];
                        const domain2 = url2.split('/')[0];
                        const path1 = url1.split('/').slice(1).join('/');
                        const path2 = url2.split('/').slice(1).join('/');
                        
                        // Same domain and similar path (allow minor differences)
                        if (domain1 === domain2 && path1 && path2) {
                            const pathDiff = Math.abs(path1.length - path2.length);
                            if (pathDiff < 10) { // Allow small path differences
                                return true;
                            }
                        }
                    }
                    
                    return false;
                };
                
                // Merge and deduplicate results intelligently
                let totalBeforeDedup = 0;
                queryResults.forEach((results, queryIndex) => {
                    totalBeforeDedup += results.length;
                    results.forEach(result => {
                        // Ensure source is set
                        if (!result.source) {
                            result.source = 'Google CSE';
                            console.warn(`âš ï¸ Result from query ${queryIndex + 1} missing source, setting to 'Google CSE'`);
                        }
                        // Check if not duplicate using smart comparison
                        if (!allSocialResults.some(r => isDuplicate(r, result))) {
                            allSocialResults.push(result);
                        }
                    });
                });

                console.log(`âœ“ [Google CSE API] Total results before deduplication: ${totalBeforeDedup}`);
                console.log(`âœ“ [Google CSE API] Total unique Social Media results after deduplication: ${allSocialResults.length}`);
                
                // Log sample results
                if (allSocialResults.length > 0) {
                    console.log(`ðŸ“‹ [Google CSE API] Sample results in allSocialResults:`, allSocialResults.slice(0, 3).map(r => ({
                        title: r.title?.substring(0, 50),
                        link: r.link?.substring(0, 50),
                        source: r.source
                    })));
                } else {
                    console.warn('âš ï¸ [Google CSE API] WARNING: allSocialResults is EMPTY!');
                    console.warn('   This means no Google CSE results were added.');
                    console.warn('   Possible causes:');
                    console.warn('   1. All queries returned empty results');
                    console.warn('   2. All results were filtered as duplicates');
                    console.warn('   3. API errors prevented results from being returned');
                }
                
                // Update status with widget-only mode message
                if (apiQuotaExhausted && allSocialResults.length === 0) {
                    updateSocialMediaSearchStatus('success', 'âœ… Results available in categorized tabs');
                    console.log('ðŸ’¡ TIP: Results are available in categorized tabs');
                }

                // 4. SOCIAL SEARCHER STYLE: Platform-specific searches (seperti social-searcher.com)
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ðŸ” Starting Social Searcher Style search (platform-specific)...');
                console.log('ðŸ“¡ This will search 6 platforms: Facebook, Instagram, Twitter, LinkedIn, TikTok, Pinterest');
                console.log('â±ï¸  Estimated time: ~8-15 seconds (with delays to avoid blocking)');
                updateSocialMediaSearchStatus('searching', 'ðŸ” Social Searcher Style: Searching 6 platforms (Facebook, Instagram, Twitter, LinkedIn, TikTok, Pinterest)...');
                
                let socialSearcherResults = [];
                try {
                    console.log('ðŸ“¤ Calling /api/social-searcher-style with name:', name);
                    const startTime = Date.now();
                    
                    const socialSearcherResponse = await fetch('/api/social-searcher-style', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: name })
                    });
                    
                    const elapsed = Date.now() - startTime;
                    console.log(`â±ï¸ Social Searcher Style response received in ${elapsed}ms`);
                    console.log('ðŸ“¥ Response status:', socialSearcherResponse.status);
                    
                    let socialSearcherData;
                    if (!socialSearcherResponse.ok) {
                        console.error('âŒ Social Searcher Style HTTP error:', socialSearcherResponse.status);
                        try {
                            const errorText = await socialSearcherResponse.text();
                            console.error('âŒ Error response:', errorText);
                            socialSearcherData = JSON.parse(errorText);
                        } catch (e) {
                            console.error('âŒ Failed to parse error response');
                            socialSearcherData = { success: false, error: `HTTP ${socialSearcherResponse.status}` };
                        }
                    } else {
                        socialSearcherData = await socialSearcherResponse.json();
                    }
                    
                    console.log('ðŸ“Š Social Searcher Style response data:', socialSearcherData);
                    
                    if (socialSearcherData.success && socialSearcherData.data && socialSearcherData.data.web) {
                        socialSearcherResults = socialSearcherData.data.web.map(item => {
                            // CRITICAL: Ensure source is set!
                            const result = {
                                ...item,
                                source: 'Social Searcher Style'  // MUST SET SOURCE!
                            };
                            // Ensure platform is preserved
                            if (item.platform) {
                                result.platform = item.platform;
                            }
                            return result;
                        });
                        console.log(`âœ… Social Searcher Style: Found ${socialSearcherResults.length} results from ${Object.keys(socialSearcherData.data.by_platform || {}).length} platforms`);
                        
                        // Log per platform
                        if (socialSearcherData.data.by_platform) {
                            Object.entries(socialSearcherData.data.by_platform).forEach(([platform, results]) => {
                                if (results && results.length > 0) {
                                    console.log(`   ðŸ“± ${platform}: ${results.length} results`);
                                } else {
                                    console.log(`   âš ï¸ ${platform}: No results`);
                                }
                            });
                        }
                        
                        // Log sample results untuk debug
                        if (socialSearcherResults.length > 0) {
                            console.log('ðŸ“‹ Sample Social Searcher results:');
                            socialSearcherResults.slice(0, 3).forEach((r, i) => {
                                console.log(`   ${i+1}. [${r.platform || 'unknown'}] ${r.title} - source: ${r.source}`);
                            });
                        }
                    } else {
                        console.warn('âš ï¸ Social Searcher Style: No results or error');
                        console.warn('âš ï¸ Response:', socialSearcherData);
                        if (socialSearcherData.error) {
                            console.error('âŒ Error message:', socialSearcherData.error);
                        }
                    }
                } catch (error) {
                    console.error('âŒ Social Searcher Style error:', error);
                    console.error('âŒ Error stack:', error.stack);
                }
                
                console.log(`ðŸ“Š Social Searcher Results count: ${socialSearcherResults.length}`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

                // 3. SMART MERGE: Combine ALL sources with intelligent deduplication
                let combinedResults = [];
                
                // Reuse normalizeUrl and isDuplicate functions from above
                const normalizeUrlForMerge = (url) => {
                    if (!url) return '';
                    try {
                        let normalized = url.toLowerCase()
                            .replace(/^https?:\/\//, '')
                            .replace(/^www\./, '')
                            .replace(/\/$/, '')
                            .split('#')[0]
                            .split('?')[0];
                        return normalized;
                    } catch (e) {
                        return url.toLowerCase();
                    }
                };
                
                const isDuplicateForMerge = (result1, result2) => {
                    const url1 = normalizeUrlForMerge(result1.link);
                    const url2 = normalizeUrlForMerge(result2.link);
                    
                    // Exact URL match
                    if (url1 === url2 && url1 !== '') return true;
                    
                    // Same title and same domain (more lenient for internal data)
                    if (result1.title && result2.title && 
                        result1.title.toLowerCase().trim() === result2.title.toLowerCase().trim()) {
                        const domain1 = url1.split('/')[0];
                        const domain2 = url2.split('/')[0];
                        if (domain1 === domain2 && domain1 !== '') {
                            return true;
                        }
                    }
                    
                    return false;
                };
                
                const addResultSmart = (result, source, priority = 0) => {
                    // Ensure source is set
                    if (!result.source) {
                        result.source = source;
                    }
                    
                    // Check if duplicate
                    const existingIndex = combinedResults.findIndex(r => isDuplicateForMerge(r, result));
                    if (existingIndex === -1) {
                        // Not duplicate, add it
                        result.mergePriority = priority;
                        combinedResults.push(result);
                        return { added: true, duplicate: false };
                    } else {
                        // Duplicate found - keep the one with higher priority or better source
                        const existing = combinedResults[existingIndex];
                        const existingPriority = existing.mergePriority || 0;
                        
                        // Priority: Universal Search (3) > Social Searcher Style (2) > Google CSE (1) > Unknown (0)
                        const sourcePriority = {
                            'Universal Search': 3,
                            'Social Searcher Style': 2,
                            'Google CSE': 1,
                            'Unknown': 0
                        };
                        
                        const newPriority = priority || sourcePriority[source] || 0;
                        const existingSourcePriority = sourcePriority[existing.source] || 0;
                        
                        // If new result has higher priority, replace it
                        if (newPriority > existingPriority || 
                            (newPriority === existingPriority && newPriority > existingSourcePriority)) {
                            result.mergePriority = newPriority;
                            combinedResults[existingIndex] = result;
                            return { added: true, duplicate: true, replaced: true };
                        }
                        
                        return { added: false, duplicate: true };
                    }
                };

                // Priority 1: Add Universal Search results first (most reliable internal data - HIGHEST PRIORITY)
                if (universalResults && universalResults.length > 0) {
                    let added = 0;
                    let skipped = 0;
                    universalResults.forEach(result => {
                        const status = addResultSmart(result, 'Universal Search', 3);
                        if (status.added && !status.duplicate) {
                            added++;
                        } else if (status.duplicate) {
                            skipped++;
                        }
                    });
                    console.log(`âœ“ Added ${added}/${universalResults.length} unique results from Universal Search (INTERNAL - highest priority)`);
                    if (skipped > 0) {
                        console.log(`   (${skipped} duplicates skipped)`);
                    }
                } else {
                    console.warn('âš ï¸ No Universal Search results found!');
                }

                // Priority 2: Add Social Searcher Style results (platform-specific, high quality)
                if (socialSearcherResults.length > 0) {
                    let added = 0;
                    let skipped = 0;
                    let replaced = 0;
                    socialSearcherResults.forEach(result => {
                        const status = addResultSmart(result, 'Social Searcher Style', 2);
                        if (status.added && !status.duplicate) {
                            added++;
                        } else if (status.duplicate) {
                            skipped++;
                            if (status.replaced) {
                                replaced++;
                            }
                        }
                    });
                    console.log(`âœ“ Added ${added} unique results from Social Searcher Style (${skipped} duplicates, ${replaced} replaced)`);
                    if (added > 0) {
                        const sample = combinedResults.filter(r => r.source === 'Social Searcher Style').slice(0, 3);
                        console.log(`ðŸ“‹ Sample Social Searcher results:`, sample.map(r => `[${r.platform || 'unknown'}] ${r.title}`));
                    }
                } else {
                    console.warn('âš ï¸ No Social Searcher Style results found!');
                }

                // Priority 3: Add ALL Social Media Search results from multiple queries (Google CSE API)
                if (allSocialResults.length > 0) {
                    let added = 0;
                    let skipped = 0;
                    let replaced = 0;
                    
                    console.log(`ðŸ“Š [Google CSE API] Starting to add ${allSocialResults.length} results to combinedResults...`);
                    console.log(`ðŸ“Š [Google CSE API] Current combinedResults length BEFORE: ${combinedResults.length}`);
                    
                    // Log sample of allSocialResults before merging
                    console.log(`ðŸ“‹ [Google CSE API] Sample allSocialResults (first 3):`, allSocialResults.slice(0, 3).map((r, i) => ({
                        index: i,
                        title: r.title?.substring(0, 50),
                        link: r.link?.substring(0, 50),
                        source: r.source,
                        hasLink: !!r.link,
                        hasTitle: !!r.title
                    })));
                    
                    allSocialResults.forEach((result, idx) => {
                        // Ensure source is set
                        if (!result.source) {
                            result.source = 'Google CSE';
                            console.warn(`âš ï¸ Result ${idx + 1} missing source, setting to 'Google CSE'`);
                        }
                        
                        // DEBUG: Log before adding
                        if (idx < 3) {
                            console.log(`ðŸ” [Google CSE API] Adding result ${idx + 1}:`, {
                                title: result.title?.substring(0, 50),
                                link: result.link?.substring(0, 50),
                                source: result.source,
                                normalizedLink: normalizeUrlForMerge(result.link)
                            });
                        }
                        
                        const status = addResultSmart(result, result.source || 'Google CSE', 1);
                        if (status.added && !status.duplicate) {
                            added++;
                            if (idx < 3) {
                                console.log(`   âœ… Result ${idx + 1} ADDED (new)`);
                            }
                        } else if (status.duplicate) {
                            skipped++;
                            if (status.replaced) {
                                replaced++;
                                if (idx < 3) {
                                    console.log(`   ðŸ”„ Result ${idx + 1} REPLACED (duplicate with higher priority)`);
                                }
                            } else {
                                if (idx < 3) {
                                    console.log(`   â­ï¸ Result ${idx + 1} SKIPPED (duplicate, existing has higher priority)`);
                                }
                            }
                        }
                    });
                    
                    console.log(`âœ… [Google CSE API] Added ${added} unique results to combinedResults (${skipped} duplicates skipped, ${replaced} replaced)`);
                    console.log(`ðŸ“Š [Google CSE API] Current combinedResults length AFTER: ${combinedResults.length}`);
                    
                    // Verify results were added
                    const googleResultsInCombined = combinedResults.filter(r => r.source === 'Google CSE');
                    console.log(`ðŸ“Š [Google CSE API] Verification: ${googleResultsInCombined.length} Google CSE results in combinedResults`);
                    
                    // Log sample of Google CSE results in combinedResults
                    if (googleResultsInCombined.length > 0) {
                        console.log(`ðŸ“‹ [Google CSE API] Sample Google CSE results in combinedResults (first 3):`, googleResultsInCombined.slice(0, 3).map((r, i) => ({
                            index: i,
                            title: r.title?.substring(0, 50),
                            link: r.link?.substring(0, 50),
                            source: r.source
                        })));
                    }
                    
                    if (googleResultsInCombined.length === 0 && allSocialResults.length > 0) {
                        console.error('âŒ [Google CSE API] ERROR: Results were not added to combinedResults!');
                        console.error('   allSocialResults.length:', allSocialResults.length);
                        console.error('   combinedResults.length:', combinedResults.length);
                        console.error('   Sample allSocialResults:', allSocialResults.slice(0, 2));
                        console.error('   Sample combinedResults:', combinedResults.slice(0, 2));
                        
                        // Check if all were duplicates
                        console.error('   ðŸ” Checking why results were not added...');
                        allSocialResults.slice(0, 3).forEach((result, idx) => {
                            const normalizedLink = normalizeUrlForMerge(result.link);
                            const isDuplicate = combinedResults.some(r => isDuplicateForMerge(r, result));
                            console.error(`   Result ${idx + 1}: link="${normalizedLink}", isDuplicate=${isDuplicate}`);
                        });
                    }
                } else {
                    console.warn('âš ï¸ [Google CSE API] No Social Media Search results from queries!');
                    console.warn('   This means Google CSE API did not return any results.');
                    console.warn('   Possible causes:');
                    console.warn('   1. API quota exhausted');
                    console.warn('   2. API key invalid');
                    console.warn('   3. Network error');
                    console.warn('   4. All queries returned empty');
                    console.warn('   5. Server not restarted with new API key');
                }

                console.log('=== TOTAL COMBINED RESULTS:', combinedResults.length, '===');
                
                // DEBUG: Show source breakdown
                // Ensure all results have source property
                combinedResults.forEach(r => {
                    if (!r.source) {
                        r.source = 'Unknown';
                        console.warn('âš ï¸ Result without source:', r.title || r.link);
                    }
                });
                
                const universalCount = combinedResults.filter(r => r.source === 'Universal Search').length;
                const googleCount = combinedResults.filter(r => r.source === 'Google CSE').length;
                const socialSearcherCount = combinedResults.filter(r => r.source === 'Social Searcher Style').length;
                const unknownCount = combinedResults.filter(r => !r.source || r.source === 'Unknown').length;
                
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ðŸ“Š SOURCE BREAKDOWN:');
                console.log(`   ðŸ”µ Universal Search (INTERNAL): ${universalCount}`);
                console.log(`   ðŸ”´ Google CSE (GOOGLE): ${googleCount}`);
                console.log(`   ðŸŸ¢ Social Searcher Style (PLATFORM-SPECIFIC): ${socialSearcherCount}`);
                console.log(`   âšª Unknown/No Source: ${unknownCount}`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                // Log sample results per source
                if (socialSearcherCount > 0) {
                    const sampleSocialSearcher = combinedResults.filter(r => r.source === 'Social Searcher Style').slice(0, 3);
                    console.log('ðŸ“‹ Sample Social Searcher Style results:');
                    sampleSocialSearcher.forEach((r, i) => {
                        console.log(`   ${i+1}. [${r.platform || 'unknown'}] ${r.title} - source: ${r.source}`);
                    });
                } else {
                    console.warn('âš ï¸ WARNING: No Social Searcher Style results found in combined results!');
                    console.warn('   This might indicate:');
                    console.warn('   1. API endpoint not called or failed');
                    console.warn('   2. Results not merged correctly');
                    console.warn('   3. Source property not set correctly');
                }
                
                if (googleCount === 0 && allSocialResults.length === 0) {
                    if (apiQuotaExhausted) {
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('ðŸš€ WIDGET-ONLY MODE ACTIVATED! (UNLIMITED!)');
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        console.log('âœ… Internal results: Categorized & ready');
                        console.log('â™¾ï¸  Google CSE Widget: UNLIMITED searches (no quota!)');
                        // Tab switching removed - tabs "Web" and "Gambar" have been deleted
                        console.log('ðŸ“Š Results from both sources available!');
                        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                        updateSocialMediaSearchStatus('success', 'âœ… Results available in categorized tabs');
                    } else {
                        console.error('âš ï¸ WARNING: NO GOOGLE CSE RESULTS! All results are from INTERNAL only!');
                        console.error('Possible issues:');
                        console.error('  1. API Key invalid or quota exhausted');
                        console.error('  2. Network error or timeout');
                        console.error('  3. Backend API /api/social-media-search not responding');
                        updateSocialMediaSearchStatus('warning', 'âš ï¸ Hanya data internal tersedia (Google CSE error)');
                    }
                }

                // Check if we have any results
                if (combinedResults.length > 0) {
                    console.log('âœ“ INTEGRATED SEARCH SUCCESS! Displaying combined results');
                    
                    // Display combined web results
                    displaySocialMediaWebResults(combinedResults, name);

                    // EXTRACT ALL SOCIAL MEDIA LINKS from combined results (150+ platforms detection)
                    const allSocialMediaLinks = extractSocialMediaLinks(combinedResults);
                    console.log('âœ“ Extracted', allSocialMediaLinks.length, 'social media links from combined results');

                    // Display ALL social media links
                    displaySocialMediaLinks(allSocialMediaLinks);

                    // Categorize and display ALL categorized results
                    const categorized = categorizeResults(combinedResults);
                    displayCategorizedResults(categorized);
                    
                    // Perform AI Analysis with ALL social media links
                    await performAIAnalysis(name, allSocialMediaLinks);

                    // Count by source
                    const universalCount = universalResults?.length || 0;
                    const socialCount = allSocialResults.length || 0;
                    updateSocialMediaSearchStatus('success',
                        `âœ“ Total: ${combinedResults.length} hasil (Universal: ${universalCount} + Social: ${socialCount}) | Social Media: ${allSocialMediaLinks.length} platforms`);

                    // Auto-switch to Categorized tab to show results immediately
                    setTimeout(() => {
                        switchSocialMediaTab('categorized');
                        console.log('Auto-switched to Categorized tab to display combined results');
                    }, 1500);
                    } else {
                    // No results
                    updateSocialMediaSearchStatus('warning', 'Tidak ada hasil ditemukan');
                        if (webResultsElement) {
                        webResultsElement.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p>Tidak ada hasil ditemukan untuk "${name}"</p>
                            </div>
                        `;
                    }
                }

            } catch (error) {
                // ERROR HANDLING: Still try to display Universal Search results even if API fails
                console.error('âŒ Error in performSocialMediaSearch:', error);
                console.error('Error details:', error.message, error.stack);
                
                // Try to display Universal Search results if available (FALLBACK)
                try {
                    console.log('ðŸ”„ Attempting fallback: Universal Search only...');
                    const universalResults = await performUniversalSearch(name);
                    
                    if (universalResults && universalResults.length > 0) {
                        console.log(`âœ“ Fallback SUCCESS: Displaying ${universalResults.length} results from Universal Search (Internal)`);
                        
                        // Display Universal Search results
                        displaySocialMediaWebResults(universalResults, name);
                        
                        // Extract and display social media links
                        const allSocialMediaLinks = extractSocialMediaLinks(universalResults);
                        displaySocialMediaLinks(allSocialMediaLinks);
                        
                        // Categorize and display
                        const categorized = categorizeResults(universalResults);
                        displayCategorizedResults(categorized);
                        
                        // AI Analysis
                        await performAIAnalysis(name, allSocialMediaLinks);
                        
                        updateSocialMediaSearchStatus('warning', 
                            `âš ï¸ API Error - Menampilkan ${universalResults.length} hasil dari Universal Search (Internal) saja`);
                        
                        // Auto-switch to Categorized tab
                        setTimeout(() => {
                            switchSocialMediaTab('categorized');
                        }, 1500);
                        
                        return; // Exit early - we have results from Universal Search
                    } else {
                        console.warn('âš ï¸ Universal Search also returned no results');
                    }
                } catch (universalError) {
                    console.error('âŒ Error in Universal Search fallback:', universalError);
                }
                
                // If we get here, no results available from any source
                console.error('âŒ No results available from any source');
                updateSocialMediaSearchStatus('error', 'Backend API tidak tersedia. Gunakan tab "Categorized" atau "Social Links" untuk hasil pencarian.');
                
                if (webResultsElement) {
                    webResultsElement.innerHTML = `
                        <div style="padding: 30px; text-align: center; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                            <i class="fas fa-info-circle" style="font-size: 3rem; color: #3b82f6; margin-bottom: 15px;"></i>
                            <h3 style="color: #1e40af; margin-bottom: 10px;">Backend API Tidak Tersedia</h3>
                            <p style="color: #1e3a8a; margin-bottom: 15px; font-size: 0.95rem;">
                                Backend API untuk pencarian social media tidak dapat digunakan saat ini.
                            </p>
                            <p style="color: #1e3a8a; margin-bottom: 20px; font-size: 0.9rem;">
                                <strong>Solusi:</strong> Gunakan tab <strong>"Categorized"</strong> atau <strong>"Social Links"</strong> untuk melihat hasil pencarian.
                            </p>
                        </div>
                    `;
                }
            }

            // Google CSE widgets removed - tabs "Web" and "Gambar" have been deleted
            // Results are now displayed via Universal Search + Google CSE API + Social Searcher Style
            console.log('âœ… Search completed - Results displayed in tabs: API Results, Categorized, Social Links');
        }

        // Update Social Media Search Status
        function updateSocialMediaSearchStatus(type, message) {
            const statusElement = document.getElementById('socialMediaSearchStatus');
            if (!statusElement) return;

            let icon = '';
            let color = 'white';
            
            switch(type) {
                case 'searching':
                    icon = '<i class="fas fa-spinner fa-spin"></i>';
                    break;
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-lightbulb"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
            }
            
            statusElement.innerHTML = `${icon} <span>${message}</span>`;
        }

        // Universal Search Function (RETURNS formatted results for integration)
        async function performUniversalSearch(name) {
            if (!name || name === 'N/A') {
                updateUniversalSearchStatus('error', 'Nama tidak tersedia untuk pencarian universal');
                return null;
            }

            const statusElement = document.getElementById('universalSearchStatus');
            const resultsElement = document.getElementById('universalResults');

            try {
                updateUniversalSearchStatus('searching', 'Mencari data universal...');

                const response = await fetch('/api/universal-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: name })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Gagal melakukan pencarian universal');
                }

                const result = await response.json();
                
                if (result.success && result.data && result.data.organic_results) {
                    updateUniversalSearchStatus('success', `âœ“ Universal: ${result.data.organic_results.length} hasil`);
                    // RETURN formatted results for integration
                    return result.data.organic_results.map(item => ({
                        title: item.title || 'No Title',
                        link: item.link || '#',
                        snippet: item.snippet || '',
                        source: 'Universal Search',
                        pagemap: item.pagemap || null
                    }));
                } else {
                    updateUniversalSearchStatus('warning', result.message || 'Server internal tidak tersedia');
                    return [];
                }

            } catch (error) {
                console.error('Universal search error:', error);
                updateUniversalSearchStatus('error', 'Universal search tidak tersedia');
                return [];
            }
        }

        function updateUniversalSearchStatus(type, message) {
            const statusElement = document.getElementById('universalSearchStatus');
            if (!statusElement) return;

            statusElement.className = `search-status ${type}`;
            
            let icon = '';
            switch(type) {
                case 'searching':
                    icon = '<i class="fas fa-spinner fa-spin"></i>';
                    break;
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
            }
            
            statusElement.innerHTML = `${icon} ${message}`;
        }

        // Helper: Get relevance score for sorting (higher = more relevant)
        function getRelevanceScore(item, searchName) {
            if (!searchName) return 0;
            
            let score = 0;
            const title = (item.title || '').toLowerCase();
            const snippet = (item.snippet || '').toLowerCase();
            const link = (item.link || '').toLowerCase();
            const searchLower = searchName.toLowerCase();
            
            // Exact match in title (highest priority)
            if (title.includes(searchLower)) score += 3;
            
            // Match in snippet
            if (snippet.includes(searchLower)) score += 2;
            
            // Profile/user indicators in URL
            if (link.includes('/profile/') || link.includes('/user/') || link.includes('/@')) score += 1;
            
            return score;
        }

        // Helper: Get platform icon (150+ platforms support)
        function getPlatformIcon(url) {
            const urlLower = url.toLowerCase();
            
            // Tier 1: Major Platforms
            if (urlLower.includes('facebook.com') || urlLower.includes('fb.com')) return 'fab fa-facebook';
            if (urlLower.includes('instagram.com')) return 'fab fa-instagram';
            if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) return 'fab fa-twitter';
            if (urlLower.includes('linkedin.com')) return 'fab fa-linkedin';
            if (urlLower.includes('tiktok.com')) return 'fab fa-tiktok';
            if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) return 'fab fa-youtube';
            if (urlLower.includes('pinterest.com')) return 'fab fa-pinterest';
            if (urlLower.includes('snapchat.com')) return 'fab fa-snapchat';
            if (urlLower.includes('whatsapp.com')) return 'fab fa-whatsapp';
            if (urlLower.includes('telegram.org') || urlLower.includes('t.me')) return 'fab fa-telegram';
            if (urlLower.includes('reddit.com')) return 'fab fa-reddit';
            if (urlLower.includes('tumblr.com')) return 'fab fa-tumblr';
            if (urlLower.includes('discord.com')) return 'fab fa-discord';
            if (urlLower.includes('twitch.tv')) return 'fab fa-twitch';
            if (urlLower.includes('medium.com')) return 'fab fa-medium';
            if (urlLower.includes('quora.com')) return 'fab fa-quora';
            if (urlLower.includes('flickr.com')) return 'fab fa-flickr';
            if (urlLower.includes('vimeo.com')) return 'fab fa-vimeo';
            if (urlLower.includes('spotify.com')) return 'fab fa-spotify';
            
            // Tier 2: Professional & Creative
            if (urlLower.includes('github.com')) return 'fab fa-github';
            if (urlLower.includes('gitlab.com')) return 'fab fa-gitlab';
            if (urlLower.includes('behance.net')) return 'fab fa-behance';
            if (urlLower.includes('dribbble.com')) return 'fab fa-dribbble';
            if (urlLower.includes('stackoverflow.com')) return 'fab fa-stack-overflow';
            if (urlLower.includes('deviantart.com')) return 'fab fa-deviantart';
            
            // Tier 3: Regional
            if (urlLower.includes('weibo.com')) return 'fab fa-weibo';
            if (urlLower.includes('vk.com')) return 'fab fa-vk';
            if (urlLower.includes('line.me')) return 'fab fa-line';
            
            // Default
            return 'fas fa-user-circle';
        }

        // Helper: Get platform name (150+ platforms support)
        function getPlatformName(url) {
            const urlLower = url.toLowerCase();
            
            // Major platforms
            if (urlLower.includes('facebook.com') || urlLower.includes('fb.com')) return 'Facebook';
            if (urlLower.includes('instagram.com')) return 'Instagram';
            if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) return 'Twitter / X';
            if (urlLower.includes('linkedin.com')) return 'LinkedIn';
            if (urlLower.includes('tiktok.com')) return 'TikTok';
            if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) return 'YouTube';
            if (urlLower.includes('pinterest.com')) return 'Pinterest';
            if (urlLower.includes('snapchat.com')) return 'Snapchat';
            if (urlLower.includes('whatsapp.com')) return 'WhatsApp';
            if (urlLower.includes('telegram.org') || urlLower.includes('t.me')) return 'Telegram';
            if (urlLower.includes('reddit.com')) return 'Reddit';
            if (urlLower.includes('tumblr.com')) return 'Tumblr';
            if (urlLower.includes('discord.com')) return 'Discord';
            if (urlLower.includes('twitch.tv')) return 'Twitch';
            if (urlLower.includes('medium.com')) return 'Medium';
            if (urlLower.includes('quora.com')) return 'Quora';
            if (urlLower.includes('flickr.com')) return 'Flickr';
            if (urlLower.includes('vimeo.com')) return 'Vimeo';
            if (urlLower.includes('spotify.com')) return 'Spotify';
            if (urlLower.includes('github.com')) return 'GitHub';
            if (urlLower.includes('gitlab.com')) return 'GitLab';
            if (urlLower.includes('behance.net')) return 'Behance';
            if (urlLower.includes('dribbble.com')) return 'Dribbble';
            if (urlLower.includes('stackoverflow.com')) return 'Stack Overflow';
            if (urlLower.includes('deviantart.com')) return 'DeviantArt';
            if (urlLower.includes('weibo.com')) return 'Weibo';
            if (urlLower.includes('vk.com')) return 'VK';
            if (urlLower.includes('line.me')) return 'LINE';
            
            return 'Social Media';
        }

        // Helper: Get video embed URL
        function getVideoEmbedUrl(url) {
            if (!url) return '';
            
            const urlLower = url.toLowerCase();
            
            // YouTube
            if (urlLower.includes('youtube.com/watch') || urlLower.includes('youtu.be/')) {
                let videoId = '';
                if (urlLower.includes('youtube.com/watch')) {
                    const match = url.match(/[?&]v=([^&]+)/);
                    videoId = match ? match[1] : '';
                } else if (urlLower.includes('youtu.be/')) {
                    const match = url.match(/youtu\.be\/([^?]+)/);
                    videoId = match ? match[1] : '';
                }
                if (videoId) {
                    return `https://www.youtube.com/embed/${videoId}`;
                }
            }
            
            // Vimeo
            if (urlLower.includes('vimeo.com/')) {
                const match = url.match(/vimeo\.com\/(\d+)/);
                if (match && match[1]) {
                    return `https://player.vimeo.com/video/${match[1]}`;
                }
            }
            
            // Default: return original URL
            return url;
        }

        // Helper: Get platform color
        function getPlatformColor(url) {
            const urlLower = url.toLowerCase();
            
            if (urlLower.includes('facebook.com') || urlLower.includes('fb.com')) return '#1877f2';
            if (urlLower.includes('instagram.com')) return '#e4405f';
            if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) return '#1da1f2';
            if (urlLower.includes('linkedin.com')) return '#0a66c2';
            if (urlLower.includes('tiktok.com')) return '#ff0050';
            if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) return '#ff0000';
            if (urlLower.includes('pinterest.com')) return '#e60023';
            if (urlLower.includes('snapchat.com')) return '#fffc00';
            if (urlLower.includes('whatsapp.com')) return '#25d366';
            if (urlLower.includes('telegram.org') || urlLower.includes('t.me')) return '#0088cc';
            if (urlLower.includes('reddit.com')) return '#ff4500';
            if (urlLower.includes('tumblr.com')) return '#35465c';
            if (urlLower.includes('discord.com')) return '#5865f2';
            if (urlLower.includes('twitch.tv')) return '#9146ff';
            if (urlLower.includes('medium.com')) return '#00ab6c';
            if (urlLower.includes('github.com')) return '#181717';
            
            return '#667eea';
        }

        // Helper: Extract image from result (ENHANCED - prioritizes profile/post images)
        function extractImage(result, platform) {
            // Priority 1: Best image from backend (already extracted and prioritized)
            if (result.best_image && result.best_image.src) {
                return result.best_image.src;
            }
            
            // Priority 2: All images array (try first one)
            if (result.all_images && result.all_images.length > 0 && result.all_images[0].src) {
                return result.all_images[0].src;
            }
            
            // Priority 3: Direct image property (from image search)
            if (result.image && result.image.src) {
                return result.image.src;
            }
            
            // Priority 4: Pagemap extraction (fallback if backend didn't extract)
            if (result.pagemap) {
                // Try Open Graph image first (best for social media profiles/posts)
                if (result.pagemap['metatags'] && result.pagemap['metatags'][0]) {
                    const meta = result.pagemap['metatags'][0];
                    if (meta['og:image']) return meta['og:image'];
                    if (meta['twitter:image']) return meta['twitter:image'];
                    if (meta['image']) return meta['image'];
                }
                
                // Try CSE Image (Google's extracted image)
                if (result.pagemap['cse_image'] && result.pagemap['cse_image'][0]) {
                    return result.pagemap['cse_image'][0].src;
                }
                
                // Try CSE Thumbnail
                if (result.pagemap['cse_thumbnail'] && result.pagemap['cse_thumbnail'][0]) {
                    return result.pagemap['cse_thumbnail'][0].src;
                }
            }
            
            // Priority 5: Try to extract from URL patterns (for some platforms)
            const link = result.link || '';
            if (link.includes('facebook.com') && link.includes('/photo')) {
                // Facebook photo URLs sometimes have image IDs
                // Could try to construct image URL, but better to rely on pagemap
            }
            
            // Priority 6: Generate platform-specific placeholder (last resort)
            const color = getPlatformColor(result.link);
            const icon = getPlatformIcon(result.link).replace('fab fa-', '').replace('fas fa-', '');
            
            // Return a placeholder SVG with platform color
            return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='${encodeURIComponent(color)}'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='80' fill='white' font-family='Arial'%3E${platform.charAt(0)}%3C/text%3E%3C/svg%3E`;
        }

        // Helper: Check if URL is social media (150+ platforms)
        function isSocialMedia(url) {
            const socialDomains = [
                'facebook.com', 'fb.com', 'instagram.com', 'twitter.com', 'x.com',
                'linkedin.com', 'tiktok.com', 'youtube.com', 'pinterest.com', 'snapchat.com',
                'whatsapp.com', 'telegram.org', 't.me', 'reddit.com', 'tumblr.com',
                'discord.com', 'twitch.tv', 'medium.com', 'quora.com', 'flickr.com',
                'vimeo.com', 'dailymotion.com', 'weibo.com', 'wechat.com', 'qq.com',
                'bilibili.com', 'douban.com', 'line.me', 'kakao.com', 'naver.com',
                'band.us', 'vk.com', 'ok.ru', 'mail.ru', 'kaskus.co.id',
                'sharechat.com', 'moj.app', 'github.com', 'gitlab.com', 'stackoverflow.com',
                'behance.net', 'dribbble.com', 'deviantart.com', 'artstation.com', 
                'angellist.com', 'xing.com', 'signal.org', 'viber.com', 'kik.com',
                'skype.com', 'slack.com', 'teams.microsoft.com', 'zoom.us',
                'kick.com', 'dlive.tv', 'trovo.live', 'caffeine.tv', 'younow.com',
                'periscope.tv', 'myspace.com', 'mewe.com', 'mastodon.social', 
                'bereal.com', 'lemon8-app.com', 'threads.net', 'bsky.app', 'bluesky.social',
                'polywork.com', 'truthsocial.com', 'gettr.com', 'parler.com', 'rumble.com',
                'gab.com', 'minds.com', 'bitchute.com', 'odysee.com', 'tinder.com',
                'bumble.com', 'hinge.co', 'okcupid.com', 'match.com', 'wordpress.com',
                'blogger.com', 'blogspot.com', 'ghost.org', 'substack.com', 'patreon.com',
                'ko-fi.com', 'buymeacoffee.com', 'digg.com', 'mix.com', 'pocket.com',
                'flipboard.com', 'goodreads.com', 'letterboxd.com', 'last.fm', 
                'spotify.com', 'steam.com', 'steamcommunity.com', 'epicgames.com',
                'playstation.com', 'xbox.com', 'roblox.com', '500px.com', 'vsco.co',
                'strava.com', 'myfitnesspal.com', 'untappd.com'
            ];
            
            const urlLower = url.toLowerCase();
            return socialDomains.some(domain => urlLower.includes(domain)) ||
                   urlLower.includes('/profile/') || 
                   urlLower.includes('/user/') || 
                   urlLower.includes('/@');
        }

        function displayUniversalResults(data, searchName) {
            const resultsElement = document.getElementById('universalResults');
            const socialLinksElement = document.getElementById('socialLinks');
            const socialGridElement = document.getElementById('socialGrid');

            if (!resultsElement) return;

            let resultsHTML = '';
            let socialLinksHTML = '';
            const socialLinks = [];

            if (data.organic_results && data.organic_results.length > 0) {
                data.organic_results.forEach((result, index) => {
                    // Extract social media links (150+ platforms)
                    if (result.link && isSocialMedia(result.link)) {
                        socialLinks.push(result);
                    }

                    // Create result item
                    resultsHTML += `
                        <div class="result-item">
                            <div class="result-title">
                                <i class="fas fa-external-link-alt"></i>
                                <a href="${result.link}" target="_blank" rel="noopener noreferrer">
                                    ${result.title || 'No Title'}
                                </a>
                            </div>
                            <div class="result-snippet">
                                ${result.snippet || 'No description available'}
                            </div>
                            <div class="result-meta">
                                <div class="result-source">
                                    <i class="fas fa-globe"></i>
                                    <span>${result.source || 'Unknown Source'}</span>
                                </div>
                                <div class="result-position">
                                    #${result.position || index + 1}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                resultsHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Tidak ditemukan hasil pencarian universal untuk "${searchName}"</p>
                    </div>
                `;
            }

            resultsElement.innerHTML = resultsHTML;

            // Display social media links if found (with RELEVANCE SORTING!)
            if (socialLinks.length > 0) {
                console.log(`Found ${socialLinks.length} social media profiles for: ${searchName}`);
                
                // Sort by RELEVANCE (name matching first!)
                const sortedLinks = socialLinks.sort((a, b) => {
                    const scoreA = getRelevanceScore(a, searchName);
                    const scoreB = getRelevanceScore(b, searchName);
                    return scoreB - scoreA; // Higher score first
                });
                
                console.log('Sorted by relevance, displaying...');
                
                sortedLinks.forEach((link, index) => {
                    const platform = getPlatformName(link.link);
                    const icon = getPlatformIcon(link.link);
                    const color = getPlatformColor(link.link);
                    const imageUrl = extractImage(link, platform);
                    const relevanceScore = getRelevanceScore(link, searchName);
                    
                    // Highlight high relevance items
                    const isHighRelevance = relevanceScore >= 3;
                    const relevanceBadge = isHighRelevance ? 
                        '<span style="display: inline-block; padding: 2px 6px; background: #10b981; color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-star" style="font-size: 0.6rem;"></i> MATCH</span>' : '';

                    socialLinksHTML += `
                        <div class="social-item" style="border-left: 3px solid ${color}; ${isHighRelevance ? 'box-shadow: 0 0 0 2px ' + color + '20;' : ''}">
                            <a href="${link.link}" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
                                <!-- Profile Image (ALWAYS SHOWN - Optimized for faster loading) -->
                                <div style="width: 100%; height: 80px; overflow: hidden; border-radius: 6px; margin-bottom: 10px; background: linear-gradient(135deg, ${color}15, ${color}05);">
                                    <img src="${imageUrl}" 
                                         alt="${platform}" 
                                         loading="lazy"
                                         style="width: 100%; height: 100%; object-fit: cover;"
                                         onerror="this.style.objectFit='contain'; this.style.padding='10px';">
                                </div>
                                
                                <!-- Platform Info -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="color: ${color}; font-size: 1.5rem;">
                                    <i class="${icon}"></i>
                                </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                                            <span style="font-weight: 700; color: ${color}; font-size: 0.9rem;">${platform}</span>
                                            <span style="padding: 2px 6px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600;">
                                                <i class="fab fa-google" style="font-size: 0.6rem;"></i> GOOGLE
                                            </span>
                                            ${relevanceBadge}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Profile Title -->
                                <div style="font-size: 0.85rem; font-weight: 600; color: #1f2937; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">
                                    ${link.title || 'Profile'}
                                </div>
                                
                                <!-- Snippet -->
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 8px;">
                                    ${link.snippet || 'Social media profile'}
                                    </div>
                                
                                <!-- Link -->
                                <div style="padding-top: 8px; border-top: 1px solid #f3f4f6;">
                                    <span style="font-size: 0.7rem; color: #9ca3af;">
                                        <i class="fas fa-link"></i> ${link.link.replace(/^https?:\/\//, '').substring(0, 40)}${link.link.length > 40 ? '...' : ''}
                                    </span>
                                </div>
                            </a>
                        </div>
                    `;
                });

                socialGridElement.innerHTML = socialLinksHTML;
                socialLinksElement.style.display = 'block';
                
                // Update header with count
                const headerElement = socialLinksElement.querySelector('h4');
                if (headerElement) {
                    headerElement.innerHTML = `<i class="fas fa-share-alt"></i> Social Media Links <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px;">${socialLinks.length} profiles</span>`;
                }
            } else {
                socialLinksElement.style.display = 'none';
            }
        }

        // ============================================================================
        // EXTRACTION & CATEGORIZATION FUNCTIONS (150+ platforms)
        // ============================================================================

        // Extract ALL Social Media Links from results (150+ platforms detection) - ULTRA SENSITIVE!
        function extractSocialMediaLinks(results) {
            const socialMediaLinks = [];
            
            // Comprehensive list of 150+ social media domains (EXPANDED!)
            const socialMediaDomains = [
                // Tier 1: Major Platforms (dengan semua varian domain)
                'facebook.com', 'fb.com', 'fb.me', 'fb.watch', 'messenger.com', 'm.facebook.com', 'web.facebook.com',
                'instagram.com', 'instagr.am', 'ig.me', 'm.instagram.com',
                'twitter.com', 'x.com', 't.co', 'twimg.com', 'mobile.twitter.com',
                'linkedin.com', 'lnkd.in', 'licdn.com',
                'tiktok.com', 'vm.tiktok.com', 'm.tiktok.com',
                'youtube.com', 'youtu.be', 'yt.be', 'ytimg.com', 'm.youtube.com',
                'pinterest.com', 'pin.it', 'pinimg.com',
                'snapchat.com', 'snap.com',
                'whatsapp.com', 'wa.me', 'chat.whatsapp.com',
                'telegram.org', 't.me', 'telegram.me',
                
                // Tier 2: Popular Platforms
                'reddit.com', 'redd.it', 'old.reddit.com',
                'tumblr.com', 'tmblr.co',
                'discord.com', 'discord.gg', 'discordapp.com',
                'twitch.tv', 'twitch.com',
                'medium.com',
                'quora.com',
                'flickr.com', 'flic.kr',
                'vimeo.com',
                'dailymotion.com',
                
                // Tier 3: Asian & Regional
                'weibo.com', 'sina.com.cn',
                'wechat.com', 'weixin.qq.com',
                'qq.com',
                'bilibili.com',
                'douban.com',
                'line.me', 'line.naver.jp',
                'kakao.com', 'kakaotalk.com',
                'naver.com',
                'band.us',
                'vk.com', 'vkontakte.ru',
                'ok.ru', 'odnoklassniki.ru',
                'mail.ru',
                'kaskus.co.id',
                'sharechat.com',
                'moj.app',
                
                // Tier 4: Professional & Creative
                'github.com',
                'gitlab.com',
                'stackoverflow.com', 'stackexchange.com',
                'behance.net',
                'dribbble.com',
                'deviantart.com',
                'artstation.com',
                'angellist.com',
                'xing.com',
                
                // Tier 5: Messaging
                'signal.org',
                'viber.com',
                'kik.com',
                'skype.com',
                'slack.com',
                'teams.microsoft.com',
                'zoom.us',
                
                // Tier 6: Video & Streaming
                'kick.com',
                'dlive.tv',
                'trovo.live',
                'caffeine.tv',
                'younow.com',
                'periscope.tv', 'pscp.tv',
                'streamlabs.com',
                
                // Tier 7: Alternative & Emerging
                'myspace.com',
                'mewe.com',
                'mastodon.social', 'mastodon.online',
                'bereal.com',
                'lemon8-app.com',
                'threads.net',
                'bsky.app', 'bluesky.social',
                'polywork.com',
                'truthsocial.com', 'truth.social',
                'gettr.com',
                'parler.com',
                'rumble.com',
                'gab.com',
                'minds.com',
                'bitchute.com',
                'odysee.com',
                
                // Tier 8: Dating & Social
                'tinder.com',
                'bumble.com',
                'hinge.co',
                'okcupid.com',
                'match.com',
                
                // Tier 9: Blogging & Publishing
                'wordpress.com',
                'blogger.com', 'blogspot.com',
                'ghost.org',
                'substack.com',
                'patreon.com',
                'ko-fi.com',
                'buymeacoffee.com',
                
                // Tier 10: Social Bookmarking
                'digg.com',
                'mix.com',
                'pocket.com',
                'flipboard.com',
                'goodreads.com',
                'letterboxd.com',
                'last.fm',
                'spotify.com',
                
                // Tier 11: Gaming
                'steam.com', 'steamcommunity.com',
                'epicgames.com',
                'playstation.com',
                'xbox.com',
                'roblox.com',
                
                // Tier 12: Niche
                'strava.com',
                'myfitnesspal.com',
                'untappd.com',
                '500px.com',
                'vsco.co'
            ];
            
            // Keywords that indicate social media profiles (EXPANDED!)
            const socialKeywords = [
                '/profile/', '/user/', '/@', '/channel/', '/people/', '/member/',
                '/account/', '/p/', '/u/', '/c/', '/author/', '/creator/',
                'profile', 'user', 'account', 'member', 'people', 'person',
                'social', 'community', 'network', 'follow', 'followers'
            ];
            
            results.forEach(result => {
                const link = (result.link || '').toLowerCase();
                const title = (result.title || '').toLowerCase();
                
                // Check 1: Domain matching
                const hasSocialDomain = socialMediaDomains.some(domain => link.includes(domain));
                
                // Check 2: Pattern matching
                const hasSocialPattern = socialKeywords.some(keyword => link.includes(keyword));
                
                // Check 3: Title matching (jika title mengandung "profile", "account", dll)
                const hasSocialTitle = socialKeywords.some(keyword => title.includes(keyword));
                
                // Tambahkan jika memenuhi SALAH SATU kriteria (lebih permissive!)
                if (hasSocialDomain || hasSocialPattern || hasSocialTitle) {
                    socialMediaLinks.push(result);
                }
            });
            
            console.log(`âœ“ Detected ${socialMediaLinks.length} social media links from ${results.length} total results`);
            return socialMediaLinks;
        }

        // Categorize Results (News, Social Media, Blog, Forum, Video, Official, Other)
        function categorizeResults(results) {
            const categories = {
                'News': [],
                'Official': [],
                'Social Media': [],
                'Postingan': [],
                'Blog': [],
                'Forum': [],
                'Video': [],
                'Lainnya': []
            };
            
            // Social Media Domains - SUPER LENGKAP (150+ platforms)
            const socialMediaDomains = [
                'facebook.com', 'fb.com', 'instagram.com', 'twitter.com', 'x.com',
                'linkedin.com', 'tiktok.com', 'youtube.com', 'pinterest.com', 'snapchat.com',
                'whatsapp.com', 'telegram.org', 't.me', 'reddit.com', 'tumblr.com',
                'discord.com', 'twitch.tv', 'medium.com', 'quora.com', 'flickr.com',
                'vimeo.com', 'dailymotion.com', 'weibo.com', 'wechat.com', 'qq.com',
                'bilibili.com', 'douban.com', 'line.me', 'kakao.com', 'naver.com',
                'band.us', 'vk.com', 'ok.ru', 'mail.ru', 'kaskus.co.id',
                'sharechat.com', 'moj.app', 'github.com', 'gitlab.com', 'stackoverflow.com',
                'behance.net', 'dribbble.com', 'deviantart.com', 'artstation.com',
                'angellist.com', 'xing.com', 'signal.org', 'viber.com', 'kik.com',
                'skype.com', 'slack.com', 'teams.microsoft.com', 'zoom.us',
                'kick.com', 'dlive.tv', 'trovo.live', 'caffeine.tv', 'younow.com',
                'periscope.tv', 'myspace.com', 'mewe.com', 'mastodon.social',
                'bereal.com', 'lemon8-app.com', 'threads.net', 'bsky.app', 'bluesky.social',
                'polywork.com', 'truthsocial.com', 'gettr.com', 'parler.com', 'rumble.com',
                'gab.com', 'minds.com', 'bitchute.com', 'odysee.com', 'tinder.com',
                'bumble.com', 'hinge.co', 'okcupid.com', 'match.com', 'wordpress.com',
                'blogger.com', 'blogspot.com', 'ghost.org', 'substack.com', 'patreon.com',
                'ko-fi.com', 'buymeacoffee.com', 'digg.com', 'mix.com', 'pocket.com',
                'flipboard.com', 'goodreads.com', 'letterboxd.com', 'last.fm',
                'spotify.com', 'steam.com', 'steamcommunity.com', 'epicgames.com',
                'playstation.com', 'xbox.com', 'roblox.com', '500px.com', 'vsco.co',
                'strava.com', 'myfitnesspal.com', 'untappd.com',
                '/profile/', '/user/', '/@', '/channel/', '/people/'
            ];
            
            // News Keywords - COMPREHENSIVE
            const newsKeywords = [
                'news', 'berita', 'detik', 'kompas', 'tempo', 'tribun', 'liputan',
                'cnbc', 'cnn', 'bbc', 'reuters', 'bloomberg', 'antaranews', 'viva',
                'okezone', 'suara', 'merdeka', 'jpnn', 'sindonews', 'bisnis',
                'kontan', 'idntimes', 'kumparan', 'tirto', 'vice', 'vice.com'
            ];
            
            // Official Keywords
            const officialKeywords = [
                '.gov', '.go.id', 'official', 'resmi', 'pemerintah', 'kemenkeu',
                'kemendag', 'polri', 'tni', 'bpk', 'kpu', 'kominfo'
            ];
            
            // Blog Keywords
            const blogKeywords = [
                'blog', 'personal', 'diary', 'wordpress', 'blogspot', 'medium',
                'tumblr', 'substack'
            ];
            
            // Forum Keywords
            const forumKeywords = [
                'forum', 'community', 'discussion', 'kaskus', 'reddit', 'quora',
                'stackexchange', 'stackoverflow'
            ];
            
            // Video Keywords
            const videoKeywords = [
                'youtube', 'youtu.be', 'vimeo', 'dailymotion', 'video',
                'bilibili', 'tiktok'
            ];
            
            results.forEach((result, index) => {
                const link = (result.link || '').toLowerCase();
                const title = (result.title || '').toLowerCase();
                const snippet = (result.snippet || '').toLowerCase();
                
                // Use content_type from backend if available, otherwise detect from frontend
                let category = 'Lainnya';
                let icon = 'fas fa-globe';
                let color = '#6b7280';
                
                if (result.content_type) {
                    // Use backend content_type
                    const contentTypeMap = {
                        'news': { category: 'News', icon: 'fas fa-newspaper', color: '#ef4444' },
                        'official': { category: 'Official', icon: 'fas fa-landmark', color: '#3b82f6' },
                        'social_media': { category: 'Social Media', icon: 'fas fa-share-alt', color: '#10b981' },
                        'posting': { category: 'Postingan', icon: 'fas fa-file-alt', color: '#8b5cf6' },
                        'blog': { category: 'Blog', icon: 'fas fa-edit', color: '#f59e0b' },
                        'forum': { category: 'Forum', icon: 'fas fa-comments', color: '#ec4899' },
                        'video': { category: 'Video', icon: 'fas fa-play-circle', color: '#ef4444' },
                        'general': { category: 'Lainnya', icon: 'fas fa-globe', color: '#6b7280' }
                    };
                    
                    const typeInfo = contentTypeMap[result.content_type] || contentTypeMap['general'];
                    category = typeInfo.category;
                    icon = typeInfo.icon;
                    color = typeInfo.color;
                    
                    // Special handling for social media - get platform color
                    if (result.content_type === 'social_media') {
                        color = getPlatformColor(result.link);
                    }
                } else {
                    // Fallback: Frontend detection (for backward compatibility)
                    // PRIORITY ORDER: News > Official > Blog > Forum > Video > Social Media > Other
                    
                    // 1. Check News first (highest priority for non-social)
                    if (newsKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'News';
                        icon = 'fas fa-newspaper';
                        color = '#ef4444';
                    }
                    // 2. Official
                    else if (officialKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'Official';
                        icon = 'fas fa-landmark';
                        color = '#3b82f6';
                    }
                    // 3. Blog
                    else if (blogKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'Blog';
                        icon = 'fas fa-edit';
                        color = '#8b5cf6';
                    }
                    // 4. Forum
                    else if (forumKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'Forum';
                        icon = 'fas fa-comments';
                        color = '#f59e0b';
                    }
                    // 5. Video
                    else if (videoKeywords.some(kw => link.includes(kw))) {
                        category = 'Video';
                        icon = 'fas fa-play-circle';
                        color = '#ef4444';
                    }
                    // 6. Social Media (after others to avoid over-categorization)
                    else if (socialMediaDomains.some(domain => link.includes(domain))) {
                        category = 'Social Media';
                        icon = 'fas fa-share-alt';
                        color = '#10b981';
                        // Get specific platform color if available
                        color = getPlatformColor(result.link);
                    }
                }
                
                // Add to category with metadata
                categories[category].push({
                    ...result,
                    category: category,
                    categoryIcon: icon,
                    categoryColor: color,
                    platform: category === 'Social Media' ? getPlatformName(result.link) : category,
                    position: index + 1
                });
            });
            
            console.log('âœ“ Categorization complete:',
                Object.entries(categories).map(([cat, items]) => `${cat}: ${items.length}`).join(', '));
            
            return categories;
        }

        // ============================================================================
        // DISPLAY FUNCTIONS
        // ============================================================================

        // Display Categorized Results
        function displayCategorizedResults(categorized) {
            const container = document.getElementById('categorizedResults');
            if (!container) return;
            
            let html = '';
            let totalResults = 0;
            
            // Display each category
            Object.entries(categorized).forEach(([category, items]) => {
                if (items.length > 0) {
                    totalResults += items.length;
                    const categoryIcon = items[0].categoryIcon || 'fas fa-folder';
                    const categoryColor = items[0].categoryColor || '#6b7280';
                    
                    html += `
                        <div class="category-section" style="margin-bottom: 30px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid ${categoryColor};">
                                <i class="${categoryIcon}" style="color: ${categoryColor}; font-size: 1.5rem;"></i>
                                <h4 style="margin: 0; color: ${categoryColor}; font-size: 1.1rem;">${category}</h4>
                                <span style="background: ${categoryColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">${items.length}</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                    `;
                    
                    items.forEach((item, index) => {
                        html += createDetailedResultItemHTML(item, index);
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            if (totalResults === 0) {
                html = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-layer-group" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Tidak ada hasil untuk dikategorikan</p>
                    </div>
                `;
            }

            container.innerHTML = html;
            console.log(`âœ“ Displayed ${totalResults} categorized results`);
        }

        // Create Detailed Result Item HTML
        function createDetailedResultItemHTML(result, index) {
            const categoryIcon = result.categoryIcon || 'fas fa-globe';
            const categoryColor = result.categoryColor || '#6b7280';
            const category = result.category || 'Lainnya';
            const platform = result.platform || 'Website';
            
            // Content Type Detection (from backend)
            const contentType = result.content_type || 'general';
            const contentTypeLabels = {
                'news': { label: 'Berita', icon: 'fas fa-newspaper', color: '#ef4444' },
                'official': { label: 'Resmi', icon: 'fas fa-landmark', color: '#3b82f6' },
                'social_media': { label: 'Social Media', icon: 'fas fa-share-alt', color: '#10b981' },
                'posting': { label: 'Postingan', icon: 'fas fa-file-alt', color: '#8b5cf6' },
                'blog': { label: 'Blog', icon: 'fas fa-edit', color: '#f59e0b' },
                'forum': { label: 'Forum', icon: 'fas fa-comments', color: '#ec4899' },
                'video': { label: 'Video', icon: 'fas fa-play-circle', color: '#ef4444' },
                'general': { label: 'Umum', icon: 'fas fa-globe', color: '#6b7280' }
            };
            const contentTypeInfo = contentTypeLabels[contentType] || contentTypeLabels['general'];
            
            // Location Information
            const detectedLocations = result.detected_locations || [];
            const locationScore = result.location_score || 0;
            let locationBadge = '';
            if (detectedLocations.length > 0) {
                const locationText = detectedLocations.slice(0, 2).join(', '); // Show max 2 locations
                const locationColor = locationScore >= 60 ? '#10b981' : locationScore >= 40 ? '#f59e0b' : '#6b7280';
                locationBadge = `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: ${locationColor}15; color: ${locationColor}; border-radius: 8px; font-size: 0.7rem; font-weight: 600; border: 1px solid ${locationColor}40;">
                    <i class="fas fa-map-marker-alt" style="font-size: 0.65rem;"></i>
                    ${locationText}${detectedLocations.length > 2 ? ' +' + (detectedLocations.length - 2) : ''}
                </span>`;
            }
            
            // Relevance Badge (if location score is high)
            let relevanceBadge = '';
            if (locationScore >= 80) {
                relevanceBadge = `<span style="display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;">
                    <i class="fas fa-star" style="font-size: 0.6rem;"></i> RELEVAN
                </span>`;
            } else if (locationScore >= 60) {
                relevanceBadge = `<span style="display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;">
                    <i class="fas fa-check-circle" style="font-size: 0.6rem;"></i> TERKAIT
                </span>`;
            }
            
            // Tentukan sumber hasil (Universal vs Social Media vs Social Searcher Style)
            const isUniversal = result.source === 'Universal Search';
            const isSocialSearcher = result.source === 'Social Searcher Style';
            
            // Platform badge untuk Social Searcher Style
            let platformBadge = '';
            if (isSocialSearcher && result.platform) {
                const platformColors = {
                    'facebook': '#1877f2',
                    'instagram': '#e4405f',
                    'twitter': '#1da1f2',
                    'linkedin': '#0077b5',
                    'tiktok': '#000000',
                    'pinterest': '#bd081c'
                };
                const platformIcons = {
                    'facebook': 'fab fa-facebook',
                    'instagram': 'fab fa-instagram',
                    'twitter': 'fab fa-twitter',
                    'linkedin': 'fab fa-linkedin',
                    'tiktok': 'fab fa-tiktok',
                    'pinterest': 'fab fa-pinterest'
                };
                const color = platformColors[result.platform] || '#667eea';
                const icon = platformIcons[result.platform] || 'fas fa-share-alt';
                platformBadge = `<span style="display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; background: ${color}; color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px; text-transform: capitalize;"><i class="${icon}" style="font-size: 0.6rem;"></i> ${result.platform}</span>`;
            }
            
            const sourceBadge = isUniversal
                ? '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;"><i class="fas fa-server"></i> INTERNAL</span>'
                : isSocialSearcher
                ? '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;"><i class="fas fa-search"></i> SOCIAL SEARCHER</span>'
                : '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;"><i class="fab fa-google"></i> GOOGLE</span>';
            
            return `
                <div class="result-item" style="border-left: 4px solid ${categoryColor}; background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s ease; ${locationScore >= 80 ? 'border-left-width: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);' : ''}">
                    <div class="result-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span class="content-type-tag" style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: ${contentTypeInfo.color}15; color: ${contentTypeInfo.color}; border-radius: 12px; font-size: 0.75rem; font-weight: 600; border: 1px solid ${contentTypeInfo.color}30;">
                                <i class="${contentTypeInfo.icon}"></i>
                                ${contentTypeInfo.label}
                            </span>
                            ${locationBadge}
                            ${relevanceBadge}
                            ${sourceBadge}
                            ${platformBadge}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${locationScore > 0 ? `<span style="font-size: 0.7rem; color: #9ca3af; font-weight: 500;">Relevansi: ${locationScore}%</span>` : ''}
                            <span class="result-position" style="font-size: 0.75rem; color: #9ca3af; font-weight: 600; padding: 4px 8px; background: #f3f4f6; border-radius: 6px;">#${index + 1}</span>
                        </div>
                    </div>
                    <div class="result-title" style="margin-bottom: 10px;">
                        <a href="${result.link}" target="_blank" rel="noopener noreferrer" style="font-size: 1.1rem; font-weight: 600; color: #1f2937; text-decoration: none; display: flex; align-items: start; gap: 8px; line-height: 1.4; transition: color 0.2s; word-break: break-word;" onmouseover="this.style.color='#667eea'" onmouseout="this.style.color='#1f2937'">
                            <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-top: 5px; color: ${categoryColor}; flex-shrink: 0;"></i>
                            <span style="flex: 1; word-wrap: break-word; overflow-wrap: break-word;">${result.title || 'No Title'}</span>
                        </a>
                    </div>
                    <div class="result-snippet" style="color: #4b5563; font-size: 0.95rem; line-height: 1.7; margin-bottom: 12px; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid ${contentTypeInfo.color}40; word-wrap: break-word; overflow-wrap: break-word;">
                        ${result.snippet || result.htmlSnippet || result.description || 'No description available'}
                    </div>
                    ${result.pagemap && result.pagemap.cse_thumbnail ? `
                        <div class="result-thumbnail" style="width: 120px; height: 120px; float: left; margin-right: 12px; margin-bottom: 10px; flex-shrink: 0;">
                            <img src="${result.pagemap.cse_thumbnail[0].src}" alt="Thumbnail" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb; box-shadow: 0 1px 4px rgba(0,0,0,0.08); cursor: pointer;" onclick="window.open('${result.pagemap.cse_thumbnail[0].src}', '_blank')" title="Klik untuk melihat gambar penuh">
                        </div>
                    ` : ''}
                    ${result.content_type === 'video' || (result.link && (result.link.includes('youtube.com') || result.link.includes('youtu.be') || result.link.includes('vimeo.com'))) ? `
                        <div class="video-embed-container" onclick="window.open('${result.link}', '_blank')" title="Klik untuk membuka video">
                            <iframe src="${getVideoEmbedUrl(result.link)}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    ` : ''}
                    <div class="result-meta" style="display: flex; align-items: center; gap: 12px; padding-top: 10px; border-top: 1px solid #f3f4f6; flex-wrap: wrap;">
                        <div class="result-source" style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #6b7280;">
                            <i class="fas fa-link" style="color: ${categoryColor};"></i>
                            <span>${result.displayLink || result.formattedUrl || result.link?.replace(/^https?:\/\//, '').split('/')[0] || 'Unknown Source'}</span>
                        </div>
                        ${result.pagemap && result.pagemap.metatags && result.pagemap.metatags[0] && result.pagemap.metatags[0]['og:type'] ? `
                            <span style="font-size: 0.75rem; color: #9ca3af;">â€¢</span>
                            <span style="font-size: 0.75rem; color: #6b7280; text-transform: capitalize;">${result.pagemap.metatags[0]['og:type']}</span>
                        ` : ''}
                        ${result.cacheId ? `
                            <span style="font-size: 0.75rem; color: #9ca3af;">â€¢</span>
                            <a href="https://webcache.googleusercontent.com/search?q=cache:${result.cacheId}" target="_blank" style="font-size: 0.75rem; color: #667eea; text-decoration: none;">
                                <i class="fas fa-archive"></i> Cached
                            </a>
                        ` : ''}
                    </div>
                        </div>
                    `;
        }

        // Display Social Media Web Results (API Results tab)
        function displaySocialMediaWebResults(results, searchName) {
            const container = document.getElementById('socialMediaWebResults');
            if (!container) {
                console.error('âŒ [Display] Container #socialMediaWebResults NOT FOUND!');
                return;
            }
            
            let html = '';
            
            if (results && results.length > 0) {
                console.log(`âœ… [Display] Displaying ${results.length} web results in API Results tab`);
                
                // Count by source for debugging
                const sourceCounts = {};
                results.forEach(r => {
                    const source = r.source || 'Unknown';
                    sourceCounts[source] = (sourceCounts[source] || 0) + 1;
                });
                console.log(`ðŸ“Š [Display] Source breakdown:`, sourceCounts);
                
                results.forEach((result, index) => {
                    const isUniversal = result.source === 'Universal Search';
                    const isSocialSearcher = result.source === 'Social Searcher Style';
                    
                    // Platform badge untuk Social Searcher Style
                    let platformBadge = '';
                    if (isSocialSearcher && result.platform) {
                        const platformColors = {
                            'facebook': '#1877f2',
                            'instagram': '#e4405f',
                            'twitter': '#1da1f2',
                            'linkedin': '#0077b5',
                            'tiktok': '#000000',
                            'pinterest': '#bd081c'
                        };
                        const platformIcons = {
                            'facebook': 'fab fa-facebook',
                            'instagram': 'fab fa-instagram',
                            'twitter': 'fab fa-twitter',
                            'linkedin': 'fab fa-linkedin',
                            'tiktok': 'fab fa-tiktok',
                            'pinterest': 'fab fa-pinterest'
                        };
                        const color = platformColors[result.platform] || '#667eea';
                        const icon = platformIcons[result.platform] || 'fas fa-share-alt';
                        platformBadge = `<span style="display: inline-block; padding: 2px 6px; background: ${color}; color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px; text-transform: capitalize;"><i class="${icon}" style="font-size: 0.6rem;"></i> ${result.platform}</span>`;
                    }
                    
                    const sourceBadge = isUniversal
                        ? '<span style="display: inline-block; padding: 2px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;"><i class="fas fa-server"></i> INTERNAL</span>'
                        : isSocialSearcher
                        ? '<span style="display: inline-block; padding: 2px 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;"><i class="fas fa-search"></i> SOCIAL SEARCHER</span>'
                        : '<span style="display: inline-block; padding: 2px 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;"><i class="fab fa-google"></i> GOOGLE</span>';
                    
                    html += `
                        <div class="result-item" style="padding: 15px; margin-bottom: 15px; background: white; border-radius: 12px; border-left: 4px solid #667eea; word-wrap: break-word; overflow-wrap: break-word;">
                            <div class="result-title" style="margin-bottom: 8px;">
                                <a href="${result.link}" target="_blank" rel="noopener noreferrer" style="font-size: 1.05rem; font-weight: 600; color: #1f2937; text-decoration: none; display: flex; align-items: start; gap: 8px; word-break: break-word; overflow-wrap: break-word; flex-wrap: wrap;">
                                    <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-top: 4px; color: #667eea; flex-shrink: 0;"></i>
                                    <span style="flex: 1; word-wrap: break-word; overflow-wrap: break-word;">${result.title || 'No Title'}</span>
                                    <div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; width: 100%;">
                                        ${sourceBadge}
                                        ${platformBadge}
                                    </div>
                            </a>
                        </div>
                            <div class="result-snippet" style="color: #4b5563; font-size: 0.9rem; line-height: 1.6; margin-bottom: 10px; word-wrap: break-word; overflow-wrap: break-word;">
                                ${result.snippet || result.htmlSnippet || result.description || 'No description available'}
                        </div>
                        ${result.pagemap && result.pagemap.cse_thumbnail ? `
                            <div class="result-thumbnail" style="width: 120px; height: 120px; float: left; margin-right: 12px; margin-bottom: 10px; flex-shrink: 0;">
                                <img src="${result.pagemap.cse_thumbnail[0].src}" alt="Thumbnail" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb; box-shadow: 0 1px 4px rgba(0,0,0,0.08); cursor: pointer;" onclick="window.open('${result.pagemap.cse_thumbnail[0].src}', '_blank')" title="Klik untuk melihat gambar penuh">
                            </div>
                        ` : ''}
                        ${result.content_type === 'video' || (result.link && (result.link.includes('youtube.com') || result.link.includes('youtu.be') || result.link.includes('vimeo.com'))) ? `
                            <div class="video-embed-container" onclick="window.open('${result.link}', '_blank')" title="Klik untuk membuka video">
                                <iframe src="${getVideoEmbedUrl(result.link)}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                        ` : ''}
                            <div class="result-meta" style="display: flex; align-items: center; gap: 12px; padding-top: 10px; border-top: 1px solid #f3f4f6; font-size: 0.8rem; color: #6b7280; flex-wrap: wrap; word-wrap: break-word;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-link" style="color: #667eea;"></i>
                                    <span>${result.displayLink || result.formattedUrl || result.link?.replace(/^https?:\/\//, '').split('/')[0] || 'Unknown Source'}</span>
                </div>
                                ${result.pagemap && result.pagemap.metatags && result.pagemap.metatags[0] && result.pagemap.metatags[0]['og:type'] ? `
                                    <span>â€¢</span>
                                    <span style="text-transform: capitalize;">${result.pagemap.metatags[0]['og:type']}</span>
                                ` : ''}
                                ${result.cacheId ? `
                                    <span>â€¢</span>
                                    <a href="https://webcache.googleusercontent.com/search?q=cache:${result.cacheId}" target="_blank" style="color: #667eea; text-decoration: none;">
                                        <i class="fas fa-archive"></i> Cached
                                    </a>
                                ` : ''}
                                <span>â€¢</span>
                                <span>#${index + 1}</span>
                            </div>
                </div>
            `;
                });
            } else {
                console.warn(`âš ï¸ [Display] No results to display for "${searchName}"`);
                html = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Tidak ada hasil ditemukan untuk "${searchName}"</p>
                        <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 10px;">
                            Coba gunakan tab "Categorized" atau "Social Links" untuk melihat hasil dari sumber lain.
                        </p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            console.log(`âœ… [Display] Updated container #socialMediaWebResults with ${results?.length || 0} results`);
            
            // Verify Google CSE results are included
            if (results && results.length > 0) {
                const googleResults = results.filter(r => r.source === 'Google CSE');
                const universalResults = results.filter(r => r.source === 'Universal Search');
                const socialSearcherResults = results.filter(r => r.source === 'Social Searcher Style');
                
                console.log(`ðŸ“Š [Display] Results breakdown in display:`);
                console.log(`   - Google CSE: ${googleResults.length}`);
                console.log(`   - Universal Search (Internal): ${universalResults.length}`);
                console.log(`   - Social Searcher Style: ${socialSearcherResults.length}`);
                
                if (googleResults.length > 0) {
                    console.log(`âœ… [Display] Google CSE results ARE included: ${googleResults.length} items`);
                    console.log(`ðŸ“‹ [Display] Sample Google CSE results:`, googleResults.slice(0, 2).map(r => ({
                        title: r.title?.substring(0, 50),
                        source: r.source
                    })));
                } else {
                    console.warn(`âš ï¸ [Display] WARNING: No Google CSE results in display! Total results: ${results.length}`);
                    console.warn(`   Sources in results:`, [...new Set(results.map(r => r.source || 'Unknown'))]);
                }
            }
        }

        // Display Social Media Links (Social Links tab) dengan RELEVANCE SORTING & IMAGE
        function displaySocialMediaLinks(socialLinks) {
            const container = document.getElementById('socialMediaLinks');
            if (!container) return;
            
            let html = '';
            
            if (socialLinks && socialLinks.length > 0) {
                console.log(`Displaying ${socialLinks.length} social media platforms`);
                
                // Get search name for relevance scoring
                const searchNameElement = document.getElementById('socialMediaSearchName');
                const searchName = searchNameElement ? searchNameElement.textContent.trim().toLowerCase() : '';
                
                console.log('Sorting by relevance for:', searchName);
                
                // Sort by RELEVANCE first (nama person match), then by platform
                const sortedLinks = [...socialLinks].sort((a, b) => {
                    // Calculate relevance score (0-3 points)
                    const scoreA = getRelevanceScore(a, searchName);
                    const scoreB = getRelevanceScore(b, searchName);
                    
                    // Higher score = more relevant = appears first
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA; // Descending (highest first)
                    }
                    
                    // If same relevance, sort by platform name
                    const platformA = getPlatformName(a.link || '');
                    const platformB = getPlatformName(b.link || '');
                    return platformA.localeCompare(platformB);
                });
                
                console.log('Sorted links by relevance:', sortedLinks.length);
                
                // Create grid
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
                
                sortedLinks.forEach((link, index) => {
                    const platform = getPlatformName(link.link);
                    const icon = getPlatformIcon(link.link);
                    const color = getPlatformColor(link.link);
                    const imageUrl = extractImage(link, platform);
                    const relevanceScore = getRelevanceScore(link, searchName);
                    
                    // Detect source (INTERNAL vs GOOGLE vs SOCIAL SEARCHER)
                    const isUniversal = link.source === 'Universal Search';
                    const isSocialSearcher = link.source === 'Social Searcher Style';
                    const sourceBadge = isUniversal
                        ? '<span style="display: inline-block; padding: 2px 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-server" style="font-size: 0.6rem;"></i> INTERNAL</span>'
                        : isSocialSearcher
                        ? '<span style="display: inline-block; padding: 2px 6px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-search" style="font-size: 0.6rem;"></i> SOCIAL SEARCHER</span>'
                        : '<span style="display: inline-block; padding: 2px 6px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fab fa-google" style="font-size: 0.6rem;"></i> GOOGLE</span>';
                    
                    // Highlight high relevance items
                    const isHighRelevance = relevanceScore >= 3;
                    const relevanceBadge = isHighRelevance ?
                        '<span style="display: inline-block; padding: 2px 6px; background: #10b981; color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-star" style="font-size: 0.6rem;"></i> MATCH</span>' : '';
                    
                    html += `
                        <div style="background: white; border-radius: 10px; padding: 15px; border-left: 3px solid ${color}; ${isHighRelevance ? 'box-shadow: 0 0 0 2px ' + color + '20;' : 'border: 1px solid #e5e7eb;'} transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='${isHighRelevance ? '0 0 0 2px ' + color + '20' : 'none'}';">
                            <a href="${link.link}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                                <!-- Profile Image (ALWAYS SHOWN) -->
                                <div style="width: 100%; height: 140px; overflow: hidden; border-radius: 8px; margin-bottom: 12px; background: linear-gradient(135deg, ${color}15, ${color}05);">
                                    <img src="${imageUrl}"
                                         alt="${platform}"
                                         style="width: 100%; height: 100%; object-fit: cover;"
                                         onerror="this.style.objectFit='contain'; this.style.padding='20px';">
                                </div>
                                
                                <!-- Platform Info -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="color: ${color}; font-size: 1.5rem;">
                                        <i class="${icon}"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                                            <div style="font-weight: 700; color: ${color}; font-size: 0.9rem;">${platform}</div>
                                            ${sourceBadge}
                                            ${relevanceBadge}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Profile Title -->
                                <div style="font-size: 0.9rem; font-weight: 600; color: #1f2937; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${link.title || 'Profile'}</div>
                                
                                <!-- Snippet -->
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 8px;">${link.snippet || ''}</div>
                                
                                <!-- Link -->
                                <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #f3f4f6;">
                                    <span style="font-size: 0.7rem; color: #9ca3af;">
                                        <i class="fas fa-link"></i> ${link.displayLink || link.formattedUrl || 'Social Media'}
                                    </span>
                                </div>
                            </a>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add header dengan count
                html = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-users"></i> Social Media Links
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem;">${socialLinks.length} platforms</span>
                        </h4>
                        </div>
                ` + html;
            } else {
                html = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Tidak ada link social media ditemukan</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // ============================================================================
        // TAB SWITCHING & GOOGLE CSE FUNCTIONS
        // ============================================================================

        // Switch Social Media Tab
        function switchSocialMediaTab(tabId) {
            // Update button styles
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => {
                btn.style.background = '#f3f4f6';
                btn.style.color = '#6b7280';
            });
            
            const activeButton = Array.from(buttons).find(btn =>
                btn.getAttribute('onclick').includes(`'${tabId}'`)
            );
            if (activeButton) {
                activeButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                activeButton.style.color = 'white';
            }
            
            // Update tab content visibility
            const tabs = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => {
                tab.style.display = 'none';
            });
            
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) {
                activeTab.style.display = 'block';
            }
            
            console.log('Switched to tab:', tabId);
        }

        // REMOVED: Google CSE Web tab functionality (no longer used)
        // Function removed - tab "Web" has been deleted
        async function _removed_loadGoogleCSEInIframe(searchQuery) {
            console.log('ðŸŒ [Google CSE Web] Fetching results via API (no iframe)...');
            
            const container = document.getElementById('googleWebSearch');
            if (!container) {
                console.error('âŒ [Google CSE Web] Container #googleWebSearch NOT FOUND!');
                return;
            }
            
            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p style="margin-top: 20px;">Mencari hasil dari Google CSE...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/google-cse-widget', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: searchQuery, type: 'web' })
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.web && result.data.web.length > 0) {
                    const results = result.data.web;
                    console.log(`âœ… [Google CSE Web] Found ${results.length} results`);
                    
                    let html = `
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                <i class="fab fa-google"></i>
                                Google CSE Results (${results.length} results)
                            </h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                                â™¾ï¸ UNLIMITED - No API key, no quota limits!
                            </p>
                        </div>
                    `;
                    
                    results.forEach((item, index) => {
                        const domain = new URL(item.link).hostname.replace('www.', '');
                        html += `
                            <div class="result-item" style="padding: 15px; margin-bottom: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div class="result-title" style="margin-bottom: 8px;">
                                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" style="font-size: 1.05rem; font-weight: 600; color: #1f2937; text-decoration: none; display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-top: 4px; color: #667eea;"></i>
                                        <span style="flex: 1;">${item.title || 'No Title'}</span>
                                        <span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">
                                            <i class="fab fa-google"></i> GOOGLE
                                        </span>
                                    </a>
                                </div>
                                <div class="result-url" style="color: #10b981; font-size: 0.85rem; margin-bottom: 8px;">
                                    <i class="fas fa-link"></i> ${item.displayLink || domain}
                                </div>
                                <div class="result-snippet" style="color: #4b5563; font-size: 0.9rem; line-height: 1.6;">
                                    ${item.snippet || 'No description available'}
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    console.log('âœ… [Google CSE Web] Results displayed successfully!');
                } else {
                    // Show error message if available
                    const errorMsg = result.error || result.message || 'Tidak ada hasil ditemukan';
                    const helpMsg = result.message || '';
                    const isQuotaError = errorMsg.includes('quota') || errorMsg.includes('Quota');
                    const isRateLimit = errorMsg.includes('rate limit') || errorMsg.includes('429') || errorMsg.includes('too many requests');
                    
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: ${isQuotaError || isRateLimit ? '#f59e0b' : '#6b7280'};">
                            <i class="fas ${isQuotaError || isRateLimit ? 'fa-exclamation-triangle' : 'fa-search'}" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-weight: 600; margin-bottom: 10px; font-size: 1.1rem;">${errorMsg}</p>
                            ${helpMsg ? `<p style="font-size: 0.9rem; color: #9ca3af; margin-bottom: 15px;">${helpMsg}</p>` : ''}
                            ${isQuotaError ? 
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Quota akan reset di midnight Pacific Time. Gunakan tab "Categorized" atau "Social Links" untuk hasil internal.</p>' :
                            isRateLimit ?
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Google Search sementara memblokir request. Tunggu beberapa menit dan coba lagi, atau gunakan tab "Categorized" untuk hasil internal.</p>' :
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Coba gunakan kata kunci yang berbeda atau gunakan tab "Categorized" untuk hasil internal.</p>'
                            }
                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
                                <p style="font-size: 0.85rem; color: #0c4a6e; margin: 0;">
                                    <i class="fas fa-lightbulb"></i> <strong>Tips:</strong> Gunakan tab <strong>"Categorized"</strong> atau <strong>"Social Links"</strong> untuk melihat hasil dari pencarian internal (tidak terpengaruh rate limit).
                                </p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ [Google CSE Web] Error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>Error loading Google CSE results</p>
                        <p style="font-size: 0.85rem; color: #9ca3af;">${error.message}</p>
                    </div>
                `;
            }
        }

        // REMOVED: Google CSE Image tab functionality (no longer used)
        // Function removed - tab "Gambar" has been deleted
        async function _removed_loadGoogleCSEImageInIframe(searchQuery) {
            console.log('ðŸ“· [Google CSE Image] Fetching results via API (no iframe)...');
            
            const container = document.getElementById('googleImageSearch');
            if (!container) {
                console.error('âŒ [Google CSE Image] Container #googleImageSearch NOT FOUND!');
                return;
            }
            
            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">Loading...</span>
                        </div>
                    <p style="margin-top: 20px;">Mencari gambar dari Google CSE...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/google-cse-widget', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: searchQuery, type: 'image' })
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.images && result.data.images.length > 0) {
                    const results = result.data.images;
                    console.log(`âœ… [Google CSE Image] Found ${results.length} images`);
                    
                    let html = `
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-images"></i>
                                Google CSE Images (${results.length} images)
                            </h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                                â™¾ï¸ UNLIMITED - No API key, no quota limits!
                            </p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                `;

                    results.forEach((item, index) => {
                html += `
                            <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <a href="${item.link}" target="_blank" rel="noopener noreferrer" style="display: block; text-decoration: none;">
                                    <div style="width: 100%; height: 200px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                        <img src="${item.imageUrl || item.link}" alt="${item.title}" 
                                             style="max-width: 100%; max-height: 100%; object-fit: cover;"
                                             onerror="this.parentElement.innerHTML='<i class=\\'fas fa-image\\' style=\\'font-size: 3rem; color: #9ca3af;\\'></i>'">
                        </div>
                                    <div style="padding: 10px;">
                                        <p style="font-size: 0.85rem; color: #1f2937; margin: 0; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.title}">
                                            ${item.title || 'No Title'}
                                        </p>
                                        <p style="font-size: 0.75rem; color: #6b7280; margin: 5px 0 0 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${new URL(item.link).hostname.replace('www.', '')}
                                        </p>
                                    </div>
                                </a>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                    container.innerHTML = html;
                    console.log('âœ… [Google CSE Image] Images displayed successfully!');
                } else {
                    // Show error message if available
                    const errorMsg = result.error || result.message || 'Tidak ada gambar ditemukan';
                    const helpMsg = result.message || '';
                    const isQuotaError = errorMsg.includes('quota') || errorMsg.includes('Quota');
                    const isRateLimit = errorMsg.includes('rate limit') || errorMsg.includes('429') || errorMsg.includes('too many requests');
                    
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: ${isQuotaError || isRateLimit ? '#f59e0b' : '#6b7280'};">
                            <i class="fas ${isQuotaError || isRateLimit ? 'fa-exclamation-triangle' : 'fa-image'}" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-weight: 600; margin-bottom: 10px; font-size: 1.1rem;">${errorMsg}</p>
                            ${helpMsg ? `<p style="font-size: 0.9rem; color: #9ca3af; margin-bottom: 15px;">${helpMsg}</p>` : ''}
                            ${isQuotaError ? 
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Quota akan reset di midnight Pacific Time. Gunakan tab "Categorized" atau "Social Links" untuk hasil internal.</p>' :
                            isRateLimit ?
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Google Search sementara memblokir request. Tunggu beberapa menit dan coba lagi, atau gunakan tab "Categorized" untuk hasil internal.</p>' :
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Coba gunakan kata kunci yang berbeda atau gunakan tab "Categorized" untuk hasil internal.</p>'
                            }
                            <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #fde68a;">
                                <p style="font-size: 0.85rem; color: #78350f; margin: 0;">
                                    <i class="fas fa-lightbulb"></i> <strong>Tips:</strong> Gunakan tab <strong>"Categorized"</strong> atau <strong>"Social Links"</strong> untuk melihat hasil dari pencarian internal (tidak terpengaruh rate limit).
                                </p>
                            </div>
                    </div>
                `;
                }
            } catch (error) {
                console.error('âŒ [Google CSE Image] Error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>Error loading Google CSE images</p>
                        <p style="font-size: 0.85rem; color: #9ca3af;">${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================================================
        // AI ANALYSIS FUNCTION
        // ============================================================================

        // Perform AI Analysis
        async function performAIAnalysis(name, socialLinks) {
            const section = document.getElementById('aiAnalysisSection');
            const content = document.getElementById('aiAnalysisContent');
            
            if (!section || !content) return;
            
            // Show section
            section.style.display = 'block';
            
            // Create analysis
            const analysis = {
                name: name,
                total_links: socialLinks.length,
                platforms: {},
                confidence: 0,
                verification: 'unknown',
                risk: 'low'
            };
            
            // Count platforms
            socialLinks.forEach(link => {
                const platform = getPlatformName(link.link);
                analysis.platforms[platform] = (analysis.platforms[platform] || 0) + 1;
            });
            
            // Calculate confidence
            if (socialLinks.length >= 5) {
                analysis.confidence = 0.9;
                analysis.verification = 'highly_verified';
            } else if (socialLinks.length >= 3) {
                analysis.confidence = 0.75;
                analysis.verification = 'verified';
            } else if (socialLinks.length >= 1) {
                analysis.confidence = 0.5;
                analysis.verification = 'partially_verified';
                } else {
                analysis.confidence = 0.2;
                analysis.verification = 'unverified';
                analysis.risk = 'medium';
            }
            
            // Display analysis
            let html = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Total Platforms</div>
                            <div style="font-size: 2rem; font-weight: 700;">${analysis.total_links}</div>
                    </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Confidence Score</div>
                            <div style="font-size: 2rem; font-weight: 700;">${Math.round(analysis.confidence * 100)}%</div>
                    </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Verification</div>
                            <div style="font-size: 1.2rem; font-weight: 600; text-transform: capitalize;">${analysis.verification.replace('_', ' ')}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Risk Level</div>
                            <div style="font-size: 1.2rem; font-weight: 600; text-transform: uppercase;">${analysis.risk}</div>
                    </div>
                </div>
            `;
            
            if (Object.keys(analysis.platforms).length > 0) {
                html += `
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 10px;">Platform Distribution</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                `;
                
                Object.entries(analysis.platforms).forEach(([platform, count]) => {
                    const color = getPlatformColor(`https://${platform.toLowerCase()}.com`);
                html += `
                        <span style="padding: 6px 12px; background: rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85rem; font-weight: 500;">
                            ${platform}: ${count}
                        </span>
                    `;
                });
                
                html += `
                    </div>
                </div>
            `;
        }

            html += '</div>';
            content.innerHTML = html;
            
            console.log('âœ“ AI Analysis complete:', analysis);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('personDetailsModal');
            if (event.target === modal) {
                closePersonDetails();
            }
        }

        // Store current person data for export
        let currentPersonData = null;

        function exportToPDF() {
            if (!currentPersonData) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            // Show loading
            const pdfBtn = document.querySelector('.pdf-btn');
            const originalText = pdfBtn.innerHTML;
            pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            pdfBtn.disabled = true;
            
            // Call backend to generate PDF
            const token = localStorage.getItem('session_token');
            fetch('/api/export/pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    person: currentPersonData,
                    username: 'admin',
                    password: 'admin123'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Gagal membuat PDF');
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `person_details_${currentPersonData.ktp_number || 'unknown'}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Gagal membuat PDF: ' + error.message);
            })
            .finally(() => {
                // Restore button
                pdfBtn.innerHTML = originalText;
                pdfBtn.disabled = false;
            });
        }

        function exportToWord() {
            if (!currentPersonData) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            // Show loading
            const wordBtn = document.querySelector('.word-btn');
            const originalText = wordBtn.innerHTML;
            wordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            wordBtn.disabled = true;
            
            // Call backend to generate Word document
            const token = localStorage.getItem('session_token');
            fetch('/api/export/word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    person: currentPersonData,
                    username: 'admin',
                    password: 'admin123'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Gagal membuat dokumen Word');
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `person_details_${currentPersonData.ktp_number || 'unknown'}.docx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Gagal membuat dokumen Word: ' + error.message);
            })
            .finally(() => {
                // Restore button
                wordBtn.innerHTML = originalText;
                wordBtn.disabled = false;
            });
        }

        function copyPersonData() {
            if (!currentPersonData) {
                alert('Tidak ada data untuk dicopy');
                return;
            }
            
            // Show loading
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
            copyBtn.disabled = true;
            
            try {
                // Helper function to format text for WhatsApp
                function formatForWhatsApp(text) {
                    if (!text) return 'N/A';
                    return String(text)
                        .replace(/\*\*(.*?)\*\*/g, '*$1*')  // Convert **bold** to *bold* for WhatsApp
                        .replace(/__(.*?)__/g, '*$1*')      // Convert __bold__ to *bold* for WhatsApp
                        .replace(/\*(.*?)\*/g, '*$1*')      // Keep *italic* as *bold* for WhatsApp
                        .replace(/_(.*?)_/g, '*$1*')        // Convert _italic_ to *bold* for WhatsApp
                        .replace(/`(.*?)`/g, '`$1`')        // Keep `code` formatting
                        .replace(/#{1,6}\s*/g, '')          // Remove headers
                        .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Remove links, keep text
                        .trim();
                }
                
                // Format data untuk copy
                let copyText = '';
                
                // Informasi Pribadi
                copyText += '*ðŸ“‹ INFORMASI PRIBADI*\n';
                copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                copyText += `â€¢ *Nama Lengkap:* ${formatForWhatsApp(currentPersonData.full_name)}\n`;
                copyText += `â€¢ *NIK:* ${formatForWhatsApp(currentPersonData.ktp_number || currentPersonData.nik)}\n`;
                copyText += `â€¢ *Tanggal Lahir:* ${formatForWhatsApp(currentPersonData.date_of_birth || currentPersonData.tanggal_lahir)}\n`;
                copyText += `â€¢ *Tempat Lahir:* ${formatForWhatsApp(currentPersonData.birth_place || currentPersonData.tempat_lahir)}\n`;
                copyText += `â€¢ *Jenis Kelamin:* ${formatForWhatsApp(currentPersonData.sex || currentPersonData.jenis_kelamin || currentPersonData.gender)}\n`;
                copyText += `â€¢ *Status Perkawinan:* ${formatForWhatsApp(currentPersonData.marital_status)}\n`;
                copyText += `â€¢ *Agama:* ${formatForWhatsApp(currentPersonData.religion)}\n`;
                copyText += `â€¢ *Pekerjaan:* ${formatForWhatsApp(currentPersonData.occupation)}\n`;
                copyText += `â€¢ *Alamat:* ${formatForWhatsApp(currentPersonData.address)}\n`;
                copyText += `â€¢ *Provinsi:* ${formatForWhatsApp(currentPersonData.province_name)}\n`;
                copyText += `â€¢ *Kecamatan:* ${formatForWhatsApp(currentPersonData.district_name)}\n`;
                copyText += `â€¢ *Desa/Kelurahan:* ${formatForWhatsApp(currentPersonData.village_name)}\n`;
                
                // Additional fields that might be available
                if (currentPersonData.blood_type) {
                    copyText += `â€¢ *Golongan Darah:* ${formatForWhatsApp(currentPersonData.blood_type)}\n`;
                }
                if (currentPersonData.birth_cert_number) {
                    copyText += `â€¢ *No Akta Lahir:* ${formatForWhatsApp(currentPersonData.birth_cert_number)}\n`;
                }
                if (currentPersonData.dead_alive_status) {
                    copyText += `â€¢ *Status:* ${formatForWhatsApp(currentPersonData.dead_alive_status)}\n`;
                }
                if (currentPersonData.divorce_cert_number) {
                    copyText += `â€¢ *No Akta Cerai:* ${formatForWhatsApp(currentPersonData.divorce_cert_number)}\n`;
                }
                if (currentPersonData.country_name) {
                    copyText += `â€¢ *Negara:* ${formatForWhatsApp(currentPersonData.country_name)}\n`;
                }
                copyText += '\n';
                
                // Nomor Telepon
                if (currentPersonData.phone_data && currentPersonData.phone_data.length > 0) {
                    copyText += `*ðŸ“± NOMOR TELEPON (${currentPersonData.phone_data.length})*\n`;
                    copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                    currentPersonData.phone_data.forEach((phone, index) => {
                        copyText += `â€¢ *No HP ${index + 1}:* ${formatForWhatsApp(phone.number || phone.msisdn)}\n`;
                        copyText += `  â”” *Operator:* ${formatForWhatsApp(phone.operator || 'Unknown')}\n`;
                        copyText += `  â”” *Terdaftar:* ${formatForWhatsApp(phone.register_date)}\n\n`;
                    });
                }
                
                // Informasi Keluarga
                if (currentPersonData.family_data && currentPersonData.family_data.anggota_keluarga && currentPersonData.family_data.anggota_keluarga.length > 0) {
                    copyText += `*ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ FAMILY MEMBERS (${currentPersonData.family_data.anggota_keluarga.length})*\n`;
                    copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                    copyText += `â€¢ *Family Head:* ${formatForWhatsApp(currentPersonData.family_data.kepala_keluarga)}\n`;
                    copyText += `â€¢ *Family Card Number (NKK):* ${formatForWhatsApp(currentPersonData.family_data.nkk)}\n`;
                    copyText += `â€¢ *Alamat Keluarga:* ${formatForWhatsApp(currentPersonData.family_data.alamat_keluarga)}\n\n`;
                    
                    currentPersonData.family_data.anggota_keluarga.forEach((member, index) => {
                        copyText += `*ðŸ‘¤ Keluarga ${index + 1}:*\n`;
                        copyText += `  â€¢ *Nama:* ${formatForWhatsApp(member.nama || member.name)}\n`;
                        copyText += `  â€¢ *Hubungan:* ${formatForWhatsApp(member.hubungan || member.relationship)}\n`;
                        copyText += `  â€¢ *NIK:* ${formatForWhatsApp(member.nik)}\n`;
                        copyText += `  â€¢ *Birth:* ${formatForWhatsApp(member.tanggal_lahir || member.date_of_birth || member.birth_date)}\n`;
                        copyText += `  â€¢ *Jenis Kelamin:* ${formatForWhatsApp(member.jenis_kelamin || member.gender || member.sex)}\n\n`;
                    });
                }
                
                // Face Detection Information
                if (currentPersonData.face_detection) {
                    copyText += `*ðŸ” INFORMASI DETEKSI WAJAH*\n`;
                    copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                    copyText += `â€¢ *Face Detected:* ${currentPersonData.face_detection.face_detected ? 'âœ… Ya' : 'âŒ Tidak'}\n`;
                    copyText += `â€¢ *Confidence:* ${formatForWhatsApp(currentPersonData.face_detection.confidence)}\n`;
                    copyText += `â€¢ *Face Count:* ${formatForWhatsApp(currentPersonData.face_detection.face_count)}\n\n`;
                }
                
                // Additional Information
                if (currentPersonData.face) {
                    copyText += `*ðŸ“¸ INFORMASI FOTO*\n`;
                    copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                    copyText += `â€¢ *Foto Tersedia:* âœ… Ya\n`;
                    copyText += `â€¢ *Format:* ${currentPersonData.face.startsWith('data:image/') ? 'Base64' : 'URL'}\n\n`;
                }
                
                // Search Parameters
                if (currentPersonData.search_params) {
                    copyText += `*ðŸ”Ž PARAMETER PENCARIAN*\n`;
                    copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                    copyText += `â€¢ *Search Type:* ${formatForWhatsApp(currentPersonData.search_params.search_type)}\n`;
                    copyText += `â€¢ *Search Query:* ${formatForWhatsApp(currentPersonData.search_params.query)}\n`;
                    copyText += `â€¢ *Search Date:* ${formatForWhatsApp(currentPersonData.search_params.timestamp)}\n\n`;
                }
                
                // Social Media Links (jika ada)
                const socialLinksElement = document.getElementById('socialLinks');
                if (socialLinksElement && socialLinksElement.style.display !== 'none') {
                    const socialItems = socialLinksElement.querySelectorAll('.social-item');
                    if (socialItems.length > 0) {
                        copyText += '*ðŸ“± SOCIAL MEDIA LINKS*\n';
                        copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                        socialItems.forEach((item, index) => {
                            const link = item.querySelector('a');
                            const platform = item.querySelector('.social-name');
                            const title = item.querySelector('.social-followers');
                            
                            if (link && platform && title) {
                                copyText += `â€¢ *${formatForWhatsApp(platform.textContent)}:*\n`;
                                copyText += `  â”” *Profile:* ${formatForWhatsApp(title.textContent)}\n`;
                                copyText += `  â”” *Link:* ${formatForWhatsApp(link.href)}\n\n`;
                            }
                        });
                    }
                }
                
                // Timestamp Information
                copyText += `*âš™ï¸ INFORMASI SISTEM*\n`;
                copyText += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                copyText += `â€¢ *Data Retrieved:* ${new Date().toLocaleString('id-ID')}\n`;
                copyText += `â€¢ *Source:* ðŸ¤– AI FaceGuard Pro System\n\n`;
                
                // Copy ke clipboard
                navigator.clipboard.writeText(copyText).then(() => {
                    // Show success message
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    copyBtn.style.background = '#059669';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.style.background = '#059669';
                    }, 2000);
                    
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Gagal menyalin data ke clipboard');
                });
                
            } catch (error) {
                console.error('Error formatting data:', error);
                alert('Gagal memformat data untuk copy');
            } finally {
                // Restore button after a delay
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.disabled = false;
                }, 2000);
            }
        }

        // AI Global Functions
        function toggleAIMode() {
            app.toggleAIMode();
        }

        function refreshAIDashboard() {
            app.refreshAIDashboard();
        }

        function closeAIInsights() {
            const modal = document.getElementById('aiInsightsModal');
            modal.style.display = 'none';
        }

        function exportAIInsights() {
            app.exportAIInsights();
        }

        // AI Face-to-NIK Global Functions
        function handleFaceUpload(input) {
            app.handleFaceUpload(input);
        }

        function selectAIResult(index) {
            app.selectAIResult(index);
        }

        function fillNIKFromAI() {
            app.fillNIKFromAI();
        }

        function updateAIThreshold() {
            app.updateAIThreshold();
        }

        // Identity Form AI Functions
        function handleIdentityFaceUpload(input) {
            app.handleIdentityFaceUpload(input);
        }

        function selectIdentityResult(index) {
            app.selectIdentityResult(index);
        }

        // Functions for wilayah dropdowns
        async function loadProvinsi() {
            try {
                const response = await fetch('/api/wilayah/provinsi');
                const result = await response.json();
                
                if (result.success) {
                    const provinsiSelect = document.getElementById('provinsi');
                    provinsiSelect.innerHTML = '<option value="">Pilih Provinsi</option>';
                    
                    result.data.forEach(provinsi => {
                        const option = document.createElement('option');
                        option.value = provinsi.kode;
                        option.textContent = provinsi.nama;
                        provinsiSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading provinsi:', error);
            }
        }

        async function loadKabupaten() {
            const provinsiSelect = document.getElementById('provinsi');
            const kabupatenSelect = document.getElementById('kabupaten');
            const kecamatanSelect = document.getElementById('kecamatan');
            const kelurahanSelect = document.getElementById('kelurahan');
            
            // Reset dependent dropdowns
            kabupatenSelect.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
            kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
            kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
            
            // Update hidden fields
            document.getElementById('no_prop').value = provinsiSelect.value;
            document.getElementById('no_kab').value = '';
            document.getElementById('no_kec').value = '';
            document.getElementById('no_desa').value = '';
            
            if (!provinsiSelect.value) {
                kabupatenSelect.disabled = true;
                kecamatanSelect.disabled = true;
                kelurahanSelect.disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`/api/wilayah/kabupaten/${provinsiSelect.value}`);
                const result = await response.json();
                
                if (result.success) {
                    kabupatenSelect.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
                    
                    result.data.forEach(kabupaten => {
                        const option = document.createElement('option');
                        option.value = kabupaten.kode;
                        option.textContent = kabupaten.nama;
                        kabupatenSelect.appendChild(option);
                    });
                    
                    kabupatenSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading kabupaten:', error);
            }
        }

        async function loadKecamatan() {
            const kabupatenSelect = document.getElementById('kabupaten');
            const kecamatanSelect = document.getElementById('kecamatan');
            const kelurahanSelect = document.getElementById('kelurahan');
            
            // Reset dependent dropdowns
            kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
            kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
            
            // Update hidden fields
            document.getElementById('no_kab').value = kabupatenSelect.value;
            document.getElementById('no_kec').value = '';
            document.getElementById('no_desa').value = '';
            
            if (!kabupatenSelect.value) {
                kecamatanSelect.disabled = true;
                kelurahanSelect.disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`/api/wilayah/kecamatan/${kabupatenSelect.value}`);
                const result = await response.json();
                
                if (result.success) {
                    kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
                    
                    result.data.forEach(kecamatan => {
                        const option = document.createElement('option');
                        option.value = kecamatan.kode;
                        option.textContent = kecamatan.nama;
                        kecamatanSelect.appendChild(option);
                    });
                    
                    kecamatanSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading kecamatan:', error);
            }
        }

        async function loadKelurahan() {
            const kecamatanSelect = document.getElementById('kecamatan');
            const kelurahanSelect = document.getElementById('kelurahan');
            
            // Reset dependent dropdown
            kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
            
            // Update hidden fields
            document.getElementById('no_kec').value = kecamatanSelect.value;
            document.getElementById('no_desa').value = '';
            
            if (!kecamatanSelect.value) {
                kelurahanSelect.disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`/api/wilayah/kelurahan/${kecamatanSelect.value}`);
                const result = await response.json();
                
                if (result.success) {
                    kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
                    
                    result.data.forEach(kelurahan => {
                        const option = document.createElement('option');
                        option.value = kelurahan.kode;
                        option.textContent = kelurahan.nama;
                        kelurahanSelect.appendChild(option);
                    });
                    
                    kelurahanSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading kelurahan:', error);
            }
        }

        function updateKelurahanCode() {
            const kelurahanSelect = document.getElementById('kelurahan');
            document.getElementById('no_desa').value = kelurahanSelect.value;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.profilingApp = new ProfilingApp();
            // Load provinsi data on page load
            loadProvinsi();
            
            // Initialize speech recognition for voice input
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                initSpeechRecognition();
            }
        });
    </script>
</body>
</html>
