<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profiling - Pencarian Wajah Clearance</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Authentication Loading Screen */
        .auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .auth-loading.hidden {
            display: none;
        }

        .auth-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .auth-loading-text {
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
        }

        .sidebar-menu {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
            margin-bottom: 8px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: rgba(255,255,255,0.5);
            transform: translateX(5px);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: white;
            border-left-width: 4px;
        }

        .menu-item i {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .nav-submenu {
            margin-left: 20px;
            margin-top: 0;
            margin-bottom: 8px;
        }

        .nav-submenu .menu-item {
            padding: 12px 25px;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .menu-item span {
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .menu-item span {
            opacity: 0;
        }

        .menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 20px 20px;
        }

        .sidebar-footer {
            position: static;
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user-details {
            opacity: 1;
            transition: opacity 0.3s ease;
            flex: 1;
            min-width: 0;
        }

        .sidebar.collapsed .user-details {
            opacity: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .logout-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .sidebar.collapsed .logout-btn span {
            opacity: 0;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 70px;
        }

        .topbar {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #667eea;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: #f8f9ff;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a202c;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 15px 10px 40px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            width: 300px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #6b7280;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: #f8f9ff;
            color: #667eea;
        }

        .notification-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Profiling Content */
        .profiling-content {
            padding: 30px;
        }

        /* AI Toggle Switch */
        .ai-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 2px solid #e1e5e9;
            transition: all 0.3s ease;
        }

        .ai-toggle-container.active {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
        }

        .ai-toggle-label {
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-toggle-label i {
            color: #667eea;
            font-size: 16px;
        }

        .ai-toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e1e5e9;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-toggle-switch.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .ai-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .ai-toggle-switch.active .ai-toggle-slider {
            transform: translateX(30px);
        }

        /* AI Suggestions Panel */
        .ai-suggestions-panel {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .ai-suggestions-panel.active {
            display: block;
        }

        .ai-suggestions-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ai-suggestions-header h4 {
            color: #667eea;
            font-weight: 600;
            margin: 0;
        }

        .ai-suggestions-header i {
            color: #667eea;
            font-size: 18px;
        }

        .ai-suggestion-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ai-suggestion-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .ai-suggestion-item i {
            color: #667eea;
            font-size: 16px;
        }

        .ai-suggestion-text {
            flex: 1;
            color: #374151;
            font-size: 14px;
        }

        .ai-suggestion-confidence {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* AI Analysis Dashboard */
        .ai-dashboard {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .ai-dashboard.active {
            display: block;
        }

        .ai-dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .ai-dashboard-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
            font-weight: 600;
            font-size: 18px;
        }

        .ai-dashboard-title i {
            font-size: 20px;
        }

        .ai-dashboard-refresh {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-dashboard-refresh:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .ai-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .ai-analysis-card {
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .ai-analysis-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .ai-analysis-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .ai-analysis-card-header i {
            color: #667eea;
            font-size: 16px;
        }

        .ai-analysis-card-title {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .ai-analysis-card-content {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
        }

        .ai-confidence-score {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            margin-top: 8px;
        }

        /* AI Insights Modal */
        .ai-insights-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }

        .ai-insights-modal-content {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            margin: 3% auto;
            padding: 0;
            border: none;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-80px) scale(0.8) rotateX(20deg);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
            }
        }

        .ai-insights-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
            overflow: hidden;
        }

        .ai-insights-modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(180deg); }
        }

        .ai-insights-modal-header h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .ai-insights-modal-header .icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .ai-insights-modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(90vh - 200px);
        }

        .ai-insights-modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .ai-insights-modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .ai-insights-modal-body::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .ai-insights-modal-body::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .ai-insight-section {
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .ai-insight-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .ai-insight-section-header i {
            color: #667eea;
            font-size: 18px;
        }

        .ai-insight-section-title {
            font-weight: 600;
            color: #374151;
            font-size: 16px;
        }

        .ai-insight-content {
            color: #6b7280;
            line-height: 1.6;
            font-size: 14px;
        }

        .ai-insight-confidence {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 10px;
        }

        .ai-insights-modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .ai-insights-modal-close {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-insights-modal-close:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .ai-insights-modal-export {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-insights-modal-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AI Face Upload Section */
        .ai-face-upload-section {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: block;
            animation: slideDown 0.3s ease;
        }

        .ai-face-upload-section.active {
            display: block;
        }

        .ai-upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
        }

        .ai-upload-area:hover {
            border-color: #5a6fd8;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0ecff 100%);
            transform: translateY(-2px);
        }

        .ai-upload-area i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
        }

        .ai-upload-area p {
            color: #374151;
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .ai-upload-area input[type="file"] {
            display: none;
        }

        /* AI Results Panel */
        .ai-results-panel {
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .ai-results-panel.active {
            display: block;
        }

        .ai-results-panel h4 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-results-panel h4 i {
            font-size: 18px;
        }

        .ai-results-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ai-result-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-result-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
        }

        .ai-result-item.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .ai-result-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e1e5e9;
        }

        .ai-result-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            border: 2px solid #e1e5e9;
        }

        .ai-result-info {
            flex: 1;
        }

        .source-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .ai-result-info h5 {
            color: #374151;
            font-weight: 600;
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        .ai-result-info p {
            color: #6b7280;
            margin: 0;
            font-size: 12px;
        }

        .confidence-score {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            min-width: 50px;
            text-align: center;
        }

        .confidence-score.high {
            background: #10b981;
        }

        .confidence-score.medium {
            background: #f59e0b;
        }

        .confidence-score.low {
            background: #ef4444;
        }

        /* Hybrid Input Form */
        .hybrid-input-form {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group input.ai-filled {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .ai-fill-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .ai-fill-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-fill-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* AI Control Panel */
        .ai-control-panel {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .ai-control-panel.active {
            display: block;
        }

        .ai-control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .ai-control-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
        }

        .ai-control-title i {
            font-size: 16px;
        }

        .ai-control-settings {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .ai-threshold-setting {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .ai-threshold-setting input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
        }

        .ai-status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .ai-status-indicator.active {
            color: #10b981;
        }

        .ai-status-indicator.inactive {
            color: #6b7280;
        }

        .ai-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #6b7280;
            border: 1px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .mobile-menu-btn {
            display: none;
        }

        /* Search Type Selector */
        .search-type-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .search-type-selector h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .search-type-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .search-tab {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .search-tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .search-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .search-tab i {
            font-size: 1.5rem;
        }

        .search-tab span {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Search Forms */
        .search-form {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .search-form.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styling */
        .form-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Face Upload Section */
        .face-upload-section {
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e8f0ff;
            transform: scale(1.02);
        }

        .upload-content i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-content h4 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .upload-content p {
            color: #6b7280;
            margin-bottom: 5px;
        }

        .upload-hint {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .face-preview {
            text-align: center;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
            border: 1px solid #e1e5e9;
        }

        .face-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }

        /* Threshold Slider */
        .threshold-slider {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .threshold-slider input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e1e5e9;
            outline: none;
            -webkit-appearance: none;
        }

        .threshold-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .threshold-slider input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        #thresholdValue {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
        }

        /* Search Buttons */
        .search-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        /* Results Section */
        .results-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            display: none;
        }

        .results-header {
            padding: 25px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a202c;
        }

        .results-count {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .results-content {
            padding: 25px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: #f8f9ff;
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #667eea;
            transition: all 0.3s ease;
            position: relative;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .result-card:first-child {
            position: relative;
        }

        .data-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .result-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .result-info h3 {
            font-size: 1rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 3px;
        }

        .result-info p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.75rem;
        }

        .info-value {
            color: #1a202c;
            font-size: 0.85rem;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .topbar {
                padding: 15px 20px;
            }

            .page-title {
                font-size: 1.4rem;
            }

            .profiling-content {
                padding: 15px;
                min-height: 100vh;
            }
            
            .page-description {
                font-size: 0.95rem;
                line-height: 1.6;
                margin-bottom: 25px;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .page-actions {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }
            
            .page-actions .btn {
                width: 100%;
                font-size: 0.9rem;
                padding: 12px 20px;
                justify-content: center;
            }

            .search-type-selector {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .search-type-selector h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            
            .search-type-tabs {
                flex-direction: row;
                justify-content: space-between;
                gap: 6px;
            }

            .search-tab {
                flex: 1;
                min-width: 0;
                padding: 12px 8px;
                font-size: 0.8rem;
            }

            .search-tab i {
                font-size: 1.2rem;
            }

            .search-tab span {
                font-size: 0.75rem;
            }

            .form-container {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                font-size: 0.95rem;
                margin-bottom: 10px;
                font-weight: 600;
            }
            
            .form-group input,
            .form-group select {
                padding: 14px 16px;
                font-size: 0.95rem;
                border-radius: 8px;
                border: 2px solid #e1e5e9;
            }
            
            .form-group input:focus,
            .form-group select:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .search-buttons {
                flex-direction: column;
                gap: 15px;
                margin-top: 20px;
            }
            
            .search-buttons .btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 0.95rem;
                font-weight: 600;
                border-radius: 10px;
            }
            
            .search-buttons .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
            }
            
            .search-buttons .btn-secondary {
                background: #f8f9fa;
                border: 2px solid #e1e5e9;
                color: #6b7280;
            }
            
            .threshold-slider {
                flex-direction: column;
                gap: 15px;
                margin-top: 20px;
            }
            
            .threshold-slider label {
                font-size: 0.9rem;
                font-weight: 600;
            }
            
            .threshold-slider input[type="range"] {
                width: 100%;
                height: 8px;
                border-radius: 4px;
                background: #e1e5e9;
                outline: none;
            }
            
            .threshold-slider input[type="range"]::-webkit-slider-thumb {
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #667eea;
                cursor: pointer;
            }
            
            .threshold-value {
                font-size: 0.9rem;
                font-weight: 600;
                color: #667eea;
                text-align: center;
                padding: 8px 12px;
                background: #f0f4ff;
                border-radius: 6px;
            }
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .pdf-btn {
            background: #dc2626;
        }

        .pdf-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        .word-btn {
            background: #2563eb;
        }

        .word-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .ai-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .copy-btn {
            background: #059669;
        }

        .copy-btn:hover {
            background: #047857;
            transform: translateY(-1px);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .modal-close:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-section h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 10px;
        }

        .detail-section h3 i {
            color: #667eea;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .detail-item .label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .detail-item .value {
            color: #1a202c;
            font-size: 1rem;
        }

        .phone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .phone-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #10b981;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .phone-number {
            font-weight: 600;
            color: #1a202c;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .phone-operator {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .phone-date {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .family-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .family-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .family-name {
            font-weight: 600;
            color: #1a202c;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .family-relationship {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .family-nik {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .topbar {
                padding: 15px 20px;
            }
            
            .topbar-left h1 {
                font-size: 1.2rem;
            }
            
            .search-box {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: #374151;
                cursor: pointer;
                margin-right: 15px;
            }
            
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                display: none;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
            
            .results-section {
                padding: 20px;
            }
            
            .results-header {
                margin-bottom: 20px;
            }
            
            .results-title {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            
            .results-count {
                font-size: 0.9rem;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .result-card {
                padding: 20px;
                border-radius: 12px;
            }
            
            .result-header {
                gap: 15px;
                margin-bottom: 15px;
            }
            
            .result-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.4rem;
            }
            
            .result-info h3 {
                font-size: 1.1rem;
            }
            
            .result-info p {
                font-size: 0.9rem;
            }
            
            .info-grid {
                gap: 12px;
                margin-bottom: 15px;
            }
            
            .info-label {
                font-size: 0.8rem;
            }
            
            .info-value {
                font-size: 0.9rem;
            }
            
            .result-actions {
                margin-top: 15px;
            }
            
            .result-actions .btn {
                width: 100%;
                padding: 12px;
                font-size: 0.9rem;
            }
            
            /* Mobile Modal Improvements */
            .modal {
                padding: 0;
            }
            
            .modal-content {
                width: 100%;
                margin: 0;
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
                display: flex;
                flex-direction: column;
            }
            
            .modal-header {
                padding: 15px 20px;
                flex-shrink: 0;
                border-radius: 0;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .modal-header h2 {
                font-size: 1.1rem;
                margin: 0;
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                margin-right: 10px;
            }
            
            .modal-actions {
                gap: 8px;
                flex-shrink: 0;
                display: flex;
                align-items: center;
            }
            
            .export-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
                min-width: auto;
            }

            /* AI Components Mobile */
            .ai-toggle-container {
                padding: 10px 15px;
                margin-bottom: 15px;
            }

            .ai-toggle-label {
                font-size: 14px;
            }

            .ai-suggestions-panel {
                padding: 15px;
                margin-bottom: 15px;
            }

            .ai-suggestions-header h4 {
                font-size: 16px;
            }

            .ai-suggestion-item {
                padding: 12px;
                margin-bottom: 8px;
            }

            .ai-suggestion-text {
                font-size: 13px;
            }

            .ai-dashboard {
                padding: 15px;
                margin-bottom: 15px;
            }

            .ai-dashboard-title {
                font-size: 16px;
            }

            .ai-analysis-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .ai-analysis-card {
                padding: 12px;
            }

            .ai-analysis-card-title {
                font-size: 13px;
            }

            .ai-analysis-card-content {
                font-size: 12px;
            }

            /* AI Face-to-NIK Mobile */
            .ai-control-panel {
                padding: 12px;
                margin-bottom: 15px;
            }

            .ai-control-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .ai-control-settings {
                width: 100%;
                justify-content: space-between;
            }

            .ai-face-upload-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .ai-upload-area {
                padding: 20px;
            }

            .ai-upload-area i {
                font-size: 36px;
            }

            .ai-upload-area p {
                font-size: 14px;
            }

            .ai-results-panel {
                padding: 15px;
            }

            .ai-results-panel h4 {
                font-size: 16px;
            }

            .ai-result-item {
                padding: 12px;
                gap: 12px;
            }

            .ai-result-item img {
                width: 40px;
                height: 40px;
            }

            .ai-result-info h5 {
                font-size: 13px;
            }

            .ai-result-info p {
                font-size: 11px;
            }

            .confidence-score {
                padding: 4px 8px;
                font-size: 11px;
                min-width: 40px;
            }

            .hybrid-input-form {
                padding: 15px;
                margin-bottom: 15px;
            }

            .input-group {
                margin-bottom: 12px;
            }

            .input-group input {
                padding: 10px 12px;
                font-size: 13px;
            }

            .ai-fill-btn {
                padding: 6px 12px;
                font-size: 11px;
                margin-left: 8px;
            }
            
            .export-btn i {
                font-size: 0.8rem;
            }
            
            .modal-close {
                font-size: 1.5rem;
                width: 30px;
                height: 30px;
            }
            
            .modal-body {
                padding: 15px 20px;
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .detail-section {
                margin-bottom: 25px;
            }
            
            .detail-section h3 {
                font-size: 1rem;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 8px;
                color: #374151;
            }
            
            .detail-section h3 i {
                font-size: 0.9rem;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .detail-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #667eea;
                margin-bottom: 12px;
            }
            
            .detail-item .label {
                font-size: 0.8rem;
                font-weight: 600;
                color: #6b7280;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 6px;
            }
            
            .detail-item .value {
                font-size: 0.95rem;
                color: #1f2937;
                font-weight: 500;
                line-height: 1.4;
                word-break: break-word;
            }
            
            /* Phone Grid Mobile */
            .phone-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .phone-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #10b981;
            }
            
            .phone-number {
                font-size: 1rem;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 5px;
            }
            
            .phone-operator, .phone-date {
                font-size: 0.8rem;
                color: #6b7280;
            }
            
            /* Family Grid Mobile */
            .family-grid {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .family-item {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 10px;
                border-left: 4px solid #8b5cf6;
                text-align: center;
            }
            
            .family-photo {
                margin-bottom: 10px;
            }
            
            .family-photo img {
                width: 50px;
                height: 50px;
            }
            
            .family-avatar {
                width: 50px !important;
                height: 50px !important;
                font-size: 14px !important;
                margin: 0 auto 10px !important;
            }
            
            .family-name {
                font-size: 0.9rem;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 5px;
            }
            
            .family-relationship, .family-nik {
                font-size: 0.75rem;
                color: #6b7280;
                margin-bottom: 3px;
            }
            
            .modal-footer {
                padding: 20px;
                border-top: 1px solid #e1e5e9;
            }
            
            .modal-footer .btn {
                width: 100%;
                margin: 5px 0;
                padding: 12px;
            }
            
            .loading-spinner {
                font-size: 1.5rem;
            }
            
            .error-message {
                padding: 20px;
                text-align: center;
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 10px;
                color: #dc2626;
                margin: 20px 0;
            }
            
            .no-results {
                padding: 40px 20px;
                text-align: center;
                color: #6b7280;
            }
            
            .no-results i {
                font-size: 3rem;
                margin-bottom: 20px;
                color: #d1d5db;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Extra Small Mobile Devices */
        @media (max-width: 480px) {
            .modal-header {
                padding: 12px 15px;
            }
            
            .modal-header h2 {
                font-size: 1rem;
            }
            
            .export-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
            
            .export-btn span {
                display: none;
            }
            
            .modal-body {
                padding: 12px 15px;
            }
            
            .detail-section {
                margin-bottom: 20px;
            }
            
            .detail-section h3 {
                font-size: 0.9rem;
                margin-bottom: 12px;
            }
            
            .detail-item {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .detail-item .label {
                font-size: 0.75rem;
            }
            
            .detail-item .value {
                font-size: 0.9rem;
            }
            
            .phone-item {
                padding: 12px;
            }
            
            .phone-number {
                font-size: 0.9rem;
            }
            
            .phone-operator, .phone-date {
                font-size: 0.75rem;
            }
            
            .family-item {
                padding: 12px;
            }
            
            .family-photo img {
                width: 40px;
                height: 40px;
            }
            
            .family-avatar {
                width: 40px !important;
                height: 40px !important;
                font-size: 12px !important;
            }
            
            .family-name {
                font-size: 0.85rem;
            }
            
        .family-relationship, .family-nik {
            font-size: 0.7rem;
        }
    }

    /* Universal Search Styles */
    .universal-search-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e1e5e9;
    }

    .universal-search-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e1e5e9;
    }

    .search-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .search-label {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
    }

    .search-name {
        font-size: 1.1rem;
        color: #1f2937;
        font-weight: 600;
    }

    .search-status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #667eea;
        font-weight: 500;
    }

    .search-status.success {
        color: #10b981;
    }

    .search-status.error {
        color: #ef4444;
    }

    .universal-results {
        margin-bottom: 20px;
    }

    .result-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .result-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .result-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .result-title a {
        color: #667eea;
        text-decoration: none;
    }

    .result-title a:hover {
        text-decoration: underline;
    }

    .result-snippet {
        font-size: 0.9rem;
        color: #6b7280;
        line-height: 1.4;
        margin-bottom: 8px;
    }

    .result-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .result-source {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .result-position {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
    }

    .social-links {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e1e5e9;
    }

    .social-links h4 {
        font-size: 1rem;
        color: #374151;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .social-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .social-item {
        background: white;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e1e5e9;
        transition: all 0.3s ease;
        text-align: center;
    }

    .social-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.15);
    }

    .social-item a {
        text-decoration: none;
        color: #374151;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .social-icon {
        font-size: 1.5rem;
        color: #667eea;
    }

    .social-name {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .social-followers {
        font-size: 0.8rem;
        color: #6b7280;
    }

    /* Mobile Universal Search */
    @media (max-width: 768px) {
        .universal-search-container {
            padding: 15px;
        }

        .universal-search-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .search-status {
            align-self: flex-end;
        }

        .result-item {
            padding: 12px;
        }

        .result-title {
            font-size: 0.9rem;
        }

        .result-snippet {
            font-size: 0.85rem;
        }

        .result-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .social-grid {
            grid-template-columns: 1fr;
        }

        .social-item {
            padding: 10px;
        }
    }

        @media (max-width: 1024px) and (min-width: 769px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-type-tabs {
                gap: 12px;
            }
            
            .search-tab {
                padding: 14px 20px;
                min-width: 100px;
            }
        }

        /* Message animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Loading Screen -->
    <div class="auth-loading" id="authLoading">
        <div class="auth-spinner"></div>
        <div class="auth-loading-text">Memverifikasi autentikasi...</div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="sidebar-title">Pencarian Clearance</div>
        </div>
        
        <nav class="sidebar-menu">
            <a href="/dashboard" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="/profiling" class="menu-item active">
                <i class="fas fa-search"></i>
                <span>Profiling</span>
            </a>
            <a href="/data-profiling" class="menu-item">
                <i class="fas fa-database"></i>
                <span>Data Profiling</span>
            </a>
            <a href="/cekplat" class="menu-item">
                <i class="fas fa-car"></i>
                <span>Cek Plat No Jambi</span>
            </a>
            <div class="nav-submenu">
                <a href="/data-cari-plat" class="menu-item">
                    <i class="fas fa-list"></i>
                    <span>Data Cari Plat No</span>
                </a>
            </div>
            <a href="/user-management" class="menu-item">
                <i class="fas fa-users"></i>
                <span>User Management</span>
            </a>
            <a href="/ai-features" class="menu-item">
                <i class="fas fa-robot"></i>
                <span>AI Features</span>
            </a>
            <a href="/mapping" class="menu-item">
                <i class="fas fa-project-diagram"></i>
                <span>Mapping Profiling</span>
            </a>
            <a href="/reports" class="menu-item">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </a>
            <div class="nav-submenu">
                <a href="/reports/profiling" class="menu-item">
                    <i class="fas fa-user-circle"></i>
                    <span>Profiling</span>
                </a>
            </div>
            <a href="/settings" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </nav>
        
        <div class="menu-divider"></div>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin User</div>
                    <div class="user-role" id="userRole">Administrator</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Profiling</h1>
            </div>
            <div class="topbar-right">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Pencarian cepat..." id="globalSearch">
                </div>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </button>
            </div>
        </div>

        <!-- Profiling Content -->
        <div class="profiling-content">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h2>Profiling Identitas</h2>
                    <p style="color: #6b7280; margin-top: 5px;">Cari dan analisis informasi identitas menggunakan berbagai metode</p>
                </div>
            </div>

            <!-- AI Toggle Switch -->
            <div class="ai-toggle-container" id="aiToggleContainer">
                <div class="ai-toggle-label">
                    <i class="fas fa-robot"></i>
                    <span>Gemini AI Mode</span>
                </div>
                <div class="ai-toggle-switch" id="aiToggleSwitch" onclick="toggleAIMode()">
                    <div class="ai-toggle-slider"></div>
                </div>
            </div>



            <!-- AI Suggestions Panel -->
            <div class="ai-suggestions-panel" id="aiSuggestionsPanel">
                <div class="ai-suggestions-header">
                    <i class="fas fa-lightbulb"></i>
                    <h4>AI Suggestions</h4>
                </div>
                <div id="aiSuggestionsContent">
                    <!-- AI suggestions will be populated here -->
                </div>
            </div>

            <!-- AI Analysis Dashboard -->
            <div class="ai-dashboard" id="aiDashboard">
                <div class="ai-dashboard-header">
                    <div class="ai-dashboard-title">
                        <i class="fas fa-chart-line"></i>
                        <span>AI Analysis Dashboard</span>
                    </div>
                    <button class="ai-dashboard-refresh" onclick="refreshAIDashboard()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                <div class="ai-analysis-grid" id="aiAnalysisGrid">
                    <!-- AI analysis cards will be populated here -->
                </div>
            </div>

            <!-- Search Type Selector -->
            <div class="search-type-selector">
                <h3><i class="fas fa-search"></i> Pilih Jenis Pencarian</h3>
                <div class="search-type-tabs">
                    <button class="search-tab active" data-type="identity" onclick="switchSearchType('identity')">
                        <i class="fas fa-id-card"></i>
                        <span>Identitas</span>
                    </button>
                    <button class="search-tab" data-type="phone" onclick="switchSearchType('phone')">
                        <i class="fas fa-phone"></i>
                        <span>Nomor HP</span>
                    </button>
                    <button class="search-tab" data-type="face" onclick="switchSearchType('face')">
                        <i class="fas fa-camera"></i>
                        <span>Deteksi Wajah</span>
                    </button>
                </div>
            </div>

            <!-- Identity Search Form -->
            <div class="search-form active" id="identityForm">
                <div class="form-container">
                    <!-- AI Face Upload Section for Identity Form -->
                    <div class="ai-face-upload-section" id="identityFaceUploadSection">
                        <div class="ai-upload-area" id="identityUploadArea" onclick="document.getElementById('identityFaceFile').click()">
                            <i class="fas fa-camera"></i>
                            <p>Upload foto untuk AI auto-fill NIK & Nama</p>
                            <input type="file" id="identityFaceFile" accept="image/*" onchange="handleIdentityFaceUpload(this)">
                        </div>
                        
                        <!-- AI Results Panel for Identity -->
                        <div class="ai-results-panel" id="identityResultsPanel">
                            <h4>
                                <i class="fas fa-search"></i>
                                Hasil Pencarian AI
                            </h4>
                            <div class="ai-results-list" id="identityResultsList">
                                <!-- AI results will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                            <div class="form-group">
                            <label for="name"><i class="fas fa-user-circle"></i> Nama Lengkap</label>
                            <input type="text" id="name" placeholder="Masukkan nama lengkap (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="nik"><i class="fas fa-id-card"></i> NIK</label>
                            <input type="text" id="nik" placeholder="Masukkan nomor NIK" value="1505041107830002">
                            </div>
                            <div class="form-group">
                            <label for="family_cert_number"><i class="fas fa-home"></i> Nomor Kartu Keluarga</label>
                            <input type="text" id="family_cert_number" placeholder="Masukkan nomor KK (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="tempat_lahir"><i class="fas fa-map-marker-alt"></i> Tempat Lahir</label>
                            <input type="text" id="tempat_lahir" placeholder="Masukkan tempat lahir (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="tanggal_lahir"><i class="fas fa-calendar"></i> Tanggal Lahir</label>
                            <input type="date" id="tanggal_lahir" placeholder="Masukkan tanggal lahir (opsional)">
                            </div>
                            <div class="form-group">
                            <label for="provinsi"><i class="fas fa-map"></i> Provinsi</label>
                            <select id="provinsi" onchange="loadKabupaten()">
                                <option value="">Pilih Provinsi</option>
                            </select>
                            <input type="hidden" id="no_prop" value="">
                            </div>
                            <div class="form-group">
                            <label for="kabupaten"><i class="fas fa-city"></i> Kabupaten/Kota</label>
                            <select id="kabupaten" onchange="loadKecamatan()" disabled>
                                <option value="">Pilih Kabupaten/Kota</option>
                            </select>
                            <input type="hidden" id="no_kab" value="">
                            </div>
                            <div class="form-group">
                            <label for="kecamatan"><i class="fas fa-building"></i> Kecamatan</label>
                            <select id="kecamatan" onchange="loadKelurahan()" disabled>
                                <option value="">Pilih Kecamatan</option>
                            </select>
                            <input type="hidden" id="no_kec" value="">
                            </div>
                            <div class="form-group">
                            <label for="kelurahan"><i class="fas fa-home"></i> Kelurahan/Desa</label>
                            <select id="kelurahan" onchange="updateKelurahanCode()" disabled>
                                <option value="">Pilih Kelurahan/Desa</option>
                            </select>
                            <input type="hidden" id="no_desa" value="">
                            </div>
                        </div>
                </div>
            </div>

            <!-- Phone Search Form -->
            <div class="search-form" id="phoneForm">
                <div class="form-container">
                    <div class="form-grid">
                            <div class="form-group">
                            <label for="phoneNumber"><i class="fas fa-phone"></i> Nomor HP</label>
                            <input type="text" id="phoneNumber" placeholder="Contoh: 6285755349653">
                        </div>
                        <div class="form-group">
                            <label for="phoneOperator"><i class="fas fa-network-wired"></i> Operator (Opsional)</label>
                            <select id="phoneOperator">
                                <option value="">Semua Operator</option>
                                <option value="TELKOMSEL">Telkomsel</option>
                                <option value="INDOSAT">Indosat</option>
                                <option value="XL">XL</option>
                                <option value="TRI">3 (Tri)</option>
                                <option value="SMARTFREN">Smartfren</option>
                            </select>
                        </div>
                            </div>
                        </div>
                    </div>

            <!-- Face Search Form -->
            <div class="search-form" id="faceForm">
                <div class="form-container">
                    <div class="face-upload-section">
                        <div class="upload-area" id="faceUploadArea">
                            <div class="upload-content">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Upload Foto Wajah</h4>
                                <p>Drag & drop atau klik untuk memilih foto</p>
                                <p class="upload-hint">Format: JPG, PNG, JPEG (Max: 5MB)</p>
                            </div>
                                <input type="file" id="faceFile" accept="image/*" style="display: none;" onchange="handleFaceUploadForNIK(this)">
                            </div>
                        <div class="face-preview" id="facePreview" style="display: none;">
                            <img id="previewImage" alt="Preview">
                            <button class="btn btn-secondary" onclick="removeFaceImage()">
                                <i class="fas fa-times"></i> Hapus
                                </button>
                            </div>
                        </div>

                        <!-- AI Results Panel for Face Form -->
                        <div class="ai-results-panel" id="faceResultsPanel">
                            <h4>
                                <i class="fas fa-search"></i>
                                Hasil Pencarian AI
                            </h4>
                            <div class="ai-results-list" id="faceResultsList">
                                <!-- AI results will be populated here -->
                            </div>
                        </div>

                        <!-- Auto-fill Form Fields -->
                        <div class="form-grid" style="margin-top: 20px;">
                            <div class="form-group">
                                <label for="faceNIK"><i class="fas fa-id-card"></i> NIK (AI Auto-fill)</label>
                                <input type="text" id="faceNIK" placeholder="NIK akan diisi otomatis oleh AI">
                            </div>
                            <div class="form-group">
                                <label for="faceName"><i class="fas fa-user-circle"></i> Nama Lengkap (AI Auto-fill)</label>
                                <input type="text" id="faceName" placeholder="Nama akan diisi otomatis oleh AI">
                            </div>
                        </div>
                            <div class="form-group">
                        <label for="faceThreshold"><i class="fas fa-sliders-h"></i> Tingkat Kemiripan</label>
                        <div class="threshold-slider">
                            <input type="range" id="faceThreshold" min="0.1" max="1.0" step="0.1" value="0.5">
                            <span id="thresholdValue">0.5</span>
                            </div>
                            </div>
                        </div>
                    </div>

            <!-- Hidden credentials (auto-filled from .env) -->
            <input type="hidden" id="username" value="">
            <input type="hidden" id="password" value="">
            
            <div class="search-buttons">
                <button class="btn btn-primary" onclick="handleSubmit()">
                    <i class="fas fa-search"></i> <span id="searchButtonText">Search Identity</span>
                        </button>
                <button class="btn btn-secondary" onclick="clearForm()">
                    <i class="fas fa-eraser"></i> Hapus Form
                        </button>
                    </div>
            </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Searching identity database...</p>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
                <div class="results-header">
                <h3 class="results-title">Hasil Pencarian</h3>
                <span class="results-count" id="resultsCount">0 hasil</span>
                </div>
            <div class="results-content" id="resultsContent">
                <!-- Results will be displayed here -->
            </div>
                </div>

        <!-- Person Details Modal -->
        <div class="modal" id="personDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Person Details</h2>
                    <div class="modal-actions">
                        <button class="export-btn ai-btn" onclick="app.showAIInsights(currentPersonData)" title="AI Insights">
                            <i class="fas fa-brain"></i> AI Insights
                        </button>
                        <button class="export-btn copy-btn" onclick="copyPersonData()" title="Copy Data">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button class="export-btn pdf-btn" onclick="exportToPDF()" title="Ekspor ke PDF">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="export-btn word-btn" onclick="exportToWord()" title="Ekspor ke Word">
                            <i class="fas fa-file-word"></i> Word
                        </button>
                        <button class="modal-close" onclick="closePersonDetails()">&times;</button>
                    </div>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Detailed information will be displayed here -->
                </div>
            </div>
        </div>

        <!-- AI Insights Modal -->
        <div class="ai-insights-modal" id="aiInsightsModal">
            <div class="ai-insights-modal-content">
                <div class="ai-insights-modal-header">
                    <h3>
                        <i class="fas fa-brain icon"></i>
                        AI Insights & Analysis
                    </h3>
                    <span class="close" onclick="closeAIInsights()">&times;</span>
                </div>
                <div class="ai-insights-modal-body" id="aiInsightsModalBody">
                    <!-- AI insights content will be populated here -->
                </div>
                <div class="ai-insights-modal-footer">
                    <button class="ai-insights-modal-close" onclick="closeAIInsights()">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="ai-insights-modal-export" onclick="exportAIInsights()">
                        <i class="fas fa-download"></i> Export Insights
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication middleware
        async function checkAuthentication() {
            const sessionToken = localStorage.getItem('session_token');
            
            if (!sessionToken) {
                console.log('No session token found, redirecting to login');
                window.location.href = '/login';
                return false;
            }
            
            try {
                const response = await fetch('/api/validate-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ session_token: sessionToken })
                });
                
                const data = await response.json();
                
                if (!data.valid) {
                    console.log('Invalid session token, redirecting to login');
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/login';
                    return false;
                }
                
                console.log('Authentication successful');
                // Hide loading screen after successful authentication
                document.getElementById('authLoading').classList.add('hidden');
                return true;
            } catch (error) {
                console.error('Authentication check failed:', error);
                localStorage.removeItem('session_token');
                localStorage.removeItem('user_data');
                window.location.href = '/login';
                return false;
            }
        }

        class ProfilingApp {
            constructor() {
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOverlay = document.getElementById('sidebarOverlay');
                this.isSidebarCollapsed = false;
                this.isMobile = window.innerWidth <= 768;
                this.currentSearchType = 'identity';
                this.faceFile = null;
                
                // AI properties
                this.aiModeEnabled = false;
                this.aiSuggestions = [];
                this.aiAnalysis = null;
                this.currentPersonData = null;
                
                // AI Face-to-NIK properties
                this.aiFaceResults = [];
                this.aiThreshold = 50;
                this.selectedNIK = null;
                
                // Identity Form AI properties
                this.identityFaceResults = [];
                this.selectedIdentityNIK = null;
                
                this.init();
            }

            async init() {
                // Check authentication first
                const isAuthenticated = await checkAuthentication();
                if (!isAuthenticated) {
                    return; // Stop initialization if not authenticated
                }
                
                this.setupEventListeners();
                this.loadConfig();
                this.loadUserData();
            }

            setupEventListeners() {
                // Face file upload
                const faceFileInput = document.getElementById('faceFile');
                const faceUploadArea = document.getElementById('faceUploadArea');
                
                faceFileInput.addEventListener('change', (e) => this.handleFaceFileSelect(e));
                
                // Drag and drop for face upload
                faceUploadArea.addEventListener('click', () => faceFileInput.click());
                faceUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    faceUploadArea.classList.add('dragover');
                });
                faceUploadArea.addEventListener('dragleave', () => {
                    faceUploadArea.classList.remove('dragover');
                });
                faceUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    faceUploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleFaceFile(files[0]);
                    }
                });

                // Threshold slider
                const thresholdSlider = document.getElementById('faceThreshold');
                const thresholdValue = document.getElementById('thresholdValue');
                thresholdSlider.addEventListener('input', (e) => {
                    thresholdValue.textContent = e.target.value;
                });

                // Global search
                document.getElementById('globalSearch').addEventListener('input', (e) => {
                    this.handleGlobalSearch(e.target.value);
                });

                // Window resize
                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth <= 768;
                    if (!this.isMobile) {
                        this.sidebarOverlay.classList.remove('active');
                    }
                });
            }

            checkAuth() {
                const token = localStorage.getItem('session_token');
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
            }

            loadConfig() {
                // Auto-fill credentials from config
                document.getElementById('username').value = 'rezarios';
                document.getElementById('password').value = '12345678';
            }

            loadUserData() {
                const userData = localStorage.getItem('user_data');
                if (userData) {
                    const user = JSON.parse(userData);
                    document.getElementById('userName').textContent = user.name || 'Admin User';
                    document.getElementById('userRole').textContent = user.role || 'Administrator';
                    
                    // Set menu visibility based on user role
                    this.setMenuVisibility(user.role);
                }
            }

            setMenuVisibility(userRole) {
                // Hide admin-only menus for non-admin users
                const adminOnlyMenus = ['user-management', 'settings'];
                
                adminOnlyMenus.forEach(menuId => {
                    const menuElement = document.querySelector(`a[href="/${menuId}"]`);
                    if (menuElement) {
                        if (userRole === 'admin') {
                            menuElement.style.display = 'flex';
                        } else {
                            menuElement.style.display = 'none';
                        }
                    }
                });
            }

            handleFaceFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.handleFaceFile(file);
                }
            }

            handleFaceFile(file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showMessage('Silakan pilih file gambar yang valid', 'error');
                    return;
                }

                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('Ukuran file harus kurang dari 5MB', 'error');
                    return;
                }

                this.faceFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('facePreview');
                    const previewImage = document.getElementById('previewImage');
                    const uploadArea = document.getElementById('faceUploadArea');
                    
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                    uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            removeFaceImage() {
                this.faceFile = null;
                document.getElementById('facePreview').style.display = 'none';
                document.getElementById('faceUploadArea').style.display = 'block';
                document.getElementById('faceFile').value = '';
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            async handleSubmit() {
                console.log('handleSubmit called');
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();

                console.log('Username:', username);
                console.log('Password:', password ? '***' : 'empty');
                console.log('Current search type:', this.currentSearchType);

                if (!username || !password) {
                    this.showMessage('Kredensial tidak ditemukan. Pastikan file .env sudah dikonfigurasi dengan benar.', 'error');
                    return;
                }

                // Validate based on search type
                if (!this.validateCurrentSearch()) {
                    console.log('Validation failed');
                    return;
                }

                console.log('Validation passed, starting search...');
                this.showLoading(true);
                this.hideResults();

                try {
                    const requestData = await this.buildRequestData(username, password);
                    console.log('Request data:', requestData);
                    
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    console.log('Response status:', response.status);
                    const result = await response.json();
                    console.log('Response result:', result);
                    
                    if (!response.ok) {
                        throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.displayResults(result);

                } catch (error) {
                    console.error('Error in handleSubmit:', error);
                    this.showMessage(`Error: ${error.message}`, 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            validateCurrentSearch() {
                console.log('validateCurrentSearch called for type:', this.currentSearchType);
                
                switch (this.currentSearchType) {
                    case 'identity':
                        const name = document.getElementById('name').value.trim();
                        const nik = document.getElementById('nik').value.trim();
                        const family_cert_number = document.getElementById('family_cert_number').value.trim();
                        const tempat_lahir = document.getElementById('tempat_lahir').value.trim();
                        const tanggal_lahir = document.getElementById('tanggal_lahir').value.trim();
                        const no_prop = document.getElementById('no_prop').value.trim();
                        const no_kab = document.getElementById('no_kab').value.trim();
                        const no_kec = document.getElementById('no_kec').value.trim();
                        const no_desa = document.getElementById('no_desa').value.trim();
                        
                        console.log('Identity validation - Name:', name, 'NIK:', nik, 'Family Cert:', family_cert_number, 'Tempat Lahir:', tempat_lahir, 'Tanggal Lahir:', tanggal_lahir, 'No Prop:', no_prop, 'No Kab:', no_kab, 'No Kec:', no_kec, 'No Desa:', no_desa);
                        
                        if (!name && !nik && !family_cert_number && !tempat_lahir && !tanggal_lahir && !no_prop && !no_kab && !no_kec && !no_desa) {
                            this.showMessage('Minimal satu parameter harus diisi (Nama, NIK, KK, Tempat Lahir, Tanggal Lahir, atau Kode Lokasi)', 'error');
                            return false;
                        }
                        break;
                    
                    case 'phone':
                        const phoneNumber = document.getElementById('phoneNumber').value.trim();
                        console.log('Phone validation - Number:', phoneNumber);
                        if (!phoneNumber) {
                            this.showMessage('Nomor HP harus diisi', 'error');
                            return false;
                        }
                        break;
                    
                    case 'face':
                        console.log('Face validation - File:', this.faceFile);
                        if (!this.faceFile) {
                            this.showMessage('Foto wajah harus diupload', 'error');
                            return false;
                        }
                        break;
                }
                console.log('Validation passed');
                return true;
            }

            async buildRequestData(username, password) {
                const baseData = {
                    username,
                    password,
                    search_type: this.currentSearchType,
                    page: 1,
                    limit: 100  // Tambahkan parameter limit dengan default 100
                };

                switch (this.currentSearchType) {
                    case 'identity':
                        return {
                            ...baseData,
                            name: document.getElementById('name').value.trim(),
                            nik: document.getElementById('nik').value.trim(),
                            family_cert_number: document.getElementById('family_cert_number').value.trim(),
                            tempat_lahir: document.getElementById('tempat_lahir').value.trim(),
                            tanggal_lahir: document.getElementById('tanggal_lahir').value.trim(),
                            no_prop: document.getElementById('no_prop').value.trim(),
                            no_kab: document.getElementById('no_kab').value.trim(),
                            no_kec: document.getElementById('no_kec').value.trim(),
                            no_desa: document.getElementById('no_desa').value.trim()
                        };
                    
                    case 'phone':
                        return {
                            ...baseData,
                            phone_number: document.getElementById('phoneNumber').value.trim(),
                            phone_operator: document.getElementById('phoneOperator').value.trim()
                        };
                    
                    case 'face':
                        const faceQuery = await this.fileToBase64(this.faceFile);
                        return {
                            ...baseData,
                            face_query: faceQuery,
                            face_threshold: parseFloat(document.getElementById('faceThreshold').value)
                        };
                    
                    default:
                        return baseData;
                }
            }

            displayResults(result) {
                console.log('displayResults called with:', result);
                console.log('result.results:', result.results);
                console.log('result.results length:', result.results ? result.results.length : 'undefined');
                
                const resultsCount = document.getElementById('resultsCount');
                const resultsContent = document.getElementById('resultsContent');
                
                resultsCount.textContent = `${result.total_results || 0} results`;
                resultsContent.innerHTML = '';

                // Check if this is a fallback mode response
                if (result.message && result.message.includes('Server eksternal tidak tersedia')) {
                    const fallbackDiv = document.createElement('div');
                    fallbackDiv.className = 'result-card';
                    fallbackDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 15px;"></i>
                            <h3 style="color: #d97706; margin-bottom: 10px;">Server Eksternal Tidak Tersedia</h3>
                            <p style="color: #92400e; margin-bottom: 15px;">Sistem sedang menggunakan mode offline</p>
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin: 10px 0;">
                                <p style="color: #92400e; margin: 0; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> 
                                    Data pencarian tidak dapat diakses saat ini. Silakan coba lagi nanti atau hubungi administrator.
                                </p>
                            </div>
                        </div>
                    `;
                    resultsContent.appendChild(fallbackDiv);
                } else if (result.results && result.results.length > 0) {
                    console.log('Creating results grid with', result.results.length, 'items');
                    // Create grid container
                    const gridContainer = document.createElement('div');
                    gridContainer.className = 'results-grid';
                    
                    result.results.forEach((item, index) => {
                        console.log('Processing item', index, ':', item);
                        const person = item.person;
                        console.log('Person data:', person);
                        const resultCard = this.createResultCard(person, index, result.results.length);
                        gridContainer.appendChild(resultCard);
                    });
                    
                    resultsContent.appendChild(gridContainer);
                    console.log('Results grid created and appended');
                } else {
                    console.log('No results found, showing empty message');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'result-card';
                    messageDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-search" style="font-size: 3rem; color: #9ca3af; margin-bottom: 15px;"></i>
                            <h3 style="color: #6b7280; margin-bottom: 10px;">Tidak Ada Hasil Ditemukan</h3>
                            <p style="color: #9ca3af;">Coba sesuaikan kriteria pencarian Anda</p>
                        </div>
                    `;
                    resultsContent.appendChild(messageDiv);
                }

                this.showResults();
            }

            createResultCard(person, index, totalResults) {
                const card = document.createElement('div');
                card.className = 'result-card';
                
                const fullName = person.full_name || person.name || 'Unknown';
                const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                card.innerHTML = `
                    ${index === 0 ? `<div class="data-count">${totalResults} data</div>` : ''}
                    <div class="result-header">
                        <div class="result-avatar">
                            ${person.face ? `<img src="${person.face}" alt="Photo" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : initials}
                        </div>
                        <div class="result-info">
                            <h3>${fullName}</h3>
                            <p>NIK: ${person.ktp_number || person.nik || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Nama Lengkap</span>
                            <span class="info-value">${fullName}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">NIK</span>
                            <span class="info-value">${person.ktp_number || person.nik || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tanggal Lahir</span>
                            <span class="info-value">${person.tanggal_lahir || person.date_of_birth || person.birth_date || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tempat Lahir</span>
                            <span class="info-value">${person.tempat_lahir || person.place_of_birth || person.birth_place || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Jenis Kelamin</span>
                            <span class="info-value">${person.jenis_kelamin || person.gender || person.sex || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Alamat</span>
                            <span class="info-value">${person.alamat || person.address || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Provinsi</span>
                            <span class="info-value">${person.province_name || person.provinsi || person.province || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="result-actions" style="margin-top: 12px; text-align: center;">
                        <button class="btn btn-primary btn-sm" onclick="viewPersonDetails('${person.ktp_number || person.nik || ''}')">
                            <i class="fas fa-eye"></i> Lihat Detail
                        </button>
                    </div>
                `;
                
                return card;
            }

            showLoading(show) {
                const loading = document.getElementById('loading');
                loading.style.display = show ? 'block' : 'none';
            }

            showResults() {
                document.getElementById('resultsSection').style.display = 'block';
            }

            hideResults() {
                document.getElementById('resultsSection').style.display = 'none';
            }

            showMessage(message, type) {
                // Create a better message display
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: bold;
                    z-index: 10000;
                    max-width: 400px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideIn 0.3s ease-out;
                `;
                
                if (type === 'error') {
                    messageDiv.style.backgroundColor = '#dc3545';
                } else if (type === 'success') {
                    messageDiv.style.backgroundColor = '#28a745';
                } else {
                    messageDiv.style.backgroundColor = '#007bff';
                }
                
                messageDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: auto;">&times;</button>
                    </div>
                `;
                
                document.body.appendChild(messageDiv);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 5000);
            }

            clearForm() {
                // Clear all form fields based on current search type
                switch (this.currentSearchType) {
                    case 'identity':
                document.getElementById('name').value = '';
                document.getElementById('nik').value = '';
                document.getElementById('family_cert_number').value = '';
                document.getElementById('tempat_lahir').value = '';
                document.getElementById('tanggal_lahir').value = '';
                
                // Reset wilayah dropdowns
                document.getElementById('provinsi').value = '';
                document.getElementById('kabupaten').value = '';
                document.getElementById('kecamatan').value = '';
                document.getElementById('kelurahan').value = '';
                
                // Reset hidden fields
                document.getElementById('no_prop').value = '';
                document.getElementById('no_kab').value = '';
                document.getElementById('no_kec').value = '';
                document.getElementById('no_desa').value = '';
                
                // Reset dropdown states
                document.getElementById('kabupaten').disabled = true;
                document.getElementById('kecamatan').disabled = true;
                document.getElementById('kelurahan').disabled = true;
                
                // Reset dropdown options
                document.getElementById('kabupaten').innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
                document.getElementById('kecamatan').innerHTML = '<option value="">Pilih Kecamatan</option>';
                document.getElementById('kelurahan').innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
                        break;
                    case 'phone':
                        document.getElementById('phoneNumber').value = '';
                        document.getElementById('phoneOperator').value = '';
                        break;
                    case 'face':
                        this.removeFaceImage();
                        document.getElementById('faceThreshold').value = '0.5';
                        document.getElementById('thresholdValue').textContent = '0.5';
                        break;
                }
                this.hideResults();
            }

            handleGlobalSearch(query) {
                if (query.length > 2) {
                    console.log('Global search for:', query);
                    // Implement global search functionality
                }
            }

            // AI Methods
            async toggleAIMode() {
                this.aiModeEnabled = !this.aiModeEnabled;
                const toggleContainer = document.getElementById('aiToggleContainer');
                const toggleSwitch = document.getElementById('aiToggleSwitch');
                const suggestionsPanel = document.getElementById('aiSuggestionsPanel');
                const dashboard = document.getElementById('aiDashboard');

                if (this.aiModeEnabled) {
                    toggleContainer.classList.add('active');
                    toggleSwitch.classList.add('active');
                    suggestionsPanel.classList.add('active');
                    dashboard.classList.add('active');
                    
                    // Load AI suggestions and analysis
                    await this.loadAISuggestions();
                    await this.loadAIAnalysis();
                } else {
                    toggleContainer.classList.remove('active');
                    toggleSwitch.classList.remove('active');
                    suggestionsPanel.classList.remove('active');
                    dashboard.classList.remove('active');
                }
            }

            async loadAISuggestions() {
                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/suggestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            search_type: this.currentSearchType,
                            context: 'profiling_search'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.aiSuggestions = result.suggestions || [];
                        this.renderAISuggestions();
                    }
                } catch (error) {
                    console.error('Error loading AI suggestions:', error);
                    this.renderAISuggestions(); // Show fallback suggestions
                }
            }

            renderAISuggestions() {
                const suggestionsContent = document.getElementById('aiSuggestionsContent');
                
                if (this.aiSuggestions.length === 0) {
                    // Fallback suggestions
                    this.aiSuggestions = [
                        { text: 'Coba tambahkan informasi lokasi untuk hasil yang lebih akurat', confidence: 85, icon: 'fas fa-map-marker-alt' },
                        { text: 'Gunakan pencarian kombinasi NIK + nama untuk hasil terbaik', confidence: 92, icon: 'fas fa-id-card' },
                        { text: 'Upload foto dengan kualitas tinggi untuk face recognition', confidence: 78, icon: 'fas fa-camera' }
                    ];
                }

                suggestionsContent.innerHTML = this.aiSuggestions.map(suggestion => `
                    <div class="ai-suggestion-item" onclick="app.applyAISuggestion('${suggestion.text}')">
                        <i class="${suggestion.icon}"></i>
                        <div class="ai-suggestion-text">${suggestion.text}</div>
                        <div class="ai-suggestion-confidence">${suggestion.confidence}%</div>
                    </div>
                `).join('');
            }

            applyAISuggestion(suggestionText) {
                // Apply suggestion based on content
                if (suggestionText.includes('lokasi')) {
                    // Focus on location input
                    const locationInput = document.querySelector('input[placeholder*="alamat"], input[placeholder*="lokasi"]');
                    if (locationInput) {
                        locationInput.focus();
                        locationInput.style.borderColor = '#667eea';
                        setTimeout(() => locationInput.style.borderColor = '', 2000);
                    }
                } else if (suggestionText.includes('NIK')) {
                    // Focus on NIK input
                    const nikInput = document.querySelector('input[placeholder*="NIK"], input[name*="nik"]');
                    if (nikInput) {
                        nikInput.focus();
                        nikInput.style.borderColor = '#667eea';
                        setTimeout(() => nikInput.style.borderColor = '', 2000);
                    }
                } else if (suggestionText.includes('foto')) {
                    // Focus on face upload
                    const faceUpload = document.getElementById('faceUploadArea');
                    if (faceUpload) {
                        faceUpload.style.borderColor = '#667eea';
                        setTimeout(() => faceUpload.style.borderColor = '', 2000);
                    }
                }
            }

            async loadAIAnalysis() {
                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            search_type: this.currentSearchType,
                            context: 'profiling_analysis'
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.aiAnalysis = result.analysis || {};
                        this.renderAIAnalysis();
                    }
                } catch (error) {
                    console.error('Error loading AI analysis:', error);
                    this.renderAIAnalysis(); // Show fallback analysis
                }
            }

            renderAIAnalysis() {
                const analysisGrid = document.getElementById('aiAnalysisGrid');
                
                if (!this.aiAnalysis || Object.keys(this.aiAnalysis).length === 0) {
                    // Fallback analysis
                    this.aiAnalysis = {
                        search_optimization: {
                            title: 'Search Optimization',
                            content: 'AI suggests using multiple search criteria for better results',
                            confidence: 88
                        },
                        data_quality: {
                            title: 'Data Quality',
                            content: 'Current search parameters show good data coverage potential',
                            confidence: 92
                        },
                        risk_assessment: {
                            title: 'Risk Assessment',
                            content: 'Standard profiling search with low risk indicators',
                            confidence: 85
                        }
                    };
                }

                analysisGrid.innerHTML = Object.entries(this.aiAnalysis).map(([key, analysis]) => `
                    <div class="ai-analysis-card">
                        <div class="ai-analysis-card-header">
                            <i class="fas fa-chart-bar"></i>
                            <div class="ai-analysis-card-title">${analysis.title}</div>
                        </div>
                        <div class="ai-analysis-card-content">${analysis.content}</div>
                        <div class="ai-confidence-score">${analysis.confidence}% confidence</div>
                    </div>
                `).join('');
            }

            async refreshAIDashboard() {
                const refreshBtn = document.querySelector('.ai-dashboard-refresh');
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                refreshBtn.disabled = true;

                try {
                    await this.loadAISuggestions();
                    await this.loadAIAnalysis();
                } finally {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }

            async showAIInsights(personData) {
                this.currentPersonData = personData;
                const modal = document.getElementById('aiInsightsModal');
                const modalBody = document.getElementById('aiInsightsModalBody');

                // Show loading
                modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Generating AI insights...</p></div>';
                modal.style.display = 'block';

                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/insights', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            person_data: personData,
                            search_type: this.currentSearchType
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.renderAIInsights(result.insights);
                    } else {
                        this.renderAIInsights(); // Show fallback insights
                    }
                } catch (error) {
                    console.error('Error loading AI insights:', error);
                    this.renderAIInsights(); // Show fallback insights
                }
            }

            renderAIInsights(insights = null) {
                const modalBody = document.getElementById('aiInsightsModalBody');
                
                if (!insights) {
                    // Fallback insights
                    insights = {
                        behavioral_analysis: {
                            title: 'Behavioral Analysis',
                            content: 'Based on available data, this individual shows standard demographic patterns typical for the region. No significant behavioral anomalies detected.',
                            confidence: 87
                        },
                        risk_assessment: {
                            title: 'Risk Assessment',
                            content: 'Low to moderate risk profile based on standard profiling criteria. No immediate red flags identified.',
                            confidence: 82
                        },
                        network_analysis: {
                            title: 'Network Analysis',
                            content: 'Standard family and social network patterns observed. No unusual connections detected.',
                            confidence: 79
                        },
                        recommendations: {
                            title: 'Recommendations',
                            content: 'Continue standard monitoring protocols. Consider additional verification if higher confidence is required.',
                            confidence: 91
                        }
                    };
                }

                modalBody.innerHTML = Object.entries(insights).map(([key, insight]) => `
                    <div class="ai-insight-section">
                        <div class="ai-insight-section-header">
                            <i class="fas fa-brain"></i>
                            <div class="ai-insight-section-title">${insight.title}</div>
                        </div>
                        <div class="ai-insight-content">${insight.content}</div>
                        <div class="ai-insight-confidence">${insight.confidence}% confidence</div>
                    </div>
                `).join('');
            }

            async exportAIInsights() {
                if (!this.currentPersonData) {
                    alert('No data available for export');
                    return;
                }

                try {
                    const token = localStorage.getItem('session_token');
                    const response = await fetch('/api/ai/export-insights', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            person_data: this.currentPersonData,
                            insights: this.aiAnalysis
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            window.open(`/api/ai/download-insights/${result.filename}`, '_blank');
                        }
                    }
                } catch (error) {
                    console.error('Error exporting AI insights:', error);
                    alert('Error exporting insights');
                }
            }

            // AI Face-to-NIK Methods
            async handleFaceUpload(input) {
                const file = input.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showMessage('Harap pilih file gambar yang valid', 'error');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('Ukuran file maksimal 5MB', 'error');
                    return;
                }

                try {
                    // Show loading state
                    this.updateAIStatus('processing', 'AI Analyzing...');
                    
                    // Convert file to base64
                    const base64 = await this.fileToBase64(file);
                    
                    // Call AI face analysis API
                    const response = await fetch('/api/ai/face-to-nik', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('session_token')}`
                        },
                        body: JSON.stringify({
                            image: base64,
                            threshold: this.aiThreshold
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.aiFaceResults = data.results || [];
                        this.renderAIResults();
                        this.updateAIStatus('active', 'AI Ready');
                        this.showMessage(`AI menemukan ${this.aiFaceResults.length} kemungkinan NIK`, 'success');
                    } else {
                        throw new Error('AI analysis failed');
                    }
                } catch (error) {
                    console.error('Error in face upload:', error);
                    this.updateAIStatus('inactive', 'AI Error');
                    this.showMessage('Error saat menganalisis foto', 'error');
                }
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            }

            renderAIResults() {
                const resultsList = document.getElementById('aiResultsList');
                const resultsPanel = document.getElementById('aiResultsPanel');
                
                if (this.aiFaceResults.length === 0) {
                    resultsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Tidak ada hasil yang ditemukan</p>';
                    resultsPanel.classList.add('active');
                    return;
                }

                resultsList.innerHTML = this.aiFaceResults.map((result, index) => {
                    const confidenceClass = this.getConfidenceClass(result.confidence);
                    const isSelected = index === 0; // Auto-select highest confidence
                    
                    return `
                        <div class="ai-result-item ${isSelected ? 'selected' : ''}" 
                             onclick="selectAIResult(${index})" 
                             data-nik="${result.nik}">
                            <img src="${result.photo_url || '/static/default-avatar.png'}" 
                                 alt="${result.name}" 
                                 onerror="this.src='/static/default-avatar.png'">
                            <div class="ai-result-info">
                                <h5>${result.name || 'N/A'}</h5>
                                <p>NIK: ${result.nik}</p>
                            </div>
                            <div class="confidence-score ${confidenceClass}">
                                ${result.confidence}%
                            </div>
                        </div>
                    `;
                }).join('');

                resultsPanel.classList.add('active');
                
                // Auto-select first result (highest confidence)
                if (this.aiFaceResults.length > 0) {
                    this.selectedNIK = this.aiFaceResults[0].nik;
                    this.updateAIFillButton();
                }
            }

            getConfidenceClass(confidence) {
                if (confidence >= 80) return 'high';
                if (confidence >= 60) return 'medium';
                return 'low';
            }

            selectAIResult(index) {
                // Remove previous selection
                document.querySelectorAll('.ai-result-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selection to clicked item
                const selectedItem = document.querySelectorAll('.ai-result-item')[index];
                selectedItem.classList.add('selected');
                
                // Update selected NIK
                this.selectedNIK = this.aiFaceResults[index].nik;
                this.updateAIFillButton();
            }

            updateAIFillButton() {
                const fillBtn = document.getElementById('aiFillBtn');
                if (this.selectedNIK) {
                    fillBtn.disabled = false;
                    fillBtn.innerHTML = '<i class="fas fa-magic"></i> AI Fill';
                } else {
                    fillBtn.disabled = true;
                    fillBtn.innerHTML = '<i class="fas fa-magic"></i> AI Fill';
                }
            }

            fillNIKFromAI() {
                if (!this.selectedNIK) {
                    this.showMessage('Pilih NIK dari hasil AI terlebih dahulu', 'error');
                    return;
                }

                const nikInput = document.getElementById('nikInput');
                nikInput.value = this.selectedNIK;
                nikInput.classList.add('ai-filled');
                
                // Find corresponding name if available
                const selectedResult = this.aiFaceResults.find(result => result.nik === this.selectedNIK);
                if (selectedResult && selectedResult.name) {
                    const nameInput = document.getElementById('nameInput');
                    nameInput.value = selectedResult.name;
                }
                
                this.showMessage('NIK berhasil diisi oleh AI!', 'success');
            }

            updateAIThreshold() {
                const thresholdInput = document.getElementById('aiThreshold');
                this.aiThreshold = parseInt(thresholdInput.value) || 50;
            }

            updateAIStatus(status, text) {
                const statusIndicator = document.getElementById('aiStatusIndicator');
                const statusDot = statusIndicator.querySelector('.ai-status-dot');
                const statusText = statusIndicator.querySelector('span');
                
                statusIndicator.className = `ai-status-indicator ${status}`;
                statusText.textContent = text;
            }

            // Identity Form AI Face Upload Methods
            async handleIdentityFaceUpload(input) {
                const file = input.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    this.showMessage('Harap pilih file gambar yang valid', 'error');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.showMessage('Ukuran file maksimal 5MB', 'error');
                    return;
                }

                try {
                    // Show loading state
                    this.showMessage('OCR sedang membaca NIK dari foto...', 'info');
                    
                    // Convert file to base64
                    const base64 = await this.fileToBase64(file);
                    
                    // Call OCR NIK extraction API
                    const response = await fetch('/api/ai/ocr-nik', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('session_token')}`
                        },
                        body: JSON.stringify({
                            image_data: base64
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // Convert OCR results to the expected format
                            this.identityFaceResults = data.data.nik_candidates.map(candidate => ({
                                nik: candidate.nik,
                                name: candidate.name || 'Nama tidak terdeteksi',
                                confidence: candidate.confidence,
                                source: 'ocr'
                            }));
                            
                            this.renderIdentityResults();
                            this.showMessage(`OCR menemukan ${this.identityFaceResults.length} NIK dari foto`, 'success');
                        } else {
                            throw new Error(data.error || 'OCR extraction failed');
                        }
                    } else {
                        throw new Error('OCR analysis failed');
                    }
                } catch (error) {
                    console.error('Error in OCR NIK extraction:', error);
                    this.showMessage('Error saat membaca NIK dari foto', 'error');
                }
            }

            renderIdentityResults() {
                const resultsList = document.getElementById('identityResultsList');
                const resultsPanel = document.getElementById('identityResultsPanel');
                
                if (this.identityFaceResults.length === 0) {
                    resultsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Tidak ada NIK yang ditemukan dalam foto</p>';
                    resultsPanel.classList.add('active');
                    return;
                }

                resultsList.innerHTML = this.identityFaceResults.map((result, index) => {
                    const confidenceClass = this.getConfidenceClass(result.confidence);
                    const isSelected = index === 0; // Auto-select highest confidence
                    const sourceIcon = result.source === 'ocr' ? 'fas fa-eye' : 'fas fa-user';
                    const sourceText = result.source === 'ocr' ? 'OCR' : 'AI';
                    
                    return `
                        <div class="ai-result-item ${isSelected ? 'selected' : ''}" 
                             onclick="selectIdentityResult(${index})" 
                             data-nik="${result.nik}">
                            <div class="ai-result-icon">
                                <i class="${sourceIcon}"></i>
                            </div>
                            <div class="ai-result-info">
                                <h5>${result.name || 'Nama tidak terdeteksi'}</h5>
                                <p>NIK: ${result.nik}</p>
                                <small class="source-badge">${sourceText}</small>
                            </div>
                            <div class="confidence-score ${confidenceClass}">
                                ${result.confidence}%
                            </div>
                        </div>
                    `;
                }).join('');

                resultsPanel.classList.add('active');
                
                // Auto-select first result (highest confidence) and auto-fill
                if (this.identityFaceResults.length > 0) {
                    this.selectedIdentityNIK = this.identityFaceResults[0].nik;
                    this.autoFillIdentityForm(this.identityFaceResults[0]);
                }
            }

            selectIdentityResult(index) {
                // Remove previous selection
                document.querySelectorAll('#identityResultsList .ai-result-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selection to clicked item
                const selectedItem = document.querySelectorAll('#identityResultsList .ai-result-item')[index];
                selectedItem.classList.add('selected');
                
                // Update selected NIK and auto-fill form
                this.selectedIdentityNIK = this.identityFaceResults[index].nik;
                this.autoFillIdentityForm(this.identityFaceResults[index]);
            }

            autoFillIdentityForm(result) {
                // Auto-fill NIK field
                const nikInput = document.getElementById('nik');
                nikInput.value = result.nik;
                nikInput.classList.add('ai-filled');
                
                // Auto-fill Name field
                const nameInput = document.getElementById('name');
                nameInput.value = result.name || '';
                nameInput.classList.add('ai-filled');
                
                this.showMessage(`Form berhasil diisi: ${result.name} - ${result.nik}`, 'success');
            }
        }

        // Global functions
        const app = new ProfilingApp();

        function handleSubmit() {
            app.handleSubmit();
        }

        function clearForm() {
            app.clearForm();
        }

        function switchSearchType(type) {
            app.currentSearchType = type;
            
            // Update active tab
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update active form
            document.querySelectorAll('.search-form').forEach(form => {
                form.classList.remove('active');
            });
            document.getElementById(`${type}Form`).classList.add('active');
            
            // Update search button text
            const buttonTexts = {
                'identity': 'Search Identity',
                'phone': 'Search by Phone',
                'face': 'Search by Face'
            };
            document.getElementById('searchButtonText').textContent = buttonTexts[type];
            
            // Clear current form
            app.clearForm();
        }

        function removeFaceImage() {
            app.removeFaceImage();
        }

        function toggleSidebar() {
            const app = window.profilingApp;
            if (app.isMobile) {
                app.sidebar.classList.toggle('mobile-open');
                app.sidebarOverlay.classList.toggle('active');
            } else {
                app.isSidebarCollapsed = !app.isSidebarCollapsed;
                app.sidebar.classList.toggle('collapsed');
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    const token = localStorage.getItem('session_token');
                    if (token) {
                        await fetch('/api/logout', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ session_token: token })
                        });
                    }
                } catch (error) {
                    console.error('Logout API error:', error);
                } finally {
                    // Always clear local storage and redirect
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/login';
                }
            }
        }

        // Person Details Modal Functions
        async function viewPersonDetails(nik) {
            if (!nik) {
                alert('NIK tidak ditemukan');
                return;
            }

            const modal = document.getElementById('personDetailsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Show loading
            modalTitle.textContent = 'Memuat...';
            modalBody.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Memuat detail orang...</p></div>';
            modal.style.display = 'block';

            try {
                const token = localStorage.getItem('session_token');
                const response = await fetch('/api/person-details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nik: nik,
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });

                const result = await response.json();

                if (result.success && result.person) {
                    displayPersonDetails(result.person);
                } else {
                    modalTitle.textContent = 'Error';
                    modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i><h3>Error Memuat Detail</h3><p>' + (result.error || 'Gagal memuat detail orang') + '</p></div>';
                }
            } catch (error) {
                modalTitle.textContent = 'Error';
                modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i><h3>Error Jaringan</h3><p>Gagal terhubung ke server</p></div>';
            }
        }

        function displayPersonDetails(person) {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            // Store person data for export
            currentPersonData = person;

            modalTitle.textContent = person.full_name || 'Person Details';

            let html = `
                <div class="detail-section">
                    <h3><i class="fas fa-user"></i> Informasi Pribadi</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="label">Nama Lengkap</div>
                            <div class="value">${person.full_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">NIK</div>
                            <div class="value">${person.ktp_number || person.nik || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Tanggal Lahir</div>
                            <div class="value">${person.date_of_birth || person.tanggal_lahir || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Tempat Lahir</div>
                            <div class="value">${person.birth_place || person.tempat_lahir || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Jenis Kelamin</div>
                            <div class="value">${person.sex || person.jenis_kelamin || person.gender || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Status Perkawinan</div>
                            <div class="value">${person.marital_status || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Agama</div>
                            <div class="value">${person.religion || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Pekerjaan</div>
                            <div class="value">${person.occupation || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Alamat</div>
                            <div class="value">${person.address || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Provinsi</div>
                            <div class="value">${person.province_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Kecamatan</div>
                            <div class="value">${person.district_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Desa/Kelurahan</div>
                            <div class="value">${person.village_name || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `;

            // Phone Numbers Section
            if (person.phone_data && person.phone_data.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3><i class="fas fa-phone"></i> Nomor Telepon (${person.phone_data.length})</h3>
                        <div class="phone-grid">
                `;
                person.phone_data.forEach(phone => {
                    html += `
                        <div class="phone-item">
                            <div class="phone-number">${phone.number || phone.msisdn || 'N/A'}</div>
                            <div class="phone-operator">${phone.operator || 'Unknown'}</div>
                            <div class="phone-date">Terdaftar: ${phone.register_date || 'N/A'}</div>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }

            // Family Members Section
            if (person.family_data && person.family_data.anggota_keluarga && person.family_data.anggota_keluarga.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3><i class="fas fa-users"></i> Family Members (${person.family_data.anggota_keluarga.length})</h3>
                        <div class="detail-item" style="margin-bottom: 20px;">
                            <div class="label">Family Head</div>
                            <div class="value">${person.family_data.kepala_keluarga || 'N/A'}</div>
                        </div>
                        <div class="detail-item" style="margin-bottom: 20px;">
                            <div class="label">Family Card Number (NKK)</div>
                            <div class="value">${person.family_data.nkk || 'N/A'}</div>
                        </div>
                        <div class="detail-item" style="margin-bottom: 20px;">
                            <div class="label">Alamat Keluarga</div>
                            <div class="value">${person.family_data.alamat_keluarga || 'N/A'}</div>
                        </div>
                        <div class="family-grid">
                `;
                person.family_data.anggota_keluarga.forEach(member => {
                    // Handle photo display
                    let photoHtml = '';
                    if (member.foto && member.foto.trim() !== '') {
                        let photoSrc = member.foto;
                        if (!photoSrc.startsWith('data:image/')) {
                            // Add proper prefix if missing
                            if (photoSrc.startsWith('/9j/')) {
                                photoSrc = 'data:image/jpeg;base64,' + photoSrc;
                            } else if (photoSrc.startsWith('iVBORw0KGgo')) {
                                photoSrc = 'data:image/png;base64,' + photoSrc;
                            } else {
                                photoSrc = 'data:image/jpeg;base64,' + photoSrc;
                            }
                        }
                        photoHtml = `<div class="family-photo"><img src="${photoSrc}" alt="${member.nama || 'Family Member'}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;"></div>`;
                    } else {
                        // Generate avatar with initials
                        const name = member.nama || 'N/A';
                        const initials = name !== 'N/A' ? name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '?';
                        photoHtml = `<div class="family-photo"><div class="family-avatar" style="width: 60px; height: 60px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; margin-bottom: 10px;">${initials}</div></div>`;
                    }
                    
                    html += `
                        <div class="family-item">
                            ${photoHtml}
                            <div class="family-name">${member.nama || member.name || 'N/A'}</div>
                            <div class="family-relationship">${member.hubungan || member.relationship || 'N/A'}</div>
                            <div class="family-nik">NIK: ${member.nik || 'N/A'}</div>
                            <div class="family-nik">Birth: ${member.tanggal_lahir || member.date_of_birth || member.birth_date || 'N/A'}</div>
                            <div class="family-nik">Jenis Kelamin: ${member.jenis_kelamin || member.gender || member.sex || 'N/A'}</div>
                        </div>
                    `;
                });
                html += `
                        </div>
                    </div>
                `;
            }

            // Add Social Media Search Section (INTEGRATED: Universal + Social Media + Multi-Query)
            html += `
                <div class="detail-section" id="socialMediaSearchSection">
                    <h3><i class="fas fa-share-alt"></i> Social Media Search</h3>
                    <div class="search-info-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; margin-bottom: 20px;">
                        <div style="color: white;">
                            <i class="fas fa-search"></i> <strong>Mencari:</strong> <span id="socialMediaSearchName">${person.full_name || 'N/A'}</span>
                            </div>
                        <div class="search-status" id="socialMediaSearchStatus" style="color: white; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-spinner fa-spin"></i> <span>Siap mencari...</span>
                            </div>
                        </div>
                        
                    <div class="universal-search-container">
                        <!-- AI Analysis Section -->
                        <div class="ai-analysis-section" id="aiAnalysisSection" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-robot"></i> AI Analysis
                                <span style="font-size: 0.8rem; background: rgba(255,255,255,0.3); padding: 4px 10px; border-radius: 8px;">Powered by AI</span>
                            </h4>
                            <div id="aiAnalysisContent" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                                <p><i class="fas fa-spinner fa-spin"></i> Analyzing social media presence...</p>
                            </div>
                        </div>
                        
                        <!-- Social Media Search Tabs -->
                        <div class="search-tabs" style="display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #e5e7eb;">
                            <button class="tab-button active" onclick="switchSocialMediaTab('api-results')" style="flex: 1; min-width: 120px; padding: 12px 16px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-server"></i> API Results
                            </button>
                            <button class="tab-button" onclick="switchSocialMediaTab('categorized')" style="flex: 1; min-width: 120px; padding: 12px 16px; border: none; background: #f3f4f6; color: #6b7280; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-layer-group"></i> Categorized
                            </button>
                            <button class="tab-button" onclick="switchSocialMediaTab('social-links')" style="flex: 1; min-width: 120px; padding: 12px 16px; border: none; background: #f3f4f6; color: #6b7280; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-users"></i> Social Links
                            </button>
                        </div>
                        
                        <!-- Tab Contents -->
                        <div class="tab-content">
                            <!-- API Results Tab -->
                            <div id="tab-api-results" class="tab-pane active">
                                <div id="socialMediaWebResults">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <p>Klik tombol pencarian untuk melihat hasil dari API</p>
                                </div>
                                </div>
                                    </div>
                            
                            <!-- Categorized Tab -->
                            <div id="tab-categorized" class="tab-pane" style="display: none;">
                                <div id="categorizedResults">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        <i class="fas fa-layer-group" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <p>Hasil akan dikategorikan otomatis</p>
                                </div>
                            </div>
                        </div>
                        
                            <!-- Social Links Tab -->
                            <div id="tab-social-links" class="tab-pane" style="display: none;">
                                <div id="socialMediaLinks">
                                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <p>Link social media akan muncul di sini (150+ platforms)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dummy elements for backward compatibility -->
                <div id="universalSearchStatus" style="display:none;"></div>
                <div id="universalResults" style="display:none;"></div>
            `;

            modalBody.innerHTML = html;
            
            // Trigger INTEGRATED SEARCH after modal is displayed
            setTimeout(() => {
                performSocialMediaSearch(person.full_name);
            }, 500);
        }

        function closePersonDetails() {
            const modal = document.getElementById('personDetailsModal');
            modal.style.display = 'none';
        }

        // ============================================================================
        // INTEGRATED SEARCH SYSTEM: Universal + Social Media + Multi-Query (80-100 results)
        // ============================================================================

        // Social Media Search - Main Function (INTEGRATED)
        async function performSocialMediaSearch(name) {
            if (!name || name === 'N/A') {
                updateSocialMediaSearchStatus('error', 'Nama tidak tersedia untuk pencarian social media');
                return;
            }

            const statusElement = document.getElementById('socialMediaSearchStatus');
            const webResultsElement = document.getElementById('socialMediaWebResults');
            const socialLinksElement = document.getElementById('socialMediaLinks');

            // Update status - mencari data
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-spinner fa-spin" style="color: #3b82f6;"></i> Mencari data...';
            }

            // Show loading message
            if (webResultsElement) {
                webResultsElement.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 15px; color: #3b82f6;"></i>
                        <h3 style="color: #1f2937; margin-bottom: 10px;">Mencari Data...</h3>
                        <p style="font-size: 0.9rem;">
                            Sedang mencari data dari Universal Search + Social Media Search<br>
                            (150+ platforms detection)
                        </p>
                    </div>
                `;
            }

            // INTEGRATED SEARCH: Universal Search + Social Media Search + ADVANCED QUERIES
            try {
                console.log('=== ADVANCED INTEGRATED SEARCH: Universal + Social Media + Multi-Query ===');
                
                // 1. Call Universal Search first (internal server)
                const universalResults = await performUniversalSearch(name);
                console.log(' Universal Search Results:', universalResults?.length || 0, 'items');

                // 2. ENHANCED QUERIES: Focus on profiles with images (more accurate!)
                const socialMediaQueries = [
                    // Core searches with image focus
                    { query: `"${name}" profile photo`, type: 'profile_photo' },
                    { query: `"${name}" profile picture`, type: 'profile_picture' },
                    { query: `"${name}"`, type: 'exact_phrase' },
                    { query: name, type: 'general' },
                    { query: `${name} profile`, type: 'profile' },
                    
                    // Major Social Media Platforms with image focus
                    { query: `"${name}" (site:facebook.com OR site:instagram.com OR site:twitter.com OR site:x.com) profile`, type: 'social_tier1_profile' },
                    { query: `"${name}" (site:facebook.com OR site:instagram.com OR site:twitter.com OR site:x.com)`, type: 'social_tier1' },
                    { query: `"${name}" (site:linkedin.com OR site:tiktok.com OR site:youtube.com) profile`, type: 'social_tier2_profile' },
                    { query: `"${name}" (site:linkedin.com OR site:tiktok.com OR site:youtube.com)`, type: 'social_tier2' },
                    { query: `"${name}" (site:pinterest.com OR site:reddit.com OR site:tumblr.com)`, type: 'social_tier3' },
                    
                    // Professional & Creative with images
                    { query: `"${name}" (site:github.com OR site:behance.net OR site:dribbble.com)`, type: 'professional' },
                    
                    // Regional/Indonesian
                    { query: `"${name}" (site:weibo.com OR site:vk.com OR site:kaskus.co.id)`, type: 'regional' },
                    
                    // Content/Media
                    { query: `"${name}" (site:medium.com OR site:quora.com OR site:stackoverflow.com)`, type: 'content' },
                    
                    // Streaming/Video
                    { query: `"${name}" (site:twitch.tv OR site:discord.com OR site:vimeo.com)`, type: 'streaming' },
                    
                    // Catch-all keywords with image focus
                    { query: `${name} social media profile photo`, type: 'social_keyword_photo' },
                    { query: `${name} social media profile`, type: 'social_keyword' },
                    { query: `${name} online presence`, type: 'online_presence' }
                ];

                const allSocialResults = [];
                let totalResultsFetched = 0;

                // SMART SEARCH MODE: Try API first, fallback to Universal Search if quota exhausted
                console.log(' SMART SEARCH MODE: Trying API first, using Universal Search as fallback');
                console.log(' Will combine all sources: Universal + Google CSE + Social Searcher Style');
                
                let apiQuotaExhausted = false; // Try API first
                
                const queryPromises = socialMediaQueries.map(async (queryObj, index) => {
                    // Skip if quota already exhausted
                    if (apiQuotaExhausted) {
                        console.log(` Query ${index + 1} skipped (quota exhausted)`);
                        return [];
                    }
                    
                    try {
                        const startTime = Date.now();
                        console.log(` [Google CSE API] Query ${index + 1}/${socialMediaQueries.length}: "${queryObj.query}"`);
                        
                        const response = await fetch('/api/social-media-search', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ name: queryObj.query, type: 'web' })
                        });

                        const result = await response.json();
                        const elapsed = Date.now() - startTime;
                        
                        // DEBUG: Log full response for debugging
                        console.log(` [Google CSE API] Query ${index + 1} Response:`, {
                            status: response.status,
                            ok: response.ok,
                            success: result.success,
                            hasData: !!result.data,
                            webLength: result.data?.web?.length || 0,
                            error: result.error,
                            message: result.message
                        });
                        
                        // DEBUG: Log response status
                        if (!response.ok) {
                            console.error(` [Google CSE API] Query ${index + 1} HTTP Error: ${response.status}`, result);
                            console.error(`   Error details:`, result.error || result.message || 'Unknown error');
                            console.error(`   Full response:`, JSON.stringify(result, null, 2));
                            
                            // Detect quota exceeded (429)
                            if (response.status === 429 || result.error?.includes('quota') || result.error?.includes('Quota') || result.error_code === 429) {
                                apiQuotaExhausted = true;
                                console.warn(' [Google CSE API] QUOTA EXCEEDED! Will continue with other sources...');
                                updateSocialMediaSearchStatus('warning', ' Google CSE API quota exceeded - Using other sources');
                                return [];
                            }
                            
                            // Detect invalid API key (400, 403)
                            if (response.status === 400 || response.status === 403) {
                                console.error(` [Google CSE API] API Key Error (${response.status}): ${result.error || result.message}`);
                                updateSocialMediaSearchStatus('error', ` Google CSE API Error: ${result.error || result.message || 'Invalid API key or access denied'}`);
                                // Don't stop completely, but log the error
                            }
                            
                            // Don't return empty on other errors - continue trying
                            console.warn(` [Google CSE API] Query ${index + 1} failed but continuing...`);
                            return [];
                        }
                        
                        if (!result.success) {
                            console.warn(` [Google CSE API] Query ${index + 1} API Error:`, result.error || result.message);
                            
                            // Also check error message for quota
                            if (result.error?.includes('quota') || result.error?.includes('Quota') || result.error?.includes('429')) {
                                apiQuotaExhausted = true;
                                console.warn(' [Google CSE API] QUOTA EXCEEDED (from error message)! Will continue with other sources...');
                                return [];
                            }
                            // Continue even if this query fails
                            return [];
                        }
                        
                        // Check if we have results - be more lenient with success check
                        const hasResults = result.data && result.data.web && Array.isArray(result.data.web) && result.data.web.length > 0;
                        
                        if (hasResults) {
                            const resultCount = result.data.web.length;
                            totalResultsFetched += resultCount;
                            console.log(` [Google CSE API] Query ${index + 1}/${socialMediaQueries.length} (${queryObj.type}): ${resultCount} results in ${elapsed}ms | Total so far: ${totalResultsFetched}`);
                            
                            // Update status with progress
                            updateSocialMediaSearchStatus('searching', 
                                ` Query ${index + 1}/${socialMediaQueries.length} - Found ${totalResultsFetched} results...`);
                            
                            // Map results with source and ensure all properties are preserved
                            const mappedResults = result.data.web.map((item, itemIdx) => {
                                const mapped = {
                                    ...item,
                                    source: 'Google CSE',  // CRITICAL: Set source for filtering
                                    queryType: queryObj.type
                                };
                                // Ensure link exists
                                if (!mapped.link && mapped.formattedUrl) {
                                    mapped.link = mapped.formattedUrl;
                                }
                                // Ensure title exists
                                if (!mapped.title && mapped.htmlTitle) {
                                    mapped.title = mapped.htmlTitle.replace(/<[^>]*>/g, ''); // Strip HTML tags
                                }
                                
                                // DEBUG: Log first result structure
                                if (itemIdx === 0) {
                                    console.log(` [Google CSE API] First result structure from query ${index + 1}:`, {
                                        hasTitle: !!mapped.title,
                                        hasLink: !!mapped.link,
                                        hasSnippet: !!mapped.snippet,
                                        source: mapped.source,
                                        keys: Object.keys(mapped)
                                    });
                                }
                                
                                return mapped;
                            });
                            
                            console.log(` [Google CSE API] Sample results from query ${index + 1}:`, mappedResults.slice(0, 2).map(r => ({
                                title: r.title?.substring(0, 50),
                                link: r.link?.substring(0, 50),
                                source: r.source
                            })));
                            
                            return mappedResults;
                        } else {
                            // More detailed logging for empty results
                            console.log(` [Google CSE API] Query ${index + 1} returned no results (${elapsed}ms)`);
                            console.log(`   Response details:`, {
                                success: result.success,
                                hasData: !!result.data,
                                hasWeb: !!result.data?.web,
                                webIsArray: Array.isArray(result.data?.web),
                                webLength: result.data?.web?.length || 0,
                                error: result.error,
                                message: result.message,
                                error_code: result.error_code
                            });
                            
                            // If success is false but no error, log it
                            if (result.success === false && !result.error) {
                                console.warn(`    API returned success=false but no error message`);
                            }
                            
                            return [];
                        }
                    } catch (error) {
                        console.error(` [Google CSE API] Query ${index + 1} (${queryObj.type}) FAILED:`, error);
                        console.error(`   Error message: ${error.message}`);
                        console.error(`   Error stack: ${error.stack}`);
                        // Don't update status for every error - too noisy
                        // updateSocialMediaSearchStatus('error', ` Query ${index + 1} failed: ${error.message}`);
                        return [];
                    }
                });

                // Wait for all queries
                const queryResults = await Promise.all(queryPromises);

                // SMART MERGE: Normalize URLs and deduplicate intelligently
                const normalizeUrl = (url) => {
                    if (!url) return '';
                    try {
                        // Remove protocol, www, trailing slash, and normalize
                        let normalized = url.toLowerCase()
                            .replace(/^https?:\/\//, '')
                            .replace(/^www\./, '')
                            .replace(/\/$/, '')
                            .split('#')[0]  // Remove fragment
                            .split('?')[0]; // Remove query params for comparison
                        return normalized;
                    } catch (e) {
                        return url.toLowerCase();
                    }
                };
                
                const isDuplicate = (result1, result2) => {
                    // Normalize URLs for comparison
                    const url1 = normalizeUrl(result1.link);
                    const url2 = normalizeUrl(result2.link);
                    
                    // Exact URL match
                    if (url1 === url2 && url1 !== '') return true;
                    
                    // Same title and similar URL (same domain + path)
                    if (result1.title && result2.title && 
                        result1.title.toLowerCase().trim() === result2.title.toLowerCase().trim()) {
                        const domain1 = url1.split('/')[0];
                        const domain2 = url2.split('/')[0];
                        const path1 = url1.split('/').slice(1).join('/');
                        const path2 = url2.split('/').slice(1).join('/');
                        
                        // Same domain and similar path (allow minor differences)
                        if (domain1 === domain2 && path1 && path2) {
                            const pathDiff = Math.abs(path1.length - path2.length);
                            if (pathDiff < 10) { // Allow small path differences
                                return true;
                            }
                        }
                    }
                    
                    return false;
                };
                
                // Merge and deduplicate results intelligently
                let totalBeforeDedup = 0;
                queryResults.forEach((results, queryIndex) => {
                    totalBeforeDedup += results.length;
                    results.forEach(result => {
                        // Ensure source is set
                        if (!result.source) {
                            result.source = 'Google CSE';
                            console.warn(` Result from query ${queryIndex + 1} missing source, setting to 'Google CSE'`);
                        }
                        // Check if not duplicate using smart comparison
                        if (!allSocialResults.some(r => isDuplicate(r, result))) {
                            allSocialResults.push(result);
                        }
                    });
                });

                console.log(` [Google CSE API] Total results before deduplication: ${totalBeforeDedup}`);
                console.log(` [Google CSE API] Total unique Social Media results after deduplication: ${allSocialResults.length}`);
                
                // Log sample results
                if (allSocialResults.length > 0) {
                    console.log(` [Google CSE API] Sample results in allSocialResults:`, allSocialResults.slice(0, 3).map(r => ({
                        title: r.title?.substring(0, 50),
                        link: r.link?.substring(0, 50),
                        source: r.source
                    })));
                } else {
                    console.warn(' [Google CSE API] WARNING: allSocialResults is EMPTY!');
                    console.warn('   This means no Google CSE results were added.');
                    console.warn('   Possible causes:');
                    console.warn('   1. All queries returned empty results');
                    console.warn('   2. All results were filtered as duplicates');
                    console.warn('   3. API errors prevented results from being returned');
                }
                
                // Update status with widget-only mode message
                if (apiQuotaExhausted && allSocialResults.length === 0) {
                    updateSocialMediaSearchStatus('success', ' Results available in categorized tabs');
                    console.log(' TIP: Results are available in categorized tabs');
                }

                // 4. SOCIAL SEARCHER STYLE: Platform-specific searches (seperti social-searcher.com)
                console.log('');
                console.log(' Starting Social Searcher Style search (platform-specific)...');
                console.log(' This will search 6 platforms: Facebook, Instagram, Twitter, LinkedIn, TikTok, Pinterest');
                console.log('  Estimated time: ~8-15 seconds (with delays to avoid blocking)');
                updateSocialMediaSearchStatus('searching', ' Social Searcher Style: Searching 6 platforms (Facebook, Instagram, Twitter, LinkedIn, TikTok, Pinterest)...');
                
                let socialSearcherResults = [];
                try {
                    console.log(' Calling /api/social-searcher-style with name:', name);
                    const startTime = Date.now();
                    
                    const socialSearcherResponse = await fetch('/api/social-searcher-style', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: name })
                    });
                    
                    const elapsed = Date.now() - startTime;
                    console.log(` Social Searcher Style response received in ${elapsed}ms`);
                    console.log(' Response status:', socialSearcherResponse.status);
                    
                    let socialSearcherData;
                    if (!socialSearcherResponse.ok) {
                        console.error(' Social Searcher Style HTTP error:', socialSearcherResponse.status);
                        try {
                            const errorText = await socialSearcherResponse.text();
                            console.error(' Error response:', errorText);
                            socialSearcherData = JSON.parse(errorText);
                        } catch (e) {
                            console.error(' Failed to parse error response');
                            socialSearcherData = { success: false, error: `HTTP ${socialSearcherResponse.status}` };
                        }
                    } else {
                        socialSearcherData = await socialSearcherResponse.json();
                    }
                    
                    console.log(' Social Searcher Style response data:', socialSearcherData);
                    
                    if (socialSearcherData.success && socialSearcherData.data && socialSearcherData.data.web) {
                        socialSearcherResults = socialSearcherData.data.web.map(item => {
                            // CRITICAL: Ensure source is set!
                            const result = {
                                ...item,
                                source: 'Social Searcher Style'  // MUST SET SOURCE!
                            };
                            // Ensure platform is preserved
                            if (item.platform) {
                                result.platform = item.platform;
                            }
                            return result;
                        });
                        console.log(` Social Searcher Style: Found ${socialSearcherResults.length} results from ${Object.keys(socialSearcherData.data.by_platform || {}).length} platforms`);
                        
                        // Log per platform
                        if (socialSearcherData.data.by_platform) {
                            Object.entries(socialSearcherData.data.by_platform).forEach(([platform, results]) => {
                                if (results && results.length > 0) {
                                    console.log(`    ${platform}: ${results.length} results`);
                                } else {
                                    console.log(`    ${platform}: No results`);
                                }
                            });
                        }
                        
                        // Log sample results untuk debug
                        if (socialSearcherResults.length > 0) {
                            console.log(' Sample Social Searcher results:');
                            socialSearcherResults.slice(0, 3).forEach((r, i) => {
                                console.log(`   ${i+1}. [${r.platform || 'unknown'}] ${r.title} - source: ${r.source}`);
                            });
                        }
                    } else {
                        console.warn(' Social Searcher Style: No results or error');
                        console.warn(' Response:', socialSearcherData);
                        if (socialSearcherData.error) {
                            console.error(' Error message:', socialSearcherData.error);
                        }
                    }
                } catch (error) {
                    console.error(' Social Searcher Style error:', error);
                    console.error(' Error stack:', error.stack);
                }
                
                console.log(` Social Searcher Results count: ${socialSearcherResults.length}`);
                console.log('');

                // 3. SMART MERGE: Combine ALL sources with intelligent deduplication
                let combinedResults = [];
                
                // Reuse normalizeUrl and isDuplicate functions from above
                const normalizeUrlForMerge = (url) => {
                    if (!url) return '';
                    try {
                        let normalized = url.toLowerCase()
                            .replace(/^https?:\/\//, '')
                            .replace(/^www\./, '')
                            .replace(/\/$/, '')
                            .split('#')[0]
                            .split('?')[0];
                        return normalized;
                    } catch (e) {
                        return url.toLowerCase();
                    }
                };
                
                const isDuplicateForMerge = (result1, result2) => {
                    const url1 = normalizeUrlForMerge(result1.link);
                    const url2 = normalizeUrlForMerge(result2.link);
                    
                    // Exact URL match
                    if (url1 === url2 && url1 !== '') return true;
                    
                    // Same title and same domain (more lenient for internal data)
                    if (result1.title && result2.title && 
                        result1.title.toLowerCase().trim() === result2.title.toLowerCase().trim()) {
                        const domain1 = url1.split('/')[0];
                        const domain2 = url2.split('/')[0];
                        if (domain1 === domain2 && domain1 !== '') {
                            return true;
                        }
                    }
                    
                    return false;
                };
                
                const addResultSmart = (result, source, priority = 0) => {
                    // Ensure source is set
                    if (!result.source) {
                        result.source = source;
                    }
                    
                    // Check if duplicate
                    const existingIndex = combinedResults.findIndex(r => isDuplicateForMerge(r, result));
                    if (existingIndex === -1) {
                        // Not duplicate, add it
                        result.mergePriority = priority;
                        combinedResults.push(result);
                        return { added: true, duplicate: false };
                    } else {
                        // Duplicate found - keep the one with higher priority or better source
                        const existing = combinedResults[existingIndex];
                        const existingPriority = existing.mergePriority || 0;
                        
                        // Priority: Universal Search (3) > Social Searcher Style (2) > Google CSE (1) > Unknown (0)
                        const sourcePriority = {
                            'Universal Search': 3,
                            'Social Searcher Style': 2,
                            'Google CSE': 1,
                            'Unknown': 0
                        };
                        
                        const newPriority = priority || sourcePriority[source] || 0;
                        const existingSourcePriority = sourcePriority[existing.source] || 0;
                        
                        // If new result has higher priority, replace it
                        if (newPriority > existingPriority || 
                            (newPriority === existingPriority && newPriority > existingSourcePriority)) {
                            result.mergePriority = newPriority;
                            combinedResults[existingIndex] = result;
                            return { added: true, duplicate: true, replaced: true };
                        }
                        
                        return { added: false, duplicate: true };
                    }
                };

                // Priority 1: Add Universal Search results first (most reliable internal data - HIGHEST PRIORITY)
                if (universalResults && universalResults.length > 0) {
                    let added = 0;
                    let skipped = 0;
                    universalResults.forEach(result => {
                        const status = addResultSmart(result, 'Universal Search', 3);
                        if (status.added && !status.duplicate) {
                            added++;
                        } else if (status.duplicate) {
                            skipped++;
                        }
                    });
                    console.log(` Added ${added}/${universalResults.length} unique results from Universal Search (INTERNAL - highest priority)`);
                    if (skipped > 0) {
                        console.log(`   (${skipped} duplicates skipped)`);
                    }
                } else {
                    console.warn(' No Universal Search results found!');
                }

                // Priority 2: Add Social Searcher Style results (platform-specific, high quality)
                if (socialSearcherResults.length > 0) {
                    let added = 0;
                    let skipped = 0;
                    let replaced = 0;
                    socialSearcherResults.forEach(result => {
                        const status = addResultSmart(result, 'Social Searcher Style', 2);
                        if (status.added && !status.duplicate) {
                            added++;
                        } else if (status.duplicate) {
                            skipped++;
                            if (status.replaced) {
                                replaced++;
                            }
                        }
                    });
                    console.log(` Added ${added} unique results from Social Searcher Style (${skipped} duplicates, ${replaced} replaced)`);
                    if (added > 0) {
                        const sample = combinedResults.filter(r => r.source === 'Social Searcher Style').slice(0, 3);
                        console.log(` Sample Social Searcher results:`, sample.map(r => `[${r.platform || 'unknown'}] ${r.title}`));
                    }
                } else {
                    console.warn(' No Social Searcher Style results found!');
                }

                // Priority 3: Add ALL Social Media Search results from multiple queries (Google CSE API)
                if (allSocialResults.length > 0) {
                    let added = 0;
                    let skipped = 0;
                    let replaced = 0;
                    
                    console.log(` [Google CSE API] Starting to add ${allSocialResults.length} results to combinedResults...`);
                    console.log(` [Google CSE API] Current combinedResults length BEFORE: ${combinedResults.length}`);
                    
                    // Log sample of allSocialResults before merging
                    console.log(` [Google CSE API] Sample allSocialResults (first 3):`, allSocialResults.slice(0, 3).map((r, i) => ({
                        index: i,
                        title: r.title?.substring(0, 50),
                        link: r.link?.substring(0, 50),
                        source: r.source,
                        hasLink: !!r.link,
                        hasTitle: !!r.title
                    })));
                    
                    allSocialResults.forEach((result, idx) => {
                        // Ensure source is set
                        if (!result.source) {
                            result.source = 'Google CSE';
                            console.warn(` Result ${idx + 1} missing source, setting to 'Google CSE'`);
                        }
                        
                        // DEBUG: Log before adding
                        if (idx < 3) {
                            console.log(` [Google CSE API] Adding result ${idx + 1}:`, {
                                title: result.title?.substring(0, 50),
                                link: result.link?.substring(0, 50),
                                source: result.source,
                                normalizedLink: normalizeUrlForMerge(result.link)
                            });
                        }
                        
                        const status = addResultSmart(result, result.source || 'Google CSE', 1);
                        if (status.added && !status.duplicate) {
                            added++;
                            if (idx < 3) {
                                console.log(`    Result ${idx + 1} ADDED (new)`);
                            }
                        } else if (status.duplicate) {
                            skipped++;
                            if (status.replaced) {
                                replaced++;
                                if (idx < 3) {
                                    console.log(`    Result ${idx + 1} REPLACED (duplicate with higher priority)`);
                                }
                            } else {
                                if (idx < 3) {
                                    console.log(`    Result ${idx + 1} SKIPPED (duplicate, existing has higher priority)`);
                                }
                            }
                        }
                    });
                    
                    console.log(` [Google CSE API] Added ${added} unique results to combinedResults (${skipped} duplicates skipped, ${replaced} replaced)`);
                    console.log(` [Google CSE API] Current combinedResults length AFTER: ${combinedResults.length}`);
                    
                    // Verify results were added
                    const googleResultsInCombined = combinedResults.filter(r => r.source === 'Google CSE');
                    console.log(` [Google CSE API] Verification: ${googleResultsInCombined.length} Google CSE results in combinedResults`);
                    
                    // Log sample of Google CSE results in combinedResults
                    if (googleResultsInCombined.length > 0) {
                        console.log(` [Google CSE API] Sample Google CSE results in combinedResults (first 3):`, googleResultsInCombined.slice(0, 3).map((r, i) => ({
                            index: i,
                            title: r.title?.substring(0, 50),
                            link: r.link?.substring(0, 50),
                            source: r.source
                        })));
                    }
                    
                    if (googleResultsInCombined.length === 0 && allSocialResults.length > 0) {
                        console.error(' [Google CSE API] ERROR: Results were not added to combinedResults!');
                        console.error('   allSocialResults.length:', allSocialResults.length);
                        console.error('   combinedResults.length:', combinedResults.length);
                        console.error('   Sample allSocialResults:', allSocialResults.slice(0, 2));
                        console.error('   Sample combinedResults:', combinedResults.slice(0, 2));
                        
                        // Check if all were duplicates
                        console.error('    Checking why results were not added...');
                        allSocialResults.slice(0, 3).forEach((result, idx) => {
                            const normalizedLink = normalizeUrlForMerge(result.link);
                            const isDuplicate = combinedResults.some(r => isDuplicateForMerge(r, result));
                            console.error(`   Result ${idx + 1}: link="${normalizedLink}", isDuplicate=${isDuplicate}`);
                        });
                    }
                } else {
                    console.warn(' [Google CSE API] No Social Media Search results from queries!');
                    console.warn('   This means Google CSE API did not return any results.');
                    console.warn('   Possible causes:');
                    console.warn('   1. API quota exhausted');
                    console.warn('   2. API key invalid');
                    console.warn('   3. Network error');
                    console.warn('   4. All queries returned empty');
                    console.warn('   5. Server not restarted with new API key');
                }

                console.log('=== TOTAL COMBINED RESULTS:', combinedResults.length, '===');
                
                // DEBUG: Show source breakdown
                // Ensure all results have source property
                combinedResults.forEach(r => {
                    if (!r.source) {
                        r.source = 'Unknown';
                        console.warn(' Result without source:', r.title || r.link);
                    }
                });
                
                const universalCount = combinedResults.filter(r => r.source === 'Universal Search').length;
                const googleCount = combinedResults.filter(r => r.source === 'Google CSE').length;
                const socialSearcherCount = combinedResults.filter(r => r.source === 'Social Searcher Style').length;
                const unknownCount = combinedResults.filter(r => !r.source || r.source === 'Unknown').length;
                
                console.log('');
                console.log(' SOURCE BREAKDOWN:');
                console.log(`    Universal Search (INTERNAL): ${universalCount}`);
                console.log(`    Google CSE (GOOGLE): ${googleCount}`);
                console.log(`    Social Searcher Style (PLATFORM-SPECIFIC): ${socialSearcherCount}`);
                console.log(`    Unknown/No Source: ${unknownCount}`);
                console.log('');
                
                // Log sample results per source
                if (socialSearcherCount > 0) {
                    const sampleSocialSearcher = combinedResults.filter(r => r.source === 'Social Searcher Style').slice(0, 3);
                    console.log(' Sample Social Searcher Style results:');
                    sampleSocialSearcher.forEach((r, i) => {
                        console.log(`   ${i+1}. [${r.platform || 'unknown'}] ${r.title} - source: ${r.source}`);
                    });
                } else {
                    console.warn(' WARNING: No Social Searcher Style results found in combined results!');
                    console.warn('   This might indicate:');
                    console.warn('   1. API endpoint not called or failed');
                    console.warn('   2. Results not merged correctly');
                    console.warn('   3. Source property not set correctly');
                }
                
                if (googleCount === 0 && allSocialResults.length === 0) {
                    if (apiQuotaExhausted) {
                        console.log('');
                        console.log(' WIDGET-ONLY MODE ACTIVATED! (UNLIMITED!)');
                        console.log('');
                        console.log(' Internal results: Categorized & ready');
                        console.log('  Google CSE Widget: UNLIMITED searches (no quota!)');
                        // Tab switching removed - tabs "Web" and "Gambar" have been deleted
                        console.log(' Results from both sources available!');
                        console.log('');
                        updateSocialMediaSearchStatus('success', ' Results available in categorized tabs');
                    } else {
                        console.error(' WARNING: NO GOOGLE CSE RESULTS! All results are from INTERNAL only!');
                        console.error('Possible issues:');
                        console.error('  1. API Key invalid or quota exhausted');
                        console.error('  2. Network error or timeout');
                        console.error('  3. Backend API /api/social-media-search not responding');
                        updateSocialMediaSearchStatus('warning', ' Hanya data internal tersedia (Google CSE error)');
                    }
                }

                // Check if we have any results
                if (combinedResults.length > 0) {
                    console.log(' INTEGRATED SEARCH SUCCESS! Displaying combined results');
                    
                    // Display combined web results
                    displaySocialMediaWebResults(combinedResults, name);

                    // EXTRACT ALL SOCIAL MEDIA LINKS from combined results (150+ platforms detection)
                    const allSocialMediaLinks = extractSocialMediaLinks(combinedResults);
                    console.log(' Extracted', allSocialMediaLinks.length, 'social media links from combined results');

                    // Display ALL social media links
                    displaySocialMediaLinks(allSocialMediaLinks);

                    // Categorize and display ALL categorized results
                    const categorized = categorizeResults(combinedResults);
                    displayCategorizedResults(categorized);
                    
                    // Perform AI Analysis with ALL social media links
                    await performAIAnalysis(name, allSocialMediaLinks);

                    // Count by source
                    const universalCount = universalResults?.length || 0;
                    const socialCount = allSocialResults.length || 0;
                    updateSocialMediaSearchStatus('success',
                        ` Total: ${combinedResults.length} hasil (Universal: ${universalCount} + Social: ${socialCount}) | Social Media: ${allSocialMediaLinks.length} platforms`);

                    // Auto-switch to Categorized tab to show results immediately
                    setTimeout(() => {
                        switchSocialMediaTab('categorized');
                        console.log('Auto-switched to Categorized tab to display combined results');
                    }, 1500);
                    } else {
                    // No results
                    updateSocialMediaSearchStatus('warning', 'Tidak ada hasil ditemukan');
                        if (webResultsElement) {
                        webResultsElement.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p>Tidak ada hasil ditemukan untuk "${name}"</p>
                            </div>
                        `;
                    }
                }

            } catch (error) {
                // ERROR HANDLING: Still try to display Universal Search results even if API fails
                console.error(' Error in performSocialMediaSearch:', error);
                console.error('Error details:', error.message, error.stack);
                
                // Try to display Universal Search results if available (FALLBACK)
                try {
                    console.log(' Attempting fallback: Universal Search only...');
                    const universalResults = await performUniversalSearch(name);
                    
                    if (universalResults && universalResults.length > 0) {
                        console.log(` Fallback SUCCESS: Displaying ${universalResults.length} results from Universal Search (Internal)`);
                        
                        // Display Universal Search results
                        displaySocialMediaWebResults(universalResults, name);
                        
                        // Extract and display social media links
                        const allSocialMediaLinks = extractSocialMediaLinks(universalResults);
                        displaySocialMediaLinks(allSocialMediaLinks);
                        
                        // Categorize and display
                        const categorized = categorizeResults(universalResults);
                        displayCategorizedResults(categorized);
                        
                        // AI Analysis
                        await performAIAnalysis(name, allSocialMediaLinks);
                        
                        updateSocialMediaSearchStatus('warning', 
                            ` API Error - Menampilkan ${universalResults.length} hasil dari Universal Search (Internal) saja`);
                        
                        // Auto-switch to Categorized tab
                        setTimeout(() => {
                            switchSocialMediaTab('categorized');
                        }, 1500);
                        
                        return; // Exit early - we have results from Universal Search
                    } else {
                        console.warn(' Universal Search also returned no results');
                    }
                } catch (universalError) {
                    console.error(' Error in Universal Search fallback:', universalError);
                }
                
                // If we get here, no results available from any source
                console.error(' No results available from any source');
                updateSocialMediaSearchStatus('error', 'Backend API tidak tersedia. Gunakan tab "Categorized" atau "Social Links" untuk hasil pencarian.');
                
                if (webResultsElement) {
                    webResultsElement.innerHTML = `
                        <div style="padding: 30px; text-align: center; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                            <i class="fas fa-info-circle" style="font-size: 3rem; color: #3b82f6; margin-bottom: 15px;"></i>
                            <h3 style="color: #1e40af; margin-bottom: 10px;">Backend API Tidak Tersedia</h3>
                            <p style="color: #1e3a8a; margin-bottom: 15px; font-size: 0.95rem;">
                                Backend API untuk pencarian social media tidak dapat digunakan saat ini.
                            </p>
                            <p style="color: #1e3a8a; margin-bottom: 20px; font-size: 0.9rem;">
                                <strong>Solusi:</strong> Gunakan tab <strong>"Categorized"</strong> atau <strong>"Social Links"</strong> untuk melihat hasil pencarian.
                            </p>
                        </div>
                    `;
                }
            }

            // Google CSE widgets removed - tabs "Web" and "Gambar" have been deleted
            // Results are now displayed via Universal Search + Google CSE API + Social Searcher Style
            console.log(' Search completed - Results displayed in tabs: API Results, Categorized, Social Links');
        }

        // Update Social Media Search Status
        function updateSocialMediaSearchStatus(type, message) {
            const statusElement = document.getElementById('socialMediaSearchStatus');
            if (!statusElement) return;

            let icon = '';
            let color = 'white';
            
            switch(type) {
                case 'searching':
                    icon = '<i class="fas fa-spinner fa-spin"></i>';
                    break;
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-lightbulb"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
            }
            
            statusElement.innerHTML = `${icon} <span>${message}</span>`;
        }

        // Universal Search Function (RETURNS formatted results for integration)
        async function performUniversalSearch(name) {
            if (!name || name === 'N/A') {
                updateUniversalSearchStatus('error', 'Nama tidak tersedia untuk pencarian universal');
                return null;
            }

            const statusElement = document.getElementById('universalSearchStatus');
            const resultsElement = document.getElementById('universalResults');

            try {
                updateUniversalSearchStatus('searching', 'Mencari data universal...');

                const response = await fetch('/api/universal-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: name })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Gagal melakukan pencarian universal');
                }

                const result = await response.json();
                
                if (result.success && result.data && result.data.organic_results) {
                    updateUniversalSearchStatus('success', ` Universal: ${result.data.organic_results.length} hasil`);
                    // RETURN formatted results for integration
                    return result.data.organic_results.map(item => ({
                        title: item.title || 'No Title',
                        link: item.link || '#',
                        snippet: item.snippet || '',
                        source: 'Universal Search',
                        pagemap: item.pagemap || null
                    }));
                } else {
                    updateUniversalSearchStatus('warning', result.message || 'Server internal tidak tersedia');
                    return [];
                }

            } catch (error) {
                console.error('Universal search error:', error);
                updateUniversalSearchStatus('error', 'Universal search tidak tersedia');
                return [];
            }
        }

        function updateUniversalSearchStatus(type, message) {
            const statusElement = document.getElementById('universalSearchStatus');
            if (!statusElement) return;

            statusElement.className = `search-status ${type}`;
            
            let icon = '';
            switch(type) {
                case 'searching':
                    icon = '<i class="fas fa-spinner fa-spin"></i>';
                    break;
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
            }
            
            statusElement.innerHTML = `${icon} ${message}`;
        }

        // Helper: Get relevance score for sorting (higher = more relevant)
        function getRelevanceScore(item, searchName) {
            if (!searchName) return 0;
            
            let score = 0;
            const title = (item.title || '').toLowerCase();
            const snippet = (item.snippet || '').toLowerCase();
            const link = (item.link || '').toLowerCase();
            const searchLower = searchName.toLowerCase();
            
            // Exact match in title (highest priority)
            if (title.includes(searchLower)) score += 3;
            
            // Match in snippet
            if (snippet.includes(searchLower)) score += 2;
            
            // Profile/user indicators in URL
            if (link.includes('/profile/') || link.includes('/user/') || link.includes('/@')) score += 1;
            
            return score;
        }

        // Helper: Get platform icon (150+ platforms support)
        function getPlatformIcon(url) {
            const urlLower = url.toLowerCase();
            
            // Tier 1: Major Platforms
            if (urlLower.includes('facebook.com') || urlLower.includes('fb.com')) return 'fab fa-facebook';
            if (urlLower.includes('instagram.com')) return 'fab fa-instagram';
            if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) return 'fab fa-twitter';
            if (urlLower.includes('linkedin.com')) return 'fab fa-linkedin';
            if (urlLower.includes('tiktok.com')) return 'fab fa-tiktok';
            if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) return 'fab fa-youtube';
            if (urlLower.includes('pinterest.com')) return 'fab fa-pinterest';
            if (urlLower.includes('snapchat.com')) return 'fab fa-snapchat';
            if (urlLower.includes('whatsapp.com')) return 'fab fa-whatsapp';
            if (urlLower.includes('telegram.org') || urlLower.includes('t.me')) return 'fab fa-telegram';
            if (urlLower.includes('reddit.com')) return 'fab fa-reddit';
            if (urlLower.includes('tumblr.com')) return 'fab fa-tumblr';
            if (urlLower.includes('discord.com')) return 'fab fa-discord';
            if (urlLower.includes('twitch.tv')) return 'fab fa-twitch';
            if (urlLower.includes('medium.com')) return 'fab fa-medium';
            if (urlLower.includes('quora.com')) return 'fab fa-quora';
            if (urlLower.includes('flickr.com')) return 'fab fa-flickr';
            if (urlLower.includes('vimeo.com')) return 'fab fa-vimeo';
            if (urlLower.includes('spotify.com')) return 'fab fa-spotify';
            
            // Tier 2: Professional & Creative
            if (urlLower.includes('github.com')) return 'fab fa-github';
            if (urlLower.includes('gitlab.com')) return 'fab fa-gitlab';
            if (urlLower.includes('behance.net')) return 'fab fa-behance';
            if (urlLower.includes('dribbble.com')) return 'fab fa-dribbble';
            if (urlLower.includes('stackoverflow.com')) return 'fab fa-stack-overflow';
            if (urlLower.includes('deviantart.com')) return 'fab fa-deviantart';
            
            // Tier 3: Regional
            if (urlLower.includes('weibo.com')) return 'fab fa-weibo';
            if (urlLower.includes('vk.com')) return 'fab fa-vk';
            if (urlLower.includes('line.me')) return 'fab fa-line';
            
            // Default
            return 'fas fa-user-circle';
        }

        // Helper: Get platform name (150+ platforms support)
        function getPlatformName(url) {
            const urlLower = url.toLowerCase();
            
            // Major platforms
            if (urlLower.includes('facebook.com') || urlLower.includes('fb.com')) return 'Facebook';
            if (urlLower.includes('instagram.com')) return 'Instagram';
            if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) return 'Twitter / X';
            if (urlLower.includes('linkedin.com')) return 'LinkedIn';
            if (urlLower.includes('tiktok.com')) return 'TikTok';
            if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) return 'YouTube';
            if (urlLower.includes('pinterest.com')) return 'Pinterest';
            if (urlLower.includes('snapchat.com')) return 'Snapchat';
            if (urlLower.includes('whatsapp.com')) return 'WhatsApp';
            if (urlLower.includes('telegram.org') || urlLower.includes('t.me')) return 'Telegram';
            if (urlLower.includes('reddit.com')) return 'Reddit';
            if (urlLower.includes('tumblr.com')) return 'Tumblr';
            if (urlLower.includes('discord.com')) return 'Discord';
            if (urlLower.includes('twitch.tv')) return 'Twitch';
            if (urlLower.includes('medium.com')) return 'Medium';
            if (urlLower.includes('quora.com')) return 'Quora';
            if (urlLower.includes('flickr.com')) return 'Flickr';
            if (urlLower.includes('vimeo.com')) return 'Vimeo';
            if (urlLower.includes('spotify.com')) return 'Spotify';
            if (urlLower.includes('github.com')) return 'GitHub';
            if (urlLower.includes('gitlab.com')) return 'GitLab';
            if (urlLower.includes('behance.net')) return 'Behance';
            if (urlLower.includes('dribbble.com')) return 'Dribbble';
            if (urlLower.includes('stackoverflow.com')) return 'Stack Overflow';
            if (urlLower.includes('deviantart.com')) return 'DeviantArt';
            if (urlLower.includes('weibo.com')) return 'Weibo';
            if (urlLower.includes('vk.com')) return 'VK';
            if (urlLower.includes('line.me')) return 'LINE';
            
            return 'Social Media';
        }

        // Helper: Get platform color
        function getPlatformColor(url) {
            const urlLower = url.toLowerCase();
            
            if (urlLower.includes('facebook.com') || urlLower.includes('fb.com')) return '#1877f2';
            if (urlLower.includes('instagram.com')) return '#e4405f';
            if (urlLower.includes('twitter.com') || urlLower.includes('x.com')) return '#1da1f2';
            if (urlLower.includes('linkedin.com')) return '#0a66c2';
            if (urlLower.includes('tiktok.com')) return '#ff0050';
            if (urlLower.includes('youtube.com') || urlLower.includes('youtu.be')) return '#ff0000';
            if (urlLower.includes('pinterest.com')) return '#e60023';
            if (urlLower.includes('snapchat.com')) return '#fffc00';
            if (urlLower.includes('whatsapp.com')) return '#25d366';
            if (urlLower.includes('telegram.org') || urlLower.includes('t.me')) return '#0088cc';
            if (urlLower.includes('reddit.com')) return '#ff4500';
            if (urlLower.includes('tumblr.com')) return '#35465c';
            if (urlLower.includes('discord.com')) return '#5865f2';
            if (urlLower.includes('twitch.tv')) return '#9146ff';
            if (urlLower.includes('medium.com')) return '#00ab6c';
            if (urlLower.includes('github.com')) return '#181717';
            
            return '#667eea';
        }

        // Helper: Extract image from result (ENHANCED - prioritizes profile/post images)
        function extractImage(result, platform) {
            // Priority 1: Best image from backend (already extracted and prioritized)
            if (result.best_image && result.best_image.src) {
                return result.best_image.src;
            }
            
            // Priority 2: All images array (try first one)
            if (result.all_images && result.all_images.length > 0 && result.all_images[0].src) {
                return result.all_images[0].src;
            }
            
            // Priority 3: Direct image property (from image search)
            if (result.image && result.image.src) {
                return result.image.src;
            }
            
            // Priority 4: Pagemap extraction (fallback if backend didn't extract)
            if (result.pagemap) {
                // Try Open Graph image first (best for social media profiles/posts)
                if (result.pagemap['metatags'] && result.pagemap['metatags'][0]) {
                    const meta = result.pagemap['metatags'][0];
                    if (meta['og:image']) return meta['og:image'];
                    if (meta['twitter:image']) return meta['twitter:image'];
                    if (meta['image']) return meta['image'];
                }
                
                // Try CSE Image (Google's extracted image)
                if (result.pagemap['cse_image'] && result.pagemap['cse_image'][0]) {
                    return result.pagemap['cse_image'][0].src;
                }
                
                // Try CSE Thumbnail
                if (result.pagemap['cse_thumbnail'] && result.pagemap['cse_thumbnail'][0]) {
                    return result.pagemap['cse_thumbnail'][0].src;
                }
            }
            
            // Priority 5: Try to extract from URL patterns (for some platforms)
            const link = result.link || '';
            if (link.includes('facebook.com') && link.includes('/photo')) {
                // Facebook photo URLs sometimes have image IDs
                // Could try to construct image URL, but better to rely on pagemap
            }
            
            // Priority 6: Generate platform-specific placeholder (last resort)
            const color = getPlatformColor(result.link);
            const icon = getPlatformIcon(result.link).replace('fab fa-', '').replace('fas fa-', '');
            
            // Return a placeholder SVG with platform color
            return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='${encodeURIComponent(color)}'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='80' fill='white' font-family='Arial'%3E${platform.charAt(0)}%3C/text%3E%3C/svg%3E`;
        }

        // Helper: Check if URL is social media (150+ platforms)
        function isSocialMedia(url) {
            const socialDomains = [
                'facebook.com', 'fb.com', 'instagram.com', 'twitter.com', 'x.com',
                'linkedin.com', 'tiktok.com', 'youtube.com', 'pinterest.com', 'snapchat.com',
                'whatsapp.com', 'telegram.org', 't.me', 'reddit.com', 'tumblr.com',
                'discord.com', 'twitch.tv', 'medium.com', 'quora.com', 'flickr.com',
                'vimeo.com', 'dailymotion.com', 'weibo.com', 'wechat.com', 'qq.com',
                'bilibili.com', 'douban.com', 'line.me', 'kakao.com', 'naver.com',
                'band.us', 'vk.com', 'ok.ru', 'mail.ru', 'kaskus.co.id',
                'sharechat.com', 'moj.app', 'github.com', 'gitlab.com', 'stackoverflow.com',
                'behance.net', 'dribbble.com', 'deviantart.com', 'artstation.com', 
                'angellist.com', 'xing.com', 'signal.org', 'viber.com', 'kik.com',
                'skype.com', 'slack.com', 'teams.microsoft.com', 'zoom.us',
                'kick.com', 'dlive.tv', 'trovo.live', 'caffeine.tv', 'younow.com',
                'periscope.tv', 'myspace.com', 'mewe.com', 'mastodon.social', 
                'bereal.com', 'lemon8-app.com', 'threads.net', 'bsky.app', 'bluesky.social',
                'polywork.com', 'truthsocial.com', 'gettr.com', 'parler.com', 'rumble.com',
                'gab.com', 'minds.com', 'bitchute.com', 'odysee.com', 'tinder.com',
                'bumble.com', 'hinge.co', 'okcupid.com', 'match.com', 'wordpress.com',
                'blogger.com', 'blogspot.com', 'ghost.org', 'substack.com', 'patreon.com',
                'ko-fi.com', 'buymeacoffee.com', 'digg.com', 'mix.com', 'pocket.com',
                'flipboard.com', 'goodreads.com', 'letterboxd.com', 'last.fm', 
                'spotify.com', 'steam.com', 'steamcommunity.com', 'epicgames.com',
                'playstation.com', 'xbox.com', 'roblox.com', '500px.com', 'vsco.co',
                'strava.com', 'myfitnesspal.com', 'untappd.com'
            ];
            
            const urlLower = url.toLowerCase();
            return socialDomains.some(domain => urlLower.includes(domain)) ||
                   urlLower.includes('/profile/') || 
                   urlLower.includes('/user/') || 
                   urlLower.includes('/@');
        }

        function displayUniversalResults(data, searchName) {
            const resultsElement = document.getElementById('universalResults');
            const socialLinksElement = document.getElementById('socialLinks');
            const socialGridElement = document.getElementById('socialGrid');

            if (!resultsElement) return;

            let resultsHTML = '';
            let socialLinksHTML = '';
            const socialLinks = [];

            if (data.organic_results && data.organic_results.length > 0) {
                data.organic_results.forEach((result, index) => {
                    // Extract social media links (150+ platforms)
                    if (result.link && isSocialMedia(result.link)) {
                        socialLinks.push(result);
                    }

                    // Create result item
                    resultsHTML += `
                        <div class="result-item">
                            <div class="result-title">
                                <i class="fas fa-external-link-alt"></i>
                                <a href="${result.link}" target="_blank" rel="noopener noreferrer">
                                    ${result.title || 'No Title'}
                                </a>
                            </div>
                            <div class="result-snippet">
                                ${result.snippet || 'No description available'}
                            </div>
                            <div class="result-meta">
                                <div class="result-source">
                                    <i class="fas fa-globe"></i>
                                    <span>${result.source || 'Unknown Source'}</span>
                                </div>
                                <div class="result-position">
                                    #${result.position || index + 1}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                resultsHTML = `
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Tidak ditemukan hasil pencarian universal untuk "${searchName}"</p>
                    </div>
                `;
            }

            resultsElement.innerHTML = resultsHTML;

            // Display social media links if found (with RELEVANCE SORTING!)
            if (socialLinks.length > 0) {
                console.log(`Found ${socialLinks.length} social media profiles for: ${searchName}`);
                
                // Sort by RELEVANCE (name matching first!)
                const sortedLinks = socialLinks.sort((a, b) => {
                    const scoreA = getRelevanceScore(a, searchName);
                    const scoreB = getRelevanceScore(b, searchName);
                    return scoreB - scoreA; // Higher score first
                });
                
                console.log('Sorted by relevance, displaying...');
                
                sortedLinks.forEach((link, index) => {
                    const platform = getPlatformName(link.link);
                    const icon = getPlatformIcon(link.link);
                    const color = getPlatformColor(link.link);
                    const imageUrl = extractImage(link, platform);
                    const relevanceScore = getRelevanceScore(link, searchName);
                    
                    // Highlight high relevance items
                    const isHighRelevance = relevanceScore >= 3;
                    const relevanceBadge = isHighRelevance ? 
                        '<span style="display: inline-block; padding: 2px 6px; background: #10b981; color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-star" style="font-size: 0.6rem;"></i> MATCH</span>' : '';

                    socialLinksHTML += `
                        <div class="social-item" style="border-left: 3px solid ${color}; ${isHighRelevance ? 'box-shadow: 0 0 0 2px ' + color + '20;' : ''}">
                            <a href="${link.link}" target="_blank" rel="noopener noreferrer" style="text-decoration: none;">
                                <!-- Profile Image (ALWAYS SHOWN) -->
                                <div style="width: 100%; height: 140px; overflow: hidden; border-radius: 8px; margin-bottom: 12px; background: linear-gradient(135deg, ${color}15, ${color}05);">
                                    <img src="${imageUrl}" 
                                         alt="${platform}" 
                                         style="width: 100%; height: 100%; object-fit: cover;"
                                         onerror="this.style.objectFit='contain'; this.style.padding='20px';">
                                </div>
                                
                                <!-- Platform Info -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="color: ${color}; font-size: 1.5rem;">
                                    <i class="${icon}"></i>
                                </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                                            <span style="font-weight: 700; color: ${color}; font-size: 0.9rem;">${platform}</span>
                                            <span style="padding: 2px 6px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600;">
                                                <i class="fab fa-google" style="font-size: 0.6rem;"></i> GOOGLE
                                            </span>
                                            ${relevanceBadge}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Profile Title -->
                                <div style="font-size: 0.85rem; font-weight: 600; color: #1f2937; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3;">
                                    ${link.title || 'Profile'}
                                </div>
                                
                                <!-- Snippet -->
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 8px;">
                                    ${link.snippet || 'Social media profile'}
                                    </div>
                                
                                <!-- Link -->
                                <div style="padding-top: 8px; border-top: 1px solid #f3f4f6;">
                                    <span style="font-size: 0.7rem; color: #9ca3af;">
                                        <i class="fas fa-link"></i> ${link.link.replace(/^https?:\/\//, '').substring(0, 40)}${link.link.length > 40 ? '...' : ''}
                                    </span>
                                </div>
                            </a>
                        </div>
                    `;
                });

                socialGridElement.innerHTML = socialLinksHTML;
                socialLinksElement.style.display = 'block';
                
                // Update header with count
                const headerElement = socialLinksElement.querySelector('h4');
                if (headerElement) {
                    headerElement.innerHTML = `<i class="fas fa-share-alt"></i> Social Media Links <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px;">${socialLinks.length} profiles</span>`;
                }
            } else {
                socialLinksElement.style.display = 'none';
            }
        }

        // ============================================================================
        // EXTRACTION & CATEGORIZATION FUNCTIONS (150+ platforms)
        // ============================================================================

        // Extract ALL Social Media Links from results (150+ platforms detection) - ULTRA SENSITIVE!
        function extractSocialMediaLinks(results) {
            const socialMediaLinks = [];
            
            // Comprehensive list of 150+ social media domains (EXPANDED!)
            const socialMediaDomains = [
                // Tier 1: Major Platforms (dengan semua varian domain)
                'facebook.com', 'fb.com', 'fb.me', 'fb.watch', 'messenger.com', 'm.facebook.com', 'web.facebook.com',
                'instagram.com', 'instagr.am', 'ig.me', 'm.instagram.com',
                'twitter.com', 'x.com', 't.co', 'twimg.com', 'mobile.twitter.com',
                'linkedin.com', 'lnkd.in', 'licdn.com',
                'tiktok.com', 'vm.tiktok.com', 'm.tiktok.com',
                'youtube.com', 'youtu.be', 'yt.be', 'ytimg.com', 'm.youtube.com',
                'pinterest.com', 'pin.it', 'pinimg.com',
                'snapchat.com', 'snap.com',
                'whatsapp.com', 'wa.me', 'chat.whatsapp.com',
                'telegram.org', 't.me', 'telegram.me',
                
                // Tier 2: Popular Platforms
                'reddit.com', 'redd.it', 'old.reddit.com',
                'tumblr.com', 'tmblr.co',
                'discord.com', 'discord.gg', 'discordapp.com',
                'twitch.tv', 'twitch.com',
                'medium.com',
                'quora.com',
                'flickr.com', 'flic.kr',
                'vimeo.com',
                'dailymotion.com',
                
                // Tier 3: Asian & Regional
                'weibo.com', 'sina.com.cn',
                'wechat.com', 'weixin.qq.com',
                'qq.com',
                'bilibili.com',
                'douban.com',
                'line.me', 'line.naver.jp',
                'kakao.com', 'kakaotalk.com',
                'naver.com',
                'band.us',
                'vk.com', 'vkontakte.ru',
                'ok.ru', 'odnoklassniki.ru',
                'mail.ru',
                'kaskus.co.id',
                'sharechat.com',
                'moj.app',
                
                // Tier 4: Professional & Creative
                'github.com',
                'gitlab.com',
                'stackoverflow.com', 'stackexchange.com',
                'behance.net',
                'dribbble.com',
                'deviantart.com',
                'artstation.com',
                'angellist.com',
                'xing.com',
                
                // Tier 5: Messaging
                'signal.org',
                'viber.com',
                'kik.com',
                'skype.com',
                'slack.com',
                'teams.microsoft.com',
                'zoom.us',
                
                // Tier 6: Video & Streaming
                'kick.com',
                'dlive.tv',
                'trovo.live',
                'caffeine.tv',
                'younow.com',
                'periscope.tv', 'pscp.tv',
                'streamlabs.com',
                
                // Tier 7: Alternative & Emerging
                'myspace.com',
                'mewe.com',
                'mastodon.social', 'mastodon.online',
                'bereal.com',
                'lemon8-app.com',
                'threads.net',
                'bsky.app', 'bluesky.social',
                'polywork.com',
                'truthsocial.com', 'truth.social',
                'gettr.com',
                'parler.com',
                'rumble.com',
                'gab.com',
                'minds.com',
                'bitchute.com',
                'odysee.com',
                
                // Tier 8: Dating & Social
                'tinder.com',
                'bumble.com',
                'hinge.co',
                'okcupid.com',
                'match.com',
                
                // Tier 9: Blogging & Publishing
                'wordpress.com',
                'blogger.com', 'blogspot.com',
                'ghost.org',
                'substack.com',
                'patreon.com',
                'ko-fi.com',
                'buymeacoffee.com',
                
                // Tier 10: Social Bookmarking
                'digg.com',
                'mix.com',
                'pocket.com',
                'flipboard.com',
                'goodreads.com',
                'letterboxd.com',
                'last.fm',
                'spotify.com',
                
                // Tier 11: Gaming
                'steam.com', 'steamcommunity.com',
                'epicgames.com',
                'playstation.com',
                'xbox.com',
                'roblox.com',
                
                // Tier 12: Niche
                'strava.com',
                'myfitnesspal.com',
                'untappd.com',
                '500px.com',
                'vsco.co'
            ];
            
            // Keywords that indicate social media profiles (EXPANDED!)
            const socialKeywords = [
                '/profile/', '/user/', '/@', '/channel/', '/people/', '/member/',
                '/account/', '/p/', '/u/', '/c/', '/author/', '/creator/',
                'profile', 'user', 'account', 'member', 'people', 'person',
                'social', 'community', 'network', 'follow', 'followers'
            ];
            
            results.forEach(result => {
                const link = (result.link || '').toLowerCase();
                const title = (result.title || '').toLowerCase();
                
                // Check 1: Domain matching
                const hasSocialDomain = socialMediaDomains.some(domain => link.includes(domain));
                
                // Check 2: Pattern matching
                const hasSocialPattern = socialKeywords.some(keyword => link.includes(keyword));
                
                // Check 3: Title matching (jika title mengandung "profile", "account", dll)
                const hasSocialTitle = socialKeywords.some(keyword => title.includes(keyword));
                
                // Tambahkan jika memenuhi SALAH SATU kriteria (lebih permissive!)
                if (hasSocialDomain || hasSocialPattern || hasSocialTitle) {
                    socialMediaLinks.push(result);
                }
            });
            
            console.log(` Detected ${socialMediaLinks.length} social media links from ${results.length} total results`);
            return socialMediaLinks;
        }

        // Categorize Results (News, Social Media, Blog, Forum, Video, Official, Other)
        function categorizeResults(results) {
            const categories = {
                'News': [],
                'Official': [],
                'Social Media': [],
                'Postingan': [],
                'Blog': [],
                'Forum': [],
                'Video': [],
                'Lainnya': []
            };
            
            // Social Media Domains - SUPER LENGKAP (150+ platforms)
            const socialMediaDomains = [
                'facebook.com', 'fb.com', 'instagram.com', 'twitter.com', 'x.com',
                'linkedin.com', 'tiktok.com', 'youtube.com', 'pinterest.com', 'snapchat.com',
                'whatsapp.com', 'telegram.org', 't.me', 'reddit.com', 'tumblr.com',
                'discord.com', 'twitch.tv', 'medium.com', 'quora.com', 'flickr.com',
                'vimeo.com', 'dailymotion.com', 'weibo.com', 'wechat.com', 'qq.com',
                'bilibili.com', 'douban.com', 'line.me', 'kakao.com', 'naver.com',
                'band.us', 'vk.com', 'ok.ru', 'mail.ru', 'kaskus.co.id',
                'sharechat.com', 'moj.app', 'github.com', 'gitlab.com', 'stackoverflow.com',
                'behance.net', 'dribbble.com', 'deviantart.com', 'artstation.com',
                'angellist.com', 'xing.com', 'signal.org', 'viber.com', 'kik.com',
                'skype.com', 'slack.com', 'teams.microsoft.com', 'zoom.us',
                'kick.com', 'dlive.tv', 'trovo.live', 'caffeine.tv', 'younow.com',
                'periscope.tv', 'myspace.com', 'mewe.com', 'mastodon.social',
                'bereal.com', 'lemon8-app.com', 'threads.net', 'bsky.app', 'bluesky.social',
                'polywork.com', 'truthsocial.com', 'gettr.com', 'parler.com', 'rumble.com',
                'gab.com', 'minds.com', 'bitchute.com', 'odysee.com', 'tinder.com',
                'bumble.com', 'hinge.co', 'okcupid.com', 'match.com', 'wordpress.com',
                'blogger.com', 'blogspot.com', 'ghost.org', 'substack.com', 'patreon.com',
                'ko-fi.com', 'buymeacoffee.com', 'digg.com', 'mix.com', 'pocket.com',
                'flipboard.com', 'goodreads.com', 'letterboxd.com', 'last.fm',
                'spotify.com', 'steam.com', 'steamcommunity.com', 'epicgames.com',
                'playstation.com', 'xbox.com', 'roblox.com', '500px.com', 'vsco.co',
                'strava.com', 'myfitnesspal.com', 'untappd.com',
                '/profile/', '/user/', '/@', '/channel/', '/people/'
            ];
            
            // News Keywords - COMPREHENSIVE
            const newsKeywords = [
                'news', 'berita', 'detik', 'kompas', 'tempo', 'tribun', 'liputan',
                'cnbc', 'cnn', 'bbc', 'reuters', 'bloomberg', 'antaranews', 'viva',
                'okezone', 'suara', 'merdeka', 'jpnn', 'sindonews', 'bisnis',
                'kontan', 'idntimes', 'kumparan', 'tirto', 'vice', 'vice.com'
            ];
            
            // Official Keywords
            const officialKeywords = [
                '.gov', '.go.id', 'official', 'resmi', 'pemerintah', 'kemenkeu',
                'kemendag', 'polri', 'tni', 'bpk', 'kpu', 'kominfo'
            ];
            
            // Blog Keywords
            const blogKeywords = [
                'blog', 'personal', 'diary', 'wordpress', 'blogspot', 'medium',
                'tumblr', 'substack'
            ];
            
            // Forum Keywords
            const forumKeywords = [
                'forum', 'community', 'discussion', 'kaskus', 'reddit', 'quora',
                'stackexchange', 'stackoverflow'
            ];
            
            // Video Keywords
            const videoKeywords = [
                'youtube', 'youtu.be', 'vimeo', 'dailymotion', 'video',
                'bilibili', 'tiktok'
            ];
            
            results.forEach((result, index) => {
                const link = (result.link || '').toLowerCase();
                const title = (result.title || '').toLowerCase();
                const snippet = (result.snippet || '').toLowerCase();
                
                // Use content_type from backend if available, otherwise detect from frontend
                let category = 'Lainnya';
                let icon = 'fas fa-globe';
                let color = '#6b7280';
                
                if (result.content_type) {
                    // Use backend content_type
                    const contentTypeMap = {
                        'news': { category: 'News', icon: 'fas fa-newspaper', color: '#ef4444' },
                        'official': { category: 'Official', icon: 'fas fa-landmark', color: '#3b82f6' },
                        'social_media': { category: 'Social Media', icon: 'fas fa-share-alt', color: '#10b981' },
                        'posting': { category: 'Postingan', icon: 'fas fa-file-alt', color: '#8b5cf6' },
                        'blog': { category: 'Blog', icon: 'fas fa-edit', color: '#f59e0b' },
                        'forum': { category: 'Forum', icon: 'fas fa-comments', color: '#ec4899' },
                        'video': { category: 'Video', icon: 'fas fa-play-circle', color: '#ef4444' },
                        'general': { category: 'Lainnya', icon: 'fas fa-globe', color: '#6b7280' }
                    };
                    
                    const typeInfo = contentTypeMap[result.content_type] || contentTypeMap['general'];
                    category = typeInfo.category;
                    icon = typeInfo.icon;
                    color = typeInfo.color;
                    
                    // Special handling for social media - get platform color
                    if (result.content_type === 'social_media') {
                        color = getPlatformColor(result.link);
                    }
                } else {
                    // Fallback: Frontend detection (for backward compatibility)
                    // PRIORITY ORDER: News > Official > Blog > Forum > Video > Social Media > Other
                    
                    // 1. Check News first (highest priority for non-social)
                    if (newsKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'News';
                        icon = 'fas fa-newspaper';
                        color = '#ef4444';
                    }
                    // 2. Official
                    else if (officialKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'Official';
                        icon = 'fas fa-landmark';
                        color = '#3b82f6';
                    }
                    // 3. Blog
                    else if (blogKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'Blog';
                        icon = 'fas fa-edit';
                        color = '#8b5cf6';
                    }
                    // 4. Forum
                    else if (forumKeywords.some(kw => link.includes(kw) || title.includes(kw))) {
                        category = 'Forum';
                        icon = 'fas fa-comments';
                        color = '#f59e0b';
                    }
                    // 5. Video
                    else if (videoKeywords.some(kw => link.includes(kw))) {
                        category = 'Video';
                        icon = 'fas fa-play-circle';
                        color = '#ef4444';
                    }
                    // 6. Social Media (after others to avoid over-categorization)
                    else if (socialMediaDomains.some(domain => link.includes(domain))) {
                        category = 'Social Media';
                        icon = 'fas fa-share-alt';
                        color = '#10b981';
                        // Get specific platform color if available
                        color = getPlatformColor(result.link);
                    }
                }
                
                // Add to category with metadata
                categories[category].push({
                    ...result,
                    category: category,
                    categoryIcon: icon,
                    categoryColor: color,
                    platform: category === 'Social Media' ? getPlatformName(result.link) : category,
                    position: index + 1
                });
            });
            
            console.log(' Categorization complete:',
                Object.entries(categories).map(([cat, items]) => `${cat}: ${items.length}`).join(', '));
            
            return categories;
        }

        // ============================================================================
        // DISPLAY FUNCTIONS
        // ============================================================================

        // Display Categorized Results
        function displayCategorizedResults(categorized) {
            const container = document.getElementById('categorizedResults');
            if (!container) return;
            
            let html = '';
            let totalResults = 0;
            
            // Display each category
            Object.entries(categorized).forEach(([category, items]) => {
                if (items.length > 0) {
                    totalResults += items.length;
                    const categoryIcon = items[0].categoryIcon || 'fas fa-folder';
                    const categoryColor = items[0].categoryColor || '#6b7280';
                    
                    html += `
                        <div class="category-section" style="margin-bottom: 30px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid ${categoryColor};">
                                <i class="${categoryIcon}" style="color: ${categoryColor}; font-size: 1.5rem;"></i>
                                <h4 style="margin: 0; color: ${categoryColor}; font-size: 1.1rem;">${category}</h4>
                                <span style="background: ${categoryColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">${items.length}</span>
                            </div>
                            <div style="display: grid; gap: 15px;">
                    `;
                    
                    items.forEach((item, index) => {
                        html += createDetailedResultItemHTML(item, index);
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            if (totalResults === 0) {
                html = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-layer-group" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Tidak ada hasil untuk dikategorikan</p>
                    </div>
                `;
            }

            container.innerHTML = html;
            console.log(` Displayed ${totalResults} categorized results`);
        }

        // Create Detailed Result Item HTML
        function createDetailedResultItemHTML(result, index) {
            const categoryIcon = result.categoryIcon || 'fas fa-globe';
            const categoryColor = result.categoryColor || '#6b7280';
            const category = result.category || 'Lainnya';
            const platform = result.platform || 'Website';
            
            // Content Type Detection (from backend)
            const contentType = result.content_type || 'general';
            const contentTypeLabels = {
                'news': { label: 'Berita', icon: 'fas fa-newspaper', color: '#ef4444' },
                'official': { label: 'Resmi', icon: 'fas fa-landmark', color: '#3b82f6' },
                'social_media': { label: 'Social Media', icon: 'fas fa-share-alt', color: '#10b981' },
                'posting': { label: 'Postingan', icon: 'fas fa-file-alt', color: '#8b5cf6' },
                'blog': { label: 'Blog', icon: 'fas fa-edit', color: '#f59e0b' },
                'forum': { label: 'Forum', icon: 'fas fa-comments', color: '#ec4899' },
                'video': { label: 'Video', icon: 'fas fa-play-circle', color: '#ef4444' },
                'general': { label: 'Umum', icon: 'fas fa-globe', color: '#6b7280' }
            };
            const contentTypeInfo = contentTypeLabels[contentType] || contentTypeLabels['general'];
            
            // Location Information
            const detectedLocations = result.detected_locations || [];
            const locationScore = result.location_score || 0;
            let locationBadge = '';
            if (detectedLocations.length > 0) {
                const locationText = detectedLocations.slice(0, 2).join(', '); // Show max 2 locations
                const locationColor = locationScore >= 60 ? '#10b981' : locationScore >= 40 ? '#f59e0b' : '#6b7280';
                locationBadge = `<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: ${locationColor}15; color: ${locationColor}; border-radius: 8px; font-size: 0.7rem; font-weight: 600; border: 1px solid ${locationColor}40;">
                    <i class="fas fa-map-marker-alt" style="font-size: 0.65rem;"></i>
                    ${locationText}${detectedLocations.length > 2 ? ' +' + (detectedLocations.length - 2) : ''}
                </span>`;
            }
            
            // Relevance Badge (if location score is high)
            let relevanceBadge = '';
            if (locationScore >= 80) {
                relevanceBadge = `<span style="display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;">
                    <i class="fas fa-star" style="font-size: 0.6rem;"></i> RELEVAN
                </span>`;
            } else if (locationScore >= 60) {
                relevanceBadge = `<span style="display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;">
                    <i class="fas fa-check-circle" style="font-size: 0.6rem;"></i> TERKAIT
                </span>`;
            }
            
            // Tentukan sumber hasil (Universal vs Social Media vs Social Searcher Style)
            const isUniversal = result.source === 'Universal Search';
            const isSocialSearcher = result.source === 'Social Searcher Style';
            
            // Platform badge untuk Social Searcher Style
            let platformBadge = '';
            if (isSocialSearcher && result.platform) {
                const platformColors = {
                    'facebook': '#1877f2',
                    'instagram': '#e4405f',
                    'twitter': '#1da1f2',
                    'linkedin': '#0077b5',
                    'tiktok': '#000000',
                    'pinterest': '#bd081c'
                };
                const platformIcons = {
                    'facebook': 'fab fa-facebook',
                    'instagram': 'fab fa-instagram',
                    'twitter': 'fab fa-twitter',
                    'linkedin': 'fab fa-linkedin',
                    'tiktok': 'fab fa-tiktok',
                    'pinterest': 'fab fa-pinterest'
                };
                const color = platformColors[result.platform] || '#667eea';
                const icon = platformIcons[result.platform] || 'fas fa-share-alt';
                platformBadge = `<span style="display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; background: ${color}; color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px; text-transform: capitalize;"><i class="${icon}" style="font-size: 0.6rem;"></i> ${result.platform}</span>`;
            }
            
            const sourceBadge = isUniversal
                ? '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;"><i class="fas fa-server"></i> INTERNAL</span>'
                : isSocialSearcher
                ? '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;"><i class="fas fa-search"></i> SOCIAL SEARCHER</span>'
                : '<span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;"><i class="fab fa-google"></i> GOOGLE</span>';
            
            return `
                <div class="result-item" style="border-left: 4px solid ${categoryColor}; background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s ease; ${locationScore >= 80 ? 'border-left-width: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);' : ''}">
                    <div class="result-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span class="content-type-tag" style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: ${contentTypeInfo.color}15; color: ${contentTypeInfo.color}; border-radius: 12px; font-size: 0.75rem; font-weight: 600; border: 1px solid ${contentTypeInfo.color}30;">
                                <i class="${contentTypeInfo.icon}"></i>
                                ${contentTypeInfo.label}
                            </span>
                            ${locationBadge}
                            ${relevanceBadge}
                            ${sourceBadge}
                            ${platformBadge}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${locationScore > 0 ? `<span style="font-size: 0.7rem; color: #9ca3af; font-weight: 500;">Relevansi: ${locationScore}%</span>` : ''}
                            <span class="result-position" style="font-size: 0.75rem; color: #9ca3af; font-weight: 600; padding: 4px 8px; background: #f3f4f6; border-radius: 6px;">#${index + 1}</span>
                        </div>
                    </div>
                    <div class="result-title" style="margin-bottom: 10px;">
                        <a href="${result.link}" target="_blank" rel="noopener noreferrer" style="font-size: 1.1rem; font-weight: 600; color: #1f2937; text-decoration: none; display: flex; align-items: start; gap: 8px; line-height: 1.4; transition: color 0.2s;" onmouseover="this.style.color='#667eea'" onmouseout="this.style.color='#1f2937'">
                            <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-top: 5px; color: ${categoryColor}; flex-shrink: 0;"></i>
                            <span style="flex: 1;">${result.title || 'No Title'}</span>
                        </a>
                    </div>
                    <div class="result-snippet" style="color: #4b5563; font-size: 0.95rem; line-height: 1.7; margin-bottom: 12px; padding: 12px; background: #f9fafb; border-radius: 6px; border-left: 3px solid ${contentTypeInfo.color}40;">
                        ${result.snippet || result.htmlSnippet || result.description || 'No description available'}
                    </div>
                    ${result.pagemap && result.pagemap.cse_thumbnail ? `
                        <div class="result-thumbnail" style="margin-bottom: 10px;">
                            <img src="${result.pagemap.cse_thumbnail[0].src}" alt="Thumbnail" style="max-width: 200px; max-height: 150px; border-radius: 6px; border: 1px solid #e5e7eb;">
                        </div>
                    ` : ''}
                    <div class="result-meta" style="display: flex; align-items: center; gap: 12px; padding-top: 10px; border-top: 1px solid #f3f4f6; flex-wrap: wrap;">
                        <div class="result-source" style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #6b7280;">
                            <i class="fas fa-link" style="color: ${categoryColor};"></i>
                            <span>${result.displayLink || result.formattedUrl || result.link?.replace(/^https?:\/\//, '').split('/')[0] || 'Unknown Source'}</span>
                        </div>
                        ${result.pagemap && result.pagemap.metatags && result.pagemap.metatags[0] && result.pagemap.metatags[0]['og:type'] ? `
                            <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                            <span style="font-size: 0.75rem; color: #6b7280; text-transform: capitalize;">${result.pagemap.metatags[0]['og:type']}</span>
                        ` : ''}
                        ${result.cacheId ? `
                            <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                            <a href="https://webcache.googleusercontent.com/search?q=cache:${result.cacheId}" target="_blank" style="font-size: 0.75rem; color: #667eea; text-decoration: none;">
                                <i class="fas fa-archive"></i> Cached
                            </a>
                        ` : ''}
                    </div>
                        </div>
                    `;
        }

        // Display Social Media Web Results (API Results tab)
        function displaySocialMediaWebResults(results, searchName) {
            const container = document.getElementById('socialMediaWebResults');
            if (!container) {
                console.error(' [Display] Container #socialMediaWebResults NOT FOUND!');
                return;
            }
            
            let html = '';
            
            if (results && results.length > 0) {
                console.log(` [Display] Displaying ${results.length} web results in API Results tab`);
                
                // Count by source for debugging
                const sourceCounts = {};
                results.forEach(r => {
                    const source = r.source || 'Unknown';
                    sourceCounts[source] = (sourceCounts[source] || 0) + 1;
                });
                console.log(` [Display] Source breakdown:`, sourceCounts);
                
                results.forEach((result, index) => {
                    const isUniversal = result.source === 'Universal Search';
                    const isSocialSearcher = result.source === 'Social Searcher Style';
                    
                    // Platform badge untuk Social Searcher Style
                    let platformBadge = '';
                    if (isSocialSearcher && result.platform) {
                        const platformColors = {
                            'facebook': '#1877f2',
                            'instagram': '#e4405f',
                            'twitter': '#1da1f2',
                            'linkedin': '#0077b5',
                            'tiktok': '#000000',
                            'pinterest': '#bd081c'
                        };
                        const platformIcons = {
                            'facebook': 'fab fa-facebook',
                            'instagram': 'fab fa-instagram',
                            'twitter': 'fab fa-twitter',
                            'linkedin': 'fab fa-linkedin',
                            'tiktok': 'fab fa-tiktok',
                            'pinterest': 'fab fa-pinterest'
                        };
                        const color = platformColors[result.platform] || '#667eea';
                        const icon = platformIcons[result.platform] || 'fas fa-share-alt';
                        platformBadge = `<span style="display: inline-block; padding: 2px 6px; background: ${color}; color: white; border-radius: 6px; font-size: 0.65rem; font-weight: 600; margin-left: 5px; text-transform: capitalize;"><i class="${icon}" style="font-size: 0.6rem;"></i> ${result.platform}</span>`;
                    }
                    
                    const sourceBadge = isUniversal
                        ? '<span style="display: inline-block; padding: 2px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;"><i class="fas fa-server"></i> INTERNAL</span>'
                        : isSocialSearcher
                        ? '<span style="display: inline-block; padding: 2px 8px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;"><i class="fas fa-search"></i> SOCIAL SEARCHER</span>'
                        : '<span style="display: inline-block; padding: 2px 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; font-size: 0.7rem; font-weight: 600; margin-left: 8px;"><i class="fab fa-google"></i> GOOGLE</span>';
                    
                    html += `
                        <div class="result-item" style="padding: 15px; margin-bottom: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div class="result-title" style="margin-bottom: 8px;">
                                <a href="${result.link}" target="_blank" rel="noopener noreferrer" style="font-size: 1.05rem; font-weight: 600; color: #1f2937; text-decoration: none; display: flex; align-items: start; gap: 8px;">
                                    <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-top: 4px; color: #667eea;"></i>
                                    <span style="flex: 1;">${result.title || 'No Title'}</span>
                                    ${sourceBadge}
                                    ${platformBadge}
                            </a>
                        </div>
                            <div class="result-snippet" style="color: #4b5563; font-size: 0.9rem; line-height: 1.6; margin-bottom: 10px;">
                                ${result.snippet || result.htmlSnippet || result.description || 'No description available'}
                        </div>
                        ${result.pagemap && result.pagemap.cse_thumbnail ? `
                            <div class="result-thumbnail" style="margin-bottom: 10px;">
                                <img src="${result.pagemap.cse_thumbnail[0].src}" alt="Thumbnail" style="max-width: 200px; max-height: 150px; border-radius: 6px; border: 1px solid #e5e7eb;">
                            </div>
                        ` : ''}
                            <div class="result-meta" style="display: flex; align-items: center; gap: 12px; padding-top: 10px; border-top: 1px solid #f3f4f6; font-size: 0.8rem; color: #6b7280; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-link" style="color: #667eea;"></i>
                                    <span>${result.displayLink || result.formattedUrl || result.link?.replace(/^https?:\/\//, '').split('/')[0] || 'Unknown Source'}</span>
                </div>
                                ${result.pagemap && result.pagemap.metatags && result.pagemap.metatags[0] && result.pagemap.metatags[0]['og:type'] ? `
                                    <span></span>
                                    <span style="text-transform: capitalize;">${result.pagemap.metatags[0]['og:type']}</span>
                                ` : ''}
                                ${result.cacheId ? `
                                    <span></span>
                                    <a href="https://webcache.googleusercontent.com/search?q=cache:${result.cacheId}" target="_blank" style="color: #667eea; text-decoration: none;">
                                        <i class="fas fa-archive"></i> Cached
                                    </a>
                                ` : ''}
                                <span></span>
                                <span>#${index + 1}</span>
                            </div>
                </div>
            `;
                });
            } else {
                console.warn(` [Display] No results to display for "${searchName}"`);
                html = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Tidak ada hasil ditemukan untuk "${searchName}"</p>
                        <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 10px;">
                            Coba gunakan tab "Categorized" atau "Social Links" untuk melihat hasil dari sumber lain.
                        </p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            console.log(` [Display] Updated container #socialMediaWebResults with ${results?.length || 0} results`);
            
            // Verify Google CSE results are included
            if (results && results.length > 0) {
                const googleResults = results.filter(r => r.source === 'Google CSE');
                const universalResults = results.filter(r => r.source === 'Universal Search');
                const socialSearcherResults = results.filter(r => r.source === 'Social Searcher Style');
                
                console.log(` [Display] Results breakdown in display:`);
                console.log(`   - Google CSE: ${googleResults.length}`);
                console.log(`   - Universal Search (Internal): ${universalResults.length}`);
                console.log(`   - Social Searcher Style: ${socialSearcherResults.length}`);
                
                if (googleResults.length > 0) {
                    console.log(` [Display] Google CSE results ARE included: ${googleResults.length} items`);
                    console.log(` [Display] Sample Google CSE results:`, googleResults.slice(0, 2).map(r => ({
                        title: r.title?.substring(0, 50),
                        source: r.source
                    })));
                } else {
                    console.warn(` [Display] WARNING: No Google CSE results in display! Total results: ${results.length}`);
                    console.warn(`   Sources in results:`, [...new Set(results.map(r => r.source || 'Unknown'))]);
                }
            }
        }

        // Display Social Media Links (Social Links tab) dengan RELEVANCE SORTING & IMAGE
        function displaySocialMediaLinks(socialLinks) {
            const container = document.getElementById('socialMediaLinks');
            if (!container) return;
            
            let html = '';
            
            if (socialLinks && socialLinks.length > 0) {
                console.log(`Displaying ${socialLinks.length} social media platforms`);
                
                // Get search name for relevance scoring
                const searchNameElement = document.getElementById('socialMediaSearchName');
                const searchName = searchNameElement ? searchNameElement.textContent.trim().toLowerCase() : '';
                
                console.log('Sorting by relevance for:', searchName);
                
                // Sort by RELEVANCE first (nama person match), then by platform
                const sortedLinks = [...socialLinks].sort((a, b) => {
                    // Calculate relevance score (0-3 points)
                    const scoreA = getRelevanceScore(a, searchName);
                    const scoreB = getRelevanceScore(b, searchName);
                    
                    // Higher score = more relevant = appears first
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA; // Descending (highest first)
                    }
                    
                    // If same relevance, sort by platform name
                    const platformA = getPlatformName(a.link || '');
                    const platformB = getPlatformName(b.link || '');
                    return platformA.localeCompare(platformB);
                });
                
                console.log('Sorted links by relevance:', sortedLinks.length);
                
                // Create grid
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
                
                sortedLinks.forEach((link, index) => {
                    const platform = getPlatformName(link.link);
                    const icon = getPlatformIcon(link.link);
                    const color = getPlatformColor(link.link);
                    const imageUrl = extractImage(link, platform);
                    const relevanceScore = getRelevanceScore(link, searchName);
                    
                    // Detect source (INTERNAL vs GOOGLE vs SOCIAL SEARCHER)
                    const isUniversal = link.source === 'Universal Search';
                    const isSocialSearcher = link.source === 'Social Searcher Style';
                    const sourceBadge = isUniversal
                        ? '<span style="display: inline-block; padding: 2px 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-server" style="font-size: 0.6rem;"></i> INTERNAL</span>'
                        : isSocialSearcher
                        ? '<span style="display: inline-block; padding: 2px 6px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-search" style="font-size: 0.6rem;"></i> SOCIAL SEARCHER</span>'
                        : '<span style="display: inline-block; padding: 2px 6px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fab fa-google" style="font-size: 0.6rem;"></i> GOOGLE</span>';
                    
                    // Highlight high relevance items
                    const isHighRelevance = relevanceScore >= 3;
                    const relevanceBadge = isHighRelevance ?
                        '<span style="display: inline-block; padding: 2px 6px; background: #10b981; color: white; border-radius: 8px; font-size: 0.65rem; font-weight: 600; margin-left: 5px;"><i class="fas fa-star" style="font-size: 0.6rem;"></i> MATCH</span>' : '';
                    
                    html += `
                        <div style="background: white; border-radius: 10px; padding: 15px; border-left: 3px solid ${color}; ${isHighRelevance ? 'box-shadow: 0 0 0 2px ' + color + '20;' : 'border: 1px solid #e5e7eb;'} transition: all 0.3s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='${isHighRelevance ? '0 0 0 2px ' + color + '20' : 'none'}';">
                            <a href="${link.link}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                                <!-- Profile Image (ALWAYS SHOWN) -->
                                <div style="width: 100%; height: 140px; overflow: hidden; border-radius: 8px; margin-bottom: 12px; background: linear-gradient(135deg, ${color}15, ${color}05);">
                                    <img src="${imageUrl}"
                                         alt="${platform}"
                                         style="width: 100%; height: 100%; object-fit: cover;"
                                         onerror="this.style.objectFit='contain'; this.style.padding='20px';">
                                </div>
                                
                                <!-- Platform Info -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div style="color: ${color}; font-size: 1.5rem;">
                                        <i class="${icon}"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 4px;">
                                            <div style="font-weight: 700; color: ${color}; font-size: 0.9rem;">${platform}</div>
                                            ${sourceBadge}
                                            ${relevanceBadge}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Profile Title -->
                                <div style="font-size: 0.9rem; font-weight: 600; color: #1f2937; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${link.title || 'Profile'}</div>
                                
                                <!-- Snippet -->
                                <div style="font-size: 0.75rem; color: #6b7280; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 8px;">${link.snippet || ''}</div>
                                
                                <!-- Link -->
                                <div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #f3f4f6;">
                                    <span style="font-size: 0.7rem; color: #9ca3af;">
                                        <i class="fas fa-link"></i> ${link.displayLink || link.formattedUrl || 'Social Media'}
                                    </span>
                                </div>
                            </a>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Add header dengan count
                html = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-users"></i> Social Media Links
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem;">${socialLinks.length} platforms</span>
                        </h4>
                        </div>
                ` + html;
            } else {
                html = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>Tidak ada link social media ditemukan</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // ============================================================================
        // TAB SWITCHING & GOOGLE CSE FUNCTIONS
        // ============================================================================

        // Switch Social Media Tab
        function switchSocialMediaTab(tabId) {
            // Update button styles
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => {
                btn.style.background = '#f3f4f6';
                btn.style.color = '#6b7280';
            });
            
            const activeButton = Array.from(buttons).find(btn =>
                btn.getAttribute('onclick').includes(`'${tabId}'`)
            );
            if (activeButton) {
                activeButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                activeButton.style.color = 'white';
            }
            
            // Update tab content visibility
            const tabs = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => {
                tab.style.display = 'none';
            });
            
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) {
                activeTab.style.display = 'block';
            }
            
            console.log('Switched to tab:', tabId);
        }

        // REMOVED: Google CSE Web tab functionality (no longer used)
        // Function removed - tab "Web" has been deleted
        async function _removed_loadGoogleCSEInIframe(searchQuery) {
            console.log(' [Google CSE Web] Fetching results via API (no iframe)...');
            
            const container = document.getElementById('googleWebSearch');
            if (!container) {
                console.error(' [Google CSE Web] Container #googleWebSearch NOT FOUND!');
                return;
            }
            
            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p style="margin-top: 20px;">Mencari hasil dari Google CSE...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/google-cse-widget', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: searchQuery, type: 'web' })
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.web && result.data.web.length > 0) {
                    const results = result.data.web;
                    console.log(` [Google CSE Web] Found ${results.length} results`);
                    
                    let html = `
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                <i class="fab fa-google"></i>
                                Google CSE Results (${results.length} results)
                            </h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                                 UNLIMITED - No API key, no quota limits!
                            </p>
                        </div>
                    `;
                    
                    results.forEach((item, index) => {
                        const domain = new URL(item.link).hostname.replace('www.', '');
                        html += `
                            <div class="result-item" style="padding: 15px; margin-bottom: 15px; background: white; border-radius: 8px; border-left: 4px solid #667eea; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div class="result-title" style="margin-bottom: 8px;">
                                    <a href="${item.link}" target="_blank" rel="noopener noreferrer" style="font-size: 1.05rem; font-weight: 600; color: #1f2937; text-decoration: none; display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-external-link-alt" style="font-size: 0.8rem; margin-top: 4px; color: #667eea;"></i>
                                        <span style="flex: 1;">${item.title || 'No Title'}</span>
                                        <span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">
                                            <i class="fab fa-google"></i> GOOGLE
                                        </span>
                                    </a>
                                </div>
                                <div class="result-url" style="color: #10b981; font-size: 0.85rem; margin-bottom: 8px;">
                                    <i class="fas fa-link"></i> ${item.displayLink || domain}
                                </div>
                                <div class="result-snippet" style="color: #4b5563; font-size: 0.9rem; line-height: 1.6;">
                                    ${item.snippet || 'No description available'}
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    console.log(' [Google CSE Web] Results displayed successfully!');
                } else {
                    // Show error message if available
                    const errorMsg = result.error || result.message || 'Tidak ada hasil ditemukan';
                    const helpMsg = result.message || '';
                    const isQuotaError = errorMsg.includes('quota') || errorMsg.includes('Quota');
                    const isRateLimit = errorMsg.includes('rate limit') || errorMsg.includes('429') || errorMsg.includes('too many requests');
                    
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: ${isQuotaError || isRateLimit ? '#f59e0b' : '#6b7280'};">
                            <i class="fas ${isQuotaError || isRateLimit ? 'fa-exclamation-triangle' : 'fa-search'}" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-weight: 600; margin-bottom: 10px; font-size: 1.1rem;">${errorMsg}</p>
                            ${helpMsg ? `<p style="font-size: 0.9rem; color: #9ca3af; margin-bottom: 15px;">${helpMsg}</p>` : ''}
                            ${isQuotaError ? 
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Quota akan reset di midnight Pacific Time. Gunakan tab "Categorized" atau "Social Links" untuk hasil internal.</p>' :
                            isRateLimit ?
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Google Search sementara memblokir request. Tunggu beberapa menit dan coba lagi, atau gunakan tab "Categorized" untuk hasil internal.</p>' :
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Coba gunakan kata kunci yang berbeda atau gunakan tab "Categorized" untuk hasil internal.</p>'
                            }
                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
                                <p style="font-size: 0.85rem; color: #0c4a6e; margin: 0;">
                                    <i class="fas fa-lightbulb"></i> <strong>Tips:</strong> Gunakan tab <strong>"Categorized"</strong> atau <strong>"Social Links"</strong> untuk melihat hasil dari pencarian internal (tidak terpengaruh rate limit).
                                </p>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(' [Google CSE Web] Error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>Error loading Google CSE results</p>
                        <p style="font-size: 0.85rem; color: #9ca3af;">${error.message}</p>
                    </div>
                `;
            }
        }

        // REMOVED: Google CSE Image tab functionality (no longer used)
        // Function removed - tab "Gambar" has been deleted
        async function _removed_loadGoogleCSEImageInIframe(searchQuery) {
            console.log(' [Google CSE Image] Fetching results via API (no iframe)...');
            
            const container = document.getElementById('googleImageSearch');
            if (!container) {
                console.error(' [Google CSE Image] Container #googleImageSearch NOT FOUND!');
                return;
            }
            
            // Show loading state
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="sr-only">Loading...</span>
                        </div>
                    <p style="margin-top: 20px;">Mencari gambar dari Google CSE...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/google-cse-widget', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: searchQuery, type: 'image' })
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.images && result.data.images.length > 0) {
                    const results = result.data.images;
                    console.log(` [Google CSE Image] Found ${results.length} images`);
                    
                    let html = `
                        <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white;">
                            <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-images"></i>
                                Google CSE Images (${results.length} images)
                            </h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">
                                 UNLIMITED - No API key, no quota limits!
                            </p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                `;

                    results.forEach((item, index) => {
                html += `
                            <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <a href="${item.link}" target="_blank" rel="noopener noreferrer" style="display: block; text-decoration: none;">
                                    <div style="width: 100%; height: 200px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                        <img src="${item.imageUrl || item.link}" alt="${item.title}" 
                                             style="max-width: 100%; max-height: 100%; object-fit: cover;"
                                             onerror="this.parentElement.innerHTML='<i class=\\'fas fa-image\\' style=\\'font-size: 3rem; color: #9ca3af;\\'></i>'">
                        </div>
                                    <div style="padding: 10px;">
                                        <p style="font-size: 0.85rem; color: #1f2937; margin: 0; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.title}">
                                            ${item.title || 'No Title'}
                                        </p>
                                        <p style="font-size: 0.75rem; color: #6b7280; margin: 5px 0 0 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            ${new URL(item.link).hostname.replace('www.', '')}
                                        </p>
                                    </div>
                                </a>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                    container.innerHTML = html;
                    console.log(' [Google CSE Image] Images displayed successfully!');
                } else {
                    // Show error message if available
                    const errorMsg = result.error || result.message || 'Tidak ada gambar ditemukan';
                    const helpMsg = result.message || '';
                    const isQuotaError = errorMsg.includes('quota') || errorMsg.includes('Quota');
                    const isRateLimit = errorMsg.includes('rate limit') || errorMsg.includes('429') || errorMsg.includes('too many requests');
                    
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: ${isQuotaError || isRateLimit ? '#f59e0b' : '#6b7280'};">
                            <i class="fas ${isQuotaError || isRateLimit ? 'fa-exclamation-triangle' : 'fa-image'}" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p style="font-weight: 600; margin-bottom: 10px; font-size: 1.1rem;">${errorMsg}</p>
                            ${helpMsg ? `<p style="font-size: 0.9rem; color: #9ca3af; margin-bottom: 15px;">${helpMsg}</p>` : ''}
                            ${isQuotaError ? 
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Quota akan reset di midnight Pacific Time. Gunakan tab "Categorized" atau "Social Links" untuk hasil internal.</p>' :
                            isRateLimit ?
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Google Search sementara memblokir request. Tunggu beberapa menit dan coba lagi, atau gunakan tab "Categorized" untuk hasil internal.</p>' :
                                '<p style="font-size: 0.85rem; color: #9ca3af;">Coba gunakan kata kunci yang berbeda atau gunakan tab "Categorized" untuk hasil internal.</p>'
                            }
                            <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #fde68a;">
                                <p style="font-size: 0.85rem; color: #78350f; margin: 0;">
                                    <i class="fas fa-lightbulb"></i> <strong>Tips:</strong> Gunakan tab <strong>"Categorized"</strong> atau <strong>"Social Links"</strong> untuk melihat hasil dari pencarian internal (tidak terpengaruh rate limit).
                                </p>
                            </div>
                    </div>
                `;
                }
            } catch (error) {
                console.error(' [Google CSE Image] Error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <p>Error loading Google CSE images</p>
                        <p style="font-size: 0.85rem; color: #9ca3af;">${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================================================
        // AI ANALYSIS FUNCTION
        // ============================================================================

        // Perform AI Analysis
        async function performAIAnalysis(name, socialLinks) {
            const section = document.getElementById('aiAnalysisSection');
            const content = document.getElementById('aiAnalysisContent');
            
            if (!section || !content) return;
            
            // Show section
            section.style.display = 'block';
            
            // Create analysis
            const analysis = {
                name: name,
                total_links: socialLinks.length,
                platforms: {},
                confidence: 0,
                verification: 'unknown',
                risk: 'low'
            };
            
            // Count platforms
            socialLinks.forEach(link => {
                const platform = getPlatformName(link.link);
                analysis.platforms[platform] = (analysis.platforms[platform] || 0) + 1;
            });
            
            // Calculate confidence
            if (socialLinks.length >= 5) {
                analysis.confidence = 0.9;
                analysis.verification = 'highly_verified';
            } else if (socialLinks.length >= 3) {
                analysis.confidence = 0.75;
                analysis.verification = 'verified';
            } else if (socialLinks.length >= 1) {
                analysis.confidence = 0.5;
                analysis.verification = 'partially_verified';
                } else {
                analysis.confidence = 0.2;
                analysis.verification = 'unverified';
                analysis.risk = 'medium';
            }
            
            // Display analysis
            let html = `
                <div style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Total Platforms</div>
                            <div style="font-size: 2rem; font-weight: 700;">${analysis.total_links}</div>
                    </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Confidence Score</div>
                            <div style="font-size: 2rem; font-weight: 700;">${Math.round(analysis.confidence * 100)}%</div>
                    </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Verification</div>
                            <div style="font-size: 1.2rem; font-weight: 600; text-transform: capitalize;">${analysis.verification.replace('_', ' ')}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">Risk Level</div>
                            <div style="font-size: 1.2rem; font-weight: 600; text-transform: uppercase;">${analysis.risk}</div>
                    </div>
                </div>
            `;
            
            if (Object.keys(analysis.platforms).length > 0) {
                html += `
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 10px;">Platform Distribution</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                `;
                
                Object.entries(analysis.platforms).forEach(([platform, count]) => {
                    const color = getPlatformColor(`https://${platform.toLowerCase()}.com`);
                html += `
                        <span style="padding: 6px 12px; background: rgba(255,255,255,0.3); border-radius: 8px; font-size: 0.85rem; font-weight: 500;">
                            ${platform}: ${count}
                        </span>
                    `;
                });
                
                html += `
                    </div>
                </div>
            `;
        }

            html += '</div>';
            content.innerHTML = html;
            
            console.log(' AI Analysis complete:', analysis);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('personDetailsModal');
            if (event.target === modal) {
                closePersonDetails();
            }
        }

        // Store current person data for export
        let currentPersonData = null;

        function exportToPDF() {
            if (!currentPersonData) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            // Show loading
            const pdfBtn = document.querySelector('.pdf-btn');
            const originalText = pdfBtn.innerHTML;
            pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            pdfBtn.disabled = true;
            
            // Call backend to generate PDF
            const token = localStorage.getItem('session_token');
            fetch('/api/export/pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    person: currentPersonData,
                    username: 'admin',
                    password: 'admin123'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Gagal membuat PDF');
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `person_details_${currentPersonData.ktp_number || 'unknown'}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Gagal membuat PDF: ' + error.message);
            })
            .finally(() => {
                // Restore button
                pdfBtn.innerHTML = originalText;
                pdfBtn.disabled = false;
            });
        }

        function exportToWord() {
            if (!currentPersonData) {
                alert('Tidak ada data untuk diekspor');
                return;
            }
            
            // Show loading
            const wordBtn = document.querySelector('.word-btn');
            const originalText = wordBtn.innerHTML;
            wordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            wordBtn.disabled = true;
            
            // Call backend to generate Word document
            const token = localStorage.getItem('session_token');
            fetch('/api/export/word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    person: currentPersonData,
                    username: 'admin',
                    password: 'admin123'
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Gagal membuat dokumen Word');
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `person_details_${currentPersonData.ktp_number || 'unknown'}.docx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Gagal membuat dokumen Word: ' + error.message);
            })
            .finally(() => {
                // Restore button
                wordBtn.innerHTML = originalText;
                wordBtn.disabled = false;
            });
        }

        function copyPersonData() {
            if (!currentPersonData) {
                alert('Tidak ada data untuk dicopy');
                return;
            }
            
            // Show loading
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';
            copyBtn.disabled = true;
            
            try {
                // Helper function to format text for WhatsApp
                function formatForWhatsApp(text) {
                    if (!text) return 'N/A';
                    return String(text)
                        .replace(/\*\*(.*?)\*\*/g, '*$1*')  // Convert **bold** to *bold* for WhatsApp
                        .replace(/__(.*?)__/g, '*$1*')      // Convert __bold__ to *bold* for WhatsApp
                        .replace(/\*(.*?)\*/g, '*$1*')      // Keep *italic* as *bold* for WhatsApp
                        .replace(/_(.*?)_/g, '*$1*')        // Convert _italic_ to *bold* for WhatsApp
                        .replace(/`(.*?)`/g, '`$1`')        // Keep `code` formatting
                        .replace(/#{1,6}\s*/g, '')          // Remove headers
                        .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Remove links, keep text
                        .trim();
                }
                
                // Format data untuk copy
                let copyText = '';
                
                // Informasi Pribadi
                copyText += '* INFORMASI PRIBADI*\n';
                copyText += '\n';
                copyText += ` *Nama Lengkap:* ${formatForWhatsApp(currentPersonData.full_name)}\n`;
                copyText += ` *NIK:* ${formatForWhatsApp(currentPersonData.ktp_number || currentPersonData.nik)}\n`;
                copyText += ` *Tanggal Lahir:* ${formatForWhatsApp(currentPersonData.date_of_birth || currentPersonData.tanggal_lahir)}\n`;
                copyText += ` *Tempat Lahir:* ${formatForWhatsApp(currentPersonData.birth_place || currentPersonData.tempat_lahir)}\n`;
                copyText += ` *Jenis Kelamin:* ${formatForWhatsApp(currentPersonData.sex || currentPersonData.jenis_kelamin || currentPersonData.gender)}\n`;
                copyText += ` *Status Perkawinan:* ${formatForWhatsApp(currentPersonData.marital_status)}\n`;
                copyText += ` *Agama:* ${formatForWhatsApp(currentPersonData.religion)}\n`;
                copyText += ` *Pekerjaan:* ${formatForWhatsApp(currentPersonData.occupation)}\n`;
                copyText += ` *Alamat:* ${formatForWhatsApp(currentPersonData.address)}\n`;
                copyText += ` *Provinsi:* ${formatForWhatsApp(currentPersonData.province_name)}\n`;
                copyText += ` *Kecamatan:* ${formatForWhatsApp(currentPersonData.district_name)}\n`;
                copyText += ` *Desa/Kelurahan:* ${formatForWhatsApp(currentPersonData.village_name)}\n`;
                
                // Additional fields that might be available
                if (currentPersonData.blood_type) {
                    copyText += ` *Golongan Darah:* ${formatForWhatsApp(currentPersonData.blood_type)}\n`;
                }
                if (currentPersonData.birth_cert_number) {
                    copyText += ` *No Akta Lahir:* ${formatForWhatsApp(currentPersonData.birth_cert_number)}\n`;
                }
                if (currentPersonData.dead_alive_status) {
                    copyText += ` *Status:* ${formatForWhatsApp(currentPersonData.dead_alive_status)}\n`;
                }
                if (currentPersonData.divorce_cert_number) {
                    copyText += ` *No Akta Cerai:* ${formatForWhatsApp(currentPersonData.divorce_cert_number)}\n`;
                }
                if (currentPersonData.country_name) {
                    copyText += ` *Negara:* ${formatForWhatsApp(currentPersonData.country_name)}\n`;
                }
                copyText += '\n';
                
                // Nomor Telepon
                if (currentPersonData.phone_data && currentPersonData.phone_data.length > 0) {
                    copyText += `* NOMOR TELEPON (${currentPersonData.phone_data.length})*\n`;
                    copyText += '\n';
                    currentPersonData.phone_data.forEach((phone, index) => {
                        copyText += ` *No HP ${index + 1}:* ${formatForWhatsApp(phone.number || phone.msisdn)}\n`;
                        copyText += `   *Operator:* ${formatForWhatsApp(phone.operator || 'Unknown')}\n`;
                        copyText += `   *Terdaftar:* ${formatForWhatsApp(phone.register_date)}\n\n`;
                    });
                }
                
                // Informasi Keluarga
                if (currentPersonData.family_data && currentPersonData.family_data.anggota_keluarga && currentPersonData.family_data.anggota_keluarga.length > 0) {
                    copyText += `* FAMILY MEMBERS (${currentPersonData.family_data.anggota_keluarga.length})*\n`;
                    copyText += '\n';
                    copyText += ` *Family Head:* ${formatForWhatsApp(currentPersonData.family_data.kepala_keluarga)}\n`;
                    copyText += ` *Family Card Number (NKK):* ${formatForWhatsApp(currentPersonData.family_data.nkk)}\n`;
                    copyText += ` *Alamat Keluarga:* ${formatForWhatsApp(currentPersonData.family_data.alamat_keluarga)}\n\n`;
                    
                    currentPersonData.family_data.anggota_keluarga.forEach((member, index) => {
                        copyText += `* Keluarga ${index + 1}:*\n`;
                        copyText += `   *Nama:* ${formatForWhatsApp(member.nama || member.name)}\n`;
                        copyText += `   *Hubungan:* ${formatForWhatsApp(member.hubungan || member.relationship)}\n`;
                        copyText += `   *NIK:* ${formatForWhatsApp(member.nik)}\n`;
                        copyText += `   *Birth:* ${formatForWhatsApp(member.tanggal_lahir || member.date_of_birth || member.birth_date)}\n`;
                        copyText += `   *Jenis Kelamin:* ${formatForWhatsApp(member.jenis_kelamin || member.gender || member.sex)}\n\n`;
                    });
                }
                
                // Face Detection Information
                if (currentPersonData.face_detection) {
                    copyText += `* INFORMASI DETEKSI WAJAH*\n`;
                    copyText += '\n';
                    copyText += ` *Face Detected:* ${currentPersonData.face_detection.face_detected ? ' Ya' : ' Tidak'}\n`;
                    copyText += ` *Confidence:* ${formatForWhatsApp(currentPersonData.face_detection.confidence)}\n`;
                    copyText += ` *Face Count:* ${formatForWhatsApp(currentPersonData.face_detection.face_count)}\n\n`;
                }
                
                // Additional Information
                if (currentPersonData.face) {
                    copyText += `* INFORMASI FOTO*\n`;
                    copyText += '\n';
                    copyText += ` *Foto Tersedia:*  Ya\n`;
                    copyText += ` *Format:* ${currentPersonData.face.startsWith('data:image/') ? 'Base64' : 'URL'}\n\n`;
                }
                
                // Search Parameters
                if (currentPersonData.search_params) {
                    copyText += `* PARAMETER PENCARIAN*\n`;
                    copyText += '\n';
                    copyText += ` *Search Type:* ${formatForWhatsApp(currentPersonData.search_params.search_type)}\n`;
                    copyText += ` *Search Query:* ${formatForWhatsApp(currentPersonData.search_params.query)}\n`;
                    copyText += ` *Search Date:* ${formatForWhatsApp(currentPersonData.search_params.timestamp)}\n\n`;
                }
                
                // Social Media Links (jika ada)
                const socialLinksElement = document.getElementById('socialLinks');
                if (socialLinksElement && socialLinksElement.style.display !== 'none') {
                    const socialItems = socialLinksElement.querySelectorAll('.social-item');
                    if (socialItems.length > 0) {
                        copyText += '* SOCIAL MEDIA LINKS*\n';
                        copyText += '\n';
                        socialItems.forEach((item, index) => {
                            const link = item.querySelector('a');
                            const platform = item.querySelector('.social-name');
                            const title = item.querySelector('.social-followers');
                            
                            if (link && platform && title) {
                                copyText += ` *${formatForWhatsApp(platform.textContent)}:*\n`;
                                copyText += `   *Profile:* ${formatForWhatsApp(title.textContent)}\n`;
                                copyText += `   *Link:* ${formatForWhatsApp(link.href)}\n\n`;
                            }
                        });
                    }
                }
                
                // Timestamp Information
                copyText += `* INFORMASI SISTEM*\n`;
                copyText += '\n';
                copyText += ` *Data Retrieved:* ${new Date().toLocaleString('id-ID')}\n`;
                copyText += ` *Source:*  AI FaceGuard Pro System\n\n`;
                
                // Copy ke clipboard
                navigator.clipboard.writeText(copyText).then(() => {
                    // Show success message
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    copyBtn.style.background = '#059669';
                    
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.style.background = '#059669';
                    }, 2000);
                    
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Gagal menyalin data ke clipboard');
                });
                
            } catch (error) {
                console.error('Error formatting data:', error);
                alert('Gagal memformat data untuk copy');
            } finally {
                // Restore button after a delay
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.disabled = false;
                }, 2000);
            }
        }

        // AI Global Functions
        function toggleAIMode() {
            app.toggleAIMode();
        }

        function refreshAIDashboard() {
            app.refreshAIDashboard();
        }

        function closeAIInsights() {
            const modal = document.getElementById('aiInsightsModal');
            modal.style.display = 'none';
        }

        function exportAIInsights() {
            app.exportAIInsights();
        }

        // AI Face-to-NIK Global Functions
        function handleFaceUpload(input) {
            app.handleFaceUpload(input);
        }

        function selectAIResult(index) {
            app.selectAIResult(index);
        }

        function fillNIKFromAI() {
            app.fillNIKFromAI();
        }

        function updateAIThreshold() {
            app.updateAIThreshold();
        }

        // Identity Form AI Functions
        function handleIdentityFaceUpload(input) {
            app.handleIdentityFaceUpload(input);
        }

        function selectIdentityResult(index) {
            app.selectIdentityResult(index);
        }

        // Functions for wilayah dropdowns
        async function loadProvinsi() {
            try {
                const response = await fetch('/api/wilayah/provinsi');
                const result = await response.json();
                
                if (result.success) {
                    const provinsiSelect = document.getElementById('provinsi');
                    provinsiSelect.innerHTML = '<option value="">Pilih Provinsi</option>';
                    
                    result.data.forEach(provinsi => {
                        const option = document.createElement('option');
                        option.value = provinsi.kode;
                        option.textContent = provinsi.nama;
                        provinsiSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading provinsi:', error);
            }
        }

        async function loadKabupaten() {
            const provinsiSelect = document.getElementById('provinsi');
            const kabupatenSelect = document.getElementById('kabupaten');
            const kecamatanSelect = document.getElementById('kecamatan');
            const kelurahanSelect = document.getElementById('kelurahan');
            
            // Reset dependent dropdowns
            kabupatenSelect.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
            kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
            kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
            
            // Update hidden fields
            document.getElementById('no_prop').value = provinsiSelect.value;
            document.getElementById('no_kab').value = '';
            document.getElementById('no_kec').value = '';
            document.getElementById('no_desa').value = '';
            
            if (!provinsiSelect.value) {
                kabupatenSelect.disabled = true;
                kecamatanSelect.disabled = true;
                kelurahanSelect.disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`/api/wilayah/kabupaten/${provinsiSelect.value}`);
                const result = await response.json();
                
                if (result.success) {
                    kabupatenSelect.innerHTML = '<option value="">Pilih Kabupaten/Kota</option>';
                    
                    result.data.forEach(kabupaten => {
                        const option = document.createElement('option');
                        option.value = kabupaten.kode;
                        option.textContent = kabupaten.nama;
                        kabupatenSelect.appendChild(option);
                    });
                    
                    kabupatenSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading kabupaten:', error);
            }
        }

        async function loadKecamatan() {
            const kabupatenSelect = document.getElementById('kabupaten');
            const kecamatanSelect = document.getElementById('kecamatan');
            const kelurahanSelect = document.getElementById('kelurahan');
            
            // Reset dependent dropdowns
            kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
            kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
            
            // Update hidden fields
            document.getElementById('no_kab').value = kabupatenSelect.value;
            document.getElementById('no_kec').value = '';
            document.getElementById('no_desa').value = '';
            
            if (!kabupatenSelect.value) {
                kecamatanSelect.disabled = true;
                kelurahanSelect.disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`/api/wilayah/kecamatan/${kabupatenSelect.value}`);
                const result = await response.json();
                
                if (result.success) {
                    kecamatanSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
                    
                    result.data.forEach(kecamatan => {
                        const option = document.createElement('option');
                        option.value = kecamatan.kode;
                        option.textContent = kecamatan.nama;
                        kecamatanSelect.appendChild(option);
                    });
                    
                    kecamatanSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading kecamatan:', error);
            }
        }

        async function loadKelurahan() {
            const kecamatanSelect = document.getElementById('kecamatan');
            const kelurahanSelect = document.getElementById('kelurahan');
            
            // Reset dependent dropdown
            kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
            
            // Update hidden fields
            document.getElementById('no_kec').value = kecamatanSelect.value;
            document.getElementById('no_desa').value = '';
            
            if (!kecamatanSelect.value) {
                kelurahanSelect.disabled = true;
                return;
            }
            
            try {
                const response = await fetch(`/api/wilayah/kelurahan/${kecamatanSelect.value}`);
                const result = await response.json();
                
                if (result.success) {
                    kelurahanSelect.innerHTML = '<option value="">Pilih Kelurahan/Desa</option>';
                    
                    result.data.forEach(kelurahan => {
                        const option = document.createElement('option');
                        option.value = kelurahan.kode;
                        option.textContent = kelurahan.nama;
                        kelurahanSelect.appendChild(option);
                    });
                    
                    kelurahanSelect.disabled = false;
                }
            } catch (error) {
                console.error('Error loading kelurahan:', error);
            }
        }

        function updateKelurahanCode() {
            const kelurahanSelect = document.getElementById('kelurahan');
            document.getElementById('no_desa').value = kelurahanSelect.value;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.profilingApp = new ProfilingApp();
            // Load provinsi data on page load
            loadProvinsi();
        });
    </script>
</body>
</html>
